<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>lxml - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;lxml
    <span class="updated">Page Updated&nbsp;
      2018-09-23 17:29
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">lxml</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#lxml">lxml</a><ul>
<li><a href="#_1">安装</a></li>
<li><a href="#html">解析html字符串</a></li>
<li><a href="#html_1">解析html文件</a><ul>
<li><a href="#_2">标签不正常返回正常</a></li>
</ul>
</li>
<li><a href="#example">Example</a><ul>
<li><a href="#douban">douban 电影</a></li>
<li><a href="#dytt8net">dytt8.net</a></li>
<li><a href="#doutulacom">doutula.com (多线程处理)</a></li>
<li><a href="#lagoucom-deprecated">lagou.com (Deprecated)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="lxml">lxml</h1>
<p>lxml 是 一个HTML/XML的解析器，主要的功能是如何解析和提取 HTML/XML 数据<br />
lxml和正则一样，也是用 C 实现的，是一款高性能的 Python HTML/XML 解析器</p>
<h2 id="_1">安装</h2>
<p>http://lxml.de</p>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">lxml</span>
</pre></div>


<h2 id="html">解析html字符串</h2>
<p>我们可以利用他来解析HTML代码，并且在解析HTML代码的时候，如果HTML代码不规范，他会自动的进行补全。</p>
<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">lxml</span> <span class="k">import</span> <span class="nx">etree</span>

<span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;div&gt;</span>
<span class="s1">    &lt;ul&gt;</span>
<span class="s1">         &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link1.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">         &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">         &lt;li class=&quot;item-inactive&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;third item&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">         &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">         &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt; # 注意，此处缺少一个 &lt;/li&gt; 闭合标签</span>
<span class="s1">     &lt;/ul&gt;</span>
<span class="s1"> &lt;/div&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="err">#</span><span class="nx">利用etree.HTML</span><span class="err">，</span><span class="nx">将字符串解析为HTML文档</span>
<span class="n">html</span> <span class="o">=</span> <span class="nx">etree.HTML</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>

<span class="err">#</span> <span class="nx">按字符串序列化HTML文档</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="nx">etree.tostring</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="bp">.</span><span class="nx">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

<span class="nx">print</span><span class="p">(</span><span class="nb">result</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;&lt;</span><span class="nb">body</span><span class="o">&gt;&lt;</span><span class="nb">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-0&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link1.html&quot;</span><span class="o">&gt;</span><span class="nb">first</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-1&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link2.html&quot;</span><span class="o">&gt;</span><span class="nb">second</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-inactive&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link3.html&quot;</span><span class="o">&gt;</span><span class="nx">third</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-1&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link4.html&quot;</span><span class="o">&gt;</span><span class="nx">fourth</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-0&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link5.html&quot;</span><span class="o">&gt;</span><span class="nx">fifth</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span> <span class="err">#</span> <span class="nx">注意</span><span class="err">，</span><span class="nx">此处缺少一个</span> <span class="o">&lt;/</span><span class="nx">li</span><span class="o">&gt;</span> <span class="nx">闭合标签</span>
     <span class="o">&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span>
 <span class="o">&lt;/</span><span class="nb">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nb">body</span><span class="o">&gt;&lt;/</span><span class="nx">html</span><span class="o">&gt;</span>
</pre></div>


<h2 id="html_1">解析html文件</h2>
<p>除了直接使用字符串进行解析，lxml还支持从文件中读取内容。我们新建一个hello.html文件：</p>
<div class="hlcode"><pre><span class="c">&lt;!-- hello.html --&gt;</span>
<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-0&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link1.html&quot;</span><span class="nt">&gt;</span>first item<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-1&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link2.html&quot;</span><span class="nt">&gt;</span>second item<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-inactive&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link3.html&quot;</span><span class="nt">&gt;&lt;span</span> <span class="na">class=</span><span class="s">&quot;bold&quot;</span><span class="nt">&gt;</span>third item<span class="nt">&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-1&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link4.html&quot;</span><span class="nt">&gt;</span>fourth item<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-0&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link5.html&quot;</span><span class="nt">&gt;</span>fifth item<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
     <span class="nt">&lt;/ul&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">lxml</span> <span class="k">import</span> <span class="nx">etree</span>

<span class="n">html</span> <span class="o">=</span> <span class="nx">etree.HTML</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="nx">etree.tostring</span><span class="p">(</span><span class="nx">html</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="bp">.</span><span class="nx">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nx">print</span><span class="p">(</span><span class="nb">result</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">&lt;!--</span> <span class="nx">hello.html</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nb">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-0&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link1.html&quot;</span><span class="o">&gt;</span><span class="nb">first</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-1&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link2.html&quot;</span><span class="o">&gt;</span><span class="nb">second</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-inactive&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link3.html&quot;</span><span class="o">&gt;&lt;</span><span class="nx">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="o">&gt;</span><span class="nx">third</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">span</span><span class="o">&gt;&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-1&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link4.html&quot;</span><span class="o">&gt;</span><span class="nx">fourth</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-0&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link5.html&quot;</span><span class="o">&gt;</span><span class="nx">fifth</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
     <span class="o">&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span>
 <span class="o">&lt;/</span><span class="nb">div</span><span class="o">&gt;</span>
</pre></div>


<h3 id="_2">标签不正常返回正常</h3>
<p>创建HTML解析器解析</p>
<div class="hlcode"><pre><span class="c">&lt;!-- hello.html --&gt;</span>
<span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-0&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link1.html&quot;</span><span class="nt">&gt;</span>first item<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
         <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;item-1&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;link2.html&quot;</span><span class="nt">&gt;</span>second item<span class="nt">&lt;/a&gt;</span>
     <span class="nt">&lt;/ul&gt;</span>
 <span class="nt">&lt;/div&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">lxml</span> <span class="k">import</span> <span class="nx">etree</span>

<span class="n">parser</span> <span class="o">=</span> <span class="nx">etree.HTMLParser</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="n">htmlElement</span> <span class="o">=</span> <span class="nx">etree.parse</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="nx">parser</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="nx">etree.tostring</span><span class="p">(</span><span class="nx">htmlElement</span><span class="p">,</span> <span class="n">pretty_print</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="bp">.</span><span class="nx">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="nx">print</span><span class="p">(</span><span class="nb">result</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">&lt;!</span><span class="nb">DOCTYPE</span> <span class="nx">html</span> <span class="k">PUBLIC</span> <span class="s2">&quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;</span> <span class="s2">&quot;http://www.w3.org/TR/REC-html40/loose.dtd&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;!--</span> <span class="nx">hello.html</span> <span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nb">body</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nb">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">ul</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-0&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link1.html&quot;</span><span class="o">&gt;</span><span class="nb">first</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">li</span><span class="o">&gt;</span>
         <span class="o">&lt;</span><span class="nx">li</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;item-1&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;link2.html&quot;</span><span class="o">&gt;</span><span class="nb">second</span> <span class="nb">item</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span>
     <span class="o">&lt;/</span><span class="nx">li</span><span class="o">&gt;&lt;/</span><span class="nx">ul</span><span class="o">&gt;</span>
 <span class="o">&lt;/</span><span class="nb">div</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="nb">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="nx">html</span><span class="o">&gt;</span>
</pre></div>


<h2 id="example">Example</h2>
<h3 id="douban">douban 电影</h3>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>
<span class="n">from</span> <span class="n">lxml</span> <span class="n">import</span> <span class="n">etree</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">User</span><span class="o">-</span><span class="n">Agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.92</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">Referer</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//movie.douban.com/&#39;</span>
<span class="p">}</span>

<span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//movie.douban.com/cinema/nowplaying/beijing/&#39;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>

<span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<span class="n">ul</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//ul[@class=&#39;lists&#39;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="cp"># print(etree.tostring(ul, encoding=&#39;utf-8&#39;).decode(&#39;utf-8&#39;)) # 所有正在上映电影的信息</span>

<span class="n">movies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lis</span> <span class="o">=</span> <span class="n">ul</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;./li&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">li</span> <span class="n">in</span> <span class="n">lis</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">print</span><span class="p">(</span><span class="n">etree</span><span class="p">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">).</span><span class="n">decode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-title&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-score&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-duration&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-region&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">director</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-director&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">actors</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;@data-actors&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">li</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//img/@src&quot;</span><span class="p">)</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;title&quot;</span><span class="o">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s">&quot;score&quot;</span><span class="o">:</span> <span class="n">score</span><span class="p">,</span>
        <span class="s">&quot;duration&quot;</span><span class="o">:</span> <span class="n">duration</span><span class="p">,</span>
        <span class="s">&quot;region&quot;</span><span class="o">:</span> <span class="n">region</span><span class="p">,</span>
        <span class="s">&quot;director&quot;</span><span class="o">:</span> <span class="n">director</span><span class="p">,</span>
        <span class="s">&quot;actors&quot;</span><span class="o">:</span> <span class="n">actors</span><span class="p">,</span>
        <span class="s">&quot;thumbnail&quot;</span><span class="o">:</span> <span class="n">thumbnail</span>
    <span class="p">}</span>
    <span class="n">movies</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>

<span class="n">print</span><span class="p">(</span><span class="n">movies</span><span class="p">)</span>
</pre></div>


<h3 id="dytt8net">dytt8.net</h3>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">lxml</span> <span class="n">import</span> <span class="n">etree</span>
<span class="n">import</span> <span class="n">requests</span>


<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;user-agent&quot;</span><span class="o">:</span> <span class="s">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Iridium/2017.11 Safari/537.36 Chrome/62.0.3202.94&quot;</span>
<span class="p">}</span>

<span class="n">BASE_DOMAIN</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//dytt8.net&#39;</span>


<span class="n">def</span> <span class="n">get_detail_urls</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
    <span class="err">#</span> <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">gbk</span><span class="err">&#39;</span><span class="p">))</span>  <span class="err">#</span> <span class="n">page</span> <span class="n">source</span> <span class="err">查看编码为</span><span class="n">gbk2312</span><span class="p">,</span> <span class="err">第三页有问题，无法解码</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">detail_urls</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//table[@class=&#39;tbspan&#39;]//a/@href&quot;</span><span class="p">)</span>
    <span class="n">detail_urls</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">url</span><span class="o">:</span><span class="n">BASE_DOMAIN</span><span class="o">+</span><span class="n">url</span><span class="p">,</span> <span class="n">detail_urls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">detail_urls</span>


<span class="n">def</span> <span class="n">parse_detail_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">movie</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">content</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">gbk</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;title_all&#39;]//font[@color=&#39;#07519a&#39;]/text()&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">title</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>

    <span class="n">zoomElement</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@id=&#39;Zoom&#39;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">zoomElement</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//img/@src&quot;</span><span class="p">)</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">screenshot</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">cover</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cover</span>
    <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">screenshot</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">screenshot</span>

    <span class="n">def</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">info</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">infos</span> <span class="o">=</span> <span class="n">zoomElement</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//text()&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">info</span> <span class="n">in</span> <span class="n">enumerate</span><span class="p">(</span><span class="n">infos</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎年</span>　　<span class="err">代&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;◎年　　代&quot;</span><span class="p">)</span>
            <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">year</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">elif</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎产</span>　　<span class="err">地&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;◎产　　地&quot;</span><span class="p">)</span>
            <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">country</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">elif</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎豆瓣评分&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;◎豆瓣评分&quot;</span><span class="p">)</span>
            <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">douban_rating</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">elif</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎导</span>　　<span class="err">演&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;◎导　　演&quot;</span><span class="p">)</span>
            <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">director</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
        <span class="n">elif</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎主</span>　　<span class="err">演&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s">&quot;◎主　　演&quot;</span><span class="p">)</span>
            <span class="n">actors</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">infos</span><span class="p">))</span><span class="o">:</span>
                <span class="n">actor</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">actor</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="sc">&#39;◎&#39;</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">break</span>
                <span class="n">actors</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">actor</span><span class="p">)</span>
            <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">actors</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actors</span>
        <span class="n">elif</span> <span class="n">info</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="err">&#39;◎简</span>　　<span class="err">介&#39;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">parse_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="err">&#39;◎简</span>　　<span class="err">介&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">infos</span><span class="p">))</span><span class="o">:</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">infos</span><span class="p">[</span><span class="n">x</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">profile</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span>

    <span class="n">download_url</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//td[@bgcolor=&#39;#fdfddf&#39;]/a/@href&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">movie</span><span class="p">[</span><span class="err">&#39;</span><span class="n">download_url</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">download_url</span>
    <span class="k">return</span> <span class="n">movie</span>


<span class="n">def</span> <span class="n">spider</span><span class="p">()</span><span class="o">:</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//dytt8.net/html/gndy/dyzz/list_23_{}.html&#39;</span>
    <span class="n">movies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">detail_urls</span> <span class="o">=</span> <span class="n">get_detail_urls</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">detail_url</span> <span class="n">in</span> <span class="n">detail_urls</span><span class="o">:</span>
            <span class="n">movie</span> <span class="o">=</span> <span class="n">parse_detail_page</span><span class="p">(</span><span class="n">detail_url</span><span class="p">)</span>
            <span class="n">movies</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">movie</span><span class="p">)</span>
            <span class="n">print</span><span class="p">(</span><span class="n">movies</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">spider</span><span class="p">()</span>
</pre></div>


<h3 id="doutulacom">doutula.com (多线程处理)</h3>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>
<span class="n">from</span> <span class="n">lxml</span> <span class="n">import</span> <span class="n">etree</span>
<span class="n">from</span> <span class="n">urllib</span> <span class="n">import</span> <span class="n">request</span>
<span class="n">import</span> <span class="n">os</span>
<span class="n">import</span> <span class="n">re</span>
<span class="n">from</span> <span class="n">queue</span> <span class="n">import</span> <span class="n">Queue</span>
<span class="n">import</span> <span class="n">threading</span>


<span class="n">class</span> <span class="n">Producer</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Iridium</span><span class="o">/</span><span class="mf">2017.11</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">62.0.3202.94</span><span class="err">&#39;</span>
    <span class="p">}</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">page_queue</span><span class="p">,</span> <span class="n">img_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="n">super</span><span class="p">(</span><span class="n">Producer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">page_queue</span> <span class="o">=</span> <span class="n">page_queue</span>
        <span class="n">self</span><span class="p">.</span><span class="n">img_queue</span> <span class="o">=</span> <span class="n">img_queue</span>

    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">page_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="o">:</span>
                <span class="k">break</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">page_queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">parse_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_page</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span><span class="o">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;page-content text-center&#39;]//img[@class!=&#39;gif&#39;]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">img</span> <span class="n">in</span> <span class="n">imgs</span><span class="o">:</span>
            <span class="n">img_url</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">data</span><span class="o">-</span><span class="n">original</span><span class="err">&#39;</span><span class="p">)</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">alt</span><span class="err">&#39;</span><span class="p">)</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="p">[</span><span class="err">\</span><span class="o">?</span><span class="err">？\</span><span class="p">.</span><span class="err">。</span><span class="p">,</span><span class="err">，</span><span class="o">!</span><span class="err">！</span><span class="o">*</span><span class="p">]</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span> <span class="err">#</span> <span class="err">替换不可能用作命名的特殊字符</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">img_url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">alt</span> <span class="o">+</span> <span class="n">suffix</span>
            <span class="n">self</span><span class="p">.</span><span class="n">img_queue</span><span class="p">.</span><span class="n">put</span><span class="p">((</span><span class="n">img_url</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>


<span class="n">class</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">page_queue</span><span class="p">,</span> <span class="n">img_queue</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="n">super</span><span class="p">(</span><span class="n">Consumer</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">page_queue</span> <span class="o">=</span> <span class="n">page_queue</span>
        <span class="n">self</span><span class="p">.</span><span class="n">img_queue</span> <span class="o">=</span> <span class="n">img_queue</span>

    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">img_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="n">and</span> <span class="n">self</span><span class="p">.</span><span class="n">page_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="o">:</span>
                <span class="k">break</span>
            <span class="n">img_url</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">img_queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">request</span><span class="p">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">img_url</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">images</span><span class="o">/</span><span class="err">&#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">print</span><span class="p">(</span><span class="n">filename</span> <span class="o">+</span> <span class="err">&#39;</span> <span class="n">has</span> <span class="n">downloaded</span><span class="p">.</span><span class="err">&#39;</span><span class="p">)</span>


<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">page_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">img_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span><span class="o">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.doutula.com/photo/list/?page=%d&#39; % i</span>
        <span class="n">page_queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Producer</span><span class="p">(</span><span class="n">page_queue</span><span class="p">,</span> <span class="n">img_queue</span><span class="p">)</span>
        <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">page_queue</span><span class="p">,</span> <span class="n">img_queue</span><span class="p">)</span>
        <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<h3 id="lagoucom-deprecated">lagou.com (Deprecated)</h3>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">requests</span>
<span class="n">from</span> <span class="n">lxml</span> <span class="n">import</span> <span class="n">etree</span>
<span class="n">import</span> <span class="n">time</span>
<span class="n">import</span> <span class="n">re</span>


<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;Referer&quot;</span><span class="o">:</span> <span class="s">&quot;https://www.lagou.com/jobs/list_python?labelWords=&amp;fromSearch=true&amp;suginput=&quot;</span><span class="p">,</span>
    <span class="s">&quot;User-Agent&quot;</span><span class="o">:</span> <span class="s">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Iridium/2017.11 Safari/537.36 Chrome/62.0.3202.94&quot;</span>
<span class="p">}</span>


<span class="n">def</span> <span class="n">request_list_page</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.lagou.com/jobs/positionAjax.json?city=%E5%8C%97%E4%BA%AC&amp;needAddtionalResult=false&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;first&quot;</span><span class="o">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
        <span class="s">&quot;pn&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&quot;kd&quot;</span><span class="o">:</span> <span class="s">&quot;python&quot;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">:</span>
        <span class="n">data</span><span class="p">[</span><span class="err">&#39;</span><span class="n">pn</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="err">&#39;</span><span class="n">content</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">positionResult</span><span class="err">&#39;</span><span class="p">][</span><span class="err">&#39;</span><span class="n">result</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">position</span> <span class="n">in</span> <span class="n">positions</span><span class="o">:</span>
            <span class="n">positionId</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="err">&#39;</span><span class="n">positionId</span><span class="err">&#39;</span><span class="p">]</span>
            <span class="n">position_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.lagou.com/jobs/%s.html&#39; % positionId</span>
            <span class="n">parse_position_detail</span><span class="p">(</span><span class="n">position_url</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">break</span>


<span class="n">def</span> <span class="n">parse_position_detail</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">etree</span><span class="p">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">position_name</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//span[@class=&#39;name&#39;]/text()&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">job_request_spans</span> <span class="o">=</span> <span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//dd[@class=&#39;job_request&#39;]//span&quot;</span><span class="p">)</span>
    <span class="n">salary</span> <span class="o">=</span> <span class="n">job_request_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xpath</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="c1">//text()&#39;)[0].strip()</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">job_request_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">xpath</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">text</span><span class="p">()</span><span class="err">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="p">[</span><span class="err">\</span><span class="n">s</span><span class="o">/</span><span class="p">]</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span> <span class="err">#</span> <span class="err">替换斜杠</span>
    <span class="n">work_years</span> <span class="o">=</span> <span class="n">job_request_spans</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">xpath</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="c1">//text()&#39;)[0].strip()</span>
    <span class="n">work_years</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="p">[</span><span class="err">\</span><span class="n">s</span><span class="o">/</span><span class="p">]</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="n">work_years</span><span class="p">)</span>
    <span class="n">education</span> <span class="o">=</span> <span class="n">job_request_spans</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">xpath</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="c1">//text()&#39;)[0].strip()</span>
    <span class="n">education</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">r</span><span class="err">&#39;</span><span class="p">[</span><span class="err">\</span><span class="n">s</span><span class="o">/</span><span class="p">]</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="n">education</span><span class="p">)</span>

    <span class="n">job_desc</span> <span class="o">=</span> <span class="err">&#39;&#39;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">html</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//dd[@class=&#39;job_bt&#39;]//text()&quot;</span><span class="p">)).</span><span class="n">strip</span><span class="p">()</span>


<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">request_list_page</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-02-21 11:54:09</p>
      </span>
    </div>

    
    
  </body>
</html>