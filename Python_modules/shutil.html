<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>shutil - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;shutil
    <span class="updated">Page Updated&nbsp;
      2018-08-26 17:57
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">shutil</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#shutil">shutil</a><ul>
<li><a href="#copyfileobj">copyfileobj</a></li>
<li><a href="#copyfile">copyfile</a></li>
<li><a href="#copymode">copymode</a></li>
<li><a href="#copystat">copystat</a></li>
<li><a href="#copy">copy</a></li>
<li><a href="#copy2">copy2</a></li>
<li><a href="#ignore_patterns42patterns">ignore_patterns(*patterns)</a></li>
<li><a href="#copytree">copytree</a></li>
<li><a href="#rmtree">rmtree 递归删除（慎用）</a></li>
<li><a href="#move">move 递归移动</a></li>
<li><a href="#make_archivebase_name-format">make_archive(base_name, format,...)</a><ul>
<li><a href="#zipfile">ZipFile</a></li>
<li><a href="#tarfile">tarfile</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="shutil">shutil</h1>
<p>高级的 文件、文件夹、压缩包 处理模块</p>
<h2 id="copyfileobj">copyfileobj</h2>
<div class="hlcode"><pre><span class="n">copyfileobj</span><span class="p">(</span><span class="n">fsrc</span><span class="p">,</span> <span class="n">fdst</span><span class="p">[,</span> <span class="n">length</span><span class="p">])</span>
</pre></div>


<blockquote>
<p>fdst 要求可写</p>
<p>length 表示buffer大小</p>
</blockquote>
<p>将文件内容拷贝到另一个文件中，可以部分内容</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copyfileobj</span><span class="p">(</span><span class="n">fsrc</span><span class="p">,</span> <span class="n">fdst</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;copy data from file-like object fsrc to file-like object fdst&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="mi">1</span><span class="o">:</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">fsrc</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">buf</span><span class="o">:</span>
            <span class="k">break</span>
        <span class="n">fdst</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</pre></div>


<h2 id="copyfile">copyfile</h2>
<div class="hlcode"><pre><span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>src, dst为文件的路径字符串</p>
</blockquote>
<p>复制文件内容，不含元数据</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Copy data from src to dst&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_samefile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
        <span class="n">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s">&quot;`%s` and `%s` are the same file&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">fn</span> <span class="n">in</span> <span class="p">[</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">]</span><span class="o">:</span>
        <span class="nl">try:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">except</span> <span class="n">OSError</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">File</span> <span class="n">most</span> <span class="n">likely</span> <span class="n">does</span> <span class="n">not</span> <span class="n">exist</span>
            <span class="n">pass</span>
        <span class="nl">else:</span>
            <span class="err">#</span> <span class="n">XXX</span> <span class="n">What</span> <span class="n">about</span> <span class="n">other</span> <span class="n">special</span> <span class="n">files</span><span class="o">?</span> <span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">devices</span><span class="p">...)</span>
            <span class="k">if</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_ISFIFO</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">SpecialFileError</span><span class="p">(</span><span class="s">&quot;`%s` is a named pipe&quot;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

    <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">rb</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">fsrc</span><span class="o">:</span>
        <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">fdst</span><span class="o">:</span>
            <span class="n">copyfileobj</span><span class="p">(</span><span class="n">fsrc</span><span class="p">,</span> <span class="n">fdst</span><span class="p">)</span>
</pre></div>


<h2 id="copymode">copymode</h2>
<div class="hlcode"><pre><span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>仅拷贝权限。内容、组、用户均不变</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Copy mode bits from src to dst&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">chmod</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span>
        <span class="n">os</span><span class="p">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</pre></div>


<h2 id="copystat">copystat</h2>
<div class="hlcode"><pre><span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>拷贝状态的信息，包括：mode bits, atime, mtime, flags</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Copy all stat info (mode bits, atime, mtime, flags) from src to dst&quot;&quot;&quot;</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">utime</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">utime</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_atime</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">chmod</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">chflags</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">and</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">st_flags</span><span class="err">&#39;</span><span class="p">)</span><span class="o">:</span>
        <span class="nl">try:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">chflags</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_flags</span><span class="p">)</span>
        <span class="n">except</span> <span class="n">OSError</span><span class="p">,</span> <span class="n">why</span><span class="o">:</span>
            <span class="k">for</span> <span class="n">err</span> <span class="n">in</span> <span class="err">&#39;</span><span class="n">EOPNOTSUPP</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">ENOTSUP</span><span class="err">&#39;</span><span class="o">:</span>
                <span class="k">if</span> <span class="n">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="n">and</span> <span class="n">why</span><span class="p">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span><span class="o">:</span>
                    <span class="k">break</span>
            <span class="nl">else:</span>
                <span class="n">raise</span>
</pre></div>


<h2 id="copy">copy</h2>
<div class="hlcode"><pre><span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>复制文件内容，权限和部分元数据，不包括创建时间和修改时间</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Copy data and mode bits (&quot;</span><span class="n">cp</span> <span class="n">src</span> <span class="n">dst</span><span class="s">&quot;).</span>

    <span class="n">The</span> <span class="n">destination</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">directory</span><span class="p">.</span>

    <span class="s">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
    <span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">copymode</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
</pre></div>


<h2 id="copy2">copy2</h2>
<div class="hlcode"><pre><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">follow_symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>比copy多了复制全部元数据，但需要平台支持</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Copy data and all stat info (&quot;</span><span class="n">cp</span> <span class="o">-</span><span class="n">p</span> <span class="n">src</span> <span class="n">dst</span><span class="s">&quot;).</span>

    <span class="n">The</span> <span class="n">destination</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">directory</span><span class="p">.</span>

    <span class="s">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
    <span class="n">copyfile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
</pre></div>


<h2 id="ignore_patterns42patterns">ignore_patterns(*patterns)</h2>
<h2 id="copytree">copytree</h2>
<div class="hlcode"><pre><span class="nx">copytree</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span><span class="nx">symlinks</span><span class="o">=</span><span class="nx">False</span><span class="p">,</span> <span class="nx">ignore</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">copy_function</span><span class="o">=</span><span class="nx">copy2</span><span class="p">,</span> <span class="nx">ignore_dangling_symlinks</span><span class="o">=</span><span class="nx">False</span><span class="p">)</span>
</pre></div>


<p>递归复制目录，默认使用copy2，也就是带更多的元数据复制</p>
<p>copytree(source, destination, ignore=ignore_patterns('<em>.pyc', 'tmp</em>'))</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">ignore_patterns</span><span class="p">(</span><span class="o">*</span><span class="n">patterns</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Function that can be used as copytree() ignore parameter.</span>

    <span class="n">Patterns</span> <span class="n">is</span> <span class="n">a</span> <span class="n">sequence</span> <span class="n">of</span> <span class="n">glob</span><span class="o">-</span><span class="n">style</span> <span class="n">patterns</span>
    <span class="n">that</span> <span class="n">are</span> <span class="n">used</span> <span class="n">to</span> <span class="n">exclude</span> <span class="n">files</span><span class="s">&quot;&quot;&quot;</span>
    <span class="n">def</span> <span class="n">_ignore_patterns</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span><span class="o">:</span>
        <span class="n">ignored_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="n">in</span> <span class="n">patterns</span><span class="o">:</span>
            <span class="n">ignored_names</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">set</span><span class="p">(</span><span class="n">ignored_names</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_ignore_patterns</span>

<span class="n">def</span> <span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="n">False</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Recursively copy a directory tree using copy2().</span>

    <span class="n">The</span> <span class="n">destination</span> <span class="n">directory</span> <span class="n">must</span> <span class="n">not</span> <span class="n">already</span> <span class="n">exist</span><span class="p">.</span>
    <span class="n">If</span> <span class="n">exception</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">occur</span><span class="p">,</span> <span class="n">an</span> <span class="n">Error</span> <span class="n">is</span> <span class="n">raised</span> <span class="n">with</span> <span class="n">a</span> <span class="n">list</span> <span class="n">of</span> <span class="n">reasons</span><span class="p">.</span>

    <span class="n">If</span> <span class="n">the</span> <span class="n">optional</span> <span class="n">symlinks</span> <span class="n">flag</span> <span class="n">is</span> <span class="nb">true</span><span class="p">,</span> <span class="n">symbolic</span> <span class="n">links</span> <span class="n">in</span> <span class="n">the</span>
    <span class="n">source</span> <span class="n">tree</span> <span class="n">result</span> <span class="n">in</span> <span class="n">symbolic</span> <span class="n">links</span> <span class="n">in</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">tree</span><span class="p">;</span> <span class="k">if</span>
    <span class="n">it</span> <span class="n">is</span> <span class="nb">false</span><span class="p">,</span> <span class="n">the</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">the</span> <span class="n">files</span> <span class="n">pointed</span> <span class="n">to</span> <span class="n">by</span> <span class="n">symbolic</span>
    <span class="n">links</span> <span class="n">are</span> <span class="n">copied</span><span class="p">.</span>

    <span class="n">The</span> <span class="n">optional</span> <span class="n">ignore</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">a</span> <span class="n">callable</span><span class="p">.</span> <span class="n">If</span> <span class="n">given</span><span class="p">,</span> <span class="n">it</span>
    <span class="n">is</span> <span class="n">called</span> <span class="n">with</span> <span class="n">the</span> <span class="err">`</span><span class="n">src</span><span class="err">`</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">which</span> <span class="n">is</span> <span class="n">the</span> <span class="n">directory</span>
    <span class="n">being</span> <span class="n">visited</span> <span class="n">by</span> <span class="n">copytree</span><span class="p">(),</span> <span class="n">and</span> <span class="err">`</span><span class="n">names</span><span class="err">`</span> <span class="n">which</span> <span class="n">is</span> <span class="n">the</span> <span class="n">list</span> <span class="n">of</span>
    <span class="err">`</span><span class="n">src</span><span class="err">`</span> <span class="n">contents</span><span class="p">,</span> <span class="n">as</span> <span class="n">returned</span> <span class="n">by</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">()</span><span class="o">:</span>

        <span class="n">callable</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ignored_names</span>

    <span class="n">Since</span> <span class="n">copytree</span><span class="p">()</span> <span class="n">is</span> <span class="n">called</span> <span class="n">recursively</span><span class="p">,</span> <span class="n">the</span> <span class="n">callable</span> <span class="n">will</span> <span class="n">be</span>
    <span class="n">called</span> <span class="n">once</span> <span class="k">for</span> <span class="n">each</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">is</span> <span class="n">copied</span><span class="p">.</span> <span class="n">It</span> <span class="n">returns</span> <span class="n">a</span>
    <span class="n">list</span> <span class="n">of</span> <span class="n">names</span> <span class="n">relative</span> <span class="n">to</span> <span class="n">the</span> <span class="err">`</span><span class="n">src</span><span class="err">`</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">should</span>
    <span class="n">not</span> <span class="n">be</span> <span class="n">copied</span><span class="p">.</span>

    <span class="n">XXX</span> <span class="n">Consider</span> <span class="n">this</span> <span class="n">example</span> <span class="n">code</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">the</span> <span class="n">ultimate</span> <span class="n">tool</span><span class="p">.</span>

    <span class="s">&quot;&quot;&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ignore</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
        <span class="n">ignored_names</span> <span class="o">=</span> <span class="n">ignore</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
    <span class="nl">else:</span>
        <span class="n">ignored_names</span> <span class="o">=</span> <span class="n">set</span><span class="p">()</span>

    <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="n">names</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="n">in</span> <span class="n">ignored_names</span><span class="o">:</span>
            <span class="k">continue</span>
        <span class="n">srcname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">dstname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nl">try:</span>
            <span class="k">if</span> <span class="n">symlinks</span> <span class="n">and</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">islink</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span><span class="o">:</span>
                <span class="n">linkto</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">linkto</span><span class="p">,</span> <span class="n">dstname</span><span class="p">)</span>
            <span class="n">elif</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">srcname</span><span class="p">)</span><span class="o">:</span>
                <span class="n">copytree</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">,</span> <span class="n">symlinks</span><span class="p">,</span> <span class="n">ignore</span><span class="p">)</span>
            <span class="nl">else:</span>
                <span class="err">#</span> <span class="n">Will</span> <span class="n">raise</span> <span class="n">a</span> <span class="n">SpecialFileError</span> <span class="k">for</span> <span class="n">unsupported</span> <span class="n">file</span> <span class="n">types</span>
                <span class="n">copy2</span><span class="p">(</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">)</span>
        <span class="err">#</span> <span class="n">catch</span> <span class="n">the</span> <span class="n">Error</span> <span class="n">from</span> <span class="n">the</span> <span class="n">recursive</span> <span class="n">copytree</span> <span class="n">so</span> <span class="n">that</span> <span class="n">we</span> <span class="n">can</span>
        <span class="err">#</span> <span class="k">continue</span> <span class="n">with</span> <span class="n">other</span> <span class="n">files</span>
        <span class="n">except</span> <span class="n">Error</span><span class="p">,</span> <span class="n">err</span><span class="o">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">err</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">except</span> <span class="n">EnvironmentError</span><span class="p">,</span> <span class="n">why</span><span class="o">:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">srcname</span><span class="p">,</span> <span class="n">dstname</span><span class="p">,</span> <span class="n">str</span><span class="p">(</span><span class="n">why</span><span class="p">)))</span>
    <span class="nl">try:</span>
        <span class="n">copystat</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="n">except</span> <span class="n">OSError</span><span class="p">,</span> <span class="n">why</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">WindowsError</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span> <span class="n">and</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">why</span><span class="p">,</span> <span class="n">WindowsError</span><span class="p">)</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">Copying</span> <span class="n">file</span> <span class="n">access</span> <span class="n">times</span> <span class="n">may</span> <span class="n">fail</span> <span class="n">on</span> <span class="n">Windows</span>
            <span class="n">pass</span>
        <span class="nl">else:</span>
            <span class="n">errors</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">str</span><span class="p">(</span><span class="n">why</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">errors</span><span class="o">:</span>
        <span class="n">raise</span> <span class="n">Error</span><span class="p">,</span> <span class="n">errors</span>
</pre></div>


<h2 id="rmtree">rmtree 递归删除（慎用）</h2>
<div class="hlcode"><pre><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="n">False</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="n">None</span><span class="p">)</span>
</pre></div>


<p>递归删除，类似于<code>rm -rf</code> ， 因为不是原子操作，有可能删除错误</p>
<div class="hlcode"><pre><span class="nx">def</span> <span class="nx">rmtree</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">ignore_errors</span><span class="o">=</span><span class="nx">False</span><span class="p">,</span> <span class="nx">onerror</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;Recursively delete a directory tree.</span>

<span class="s2">    If ignore_errors is set, errors are ignored; otherwise, if onerror</span>
<span class="s2">    is set, it is called to handle the error with arguments (func,</span>
<span class="s2">    path, exc_info) where func is os.listdir, os.remove, or os.rmdir;</span>
<span class="s2">    path is the argument to that function that caused it to fail; and</span>
<span class="s2">    exc_info is a tuple returned by sys.exc_info().  If ignore_errors</span>
<span class="s2">    is false and onerror is None, an exception is raised.</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nx">ignore_errors</span><span class="o">:</span>
        <span class="nx">def</span> <span class="nx">onerror</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">pass</span>
    <span class="nx">elif</span> <span class="nx">onerror</span> <span class="nx">is</span> <span class="nx">None</span><span class="o">:</span>
        <span class="nx">def</span> <span class="nx">onerror</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span>
    <span class="k">try</span><span class="o">:</span>
        <span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">islink</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">symlinks</span> <span class="nx">to</span> <span class="nx">directories</span> <span class="nx">are</span> <span class="nx">forbidden</span><span class="p">,</span> <span class="nx">see</span> <span class="nx">bug</span> <span class="err">#</span><span class="mi">1669</span>
            <span class="nx">raise</span> <span class="nx">OSError</span><span class="p">(</span><span class="s2">&quot;Cannot call rmtree on a symbolic link&quot;</span><span class="p">)</span>
    <span class="nx">except</span> <span class="nx">OSError</span><span class="o">:</span>
        <span class="nx">onerror</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">islink</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">exc_info</span><span class="p">())</span>
        <span class="err">#</span> <span class="nx">can</span><span class="err">&#39;</span><span class="nx">t</span> <span class="k">continue</span> <span class="nx">even</span> <span class="k">if</span> <span class="nx">onerror</span> <span class="nx">hook</span> <span class="nx">returns</span>
        <span class="k">return</span>
    <span class="nx">names</span> <span class="o">=</span> <span class="cp">[]</span>
    <span class="k">try</span><span class="o">:</span>
        <span class="nx">names</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">listdir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">except</span> <span class="nx">os</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">err</span><span class="o">:</span>
        <span class="nx">onerror</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">listdir</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">exc_info</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span><span class="o">:</span>
        <span class="nx">fullname</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
        <span class="k">try</span><span class="o">:</span>
            <span class="nx">mode</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">lstat</span><span class="p">(</span><span class="nx">fullname</span><span class="p">).</span><span class="nx">st_mode</span>
        <span class="nx">except</span> <span class="nx">os</span><span class="p">.</span><span class="nx">error</span><span class="o">:</span>
            <span class="nx">mode</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">S_ISDIR</span><span class="p">(</span><span class="nx">mode</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">rmtree</span><span class="p">(</span><span class="nx">fullname</span><span class="p">,</span> <span class="nx">ignore_errors</span><span class="p">,</span> <span class="nx">onerror</span><span class="p">)</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="k">try</span><span class="o">:</span>
                <span class="nx">os</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">fullname</span><span class="p">)</span>
            <span class="nx">except</span> <span class="nx">os</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span> <span class="nx">err</span><span class="o">:</span>
                <span class="nx">onerror</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">remove</span><span class="p">,</span> <span class="nx">fullname</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">exc_info</span><span class="p">())</span>
    <span class="k">try</span><span class="o">:</span>
        <span class="nx">os</span><span class="p">.</span><span class="nx">rmdir</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="nx">except</span> <span class="nx">os</span><span class="p">.</span><span class="nx">error</span><span class="o">:</span>
        <span class="nx">onerror</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">rmdir</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">exc_info</span><span class="p">())</span>
</pre></div>


<h2 id="move">move 递归移动</h2>
<div class="hlcode"><pre><span class="nx">move</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">copy_function</span><span class="o">=</span><span class="nx">copy2</span><span class="p">)</span>
</pre></div>


<p>递归移动文件， 目录到目标，并返回目标</p>
<div class="hlcode"><pre><span class="n">def</span> <span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Recursively move a file or directory to another location. This is</span>
    <span class="n">similar</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Unix</span> <span class="s">&quot;mv&quot;</span> <span class="n">command</span><span class="p">.</span>

    <span class="n">If</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">is</span> <span class="n">a</span> <span class="n">directory</span> <span class="n">or</span> <span class="n">a</span> <span class="n">symlink</span> <span class="n">to</span> <span class="n">a</span> <span class="n">directory</span><span class="p">,</span> <span class="n">the</span> <span class="n">source</span>
    <span class="n">is</span> <span class="n">moved</span> <span class="n">inside</span> <span class="n">the</span> <span class="n">directory</span><span class="p">.</span> <span class="n">The</span> <span class="n">destination</span> <span class="n">path</span> <span class="n">must</span> <span class="n">not</span> <span class="n">already</span>
    <span class="n">exist</span><span class="p">.</span>

    <span class="n">If</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">already</span> <span class="n">exists</span> <span class="n">but</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">directory</span><span class="p">,</span> <span class="n">it</span> <span class="n">may</span> <span class="n">be</span>
    <span class="n">overwritten</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">()</span> <span class="n">semantics</span><span class="p">.</span>

    <span class="n">If</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">is</span> <span class="n">on</span> <span class="n">our</span> <span class="n">current</span> <span class="n">filesystem</span><span class="p">,</span> <span class="n">then</span> <span class="n">rename</span><span class="p">()</span> <span class="n">is</span> <span class="n">used</span><span class="p">.</span>
    <span class="n">Otherwise</span><span class="p">,</span> <span class="n">src</span> <span class="n">is</span> <span class="n">copied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">and</span> <span class="n">then</span> <span class="n">removed</span><span class="p">.</span>
    <span class="n">A</span> <span class="n">lot</span> <span class="n">more</span> <span class="n">could</span> <span class="n">be</span> <span class="n">done</span> <span class="n">here</span><span class="p">...</span>  <span class="n">A</span> <span class="n">look</span> <span class="n">at</span> <span class="n">a</span> <span class="n">mv</span><span class="p">.</span><span class="n">c</span> <span class="n">shows</span> <span class="n">a</span> <span class="n">lot</span> <span class="n">of</span>
    <span class="n">the</span> <span class="n">issues</span> <span class="n">this</span> <span class="n">implementation</span> <span class="n">glosses</span> <span class="n">over</span><span class="p">.</span>

    <span class="s">&quot;&quot;&quot;</span>
    <span class="n">real_dst</span> <span class="o">=</span> <span class="n">dst</span>
    <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">_samefile</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">We</span> <span class="n">might</span> <span class="n">be</span> <span class="n">on</span> <span class="n">a</span> <span class="k">case</span> <span class="n">insensitive</span> <span class="n">filesystem</span><span class="p">,</span>
            <span class="err">#</span> <span class="n">perform</span> <span class="n">the</span> <span class="n">rename</span> <span class="n">anyway</span><span class="p">.</span>
            <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">real_dst</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">_basename</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_dst</span><span class="p">)</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">Error</span><span class="p">,</span> <span class="s">&quot;Destination path &#39;%s&#39; already exists&quot;</span> <span class="o">%</span> <span class="n">real_dst</span>
    <span class="nl">try:</span>
        <span class="n">os</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">real_dst</span><span class="p">)</span>
    <span class="n">except</span> <span class="n">OSError</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">_destinsrc</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">Error</span><span class="p">,</span> <span class="s">&quot;Cannot move a directory &#39;%s&#39; into itself &#39;%s&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">real_dst</span><span class="p">,</span> <span class="n">symlinks</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
            <span class="n">rmtree</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="nl">else:</span>
            <span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">real_dst</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>          
</pre></div>


<h2 id="make_archivebase_name-format">make_archive(base_name, format,...)</h2>
<p>创建压缩包并返回文件路径，例如：zip、tar</p>
<ul>
<li>base_name： 压缩包的文件名，也可以是压缩包的路径。只是文件名时，则保存至当前目录，否则保存至指定路径，<br />
  如：www                        =&gt;保存至当前路径<br />
  如：/Users/wupeiqi/www =&gt;保存至/Users/wupeiqi/</li>
<li>format：   压缩包种类，“zip”, “tar”, “bztar”，“gztar”</li>
<li>root_dir： 要压缩的文件夹路径（默认当前目录）</li>
<li>owner：    用户，默认当前用户</li>
<li>group：    组，默认当前组</li>
<li>logger：   用于记录日志，通常是logging.Logger对象</li>
</ul>
<div class="hlcode"><pre><span class="err">`#将</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">test</span> <span class="err">下的文件打包放置当前程序目录`</span> <span class="err">`</span><span class="n">import</span><span class="err">`</span> <span class="err">`</span><span class="n">shutil</span><span class="err">``</span><span class="n">ret</span> <span class="err">``</span><span class="o">=</span><span class="err">`</span> <span class="err">`</span><span class="n">shutil</span><span class="p">.</span><span class="n">make_archive</span><span class="p">(</span><span class="err">``</span><span class="s">&quot;wwwwwwwwww&quot;</span><span class="err">``</span><span class="p">,</span> <span class="err">``&#39;</span><span class="n">gztar</span><span class="err">&#39;``</span><span class="p">,</span> <span class="n">root_dir</span><span class="err">``</span><span class="o">=</span><span class="err">``&#39;</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">test</span><span class="err">&#39;``</span><span class="p">)</span><span class="err">`</span>  <span class="err">`#将</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">test</span> <span class="err">下的文件打包放置</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="err">目录``</span><span class="n">import</span><span class="err">`</span> <span class="err">`</span><span class="n">shutil</span><span class="err">``</span><span class="n">ret</span> <span class="err">``</span><span class="o">=</span><span class="err">`</span> <span class="err">`</span><span class="n">shutil</span><span class="p">.</span><span class="n">make_archive</span><span class="p">(</span><span class="err">``</span><span class="s">&quot;/Users/wupeiqi/wwwwwwwwww&quot;</span><span class="err">``</span><span class="p">,</span> <span class="err">``&#39;</span><span class="n">gztar</span><span class="err">&#39;``</span><span class="p">,</span> <span class="n">root_dir</span><span class="err">``</span><span class="o">=</span><span class="err">``&#39;</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">test</span><span class="err">&#39;``</span><span class="p">)</span><span class="err">`</span>
</pre></div>


<div class="hlcode"><pre><span class="n">def</span> <span class="n">make_archive</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">dry_run</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;Create an archive file (eg. zip or tar).</span>

    <span class="err">&#39;</span><span class="n">base_name</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span> <span class="n">to</span> <span class="n">create</span><span class="p">,</span> <span class="n">minus</span> <span class="n">any</span> <span class="n">format</span><span class="o">-</span><span class="n">specific</span>
    <span class="n">extension</span><span class="p">;</span> <span class="err">&#39;</span><span class="n">format</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="n">archive</span> <span class="n">format</span><span class="o">:</span> <span class="n">one</span> <span class="n">of</span> <span class="s">&quot;zip&quot;</span><span class="p">,</span> <span class="s">&quot;tar&quot;</span><span class="p">,</span> <span class="s">&quot;bztar&quot;</span>
    <span class="n">or</span> <span class="s">&quot;gztar&quot;</span><span class="p">.</span>

    <span class="err">&#39;</span><span class="n">root_dir</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">a</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">root</span> <span class="n">directory</span> <span class="n">of</span> <span class="n">the</span>
    <span class="n">archive</span><span class="p">;</span> <span class="n">ie</span><span class="p">.</span> <span class="n">we</span> <span class="n">typically</span> <span class="n">chdir</span> <span class="n">into</span> <span class="err">&#39;</span><span class="n">root_dir</span><span class="err">&#39;</span> <span class="n">before</span> <span class="n">creating</span> <span class="n">the</span>
    <span class="n">archive</span><span class="p">.</span>  <span class="err">&#39;</span><span class="n">base_dir</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">the</span> <span class="n">directory</span> <span class="n">where</span> <span class="n">we</span> <span class="n">start</span> <span class="n">archiving</span> <span class="n">from</span><span class="p">;</span>
    <span class="n">ie</span><span class="p">.</span> <span class="err">&#39;</span><span class="n">base_dir</span><span class="err">&#39;</span> <span class="n">will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">common</span> <span class="n">prefix</span> <span class="n">of</span> <span class="n">all</span> <span class="n">files</span> <span class="n">and</span>
    <span class="n">directories</span> <span class="n">in</span> <span class="n">the</span> <span class="n">archive</span><span class="p">.</span>  <span class="err">&#39;</span><span class="n">root_dir</span><span class="err">&#39;</span> <span class="n">and</span> <span class="err">&#39;</span><span class="n">base_dir</span><span class="err">&#39;</span> <span class="n">both</span> <span class="k">default</span>
    <span class="n">to</span> <span class="n">the</span> <span class="n">current</span> <span class="n">directory</span><span class="p">.</span>  <span class="n">Returns</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">archive</span> <span class="n">file</span><span class="p">.</span>

    <span class="err">&#39;</span><span class="n">owner</span><span class="err">&#39;</span> <span class="n">and</span> <span class="err">&#39;</span><span class="n">group</span><span class="err">&#39;</span> <span class="n">are</span> <span class="n">used</span> <span class="n">when</span> <span class="n">creating</span> <span class="n">a</span> <span class="n">tar</span> <span class="n">archive</span><span class="p">.</span> <span class="n">By</span> <span class="k">default</span><span class="p">,</span>
    <span class="n">uses</span> <span class="n">the</span> <span class="n">current</span> <span class="n">owner</span> <span class="n">and</span> <span class="n">group</span><span class="p">.</span>
    <span class="s">&quot;&quot;&quot;</span>
    <span class="n">save_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">root_dir</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;changing into &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">root_dir</span><span class="p">)</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">dry_run</span><span class="o">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">base_dir</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">curdir</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">dry_run</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">dry_run</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">logger</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">logger</span><span class="p">}</span>

    <span class="nl">try:</span>
        <span class="n">format_info</span> <span class="o">=</span> <span class="n">_ARCHIVE_FORMATS</span><span class="p">[</span><span class="n">format</span><span class="p">]</span>
    <span class="n">except</span> <span class="n">KeyError</span><span class="o">:</span>
        <span class="n">raise</span> <span class="n">ValueError</span><span class="p">,</span> <span class="s">&quot;unknown archive format &#39;%s&#39;&quot;</span> <span class="o">%</span> <span class="n">format</span>

    <span class="n">func</span> <span class="o">=</span> <span class="n">format_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="n">in</span> <span class="n">format_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">if</span> <span class="n">format</span> <span class="o">!=</span> <span class="err">&#39;</span><span class="n">zip</span><span class="err">&#39;</span><span class="o">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">owner</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">owner</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">group</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>

    <span class="nl">try:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nl">finally:</span>
        <span class="k">if</span> <span class="n">root_dir</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
                <span class="n">logger</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;changing back to &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">save_cwd</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">save_cwd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filename</span>
</pre></div>


<h3 id="zipfile">ZipFile</h3>
<p>shutil 对压缩包的处理是调用 ZipFile 和 TarFile 两个模块来进行的，详细：</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">zipfile</span>

<span class="cp"># 压缩</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="err">&#39;</span><span class="n">laxi</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">)</span>
<span class="n">z</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="err">&#39;</span><span class="n">a</span><span class="p">.</span><span class="n">log</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">z</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="err">&#39;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">z</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="cp"># 解压</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="err">&#39;</span><span class="n">laxi</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">)</span>
<span class="n">z</span><span class="p">.</span><span class="n">extractall</span><span class="p">()</span>
<span class="n">z</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<h3 id="tarfile">tarfile</h3>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">tarfile</span>

<span class="cp"># 压缩</span>
<span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">your</span><span class="p">.</span><span class="n">tar</span><span class="sc">&#39;,&#39;</span><span class="n">w</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">tar</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">PycharmProjects</span><span class="o">/</span><span class="n">bbs2</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="err">&#39;</span><span class="n">bbs2</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">tar</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wupeiqi</span><span class="o">/</span><span class="n">PycharmProjects</span><span class="o">/</span><span class="n">cmdb</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="err">&#39;</span><span class="n">cmdb</span><span class="p">.</span><span class="n">zip</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">tar</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="cp"># 解压</span>
<span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">your</span><span class="p">.</span><span class="n">tar</span><span class="sc">&#39;,&#39;</span><span class="n">r</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">tar</span><span class="p">.</span><span class="n">extractall</span><span class="p">()</span>  <span class="err">#</span> <span class="err">可设置解压地址</span>
<span class="n">tar</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="n">class</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot; Class with methods to open, read, write, close, list zip files.</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">ZIP_STORED</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>

    <span class="nl">file:</span> <span class="n">Either</span> <span class="n">the</span> <span class="n">path</span> <span class="n">to</span> <span class="n">the</span> <span class="n">file</span><span class="p">,</span> <span class="n">or</span> <span class="n">a</span> <span class="n">file</span><span class="o">-</span><span class="n">like</span> <span class="n">object</span><span class="p">.</span>
          <span class="n">If</span> <span class="n">it</span> <span class="n">is</span> <span class="n">a</span> <span class="n">path</span><span class="p">,</span> <span class="n">the</span> <span class="n">file</span> <span class="n">will</span> <span class="n">be</span> <span class="n">opened</span> <span class="n">and</span> <span class="n">closed</span> <span class="n">by</span> <span class="n">ZipFile</span><span class="p">.</span>
    <span class="nl">mode:</span> <span class="n">The</span> <span class="n">mode</span> <span class="n">can</span> <span class="n">be</span> <span class="n">either</span> <span class="n">read</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">write</span> <span class="s">&quot;w&quot;</span> <span class="n">or</span> <span class="n">append</span> <span class="s">&quot;a&quot;</span><span class="p">.</span>
    <span class="nl">compression:</span> <span class="n">ZIP_STORED</span> <span class="p">(</span><span class="n">no</span> <span class="n">compression</span><span class="p">)</span> <span class="n">or</span> <span class="n">ZIP_DEFLATED</span> <span class="p">(</span><span class="n">requires</span> <span class="n">zlib</span><span class="p">).</span>
    <span class="nl">allowZip64:</span> <span class="k">if</span> <span class="n">True</span> <span class="n">ZipFile</span> <span class="n">will</span> <span class="n">create</span> <span class="n">files</span> <span class="n">with</span> <span class="n">ZIP64</span> <span class="n">extensions</span> <span class="n">when</span>
                <span class="n">needed</span><span class="p">,</span> <span class="n">otherwise</span> <span class="n">it</span> <span class="n">will</span> <span class="n">raise</span> <span class="n">an</span> <span class="n">exception</span> <span class="n">when</span> <span class="n">this</span> <span class="n">would</span>
                <span class="n">be</span> <span class="n">necessary</span><span class="p">.</span>

    <span class="s">&quot;&quot;&quot;</span>

    <span class="n">fp</span> <span class="o">=</span> <span class="n">None</span>                   <span class="err">#</span> <span class="n">Set</span> <span class="n">here</span> <span class="n">since</span> <span class="n">__del__</span> <span class="n">checks</span> <span class="n">it</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">ZIP_STORED</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="n">False</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Open the ZIP file with mode read &quot;</span><span class="n">r</span><span class="s">&quot;, write &quot;</span><span class="n">w</span><span class="s">&quot; or append &quot;</span><span class="n">a</span><span class="s">&quot;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="n">not</span> <span class="n">in</span> <span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">ZipFile</span><span class="p">()</span> <span class="n">requires</span> <span class="n">mode</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="n">or</span> <span class="s">&quot;a&quot;</span><span class="err">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compression</span> <span class="o">==</span> <span class="n">ZIP_STORED</span><span class="o">:</span>
            <span class="n">pass</span>
        <span class="n">elif</span> <span class="n">compression</span> <span class="o">==</span> <span class="n">ZIP_DEFLATED</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">not</span> <span class="n">zlib</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span>\
                      <span class="s">&quot;Compression requires the (missing) zlib module&quot;</span>
        <span class="nl">else:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> <span class="s">&quot;That compression method is not supported&quot;</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span> <span class="o">=</span> <span class="n">allowZip64</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>  <span class="err">#</span> <span class="n">Level</span> <span class="n">of</span> <span class="n">printing</span><span class="o">:</span> <span class="mi">0</span> <span class="n">through</span> <span class="mi">3</span>
        <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span> <span class="o">=</span> <span class="p">{}</span>    <span class="err">#</span> <span class="n">Find</span> <span class="n">file</span> <span class="n">info</span> <span class="n">given</span> <span class="n">name</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filelist</span> <span class="o">=</span> <span class="p">[]</span>      <span class="err">#</span> <span class="n">List</span> <span class="n">of</span> <span class="n">ZipInfo</span> <span class="n">instances</span> <span class="k">for</span> <span class="n">archive</span>
        <span class="n">self</span><span class="p">.</span><span class="n">compression</span> <span class="o">=</span> <span class="n">compression</span>  <span class="err">#</span> <span class="n">Method</span> <span class="n">of</span> <span class="n">compression</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="n">mode</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="sc">&#39;b&#39;</span><span class="p">,</span> <span class="err">&#39;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pwd</span> <span class="o">=</span> <span class="n">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="err">&#39;&#39;</span>

        <span class="err">#</span> <span class="n">Check</span> <span class="k">if</span> <span class="n">we</span> <span class="n">were</span> <span class="n">passed</span> <span class="n">a</span> <span class="n">file</span><span class="o">-</span><span class="n">like</span> <span class="n">object</span>
        <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">basestring</span><span class="p">)</span><span class="o">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_filePassed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">modeDict</span> <span class="o">=</span> <span class="p">{</span><span class="sc">&#39;r&#39;</span> <span class="o">:</span> <span class="err">&#39;</span><span class="n">rb</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span> <span class="o">:</span> <span class="err">&#39;</span><span class="n">r</span><span class="o">+</span><span class="n">b</span><span class="err">&#39;</span><span class="p">}</span>
            <span class="nl">try:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">modeDict</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
            <span class="n">except</span> <span class="n">IOError</span><span class="o">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">modeDict</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>
                <span class="nl">else:</span>
                    <span class="n">raise</span>
        <span class="nl">else:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">_filePassed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">file</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">getattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">None</span><span class="p">)</span>

        <span class="nl">try:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_RealGetContents</span><span class="p">()</span>
            <span class="n">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>
                <span class="err">#</span> <span class="n">set</span> <span class="n">the</span> <span class="n">modified</span> <span class="n">flag</span> <span class="n">so</span> <span class="n">central</span> <span class="n">directory</span> <span class="n">gets</span> <span class="n">written</span>
                <span class="err">#</span> <span class="n">even</span> <span class="k">if</span> <span class="n">no</span> <span class="n">files</span> <span class="n">are</span> <span class="n">added</span> <span class="n">to</span> <span class="n">the</span> <span class="n">archive</span>
                <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">True</span>
            <span class="n">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
                <span class="nl">try:</span>
                    <span class="err">#</span> <span class="n">See</span> <span class="k">if</span> <span class="n">file</span> <span class="n">is</span> <span class="n">a</span> <span class="n">zip</span> <span class="n">file</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_RealGetContents</span><span class="p">()</span>
                    <span class="err">#</span> <span class="n">seek</span> <span class="n">to</span> <span class="n">start</span> <span class="n">of</span> <span class="n">directory</span> <span class="n">and</span> <span class="n">overwrite</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">start_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">except</span> <span class="n">BadZipfile</span><span class="o">:</span>
                    <span class="err">#</span> <span class="n">file</span> <span class="n">is</span> <span class="n">not</span> <span class="n">a</span> <span class="n">zip</span> <span class="n">file</span><span class="p">,</span> <span class="n">just</span> <span class="n">append</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                    <span class="err">#</span> <span class="n">set</span> <span class="n">the</span> <span class="n">modified</span> <span class="n">flag</span> <span class="n">so</span> <span class="n">central</span> <span class="n">directory</span> <span class="n">gets</span> <span class="n">written</span>
                    <span class="err">#</span> <span class="n">even</span> <span class="k">if</span> <span class="n">no</span> <span class="n">files</span> <span class="n">are</span> <span class="n">added</span> <span class="n">to</span> <span class="n">the</span> <span class="n">archive</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">True</span>
            <span class="nl">else:</span>
                <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Mode</span> <span class="n">must</span> <span class="n">be</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span> <span class="n">or</span> <span class="s">&quot;a&quot;</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="nl">except:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">None</span>
            <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_filePassed</span><span class="o">:</span>
                <span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">raise</span>

    <span class="n">def</span> <span class="n">__enter__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">self</span>

    <span class="n">def</span> <span class="n">__exit__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">_RealGetContents</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Read in the table of contents for the ZIP file.&quot;&quot;&quot;</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span>
        <span class="nl">try:</span>
            <span class="n">endrec</span> <span class="o">=</span> <span class="n">_EndRecData</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">except</span> <span class="n">IOError</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">(</span><span class="s">&quot;File is not a zip file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">endrec</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">,</span> <span class="s">&quot;File is not a zip file&quot;</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">:</span>
            <span class="n">print</span> <span class="n">endrec</span>
        <span class="n">size_cd</span> <span class="o">=</span> <span class="n">endrec</span><span class="p">[</span><span class="n">_ECD_SIZE</span><span class="p">]</span>             <span class="err">#</span> <span class="n">bytes</span> <span class="n">in</span> <span class="n">central</span> <span class="n">directory</span>
        <span class="n">offset_cd</span> <span class="o">=</span> <span class="n">endrec</span><span class="p">[</span><span class="n">_ECD_OFFSET</span><span class="p">]</span>         <span class="err">#</span> <span class="n">offset</span> <span class="n">of</span> <span class="n">central</span> <span class="n">directory</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">endrec</span><span class="p">[</span><span class="n">_ECD_COMMENT</span><span class="p">]</span>    <span class="err">#</span> <span class="n">archive</span> <span class="n">comment</span>

        <span class="err">#</span> <span class="s">&quot;concat&quot;</span> <span class="n">is</span> <span class="n">zero</span><span class="p">,</span> <span class="n">unless</span> <span class="n">zip</span> <span class="n">was</span> <span class="n">concatenated</span> <span class="n">to</span> <span class="n">another</span> <span class="n">file</span>
        <span class="n">concat</span> <span class="o">=</span> <span class="n">endrec</span><span class="p">[</span><span class="n">_ECD_LOCATION</span><span class="p">]</span> <span class="o">-</span> <span class="n">size_cd</span> <span class="o">-</span> <span class="n">offset_cd</span>
        <span class="k">if</span> <span class="n">endrec</span><span class="p">[</span><span class="n">_ECD_SIGNATURE</span><span class="p">]</span> <span class="o">==</span> <span class="n">stringEndArchive64</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">If</span> <span class="n">Zip64</span> <span class="n">extension</span> <span class="n">structures</span> <span class="n">are</span> <span class="n">present</span><span class="p">,</span> <span class="n">account</span> <span class="k">for</span> <span class="n">them</span>
            <span class="n">concat</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sizeEndCentDir64</span> <span class="o">+</span> <span class="n">sizeEndCentDir64Locator</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">:</span>
            <span class="n">inferred</span> <span class="o">=</span> <span class="n">concat</span> <span class="o">+</span> <span class="n">offset_cd</span>
            <span class="n">print</span> <span class="s">&quot;given, inferred, offset&quot;</span><span class="p">,</span> <span class="n">offset_cd</span><span class="p">,</span> <span class="n">inferred</span><span class="p">,</span> <span class="n">concat</span>
        <span class="err">#</span> <span class="n">self</span><span class="p">.</span><span class="n">start_dir</span><span class="o">:</span>  <span class="n">Position</span> <span class="n">of</span> <span class="n">start</span> <span class="n">of</span> <span class="n">central</span> <span class="n">directory</span>
        <span class="n">self</span><span class="p">.</span><span class="n">start_dir</span> <span class="o">=</span> <span class="n">offset_cd</span> <span class="o">+</span> <span class="n">concat</span>
        <span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">start_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">size_cd</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="p">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">size_cd</span><span class="o">:</span>
            <span class="n">centdir</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">sizeCentralDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">centdir</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sizeCentralDir</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">(</span><span class="s">&quot;Truncated central directory&quot;</span><span class="p">)</span>
            <span class="n">centdir</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">structCentralDir</span><span class="p">,</span> <span class="n">centdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">centdir</span><span class="p">[</span><span class="n">_CD_SIGNATURE</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stringCentralDir</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">(</span><span class="s">&quot;Bad magic number for central directory&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">:</span>
                <span class="n">print</span> <span class="n">centdir</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">centdir</span><span class="p">[</span><span class="n">_CD_FILENAME_LENGTH</span><span class="p">])</span>
            <span class="err">#</span> <span class="n">Create</span> <span class="n">ZipInfo</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">store</span> <span class="n">file</span> <span class="n">information</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">ZipInfo</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">x</span><span class="p">.</span><span class="n">extra</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">centdir</span><span class="p">[</span><span class="n">_CD_EXTRA_FIELD_LENGTH</span><span class="p">])</span>
            <span class="n">x</span><span class="p">.</span><span class="n">comment</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">centdir</span><span class="p">[</span><span class="n">_CD_COMMENT_LENGTH</span><span class="p">])</span>
            <span class="n">x</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">=</span> <span class="n">centdir</span><span class="p">[</span><span class="n">_CD_LOCAL_HEADER_OFFSET</span><span class="p">]</span>
            <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">create_version</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">create_system</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">extract_version</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">reserved</span><span class="p">,</span>
                <span class="n">x</span><span class="p">.</span><span class="n">flag_bits</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">compress_type</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span>
                <span class="n">x</span><span class="p">.</span><span class="n">CRC</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">compress_size</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">file_size</span><span class="p">)</span> <span class="o">=</span> <span class="n">centdir</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">12</span><span class="p">]</span>
            <span class="n">x</span><span class="p">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">internal_attr</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="n">centdir</span><span class="p">[</span><span class="mi">15</span><span class="o">:</span><span class="mi">18</span><span class="p">]</span>
            <span class="err">#</span> <span class="n">Convert</span> <span class="n">date</span><span class="o">/</span><span class="n">time</span> <span class="n">code</span> <span class="n">to</span> <span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">hour</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">sec</span><span class="p">)</span>
            <span class="n">x</span><span class="p">.</span><span class="n">_raw_time</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">x</span><span class="p">.</span><span class="n">date_time</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">d</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">)</span><span class="o">+</span><span class="mi">1980</span><span class="p">,</span> <span class="p">(</span><span class="n">d</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xF</span><span class="p">,</span> <span class="n">d</span><span class="o">&amp;</span><span class="mh">0x1F</span><span class="p">,</span>
                                     <span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">11</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x3F</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="o">&amp;</span><span class="mh">0x1F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">)</span>

            <span class="n">x</span><span class="p">.</span><span class="n">_decodeExtra</span><span class="p">()</span>
            <span class="n">x</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">+</span> <span class="n">concat</span>
            <span class="n">x</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">_decodeFilename</span><span class="p">()</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

            <span class="err">#</span> <span class="n">update</span> <span class="n">total</span> <span class="n">bytes</span> <span class="n">read</span> <span class="n">from</span> <span class="n">central</span> <span class="n">directory</span>
            <span class="n">total</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">sizeCentralDir</span> <span class="o">+</span> <span class="n">centdir</span><span class="p">[</span><span class="n">_CD_FILENAME_LENGTH</span><span class="p">]</span>
                     <span class="o">+</span> <span class="n">centdir</span><span class="p">[</span><span class="n">_CD_EXTRA_FIELD_LENGTH</span><span class="p">]</span>
                     <span class="o">+</span> <span class="n">centdir</span><span class="p">[</span><span class="n">_CD_COMMENT_LENGTH</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">:</span>
                <span class="n">print</span> <span class="s">&quot;total&quot;</span><span class="p">,</span> <span class="n">total</span>


    <span class="n">def</span> <span class="n">namelist</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Return a list of file names in the archive.&quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="o">:</span>
            <span class="n">l</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">l</span>

    <span class="n">def</span> <span class="n">infolist</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Return a list of class ZipInfo instances for files in the</span>
        <span class="n">archive</span><span class="p">.</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">filelist</span>

    <span class="n">def</span> <span class="n">printdir</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Print a table of contents for the zip file.&quot;&quot;&quot;</span>
        <span class="n">print</span> <span class="s">&quot;%-46s %19s %12s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&quot;File Name&quot;</span><span class="p">,</span> <span class="s">&quot;Modified    &quot;</span><span class="p">,</span> <span class="s">&quot;Size&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">zinfo</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="o">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="s">&quot;%d-%02d-%02d %02d:%02d:%02d&quot;</span> <span class="o">%</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">date_time</span><span class="p">[</span><span class="o">:</span><span class="mi">6</span><span class="p">]</span>
            <span class="n">print</span> <span class="s">&quot;%-46s %s %12d&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">testzip</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Read all the files and check the CRC.&quot;&quot;&quot;</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">20</span>
        <span class="k">for</span> <span class="n">zinfo</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="o">:</span>
            <span class="nl">try:</span>
                <span class="err">#</span> <span class="n">Read</span> <span class="n">by</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">an</span> <span class="n">OverflowError</span> <span class="n">or</span> <span class="n">a</span>
                <span class="err">#</span> <span class="n">MemoryError</span> <span class="n">with</span> <span class="n">very</span> <span class="n">large</span> <span class="n">embedded</span> <span class="n">files</span><span class="p">.</span>
                <span class="n">with</span> <span class="n">self</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="n">as</span> <span class="n">f</span><span class="o">:</span>
                    <span class="k">while</span> <span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span><span class="o">:</span>     <span class="err">#</span> <span class="n">Check</span> <span class="n">CRC</span><span class="o">-</span><span class="mi">32</span>
                        <span class="n">pass</span>
            <span class="n">except</span> <span class="n">BadZipfile</span><span class="o">:</span>
                <span class="k">return</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span>

    <span class="n">def</span> <span class="n">getinfo</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Return the instance of ZipInfo given &#39;name&#39;.&quot;&quot;&quot;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">KeyError</span><span class="p">(</span>
                <span class="err">&#39;</span><span class="n">There</span> <span class="n">is</span> <span class="n">no</span> <span class="n">item</span> <span class="n">named</span> <span class="o">%</span><span class="n">r</span> <span class="n">in</span> <span class="n">the</span> <span class="n">archive</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span>

    <span class="n">def</span> <span class="n">setpassword</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Set default password for encrypted files.&quot;&quot;&quot;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span>

    <span class="err">@</span><span class="n">property</span>
    <span class="n">def</span> <span class="n">comment</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;The comment text associated with the ZIP file.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_comment</span>

    <span class="err">@</span><span class="n">comment</span><span class="p">.</span><span class="n">setter</span>
    <span class="n">def</span> <span class="n">comment</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="n">check</span> <span class="k">for</span> <span class="n">valid</span> <span class="n">comment</span> <span class="n">length</span>
        <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZIP_MAX_COMMENT</span><span class="o">:</span>
            <span class="n">import</span> <span class="n">warnings</span>
            <span class="n">warnings</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Archive</span> <span class="n">comment</span> <span class="n">is</span> <span class="n">too</span> <span class="kt">long</span><span class="p">;</span> <span class="n">truncating</span> <span class="n">to</span> <span class="o">%</span><span class="n">d</span> <span class="n">bytes</span><span class="err">&#39;</span>
                          <span class="o">%</span> <span class="n">ZIP_MAX_COMMENT</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="o">:</span><span class="n">ZIP_MAX_COMMENT</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_comment</span> <span class="o">=</span> <span class="n">comment</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">True</span>

    <span class="n">def</span> <span class="n">read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Return file bytes (as a string) for name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">open</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Return file-like object for &#39;name&#39;.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="n">not</span> <span class="n">in</span> <span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="s">&quot;rU&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">open</span><span class="p">()</span> <span class="n">requires</span> <span class="n">mode</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="n">or</span> <span class="s">&quot;rU&quot;</span><span class="err">&#39;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> \
                  <span class="s">&quot;Attempt to read ZIP archive that was already closed&quot;</span>

        <span class="err">#</span> <span class="n">Only</span> <span class="n">open</span> <span class="n">a</span> <span class="n">new</span> <span class="n">file</span> <span class="k">for</span> <span class="n">instances</span> <span class="n">where</span> <span class="n">we</span> <span class="n">were</span> <span class="n">not</span>
        <span class="err">#</span> <span class="n">given</span> <span class="n">a</span> <span class="n">file</span> <span class="n">object</span> <span class="n">in</span> <span class="n">the</span> <span class="n">constructor</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">_filePassed</span><span class="o">:</span>
            <span class="n">zef_file</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span>
            <span class="n">should_close</span> <span class="o">=</span> <span class="n">False</span>
        <span class="nl">else:</span>
            <span class="n">zef_file</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">rb</span><span class="err">&#39;</span><span class="p">)</span>
            <span class="n">should_close</span> <span class="o">=</span> <span class="n">True</span>

        <span class="nl">try:</span>
            <span class="err">#</span> <span class="n">Make</span> <span class="n">sure</span> <span class="n">we</span> <span class="n">have</span> <span class="n">an</span> <span class="n">info</span> <span class="n">object</span>
            <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ZipInfo</span><span class="p">)</span><span class="o">:</span>
                <span class="err">#</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">already</span> <span class="n">an</span> <span class="n">info</span> <span class="n">object</span>
                <span class="n">zinfo</span> <span class="o">=</span> <span class="n">name</span>
            <span class="nl">else:</span>
                <span class="err">#</span> <span class="n">Get</span> <span class="n">info</span> <span class="n">object</span> <span class="k">for</span> <span class="n">name</span>
                <span class="n">zinfo</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">zef_file</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="err">#</span> <span class="n">Skip</span> <span class="n">the</span> <span class="n">file</span> <span class="n">header</span><span class="o">:</span>
            <span class="n">fheader</span> <span class="o">=</span> <span class="n">zef_file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">sizeFileHeader</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">fheader</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sizeFileHeader</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">(</span><span class="s">&quot;Truncated file header&quot;</span><span class="p">)</span>
            <span class="n">fheader</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">structFileHeader</span><span class="p">,</span> <span class="n">fheader</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fheader</span><span class="p">[</span><span class="n">_FH_SIGNATURE</span><span class="p">]</span> <span class="o">!=</span> <span class="n">stringFileHeader</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">(</span><span class="s">&quot;Bad magic number for file header&quot;</span><span class="p">)</span>

            <span class="n">fname</span> <span class="o">=</span> <span class="n">zef_file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">fheader</span><span class="p">[</span><span class="n">_FH_FILENAME_LENGTH</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fheader</span><span class="p">[</span><span class="n">_FH_EXTRA_FIELD_LENGTH</span><span class="p">]</span><span class="o">:</span>
                <span class="n">zef_file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">fheader</span><span class="p">[</span><span class="n">_FH_EXTRA_FIELD_LENGTH</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">fname</span> <span class="o">!=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">orig_filename</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">BadZipfile</span><span class="p">,</span> \
                        <span class="err">&#39;</span><span class="n">File</span> <span class="n">name</span> <span class="n">in</span> <span class="n">directory</span> <span class="s">&quot;%s&quot;</span> <span class="n">and</span> <span class="n">header</span> <span class="s">&quot;%s&quot;</span> <span class="n">differ</span><span class="p">.</span><span class="err">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">zinfo</span><span class="p">.</span><span class="n">orig_filename</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

            <span class="err">#</span> <span class="n">check</span> <span class="k">for</span> <span class="n">encrypted</span> <span class="n">flag</span> <span class="o">&amp;</span> <span class="n">handle</span> <span class="n">password</span>
            <span class="n">is_encrypted</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">flag_bits</span> <span class="o">&amp;</span> <span class="mh">0x1</span>
            <span class="n">zd</span> <span class="o">=</span> <span class="n">None</span>
            <span class="k">if</span> <span class="n">is_encrypted</span><span class="o">:</span>
                <span class="k">if</span> <span class="n">not</span> <span class="n">pwd</span><span class="o">:</span>
                    <span class="n">pwd</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">pwd</span>
                <span class="k">if</span> <span class="n">not</span> <span class="n">pwd</span><span class="o">:</span>
                    <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> <span class="s">&quot;File %s is encrypted, &quot;</span> \
                        <span class="s">&quot;password required for extraction&quot;</span> <span class="o">%</span> <span class="n">name</span>

                <span class="n">zd</span> <span class="o">=</span> <span class="n">_ZipDecrypter</span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span>
                <span class="err">#</span> <span class="n">The</span> <span class="n">first</span> <span class="mi">12</span> <span class="n">bytes</span> <span class="n">in</span> <span class="n">the</span> <span class="n">cypher</span> <span class="n">stream</span> <span class="n">is</span> <span class="n">an</span> <span class="n">encryption</span> <span class="n">header</span>
                <span class="err">#</span>  <span class="n">used</span> <span class="n">to</span> <span class="n">strengthen</span> <span class="n">the</span> <span class="n">algorithm</span><span class="p">.</span> <span class="n">The</span> <span class="n">first</span> <span class="mi">11</span> <span class="n">bytes</span> <span class="n">are</span>
                <span class="err">#</span>  <span class="n">completely</span> <span class="n">random</span><span class="p">,</span> <span class="k">while</span> <span class="n">the</span> <span class="mi">12</span><span class="n">th</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">MSB</span> <span class="n">of</span> <span class="n">the</span> <span class="n">CRC</span><span class="p">,</span>
                <span class="err">#</span>  <span class="n">or</span> <span class="n">the</span> <span class="n">MSB</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span> <span class="n">time</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">the</span> <span class="n">header</span> <span class="n">type</span>
                <span class="err">#</span>  <span class="n">and</span> <span class="n">is</span> <span class="n">used</span> <span class="n">to</span> <span class="n">check</span> <span class="n">the</span> <span class="n">correctness</span> <span class="n">of</span> <span class="n">the</span> <span class="n">password</span><span class="p">.</span>
                <span class="n">bytes</span> <span class="o">=</span> <span class="n">zef_file</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">map</span><span class="p">(</span><span class="n">zd</span><span class="p">,</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">12</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">flag_bits</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="o">:</span>
                    <span class="err">#</span> <span class="n">compare</span> <span class="n">against</span> <span class="n">the</span> <span class="n">file</span> <span class="n">type</span> <span class="n">from</span> <span class="n">extended</span> <span class="n">local</span> <span class="n">headers</span>
                    <span class="n">check_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">_raw_time</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="nl">else:</span>
                    <span class="err">#</span> <span class="n">compare</span> <span class="n">against</span> <span class="n">the</span> <span class="n">CRC</span> <span class="n">otherwise</span>
                    <span class="n">check_byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span>
                <span class="k">if</span> <span class="n">ord</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span> <span class="o">!=</span> <span class="n">check_byte</span><span class="o">:</span>
                    <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span><span class="s">&quot;Bad password for file&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ZipExtFile</span><span class="p">(</span><span class="n">zef_file</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">,</span> <span class="n">zd</span><span class="p">,</span>
                    <span class="n">close_fileobj</span><span class="o">=</span><span class="n">should_close</span><span class="p">)</span>
        <span class="nl">except:</span>
            <span class="k">if</span> <span class="n">should_close</span><span class="o">:</span>
                <span class="n">zef_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">raise</span>

    <span class="n">def</span> <span class="n">extract</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Extract a member from the archive to the current working directory,</span>
           <span class="n">using</span> <span class="n">its</span> <span class="n">full</span> <span class="n">name</span><span class="p">.</span> <span class="n">Its</span> <span class="n">file</span> <span class="n">information</span> <span class="n">is</span> <span class="n">extracted</span> <span class="n">as</span> <span class="n">accurately</span>
           <span class="n">as</span> <span class="n">possible</span><span class="p">.</span> <span class="err">`</span><span class="n">member</span><span class="err">&#39;</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">filename</span> <span class="n">or</span> <span class="n">a</span> <span class="n">ZipInfo</span> <span class="n">object</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span>
           <span class="n">specify</span> <span class="n">a</span> <span class="n">different</span> <span class="n">directory</span> <span class="n">using</span> <span class="err">`</span><span class="n">path</span><span class="err">&#39;</span><span class="p">.</span>
        <span class="s">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">ZipInfo</span><span class="p">)</span><span class="o">:</span>
            <span class="n">member</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">_extract_member</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">extractall</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">members</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Extract all members from the archive to the current working</span>
           <span class="n">directory</span><span class="p">.</span> <span class="err">`</span><span class="n">path</span><span class="err">&#39;</span> <span class="n">specifies</span> <span class="n">a</span> <span class="n">different</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">extract</span> <span class="n">to</span><span class="p">.</span>
           <span class="err">`</span><span class="n">members</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">optional</span> <span class="n">and</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="n">subset</span> <span class="n">of</span> <span class="n">the</span> <span class="n">list</span> <span class="n">returned</span>
           <span class="n">by</span> <span class="n">namelist</span><span class="p">().</span>
        <span class="s">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">members</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">members</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">namelist</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">zipinfo</span> <span class="n">in</span> <span class="n">members</span><span class="o">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">extract</span><span class="p">(</span><span class="n">zipinfo</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">_extract_member</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">member</span><span class="p">,</span> <span class="n">targetpath</span><span class="p">,</span> <span class="n">pwd</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Extract the ZipInfo object &#39;member&#39; to a physical</span>
           <span class="n">file</span> <span class="n">on</span> <span class="n">the</span> <span class="n">path</span> <span class="n">targetpath</span><span class="p">.</span>
        <span class="s">&quot;&quot;&quot;</span>
        <span class="err">#</span> <span class="n">build</span> <span class="n">the</span> <span class="n">destination</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">replacing</span>
        <span class="err">#</span> <span class="n">forward</span> <span class="n">slashes</span> <span class="n">to</span> <span class="n">platform</span> <span class="n">specific</span> <span class="n">separators</span><span class="p">.</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">member</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">altsep</span><span class="o">:</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">arcname</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">altsep</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="err">#</span> <span class="n">interpret</span> <span class="n">absolute</span> <span class="n">pathname</span> <span class="n">as</span> <span class="n">relative</span><span class="p">,</span> <span class="n">remove</span> <span class="n">drive</span> <span class="n">letter</span> <span class="n">or</span>
        <span class="err">#</span> <span class="n">UNC</span> <span class="n">path</span><span class="p">,</span> <span class="n">redundant</span> <span class="n">separators</span><span class="p">,</span> <span class="s">&quot;.&quot;</span> <span class="n">and</span> <span class="s">&quot;..&quot;</span> <span class="n">components</span><span class="p">.</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">arcname</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">arcname</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="n">not</span> <span class="n">in</span> <span class="p">(</span><span class="err">&#39;&#39;</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">curdir</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">pardir</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">filter</span> <span class="n">illegal</span> <span class="n">characters</span> <span class="n">on</span> <span class="n">Windows</span>
            <span class="n">illegal</span> <span class="o">=</span> <span class="err">&#39;</span><span class="o">:&lt;&gt;|</span><span class="s">&quot;?*&#39;</span>
            <span class="k">if</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span><span class="o">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="p">{</span><span class="n">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">:</span> <span class="n">ord</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="n">in</span> <span class="n">illegal</span><span class="p">}</span>
            <span class="nl">else:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">maketrans</span><span class="p">(</span><span class="n">illegal</span><span class="p">,</span> <span class="sc">&#39;_&#39;</span> <span class="o">*</span> <span class="n">len</span><span class="p">(</span><span class="n">illegal</span><span class="p">))</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">arcname</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="err">#</span> <span class="n">remove</span> <span class="n">trailing</span> <span class="n">dots</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">rstrip</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">arcname</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">))</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">sep</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">arcname</span> <span class="k">if</span> <span class="n">x</span><span class="p">)</span>

        <span class="n">targetpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="n">arcname</span><span class="p">)</span>
        <span class="n">targetpath</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>

        <span class="err">#</span> <span class="n">Create</span> <span class="n">all</span> <span class="n">upper</span> <span class="n">directories</span> <span class="k">if</span> <span class="n">necessary</span><span class="p">.</span>
        <span class="n">upperdirs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upperdirs</span> <span class="n">and</span> <span class="n">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upperdirs</span><span class="p">)</span><span class="o">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">upperdirs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">member</span><span class="p">.</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span><span class="o">:</span>
                <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">targetpath</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">targetpath</span>

        <span class="n">with</span> <span class="n">self</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="n">pwd</span><span class="p">)</span> <span class="n">as</span> <span class="n">source</span><span class="p">,</span> \
             <span class="n">file</span><span class="p">(</span><span class="n">targetpath</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span> <span class="n">as</span> <span class="n">target</span><span class="o">:</span>
            <span class="n">shutil</span><span class="p">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">targetpath</span>

    <span class="n">def</span> <span class="n">_writecheck</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Check for errors before writing a file to the archive.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="o">:</span>
            <span class="n">import</span> <span class="n">warnings</span>
            <span class="n">warnings</span><span class="p">.</span><span class="n">warn</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Duplicate</span> <span class="n">name</span><span class="o">:</span> <span class="o">%</span><span class="n">r</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="n">not</span> <span class="n">in</span> <span class="p">(</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">write</span><span class="p">()</span> <span class="n">requires</span> <span class="n">mode</span> <span class="s">&quot;w&quot;</span> <span class="n">or</span> <span class="s">&quot;a&quot;</span><span class="err">&#39;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> \
                  <span class="s">&quot;Attempt to write ZIP archive that was already closed&quot;</span>
        <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">==</span> <span class="n">ZIP_DEFLATED</span> <span class="n">and</span> <span class="n">not</span> <span class="n">zlib</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> \
                  <span class="s">&quot;Compression requires the (missing) zlib module&quot;</span>
        <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="n">not</span> <span class="n">in</span> <span class="p">(</span><span class="n">ZIP_STORED</span><span class="p">,</span> <span class="n">ZIP_DEFLATED</span><span class="p">)</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">,</span> \
                  <span class="s">&quot;That compression method is not supported&quot;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span><span class="o">:</span>
            <span class="n">requires_zip64</span> <span class="o">=</span> <span class="n">None</span>
            <span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ZIP_FILECOUNT_LIMIT</span><span class="o">:</span>
                <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Files count&quot;</span>
            <span class="n">elif</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Filesize&quot;</span>
            <span class="n">elif</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Zipfile size&quot;</span>
            <span class="k">if</span> <span class="n">requires_zip64</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">LargeZipFile</span><span class="p">(</span><span class="n">requires_zip64</span> <span class="o">+</span>
                                   <span class="s">&quot; would require ZIP64 extensions&quot;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Put the bytes from filename into the archive under the name</span>
        <span class="n">arcname</span><span class="p">.</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span>
                  <span class="s">&quot;Attempt to write to ZIP archive that was already closed&quot;</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">isdir</span> <span class="o">=</span> <span class="n">stat</span><span class="p">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mtime</span><span class="p">)</span>
        <span class="n">date_time</span> <span class="o">=</span> <span class="n">mtime</span><span class="p">[</span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="err">#</span> <span class="n">Create</span> <span class="n">ZipInfo</span> <span class="n">instance</span> <span class="n">to</span> <span class="n">store</span> <span class="n">file</span> <span class="n">information</span>
        <span class="k">if</span> <span class="n">arcname</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">arcname</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">arcname</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">while</span> <span class="n">arcname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="n">in</span> <span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">altsep</span><span class="p">)</span><span class="o">:</span>
            <span class="n">arcname</span> <span class="o">=</span> <span class="n">arcname</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">isdir</span><span class="o">:</span>
            <span class="n">arcname</span> <span class="o">+=</span> <span class="sc">&#39;/&#39;</span>
        <span class="n">zinfo</span> <span class="o">=</span> <span class="n">ZipInfo</span><span class="p">(</span><span class="n">arcname</span><span class="p">,</span> <span class="n">date_time</span><span class="p">)</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16L</span>      <span class="err">#</span> <span class="n">Unix</span> <span class="n">attributes</span>
        <span class="k">if</span> <span class="n">compress_type</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">compression</span>
        <span class="nl">else:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">compress_type</span>

        <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">flag_bits</span> <span class="o">=</span> <span class="mh">0x00</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tell</span><span class="p">()</span>    <span class="err">#</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">header</span> <span class="n">bytes</span>

        <span class="n">self</span><span class="p">.</span><span class="n">_writecheck</span><span class="p">(</span><span class="n">zinfo</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">True</span>

        <span class="k">if</span> <span class="n">isdir</span><span class="o">:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">|=</span> <span class="mh">0x10</span>  <span class="err">#</span> <span class="n">MS</span><span class="o">-</span><span class="n">DOS</span> <span class="n">directory</span> <span class="n">flag</span>
            <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="p">[</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">zinfo</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">False</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span> <span class="n">as</span> <span class="n">fp</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">Must</span> <span class="n">overwrite</span> <span class="n">CRC</span> <span class="n">and</span> <span class="n">sizes</span> <span class="n">with</span> <span class="n">correct</span> <span class="n">data</span> <span class="n">later</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span> <span class="o">=</span> <span class="n">CRC</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="n">compress_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="err">#</span> <span class="n">Compressed</span> <span class="n">size</span> <span class="n">can</span> <span class="n">be</span> <span class="n">larger</span> <span class="n">than</span> <span class="n">uncompressed</span> <span class="n">size</span>
            <span class="n">zip64</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span> <span class="n">and</span> \
                    <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">zip64</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">==</span> <span class="n">ZIP_DEFLATED</span><span class="o">:</span>
                <span class="n">cmpr</span> <span class="o">=</span> <span class="n">zlib</span><span class="p">.</span><span class="n">compressobj</span><span class="p">(</span><span class="n">zlib</span><span class="p">.</span><span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">,</span>
                     <span class="n">zlib</span><span class="p">.</span><span class="n">DEFLATED</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
            <span class="nl">else:</span>
                <span class="n">cmpr</span> <span class="o">=</span> <span class="n">None</span>
            <span class="n">file_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="mi">1</span><span class="o">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">fp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">not</span> <span class="n">buf</span><span class="o">:</span>
                    <span class="k">break</span>
                <span class="n">file_size</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">+</span> <span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">CRC</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">CRC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
                <span class="k">if</span> <span class="n">cmpr</span><span class="o">:</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">cmpr</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                    <span class="n">compress_size</span> <span class="o">=</span> <span class="n">compress_size</span> <span class="o">+</span> <span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmpr</span><span class="o">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">cmpr</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">compress_size</span> <span class="o">=</span> <span class="n">compress_size</span> <span class="o">+</span> <span class="n">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="n">compress_size</span>
        <span class="nl">else:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="n">file_size</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span> <span class="o">=</span> <span class="n">CRC</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="n">file_size</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">zip64</span> <span class="n">and</span> <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span><span class="o">:</span>
            <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">File</span> <span class="n">size</span> <span class="n">has</span> <span class="n">increased</span> <span class="n">during</span> <span class="n">compressing</span><span class="err">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compress_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Compressed</span> <span class="n">size</span> <span class="n">larger</span> <span class="n">than</span> <span class="n">uncompressed</span> <span class="n">size</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="err">#</span> <span class="n">Seek</span> <span class="n">backwards</span> <span class="n">and</span> <span class="n">write</span> <span class="n">file</span> <span class="n">header</span> <span class="p">(</span><span class="n">which</span> <span class="n">will</span> <span class="n">now</span> <span class="n">include</span>
        <span class="err">#</span> <span class="n">correct</span> <span class="n">CRC</span> <span class="n">and</span> <span class="n">file</span> <span class="n">sizes</span><span class="p">)</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tell</span><span class="p">()</span>       <span class="err">#</span> <span class="n">Preserve</span> <span class="n">current</span> <span class="n">position</span> <span class="n">in</span> <span class="n">file</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">zip64</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="p">[</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">zinfo</span>

    <span class="n">def</span> <span class="n">writestr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">zinfo_or_arcname</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">compress_type</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Write a file into the archive.  The contents is the string</span>
        <span class="err">&#39;</span><span class="n">bytes</span><span class="err">&#39;</span><span class="p">.</span>  <span class="err">&#39;</span><span class="n">zinfo_or_arcname</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">either</span> <span class="n">a</span> <span class="n">ZipInfo</span> <span class="n">instance</span> <span class="n">or</span>
        <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">file</span> <span class="n">in</span> <span class="n">the</span> <span class="n">archive</span><span class="p">.</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">zinfo_or_arcname</span><span class="p">,</span> <span class="n">ZipInfo</span><span class="p">)</span><span class="o">:</span>
            <span class="n">zinfo</span> <span class="o">=</span> <span class="n">ZipInfo</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">zinfo_or_arcname</span><span class="p">,</span>
                            <span class="n">date_time</span><span class="o">=</span><span class="n">time</span><span class="p">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">())[</span><span class="o">:</span><span class="mi">6</span><span class="p">])</span>

            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">compression</span>
            <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="o">:</span>
                <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o40775</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>   <span class="err">#</span> <span class="n">drwxrwxr</span><span class="o">-</span><span class="n">x</span>
                <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">|=</span> <span class="mh">0x10</span>           <span class="err">#</span> <span class="n">MS</span><span class="o">-</span><span class="n">DOS</span> <span class="n">directory</span> <span class="n">flag</span>
            <span class="nl">else:</span>
                <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span> <span class="o">=</span> <span class="mi">0</span><span class="n">o600</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>     <span class="err">#</span> <span class="o">?</span><span class="n">rw</span><span class="o">-------</span>
        <span class="nl">else:</span>
            <span class="n">zinfo</span> <span class="o">=</span> <span class="n">zinfo_or_arcname</span>

        <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">RuntimeError</span><span class="p">(</span>
                  <span class="s">&quot;Attempt to write to ZIP archive that was already closed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">compress_type</span> <span class="n">is</span> <span class="n">not</span> <span class="n">None</span><span class="o">:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">=</span> <span class="n">compress_type</span>

        <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>            <span class="err">#</span> <span class="n">Uncompressed</span> <span class="n">size</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tell</span><span class="p">()</span>    <span class="err">#</span> <span class="n">Start</span> <span class="n">of</span> <span class="n">header</span> <span class="n">bytes</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_writecheck</span><span class="p">(</span><span class="n">zinfo</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span> <span class="o">=</span> <span class="n">True</span>
        <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>       <span class="err">#</span> <span class="n">CRC</span><span class="o">-</span><span class="mi">32</span> <span class="n">checksum</span>
        <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span> <span class="o">==</span> <span class="n">ZIP_DEFLATED</span><span class="o">:</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">zlib</span><span class="p">.</span><span class="n">compressobj</span><span class="p">(</span><span class="n">zlib</span><span class="p">.</span><span class="n">Z_DEFAULT_COMPRESSION</span><span class="p">,</span>
                 <span class="n">zlib</span><span class="p">.</span><span class="n">DEFLATED</span><span class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">bytes</span> <span class="o">=</span> <span class="n">co</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span> <span class="o">+</span> <span class="n">co</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>    <span class="err">#</span> <span class="n">Compressed</span> <span class="n">size</span>
        <span class="nl">else:</span>
            <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span>
        <span class="n">zip64</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span> <span class="n">or</span> \
                <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span>
        <span class="k">if</span> <span class="n">zip64</span> <span class="n">and</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span><span class="o">:</span>
            <span class="n">raise</span> <span class="n">LargeZipFile</span><span class="p">(</span><span class="s">&quot;Filesize would require ZIP64 extensions&quot;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">(</span><span class="n">zip64</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">flag_bits</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="o">:</span>
            <span class="err">#</span> <span class="n">Write</span> <span class="n">CRC</span> <span class="n">and</span> <span class="n">file</span> <span class="n">sizes</span> <span class="n">after</span> <span class="n">the</span> <span class="n">file</span> <span class="n">data</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="err">&#39;</span><span class="o">&lt;</span><span class="n">LQQ</span><span class="err">&#39;</span> <span class="k">if</span> <span class="n">zip64</span> <span class="k">else</span> <span class="err">&#39;</span><span class="o">&lt;</span><span class="n">LLL</span><span class="err">&#39;</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span><span class="p">,</span>
                  <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">NameToInfo</span><span class="p">[</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">zinfo</span>

    <span class="n">def</span> <span class="n">__del__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Call the &quot;</span><span class="n">close</span><span class="p">()</span><span class="s">&quot; method in case the user forgot.&quot;&quot;&quot;</span>
        <span class="n">self</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">close</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;Close the file, and for mode &quot;</span><span class="n">w</span><span class="s">&quot; and &quot;</span><span class="n">a</span><span class="s">&quot; write the ending</span>
        <span class="n">records</span><span class="p">.</span><span class="s">&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="n">is</span> <span class="n">None</span><span class="o">:</span>
            <span class="k">return</span>

        <span class="nl">try:</span>
            <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">mode</span> <span class="n">in</span> <span class="p">(</span><span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span> <span class="n">and</span> <span class="n">self</span><span class="p">.</span><span class="n">_didModify</span><span class="o">:</span> <span class="err">#</span> <span class="n">write</span> <span class="n">ending</span> <span class="n">records</span>
                <span class="n">pos1</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">zinfo</span> <span class="n">in</span> <span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="o">:</span>         <span class="err">#</span> <span class="n">write</span> <span class="n">central</span> <span class="n">directory</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">date_time</span>
                    <span class="n">dosdate</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1980</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span> <span class="o">|</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">dt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">dostime</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span> <span class="o">|</span> <span class="n">dt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="c1">// 2)</span>
                    <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span> \
                            <span class="n">or</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                        <span class="n">extra</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span><span class="p">)</span>
                        <span class="n">extra</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span><span class="p">)</span>
                        <span class="n">file_size</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
                        <span class="n">compress_size</span> <span class="o">=</span> <span class="mh">0xffffffff</span>
                    <span class="nl">else:</span>
                        <span class="n">file_size</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">file_size</span>
                        <span class="n">compress_size</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_size</span>

                    <span class="k">if</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                        <span class="n">extra</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span><span class="p">)</span>
                        <span class="n">header_offset</span> <span class="o">=</span> <span class="mh">0xffffffffL</span>
                    <span class="nl">else:</span>
                        <span class="n">header_offset</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">header_offset</span>

                    <span class="n">extra_data</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">extra</span>
                    <span class="k">if</span> <span class="n">extra</span><span class="o">:</span>
                        <span class="err">#</span> <span class="n">Append</span> <span class="n">a</span> <span class="n">ZIP64</span> <span class="n">field</span> <span class="n">to</span> <span class="n">the</span> <span class="n">extra</span><span class="err">&#39;</span><span class="n">s</span>
                        <span class="n">extra_data</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span>
                                <span class="err">&#39;</span><span class="o">&lt;</span><span class="n">HH</span><span class="err">&#39;</span> <span class="o">+</span> <span class="sc">&#39;Q&#39;</span><span class="o">*</span><span class="n">len</span><span class="p">(</span><span class="n">extra</span><span class="p">),</span>
                                <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">len</span><span class="p">(</span><span class="n">extra</span><span class="p">),</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_data</span>

                        <span class="n">extract_version</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">extract_version</span><span class="p">)</span>
                        <span class="n">create_version</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">create_version</span><span class="p">)</span>
                    <span class="nl">else:</span>
                        <span class="n">extract_version</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">extract_version</span>
                        <span class="n">create_version</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">create_version</span>

                    <span class="nl">try:</span>
                        <span class="n">filename</span><span class="p">,</span> <span class="n">flag_bits</span> <span class="o">=</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">_encodeFilenameFlags</span><span class="p">()</span>
                        <span class="n">centdir</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">structCentralDir</span><span class="p">,</span>
                        <span class="n">stringCentralDir</span><span class="p">,</span> <span class="n">create_version</span><span class="p">,</span>
                        <span class="n">zinfo</span><span class="p">.</span><span class="n">create_system</span><span class="p">,</span> <span class="n">extract_version</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">reserved</span><span class="p">,</span>
                        <span class="n">flag_bits</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span><span class="p">,</span> <span class="n">dostime</span><span class="p">,</span> <span class="n">dosdate</span><span class="p">,</span>
                        <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span><span class="p">,</span> <span class="n">compress_size</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span>
                        <span class="n">len</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">extra_data</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">comment</span><span class="p">),</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">internal_attr</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span><span class="p">,</span>
                        <span class="n">header_offset</span><span class="p">)</span>
                    <span class="n">except</span> <span class="n">DeprecationWarning</span><span class="o">:</span>
                        <span class="n">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="p">.</span><span class="n">stderr</span><span class="p">,</span> <span class="p">(</span><span class="n">structCentralDir</span><span class="p">,</span>
                        <span class="n">stringCentralDir</span><span class="p">,</span> <span class="n">create_version</span><span class="p">,</span>
                        <span class="n">zinfo</span><span class="p">.</span><span class="n">create_system</span><span class="p">,</span> <span class="n">extract_version</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">reserved</span><span class="p">,</span>
                        <span class="n">zinfo</span><span class="p">.</span><span class="n">flag_bits</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">compress_type</span><span class="p">,</span> <span class="n">dostime</span><span class="p">,</span> <span class="n">dosdate</span><span class="p">,</span>
                        <span class="n">zinfo</span><span class="p">.</span><span class="n">CRC</span><span class="p">,</span> <span class="n">compress_size</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span>
                        <span class="n">len</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">filename</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">extra_data</span><span class="p">),</span> <span class="n">len</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">comment</span><span class="p">),</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">internal_attr</span><span class="p">,</span> <span class="n">zinfo</span><span class="p">.</span><span class="n">external_attr</span><span class="p">,</span>
                        <span class="n">header_offset</span><span class="p">)</span>
                        <span class="n">raise</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">centdir</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">extra_data</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zinfo</span><span class="p">.</span><span class="n">comment</span><span class="p">)</span>

                <span class="n">pos2</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="err">#</span> <span class="n">Write</span> <span class="n">end</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">zip</span><span class="o">-</span><span class="n">archive</span> <span class="n">record</span>
                <span class="n">centDirCount</span> <span class="o">=</span> <span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">filelist</span><span class="p">)</span>
                <span class="n">centDirSize</span> <span class="o">=</span> <span class="n">pos2</span> <span class="o">-</span> <span class="n">pos1</span>
                <span class="n">centDirOffset</span> <span class="o">=</span> <span class="n">pos1</span>
                <span class="n">requires_zip64</span> <span class="o">=</span> <span class="n">None</span>
                <span class="k">if</span> <span class="n">centDirCount</span> <span class="o">&gt;</span> <span class="n">ZIP_FILECOUNT_LIMIT</span><span class="o">:</span>
                    <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Files count&quot;</span>
                <span class="n">elif</span> <span class="n">centDirOffset</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                    <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Central directory offset&quot;</span>
                <span class="n">elif</span> <span class="n">centDirSize</span> <span class="o">&gt;</span> <span class="n">ZIP64_LIMIT</span><span class="o">:</span>
                    <span class="n">requires_zip64</span> <span class="o">=</span> <span class="s">&quot;Central directory size&quot;</span>
                <span class="k">if</span> <span class="n">requires_zip64</span><span class="o">:</span>
                    <span class="err">#</span> <span class="n">Need</span> <span class="n">to</span> <span class="n">write</span> <span class="n">the</span> <span class="n">ZIP64</span> <span class="n">end</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">archive</span> <span class="n">records</span>
                    <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_allowZip64</span><span class="o">:</span>
                        <span class="n">raise</span> <span class="n">LargeZipFile</span><span class="p">(</span><span class="n">requires_zip64</span> <span class="o">+</span>
                                           <span class="s">&quot; would require ZIP64 extensions&quot;</span><span class="p">)</span>
                    <span class="n">zip64endrec</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span>
                            <span class="n">structEndArchive64</span><span class="p">,</span> <span class="n">stringEndArchive64</span><span class="p">,</span>
                            <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">centDirCount</span><span class="p">,</span> <span class="n">centDirCount</span><span class="p">,</span>
                            <span class="n">centDirSize</span><span class="p">,</span> <span class="n">centDirOffset</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zip64endrec</span><span class="p">)</span>

                    <span class="n">zip64locrec</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span>
                            <span class="n">structEndArchive64Locator</span><span class="p">,</span>
                            <span class="n">stringEndArchive64Locator</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">zip64locrec</span><span class="p">)</span>
                    <span class="n">centDirCount</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">centDirCount</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">)</span>
                    <span class="n">centDirSize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">centDirSize</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>
                    <span class="n">centDirOffset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">centDirOffset</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span>

                <span class="n">endrec</span> <span class="o">=</span> <span class="k">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">structEndArchive</span><span class="p">,</span> <span class="n">stringEndArchive</span><span class="p">,</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">centDirCount</span><span class="p">,</span> <span class="n">centDirCount</span><span class="p">,</span>
                                    <span class="n">centDirSize</span><span class="p">,</span> <span class="n">centDirOffset</span><span class="p">,</span> <span class="n">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_comment</span><span class="p">))</span>
                <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">endrec</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_comment</span><span class="p">)</span>
                <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="nl">finally:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">fp</span>
            <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">None</span>
            <span class="k">if</span> <span class="n">not</span> <span class="n">self</span><span class="p">.</span><span class="n">_filePassed</span><span class="o">:</span>
                <span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="kr">class</span> <span class="nx">TarFile</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;The TarFile Class provides an interface to tar archives.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="nx">debug</span> <span class="o">=</span> <span class="mi">0</span>                   <span class="err">#</span> <span class="nx">May</span> <span class="nx">be</span> <span class="nx">set</span> <span class="nx">from</span> <span class="mi">0</span> <span class="p">(</span><span class="nx">no</span> <span class="nx">msgs</span><span class="p">)</span> <span class="nx">to</span> <span class="mi">3</span> <span class="p">(</span><span class="nx">all</span> <span class="nx">msgs</span><span class="p">)</span>

    <span class="nx">dereference</span> <span class="o">=</span> <span class="nx">False</span>         <span class="err">#</span> <span class="nx">If</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">add</span> <span class="nx">content</span> <span class="nx">of</span> <span class="nx">linked</span> <span class="nx">file</span> <span class="nx">to</span> <span class="nx">the</span>
                                <span class="err">#</span> <span class="nx">tar</span> <span class="nx">file</span><span class="p">,</span> <span class="k">else</span> <span class="nx">the</span> <span class="nx">link</span><span class="p">.</span>

    <span class="nx">ignore_zeros</span> <span class="o">=</span> <span class="nx">False</span>        <span class="err">#</span> <span class="nx">If</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">skips</span> <span class="nx">empty</span> <span class="nx">or</span> <span class="nx">invalid</span> <span class="nx">blocks</span> <span class="nx">and</span>
                                <span class="err">#</span> <span class="nx">continues</span> <span class="nx">processing</span><span class="p">.</span>

    <span class="nx">errorlevel</span> <span class="o">=</span> <span class="mi">1</span>              <span class="err">#</span> <span class="nx">If</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fatal</span> <span class="nx">errors</span> <span class="nx">only</span> <span class="nx">appear</span> <span class="k">in</span> <span class="nx">debug</span>
                                <span class="err">#</span> <span class="nx">messages</span> <span class="p">(</span><span class="k">if</span> <span class="nx">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">).</span> <span class="nx">If</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">errors</span>
                                <span class="err">#</span> <span class="nx">are</span> <span class="nx">passed</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">caller</span> <span class="nx">as</span> <span class="nx">exceptions</span><span class="p">.</span>

    <span class="nx">format</span> <span class="o">=</span> <span class="nx">DEFAULT_FORMAT</span>     <span class="err">#</span> <span class="nx">The</span> <span class="nx">format</span> <span class="nx">to</span> <span class="nx">use</span> <span class="nx">when</span> <span class="nx">creating</span> <span class="nx">an</span> <span class="nx">archive</span><span class="p">.</span>

    <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">ENCODING</span>         <span class="err">#</span> <span class="nx">Encoding</span> <span class="k">for</span> <span class="mi">8</span><span class="o">-</span><span class="nx">bit</span> <span class="nx">character</span> <span class="nx">strings</span><span class="p">.</span>

    <span class="nx">errors</span> <span class="o">=</span> <span class="nx">None</span>               <span class="err">#</span> <span class="nb">Error</span> <span class="nx">handler</span> <span class="k">for</span> <span class="nx">unicode</span> <span class="nx">conversion</span><span class="p">.</span>

    <span class="nx">tarinfo</span> <span class="o">=</span> <span class="nx">TarInfo</span>           <span class="err">#</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">TarInfo</span> <span class="kr">class</span> <span class="nx">to</span> <span class="nx">use</span><span class="p">.</span>

    <span class="nx">fileobject</span> <span class="o">=</span> <span class="nx">ExFileObject</span>   <span class="err">#</span> <span class="nx">The</span> <span class="k">default</span> <span class="nx">ExFileObject</span> <span class="kr">class</span> <span class="nx">to</span> <span class="nx">use</span><span class="p">.</span>

    <span class="nx">def</span> <span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">name</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">format</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span>
            <span class="nx">tarinfo</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">dereference</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">ignore_zeros</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span>
            <span class="nx">errors</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">pax_headers</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">errorlevel</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Open an (uncompressed) tar archive `name&#39;. `mode&#39; is either &#39;r&#39; to</span>
<span class="s2">           read from an existing archive, &#39;a&#39; to append data to an existing</span>
<span class="s2">           file or &#39;w&#39; to create a new file overwriting an existing one. `mode&#39;</span>
<span class="s2">           defaults to &#39;r&#39;.</span>
<span class="s2">           If `fileobj&#39; is given, it is used for reading or writing data. If it</span>
<span class="s2">           can be determined, `mode&#39; is overridden by `fileobj&#39;s mode.</span>
<span class="s2">           `fileobj&#39; is not closed, when TarFile is closed.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nx">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="o">:</span> <span class="s2">&quot;r+b&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="o">:</span> <span class="s2">&quot;wb&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nx">mode</span> <span class="nx">not</span> <span class="k">in</span> <span class="nx">modes</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;a&#39; or &#39;w&#39;&quot;</span><span class="p">)</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">mode</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_mode</span> <span class="o">=</span> <span class="nx">modes</span><span class="cp">[</span><span class="nb">mode</span><span class="cp">]</span>

        <span class="k">if</span> <span class="nx">not</span> <span class="nx">fileobj</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span> <span class="nx">and</span> <span class="nx">not</span> <span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="o">:</span>
                <span class="err">#</span> <span class="nx">Create</span> <span class="nx">nonexistent</span> <span class="nx">files</span> <span class="k">in</span> <span class="nx">append</span> <span class="nx">mode</span><span class="p">.</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_mode</span> <span class="o">=</span> <span class="s2">&quot;wb&quot;</span>
            <span class="nx">fileobj</span> <span class="o">=</span> <span class="nx">bltn_open</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_mode</span><span class="p">)</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_extfileobj</span> <span class="o">=</span> <span class="nx">False</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">name</span> <span class="nx">is</span> <span class="nx">None</span> <span class="nx">and</span> <span class="nx">hasattr</span><span class="p">(</span><span class="nx">fileobj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">:</span>
                <span class="nx">name</span> <span class="o">=</span> <span class="nx">fileobj</span><span class="p">.</span><span class="nx">name</span>
            <span class="k">if</span> <span class="nx">hasattr</span><span class="p">(</span><span class="nx">fileobj</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_mode</span> <span class="o">=</span> <span class="nx">fileobj</span><span class="p">.</span><span class="nx">mode</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_extfileobj</span> <span class="o">=</span> <span class="nx">True</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">abspath</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="k">if</span> <span class="nx">name</span> <span class="k">else</span> <span class="nx">None</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span> <span class="o">=</span> <span class="nx">fileobj</span>

        <span class="err">#</span> <span class="nx">Init</span> <span class="nx">attributes</span><span class="p">.</span>
        <span class="k">if</span> <span class="nx">format</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">format</span>
        <span class="k">if</span> <span class="nx">tarinfo</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">tarinfo</span> <span class="o">=</span> <span class="nx">tarinfo</span>
        <span class="k">if</span> <span class="nx">dereference</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">dereference</span> <span class="o">=</span> <span class="nx">dereference</span>
        <span class="k">if</span> <span class="nx">ignore_zeros</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">ignore_zeros</span> <span class="o">=</span> <span class="nx">ignore_zeros</span>
        <span class="k">if</span> <span class="nx">encoding</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">=</span> <span class="nx">encoding</span>

        <span class="k">if</span> <span class="nx">errors</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">errors</span>
        <span class="nx">elif</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="s2">&quot;strict&quot;</span>

        <span class="k">if</span> <span class="nx">pax_headers</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span> <span class="nx">and</span> <span class="nx">self</span><span class="p">.</span><span class="nx">format</span> <span class="o">==</span> <span class="nx">PAX_FORMAT</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">pax_headers</span> <span class="o">=</span> <span class="nx">pax_headers</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">pax_headers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nx">debug</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">debug</span> <span class="o">=</span> <span class="nx">debug</span>
        <span class="k">if</span> <span class="nx">errorlevel</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">errorlevel</span> <span class="o">=</span> <span class="nx">errorlevel</span>

        <span class="err">#</span> <span class="nx">Init</span> <span class="nx">datastructures</span><span class="p">.</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">closed</span> <span class="o">=</span> <span class="nx">False</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">members</span> <span class="o">=</span> <span class="cp">[]</span>       <span class="err">#</span> <span class="nx">list</span> <span class="nx">of</span> <span class="nx">members</span> <span class="nx">as</span> <span class="nx">TarInfo</span> <span class="nx">objects</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_loaded</span> <span class="o">=</span> <span class="nx">False</span>    <span class="err">#</span> <span class="nx">flag</span> <span class="k">if</span> <span class="nx">all</span> <span class="nx">members</span> <span class="nx">have</span> <span class="nx">been</span> <span class="nx">read</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">tell</span><span class="p">()</span>
                                <span class="err">#</span> <span class="nx">current</span> <span class="nx">position</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">archive</span> <span class="nx">file</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">inodes</span> <span class="o">=</span> <span class="p">{}</span>        <span class="err">#</span> <span class="nx">dictionary</span> <span class="nx">caching</span> <span class="nx">the</span> <span class="nx">inodes</span> <span class="nx">of</span>
                                <span class="err">#</span> <span class="nx">archive</span> <span class="nx">members</span> <span class="nx">already</span> <span class="nx">added</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">firstmember</span> <span class="o">=</span> <span class="nx">None</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">firstmember</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>

            <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;a&quot;</span><span class="o">:</span>
                <span class="err">#</span> <span class="nx">Move</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">end</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">archive</span><span class="p">,</span>
                <span class="err">#</span> <span class="nx">before</span> <span class="nx">the</span> <span class="nx">first</span> <span class="nx">empty</span> <span class="nx">block</span><span class="p">.</span>
                <span class="k">while</span> <span class="nx">True</span><span class="o">:</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span>
                    <span class="k">try</span><span class="o">:</span>
                        <span class="nx">tarinfo</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tarinfo</span><span class="p">.</span><span class="nx">fromtarfile</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">members</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">tarinfo</span><span class="p">)</span>
                    <span class="nx">except</span> <span class="nx">EOFHeaderError</span><span class="o">:</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="nx">except</span> <span class="nx">HeaderError</span><span class="p">,</span> <span class="nx">e</span><span class="o">:</span>
                        <span class="nx">raise</span> <span class="nx">ReadError</span><span class="p">(</span><span class="nx">str</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span>

            <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="k">in</span> <span class="s2">&quot;aw&quot;</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">_loaded</span> <span class="o">=</span> <span class="nx">True</span>

                <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pax_headers</span><span class="o">:</span>
                    <span class="nx">buf</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tarinfo</span><span class="p">.</span><span class="nx">create_pax_global_header</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pax_headers</span><span class="p">.</span><span class="nx">copy</span><span class="p">())</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
                    <span class="nx">self</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="nx">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
        <span class="nx">except</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">not</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_extfileobj</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">closed</span> <span class="o">=</span> <span class="nx">True</span>
            <span class="nx">raise</span>

    <span class="nx">def</span> <span class="nx">_getposix</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">format</span> <span class="o">==</span> <span class="nx">USTAR_FORMAT</span>
    <span class="nx">def</span> <span class="nx">_setposix</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span><span class="o">:</span>
        <span class="kr">import</span> <span class="nx">warnings</span>
        <span class="nx">warnings</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;use the format attribute instead&quot;</span><span class="p">,</span> <span class="nx">DeprecationWarning</span><span class="p">,</span>
                      <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">value</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">USTAR_FORMAT</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="nx">GNU_FORMAT</span>
    <span class="nx">posix</span> <span class="o">=</span> <span class="nx">property</span><span class="p">(</span><span class="nx">_getposix</span><span class="p">,</span> <span class="nx">_setposix</span><span class="p">)</span>

    <span class="err">#</span><span class="o">--------------------------------------------------------------------------</span>
    <span class="err">#</span> <span class="nx">Below</span> <span class="nx">are</span> <span class="nx">the</span> <span class="nx">classmethods</span> <span class="nx">which</span> <span class="nx">act</span> <span class="nx">as</span> <span class="nx">alternate</span> <span class="nx">constructors</span> <span class="nx">to</span> <span class="nx">the</span>
    <span class="err">#</span> <span class="nx">TarFile</span> <span class="kr">class</span><span class="p">.</span> <span class="nx">The</span> <span class="nx">open</span><span class="p">()</span> <span class="nx">method</span> <span class="nx">is</span> <span class="nx">the</span> <span class="nx">only</span> <span class="nx">one</span> <span class="nx">that</span> <span class="nx">is</span> <span class="nx">needed</span> <span class="k">for</span>
    <span class="err">#</span> <span class="kr">public</span> <span class="nx">use</span><span class="p">;</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">the</span> <span class="s2">&quot;super&quot;</span><span class="o">-</span><span class="nx">constructor</span> <span class="nx">and</span> <span class="nx">is</span> <span class="nx">able</span> <span class="nx">to</span> <span class="nx">select</span> <span class="nx">an</span>
    <span class="err">#</span> <span class="nx">adequate</span> <span class="s2">&quot;sub&quot;</span><span class="o">-</span><span class="nx">constructor</span> <span class="k">for</span> <span class="nx">a</span> <span class="nx">particular</span> <span class="nx">compression</span> <span class="nx">using</span> <span class="nx">the</span> <span class="nx">mapping</span>
    <span class="err">#</span> <span class="nx">from</span> <span class="nx">OPEN_METH</span><span class="p">.</span>
    <span class="err">#</span>
    <span class="err">#</span> <span class="nx">This</span> <span class="nx">concept</span> <span class="nx">allows</span> <span class="nx">one</span> <span class="nx">to</span> <span class="nx">subclass</span> <span class="nx">TarFile</span> <span class="nx">without</span> <span class="nx">losing</span> <span class="nx">the</span> <span class="nx">comfort</span> <span class="nx">of</span>
    <span class="err">#</span> <span class="nx">the</span> <span class="kr">super</span><span class="o">-</span><span class="nx">constructor</span><span class="p">.</span> <span class="nx">A</span> <span class="nx">sub</span><span class="o">-</span><span class="nx">constructor</span> <span class="nx">is</span> <span class="nx">registered</span> <span class="nx">and</span> <span class="nx">made</span> <span class="nx">available</span>
    <span class="err">#</span> <span class="nx">by</span> <span class="nx">adding</span> <span class="nx">it</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">mapping</span> <span class="k">in</span> <span class="nx">OPEN_METH</span><span class="p">.</span>

    <span class="err">@</span><span class="nx">classmethod</span>
    <span class="nx">def</span> <span class="nx">open</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">name</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">bufsize</span><span class="o">=</span><span class="nx">RECORDSIZE</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Open a tar archive for reading, writing or appending. Return</span>
<span class="s2">           an appropriate TarFile class.</span>

<span class="s2">           mode:</span>
<span class="s2">           &#39;r&#39; or &#39;r:*&#39; open for reading with transparent compression</span>
<span class="s2">           &#39;r:&#39;         open for reading exclusively uncompressed</span>
<span class="s2">           &#39;r:gz&#39;       open for reading with gzip compression</span>
<span class="s2">           &#39;r:bz2&#39;      open for reading with bzip2 compression</span>
<span class="s2">           &#39;a&#39; or &#39;a:&#39;  open for appending, creating the file if necessary</span>
<span class="s2">           &#39;w&#39; or &#39;w:&#39;  open for writing without compression</span>
<span class="s2">           &#39;w:gz&#39;       open for writing with gzip compression</span>
<span class="s2">           &#39;w:bz2&#39;      open for writing with bzip2 compression</span>

<span class="s2">           &#39;r|*&#39;        open a stream of tar blocks with transparent compression</span>
<span class="s2">           &#39;r|&#39;         open an uncompressed stream of tar blocks for reading</span>
<span class="s2">           &#39;r|gz&#39;       open a gzip compressed stream of tar blocks</span>
<span class="s2">           &#39;r|bz2&#39;      open a bzip2 compressed stream of tar blocks</span>
<span class="s2">           &#39;w|&#39;         open an uncompressed stream for writing</span>
<span class="s2">           &#39;w|gz&#39;       open a gzip compressed stream for writing</span>
<span class="s2">           &#39;w|bz2&#39;      open a bzip2 compressed stream for writing</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nx">not</span> <span class="nx">name</span> <span class="nx">and</span> <span class="nx">not</span> <span class="nx">fileobj</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;nothing to open&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">mode</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r:*&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">Find</span> <span class="nx">out</span> <span class="nx">which</span> <span class="o">*</span><span class="nx">open</span><span class="p">()</span> <span class="nx">is</span> <span class="nx">appropriate</span> <span class="k">for</span> <span class="nx">opening</span> <span class="nx">the</span> <span class="nx">file</span><span class="p">.</span>
            <span class="k">for</span> <span class="nx">comptype</span> <span class="k">in</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">OPEN_METH</span><span class="o">:</span>
                <span class="nx">func</span> <span class="o">=</span> <span class="nx">getattr</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">OPEN_METH</span><span class="cp">[</span><span class="nx">comptype</span><span class="cp">]</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">fileobj</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
                    <span class="nx">saved_pos</span> <span class="o">=</span> <span class="nx">fileobj</span><span class="p">.</span><span class="nx">tell</span><span class="p">()</span>
                <span class="k">try</span><span class="o">:</span>
                    <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
                <span class="nx">except</span> <span class="p">(</span><span class="nx">ReadError</span><span class="p">,</span> <span class="nx">CompressionError</span><span class="p">),</span> <span class="nx">e</span><span class="o">:</span>
                    <span class="k">if</span> <span class="nx">fileobj</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
                        <span class="nx">fileobj</span><span class="p">.</span><span class="nx">seek</span><span class="p">(</span><span class="nx">saved_pos</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="nx">raise</span> <span class="nx">ReadError</span><span class="p">(</span><span class="s2">&quot;file could not be opened successfully&quot;</span><span class="p">)</span>

        <span class="nx">elif</span> <span class="s2">&quot;:&quot;</span> <span class="k">in</span> <span class="nx">mode</span><span class="o">:</span>
            <span class="nx">filemode</span><span class="p">,</span> <span class="nx">comptype</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nx">filemode</span> <span class="o">=</span> <span class="nx">filemode</span> <span class="nx">or</span> <span class="s2">&quot;r&quot;</span>
            <span class="nx">comptype</span> <span class="o">=</span> <span class="nx">comptype</span> <span class="nx">or</span> <span class="s2">&quot;tar&quot;</span>

            <span class="err">#</span> <span class="nx">Select</span> <span class="nx">the</span> <span class="o">*</span><span class="nx">open</span><span class="p">()</span> <span class="kd">function</span> <span class="nx">according</span> <span class="nx">to</span>
            <span class="err">#</span> <span class="nx">given</span> <span class="nx">compression</span><span class="p">.</span>
            <span class="k">if</span> <span class="nx">comptype</span> <span class="k">in</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">OPEN_METH</span><span class="o">:</span>
                <span class="nx">func</span> <span class="o">=</span> <span class="nx">getattr</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">OPEN_METH</span><span class="cp">[</span><span class="nx">comptype</span><span class="cp">]</span><span class="p">)</span>
            <span class="k">else</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">CompressionError</span><span class="p">(</span><span class="s2">&quot;unknown compression type %r&quot;</span> <span class="o">%</span> <span class="nx">comptype</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">func</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">filemode</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>

        <span class="nx">elif</span> <span class="s2">&quot;|&quot;</span> <span class="k">in</span> <span class="nx">mode</span><span class="o">:</span>
            <span class="nx">filemode</span><span class="p">,</span> <span class="nx">comptype</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="nx">filemode</span> <span class="o">=</span> <span class="nx">filemode</span> <span class="nx">or</span> <span class="s2">&quot;r&quot;</span>
            <span class="nx">comptype</span> <span class="o">=</span> <span class="nx">comptype</span> <span class="nx">or</span> <span class="s2">&quot;tar&quot;</span>

            <span class="k">if</span> <span class="nx">filemode</span> <span class="nx">not</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39; or &#39;w&#39;&quot;</span><span class="p">)</span>

            <span class="nx">stream</span> <span class="o">=</span> <span class="nx">_Stream</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">filemode</span><span class="p">,</span> <span class="nx">comptype</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="nx">bufsize</span><span class="p">)</span>
            <span class="k">try</span><span class="o">:</span>
                <span class="nx">t</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">filemode</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
            <span class="nx">except</span><span class="o">:</span>
                <span class="nx">stream</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
                <span class="nx">raise</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">_extfileobj</span> <span class="o">=</span> <span class="nx">False</span>
            <span class="k">return</span> <span class="nx">t</span>

        <span class="nx">elif</span> <span class="nx">mode</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="k">return</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">taropen</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>

        <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;undiscernible mode&quot;</span><span class="p">)</span>

    <span class="err">@</span><span class="nx">classmethod</span>
    <span class="nx">def</span> <span class="nx">taropen</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Open uncompressed tar archive name for reading or writing.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">mode</span> <span class="nx">not</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39;, &#39;a&#39; or &#39;w&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">cls</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>

    <span class="err">@</span><span class="nx">classmethod</span>
    <span class="nx">def</span> <span class="nx">gzopen</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Open gzip compressed tar archive name for reading or writing.</span>
<span class="s2">           Appending is not allowed.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">mode</span> <span class="nx">not</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39; or &#39;w&#39;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="kr">import</span> <span class="nx">gzip</span>
            <span class="nx">gzip</span><span class="p">.</span><span class="nx">GzipFile</span>
        <span class="nx">except</span> <span class="p">(</span><span class="nx">ImportError</span><span class="p">,</span> <span class="nx">AttributeError</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">CompressionError</span><span class="p">(</span><span class="s2">&quot;gzip module is not available&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="nx">fileobj</span> <span class="o">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">GzipFile</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">compresslevel</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">)</span>
        <span class="nx">except</span> <span class="nx">OSError</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">fileobj</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span> <span class="nx">and</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">ReadError</span><span class="p">(</span><span class="s2">&quot;not a gzip file&quot;</span><span class="p">)</span>
            <span class="nx">raise</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="nx">t</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">taropen</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
        <span class="nx">except</span> <span class="nx">IOError</span><span class="o">:</span>
            <span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">ReadError</span><span class="p">(</span><span class="s2">&quot;not a gzip file&quot;</span><span class="p">)</span>
            <span class="nx">raise</span>
        <span class="nx">except</span><span class="o">:</span>
            <span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="nx">raise</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">_extfileobj</span> <span class="o">=</span> <span class="nx">False</span>
        <span class="k">return</span> <span class="nx">t</span>

    <span class="err">@</span><span class="nx">classmethod</span>
    <span class="nx">def</span> <span class="nx">bz2open</span><span class="p">(</span><span class="nx">cls</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">compresslevel</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Open bzip2 compressed tar archive name for reading or writing.</span>
<span class="s2">           Appending is not allowed.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">mode</span> <span class="nx">not</span> <span class="k">in</span> <span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">ValueError</span><span class="p">(</span><span class="s2">&quot;mode must be &#39;r&#39; or &#39;w&#39;.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="kr">import</span> <span class="nx">bz2</span>
        <span class="nx">except</span> <span class="nx">ImportError</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">CompressionError</span><span class="p">(</span><span class="s2">&quot;bz2 module is not available&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">fileobj</span> <span class="nx">is</span> <span class="nx">not</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">fileobj</span> <span class="o">=</span> <span class="nx">_BZ2Proxy</span><span class="p">(</span><span class="nx">fileobj</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="nx">fileobj</span> <span class="o">=</span> <span class="nx">bz2</span><span class="p">.</span><span class="nx">BZ2File</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">compresslevel</span><span class="o">=</span><span class="nx">compresslevel</span><span class="p">)</span>

        <span class="k">try</span><span class="o">:</span>
            <span class="nx">t</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">taropen</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">fileobj</span><span class="p">,</span> <span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span>
        <span class="nx">except</span> <span class="p">(</span><span class="nx">IOError</span><span class="p">,</span> <span class="nx">EOFError</span><span class="p">)</span><span class="o">:</span>
            <span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="o">:</span>
                <span class="nx">raise</span> <span class="nx">ReadError</span><span class="p">(</span><span class="s2">&quot;not a bzip2 file&quot;</span><span class="p">)</span>
            <span class="nx">raise</span>
        <span class="nx">except</span><span class="o">:</span>
            <span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="nx">raise</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">_extfileobj</span> <span class="o">=</span> <span class="nx">False</span>
        <span class="k">return</span> <span class="nx">t</span>

    <span class="err">#</span> <span class="nx">All</span> <span class="o">*</span><span class="nx">open</span><span class="p">()</span> <span class="nx">methods</span> <span class="nx">are</span> <span class="nx">registered</span> <span class="nx">here</span><span class="p">.</span>
    <span class="nx">OPEN_METH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tar&quot;</span><span class="o">:</span> <span class="s2">&quot;taropen&quot;</span><span class="p">,</span>   <span class="err">#</span> <span class="nx">uncompressed</span> <span class="nx">tar</span>
        <span class="s2">&quot;gz&quot;</span><span class="o">:</span>  <span class="s2">&quot;gzopen&quot;</span><span class="p">,</span>    <span class="err">#</span> <span class="nx">gzip</span> <span class="nx">compressed</span> <span class="nx">tar</span>
        <span class="s2">&quot;bz2&quot;</span><span class="o">:</span> <span class="s2">&quot;bz2open&quot;</span>    <span class="err">#</span> <span class="nx">bzip2</span> <span class="nx">compressed</span> <span class="nx">tar</span>
    <span class="p">}</span>

    <span class="err">#</span><span class="o">--------------------------------------------------------------------------</span>
    <span class="err">#</span> <span class="nx">The</span> <span class="kr">public</span> <span class="nx">methods</span> <span class="nx">which</span> <span class="nx">TarFile</span> <span class="nx">provides</span><span class="o">:</span>

    <span class="nx">def</span> <span class="nx">close</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Close the TarFile. In write-mode, two finishing zero blocks are</span>
<span class="s2">           appended to the archive.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">closed</span><span class="o">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nx">self</span><span class="p">.</span><span class="nx">mode</span> <span class="k">in</span> <span class="s2">&quot;aw&quot;</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">NUL</span> <span class="o">*</span> <span class="p">(</span><span class="nx">BLOCKSIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">BLOCKSIZE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="err">#</span> <span class="nx">fill</span> <span class="nx">up</span> <span class="nx">the</span> <span class="nx">end</span> <span class="kd">with</span> <span class="nx">zero</span><span class="o">-</span><span class="nx">blocks</span>
            <span class="err">#</span> <span class="p">(</span><span class="nx">like</span> <span class="nx">option</span> <span class="o">-</span><span class="nx">b20</span> <span class="k">for</span> <span class="nx">tar</span> <span class="nx">does</span><span class="p">)</span>
            <span class="nx">blocks</span><span class="p">,</span> <span class="nx">remainder</span> <span class="o">=</span> <span class="nx">divmod</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">offset</span><span class="p">,</span> <span class="nx">RECORDSIZE</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">NUL</span> <span class="o">*</span> <span class="p">(</span><span class="nx">RECORDSIZE</span> <span class="o">-</span> <span class="nx">remainder</span><span class="p">))</span>

        <span class="k">if</span> <span class="nx">not</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_extfileobj</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">closed</span> <span class="o">=</span> <span class="nx">True</span>

    <span class="nx">def</span> <span class="nx">getmember</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Return a TarInfo object for member `name&#39;. If `name&#39; can not be</span>
<span class="s2">           found in the archive, KeyError is raised. If a member occurs more</span>
<span class="s2">           than once in the archive, its last occurrence is assumed to be the</span>
<span class="s2">           most up-to-date version.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nx">tarinfo</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_getmember</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">tarinfo</span> <span class="nx">is</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">raise</span> <span class="nx">KeyError</span><span class="p">(</span><span class="s2">&quot;filename %r not found&quot;</span> <span class="o">%</span> <span class="nx">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">tarinfo</span>

    <span class="nx">def</span> <span class="nx">getmembers</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Return the members of the archive as a list of TarInfo objects. The</span>
<span class="s2">           list has the same order as the members in the archive.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_check</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">not</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_loaded</span><span class="o">:</span>    <span class="err">#</span> <span class="k">if</span> <span class="nx">we</span> <span class="nx">want</span> <span class="nx">to</span> <span class="nx">obtain</span> <span class="nx">a</span> <span class="nx">list</span> <span class="nx">of</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">_load</span><span class="p">()</span>        <span class="err">#</span> <span class="nx">all</span> <span class="nx">members</span><span class="p">,</span> <span class="nx">we</span> <span class="nx">first</span> <span class="nx">have</span> <span class="nx">to</span>
                                <span class="err">#</span> <span class="nx">scan</span> <span class="nx">the</span> <span class="nx">whole</span> <span class="nx">archive</span><span class="p">.</span>
        <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">members</span>

    <span class="nx">def</span> <span class="nx">getnames</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Return the members of the archive as a list of their names. It has</span>
<span class="s2">           the same order as the list returned by getmembers().</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="cp">[</span><span class="nx">tarinfo.name</span> <span class="nb">for</span> <span class="n">tarinfo</span> <span class="k">in</span> <span class="bp">self.</span><span class="nx">getmembers</span><span class="p">()</span><span class="cp">]</span>

    <span class="nx">def</span> <span class="nx">gettarinfo</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">name</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">arcname</span><span class="o">=</span><span class="nx">None</span><span class="p">,</span> <span class="nx">fileobj</span><span class="o">=</span><span class="nx">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s2">&quot;&quot;&quot;Create a TarInfo object for either the file `name&#39; or the file</span>
<span class="s2">           object `fileobj&#39; (using os.fstat on its file descriptor). You can</span>
<span class="s2">           modify some of the TarInfo&#39;s attributes before you add it using</span>
<span class="s2">           addfile(). If given, `arcname&#39; specifies an alternative name for the</span>
<span class="s2">           file in the archive.</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_check</span><span class="p">(</span><span class="s2">&quot;aw&quot;</span><span class="p">)</span>

        <span class="err">#</span> <span class="nx">When</span> <span class="nx">fileobj</span> <span class="nx">is</span> <span class="nx">given</span><span class="p">,</span> <span class="nx">replace</span> <span class="nx">name</span> <span class="nx">by</span>
        <span class="err">#</span> <span class="nx">fileobj</span><span class="s1">&#39;s real name.</span>
<span class="s1">        if fileobj is not None:</span>
<span class="s1">            name = fileobj.name</span>

<span class="s1">        # Building the name of the member in the archive.</span>
<span class="s1">        # Backward slashes are converted to forward slashes,</span>
<span class="s1">        # Absolute paths are turned to relative paths.</span>
<span class="s1">        if arcname is None:</span>
<span class="s1">            arcname = name</span>
<span class="s1">        drv, arcname = os.path.splitdrive(arcname)</span>
<span class="s1">        arcname = arcname.replace(os.sep, &quot;/&quot;)</span>
<span class="s1">        arcname = arcname.lstrip(&quot;/&quot;)</span>

<span class="s1">        # Now, fill the TarInfo object with</span>
<span class="s1">        # information specific for the file.</span>
<span class="s1">        tarinfo = self.tarinfo()</span>
<span class="s1">        tarinfo.tarfile = self</span>

<span class="s1">        # Use os.stat or os.lstat, depending on platform</span>
<span class="s1">        # and if symlinks shall be resolved.</span>
<span class="s1">        if fileobj is None:</span>
<span class="s1">            if hasattr(os, &quot;lstat&quot;) and not self.dereference:</span>
<span class="s1">                statres = os.lstat(name)</span>
<span class="s1">            else:</span>
<span class="s1">                statres = os.stat(name)</span>
<span class="s1">        else:</span>
<span class="s1">            statres = os.fstat(fileobj.fileno())</span>
<span class="s1">        linkname = &quot;&quot;</span>

<span class="s1">        stmd = statres.st_mode</span>
<span class="s1">        if stat.S_ISREG(stmd):</span>
<span class="s1">            inode = (statres.st_ino, statres.st_dev)</span>
<span class="s1">            if not self.dereference and statres.st_nlink &gt; 1 and \</span>
<span class="s1">                    inode in self.inodes and arcname != self.inodes</span><span class="cp">[</span><span class="nx">inode</span><span class="cp">]</span><span class="s1">:</span>
<span class="s1">                # Is it a hardlink to an already</span>
<span class="s1">                # archived file?</span>
<span class="s1">                type = LNKTYPE</span>
<span class="s1">                linkname = self.inodes</span><span class="cp">[</span><span class="nx">inode</span><span class="cp">]</span><span class="s1"></span>
<span class="s1">            else:</span>
<span class="s1">                # The inode is added only if its valid.</span>
<span class="s1">                # For win32 it is always 0.</span>
<span class="s1">                type = REGTYPE</span>
<span class="s1">                if inode</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="s1">:</span>
<span class="s1">                    self.inodes</span><span class="cp">[</span><span class="nx">inode</span><span class="cp">]</span><span class="s1"> = arcname</span>
<span class="s1">        elif stat.S_ISDIR(stmd):</span>
<span class="s1">            type = DIRTYPE</span>
<span class="s1">        elif stat.S_ISFIFO(stmd):</span>
<span class="s1">            type = FIFOTYPE</span>
<span class="s1">        elif stat.S_ISLNK(stmd):</span>
<span class="s1">            type = SYMTYPE</span>
<span class="s1">            linkname = os.readlink(name)</span>
<span class="s1">        elif stat.S_ISCHR(stmd):</span>
<span class="s1">            type = CHRTYPE</span>
<span class="s1">        elif stat.S_ISBLK(stmd):</span>
<span class="s1">            type = BLKTYPE</span>
<span class="s1">        else:</span>
<span class="s1">            return None</span>

<span class="s1">        # Fill the TarInfo object with all</span>
<span class="s1">        # information we can get.</span>
<span class="s1">        tarinfo.name = arcname</span>
<span class="s1">        tarinfo.mode = stmd</span>
<span class="s1">        tarinfo.uid = statres.st_uid</span>
<span class="s1">        tarinfo.gid = statres.st_gid</span>
<span class="s1">        if type == REGTYPE:</span>
<span class="s1">            tarinfo.size = statres.st_size</span>
<span class="s1">        else:</span>
<span class="s1">            tarinfo.size = 0L</span>
<span class="s1">        tarinfo.mtime = statres.st_mtime</span>
<span class="s1">        tarinfo.type = type</span>
<span class="s1">        tarinfo.linkname = linkname</span>
<span class="s1">        if pwd:</span>
<span class="s1">            try:</span>
<span class="s1">                tarinfo.uname = pwd.getpwuid(tarinfo.uid)</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="s1"></span>
<span class="s1">            except KeyError:</span>
<span class="s1">                pass</span>
<span class="s1">        if grp:</span>
<span class="s1">            try:</span>
<span class="s1">                tarinfo.gname = grp.getgrgid(tarinfo.gid)</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="s1"></span>
<span class="s1">            except KeyError:</span>
<span class="s1">                pass</span>

<span class="s1">        if type in (CHRTYPE, BLKTYPE):</span>
<span class="s1">            if hasattr(os, &quot;major&quot;) and hasattr(os, &quot;minor&quot;):</span>
<span class="s1">                tarinfo.devmajor = os.major(statres.st_rdev)</span>
<span class="s1">                tarinfo.devminor = os.minor(statres.st_rdev)</span>
<span class="s1">        return tarinfo</span>

<span class="s1">    def list(self, verbose=True):</span>
<span class="s1">        &quot;&quot;&quot;Print a table of contents to sys.stdout. If `verbose&#39;</span> <span class="nx">is</span> <span class="nx">False</span><span class="p">,</span> <span class="nx">only</span>
           <span class="nx">the</span> <span class="nx">names</span> <span class="nx">of</span> <span class="nx">the</span> <span class="nx">members</span> <span class="nx">are</span> <span class="nx">printed</span><span class="p">.</span> <span class="nx">If</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">True</span><span class="p">,</span> <span class="nx">an</span> <span class="err">`</span><span class="nx">ls</span> <span class="o">-</span><span class="nx">l</span><span class="s1">&#39;-like</span>
<span class="s1">           output is produced.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        self._check()</span>

<span class="s1">        for tarinfo in self:</span>
<span class="s1">            if verbose:</span>
<span class="s1">                print filemode(tarinfo.mode),</span>
<span class="s1">                print &quot;%s/%s&quot; % (tarinfo.uname or tarinfo.uid,</span>
<span class="s1">                                 tarinfo.gname or tarinfo.gid),</span>
<span class="s1">                if tarinfo.ischr() or tarinfo.isblk():</span>
<span class="s1">                    print &quot;%10s&quot; % (&quot;%d,%d&quot; \</span>
<span class="s1">                                    % (tarinfo.devmajor, tarinfo.devminor)),</span>
<span class="s1">                else:</span>
<span class="s1">                    print &quot;%10d&quot; % tarinfo.size,</span>
<span class="s1">                print &quot;%d-%02d-%02d %02d:%02d:%02d&quot; \</span>
<span class="s1">                      % time.localtime(tarinfo.mtime)</span><span class="cp">[</span><span class="p">:</span><span class="mi">6</span><span class="cp">]</span><span class="s1">,</span>

<span class="s1">            print tarinfo.name + (&quot;/&quot; if tarinfo.isdir() else &quot;&quot;),</span>

<span class="s1">            if verbose:</span>
<span class="s1">                if tarinfo.issym():</span>
<span class="s1">                    print &quot;-&gt;&quot;, tarinfo.linkname,</span>
<span class="s1">                if tarinfo.islnk():</span>
<span class="s1">                    print &quot;link to&quot;, tarinfo.linkname,</span>
<span class="s1">            print</span>

<span class="s1">    def add(self, name, arcname=None, recursive=True, exclude=None, filter=None):</span>
<span class="s1">        &quot;&quot;&quot;Add the file `name&#39;</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">archive</span><span class="p">.</span> <span class="err">`</span><span class="nx">name</span><span class="s1">&#39; may be any type of file</span>
<span class="s1">           (directory, fifo, symbolic link, etc.). If given, `arcname&#39;</span>
           <span class="nx">specifies</span> <span class="nx">an</span> <span class="nx">alternative</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">the</span> <span class="nx">archive</span><span class="p">.</span>
           <span class="nx">Directories</span> <span class="nx">are</span> <span class="nx">added</span> <span class="nx">recursively</span> <span class="nx">by</span> <span class="k">default</span><span class="p">.</span> <span class="nx">This</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">avoided</span> <span class="nx">by</span>
           <span class="nx">setting</span> <span class="err">`</span><span class="nx">recursive</span><span class="s1">&#39; to False. `exclude&#39;</span> <span class="nx">is</span> <span class="nx">a</span> <span class="kd">function</span> <span class="nx">that</span> <span class="nx">should</span>
           <span class="k">return</span> <span class="nx">True</span> <span class="k">for</span> <span class="nx">each</span> <span class="nx">filename</span> <span class="nx">to</span> <span class="nx">be</span> <span class="nx">excluded</span><span class="p">.</span> <span class="err">`</span><span class="nx">filter</span><span class="s1">&#39; is a function</span>
<span class="s1">           that expects a TarInfo object argument and returns the changed</span>
<span class="s1">           TarInfo object, if it returns None the TarInfo object will be</span>
<span class="s1">           excluded from the archive.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        self._check(&quot;aw&quot;)</span>

<span class="s1">        if arcname is None:</span>
<span class="s1">            arcname = name</span>

<span class="s1">        # Exclude pathnames.</span>
<span class="s1">        if exclude is not None:</span>
<span class="s1">            import warnings</span>
<span class="s1">            warnings.warn(&quot;use the filter argument instead&quot;,</span>
<span class="s1">                    DeprecationWarning, 2)</span>
<span class="s1">            if exclude(name):</span>
<span class="s1">                self._dbg(2, &quot;tarfile: Excluded %r&quot; % name)</span>
<span class="s1">                return</span>

<span class="s1">        # Skip if somebody tries to archive the archive...</span>
<span class="s1">        if self.name is not None and os.path.abspath(name) == self.name:</span>
<span class="s1">            self._dbg(2, &quot;tarfile: Skipped %r&quot; % name)</span>
<span class="s1">            return</span>

<span class="s1">        self._dbg(1, name)</span>

<span class="s1">        # Create a TarInfo object from the file.</span>
<span class="s1">        tarinfo = self.gettarinfo(name, arcname)</span>

<span class="s1">        if tarinfo is None:</span>
<span class="s1">            self._dbg(1, &quot;tarfile: Unsupported type %r&quot; % name)</span>
<span class="s1">            return</span>

<span class="s1">        # Change or exclude the TarInfo object.</span>
<span class="s1">        if filter is not None:</span>
<span class="s1">            tarinfo = filter(tarinfo)</span>
<span class="s1">            if tarinfo is None:</span>
<span class="s1">                self._dbg(2, &quot;tarfile: Excluded %r&quot; % name)</span>
<span class="s1">                return</span>

<span class="s1">        # Append the tar header and data to the archive.</span>
<span class="s1">        if tarinfo.isreg():</span>
<span class="s1">            with bltn_open(name, &quot;rb&quot;) as f:</span>
<span class="s1">                self.addfile(tarinfo, f)</span>

<span class="s1">        elif tarinfo.isdir():</span>
<span class="s1">            self.addfile(tarinfo)</span>
<span class="s1">            if recursive:</span>
<span class="s1">                for f in os.listdir(name):</span>
<span class="s1">                    self.add(os.path.join(name, f), os.path.join(arcname, f),</span>
<span class="s1">                            recursive, exclude, filter)</span>

<span class="s1">        else:</span>
<span class="s1">            self.addfile(tarinfo)</span>

<span class="s1">    def addfile(self, tarinfo, fileobj=None):</span>
<span class="s1">        &quot;&quot;&quot;Add the TarInfo object `tarinfo&#39;</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">archive</span><span class="p">.</span> <span class="nx">If</span> <span class="err">`</span><span class="nx">fileobj</span><span class="s1">&#39; is</span>
<span class="s1">           given, tarinfo.size bytes are read from it and added to the archive.</span>
<span class="s1">           You can create TarInfo objects using gettarinfo().</span>
<span class="s1">           On Windows platforms, `fileobj&#39;</span> <span class="nx">should</span> <span class="nx">always</span> <span class="nx">be</span> <span class="nx">opened</span> <span class="kd">with</span> <span class="nx">mode</span>
           <span class="s1">&#39;rb&#39;</span> <span class="nx">to</span> <span class="nx">avoid</span> <span class="nx">irritation</span> <span class="nx">about</span> <span class="nx">the</span> <span class="nx">file</span> <span class="nx">size</span><span class="p">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        self._check(&quot;</span><span class="nx">aw</span><span class="s2">&quot;)</span>

<span class="s2">        tarinfo = copy.copy(tarinfo)</span>

<span class="s2">        buf = tarinfo.tobuf(self.format, self.encoding, self.errors)</span>
<span class="s2">        self.fileobj.write(buf)</span>
<span class="s2">        self.offset += len(buf)</span>

<span class="s2">        # If there&#39;s data to follow, append it.</span>
<span class="s2">        if fileobj is not None:</span>
<span class="s2">            copyfileobj(fileobj, self.fileobj, tarinfo.size)</span>
<span class="s2">            blocks, remainder = divmod(tarinfo.size, BLOCKSIZE)</span>
<span class="s2">            if remainder &gt; 0:</span>
<span class="s2">                self.fileobj.write(NUL * (BLOCKSIZE - remainder))</span>
<span class="s2">                blocks += 1</span>
<span class="s2">            self.offset += blocks * BLOCKSIZE</span>

<span class="s2">        self.members.append(tarinfo)</span>

<span class="s2">    def extractall(self, path=&quot;</span><span class="p">.</span><span class="s2">&quot;, members=None):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Extract</span> <span class="nx">all</span> <span class="nx">members</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">archive</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">working</span>
           <span class="nx">directory</span> <span class="nx">and</span> <span class="nx">set</span> <span class="nx">owner</span><span class="p">,</span> <span class="nx">modification</span> <span class="nx">time</span> <span class="nx">and</span> <span class="nx">permissions</span> <span class="nx">on</span>
           <span class="nx">directories</span> <span class="nx">afterwards</span><span class="p">.</span> <span class="err">`</span><span class="nx">path</span><span class="s1">&#39; specifies a different directory</span>
<span class="s1">           to extract to. `members&#39;</span> <span class="nx">is</span> <span class="nx">optional</span> <span class="nx">and</span> <span class="nx">must</span> <span class="nx">be</span> <span class="nx">a</span> <span class="nx">subset</span> <span class="nx">of</span> <span class="nx">the</span>
           <span class="nx">list</span> <span class="nx">returned</span> <span class="nx">by</span> <span class="nx">getmembers</span><span class="p">().</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        directories = </span><span class="cp">[]</span><span class="s2"></span>

<span class="s2">        if members is None:</span>
<span class="s2">            members = self</span>

<span class="s2">        for tarinfo in members:</span>
<span class="s2">            if tarinfo.isdir():</span>
<span class="s2">                # Extract directories with a safe mode.</span>
<span class="s2">                directories.append(tarinfo)</span>
<span class="s2">                tarinfo = copy.copy(tarinfo)</span>
<span class="s2">                tarinfo.mode = 0700</span>
<span class="s2">            self.extract(tarinfo, path)</span>

<span class="s2">        # Reverse sort directories.</span>
<span class="s2">        directories.sort(key=operator.attrgetter(&#39;name&#39;))</span>
<span class="s2">        directories.reverse()</span>

<span class="s2">        # Set correct owner, mtime and filemode on directories.</span>
<span class="s2">        for tarinfo in directories:</span>
<span class="s2">            dirpath = os.path.join(path, tarinfo.name)</span>
<span class="s2">            try:</span>
<span class="s2">                self.chown(tarinfo, dirpath)</span>
<span class="s2">                self.utime(tarinfo, dirpath)</span>
<span class="s2">                self.chmod(tarinfo, dirpath)</span>
<span class="s2">            except ExtractError, e:</span>
<span class="s2">                if self.errorlevel &gt; 1:</span>
<span class="s2">                    raise</span>
<span class="s2">                else:</span>
<span class="s2">                    self._dbg(1, &quot;</span><span class="nx">tarfile</span><span class="o">:</span> <span class="o">%</span><span class="nx">s</span><span class="s2">&quot; % e)</span>

<span class="s2">    def extract(self, member, path=&quot;&quot;):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Extract</span> <span class="nx">a</span> <span class="nx">member</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">archive</span> <span class="nx">to</span> <span class="nx">the</span> <span class="nx">current</span> <span class="nx">working</span> <span class="nx">directory</span><span class="p">,</span>
           <span class="nx">using</span> <span class="nx">its</span> <span class="nx">full</span> <span class="nx">name</span><span class="p">.</span> <span class="nx">Its</span> <span class="nx">file</span> <span class="nx">information</span> <span class="nx">is</span> <span class="nx">extracted</span> <span class="nx">as</span> <span class="nx">accurately</span>
           <span class="nx">as</span> <span class="nx">possible</span><span class="p">.</span> <span class="err">`</span><span class="nx">member</span><span class="s1">&#39; may be a filename or a TarInfo object. You can</span>
<span class="s1">           specify a different directory using `path&#39;</span><span class="p">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        self._check(&quot;</span><span class="nx">r</span><span class="s2">&quot;)</span>

<span class="s2">        if isinstance(member, basestring):</span>
<span class="s2">            tarinfo = self.getmember(member)</span>
<span class="s2">        else:</span>
<span class="s2">            tarinfo = member</span>

<span class="s2">        # Prepare the link target for makelink().</span>
<span class="s2">        if tarinfo.islnk():</span>
<span class="s2">            tarinfo._link_target = os.path.join(path, tarinfo.linkname)</span>

<span class="s2">        try:</span>
<span class="s2">            self._extract_member(tarinfo, os.path.join(path, tarinfo.name))</span>
<span class="s2">        except EnvironmentError, e:</span>
<span class="s2">            if self.errorlevel &gt; 0:</span>
<span class="s2">                raise</span>
<span class="s2">            else:</span>
<span class="s2">                if e.filename is None:</span>
<span class="s2">                    self._dbg(1, &quot;</span><span class="nx">tarfile</span><span class="o">:</span> <span class="o">%</span><span class="nx">s</span><span class="s2">&quot; % e.strerror)</span>
<span class="s2">                else:</span>
<span class="s2">                    self._dbg(1, &quot;</span><span class="nx">tarfile</span><span class="o">:</span> <span class="o">%</span><span class="nx">s</span> <span class="o">%</span><span class="nx">r</span><span class="s2">&quot; % (e.strerror, e.filename))</span>
<span class="s2">        except ExtractError, e:</span>
<span class="s2">            if self.errorlevel &gt; 1:</span>
<span class="s2">                raise</span>
<span class="s2">            else:</span>
<span class="s2">                self._dbg(1, &quot;</span><span class="nx">tarfile</span><span class="o">:</span> <span class="o">%</span><span class="nx">s</span><span class="s2">&quot; % e)</span>

<span class="s2">    def extractfile(self, member):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Extract</span> <span class="nx">a</span> <span class="nx">member</span> <span class="nx">from</span> <span class="nx">the</span> <span class="nx">archive</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">file</span> <span class="nx">object</span><span class="p">.</span> <span class="err">`</span><span class="nx">member</span><span class="s1">&#39; may be</span>
<span class="s1">           a filename or a TarInfo object. If `member&#39;</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">regular</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">a</span>
           <span class="nx">file</span><span class="o">-</span><span class="nx">like</span> <span class="nx">object</span> <span class="nx">is</span> <span class="nx">returned</span><span class="p">.</span> <span class="nx">If</span> <span class="err">`</span><span class="nx">member</span><span class="s1">&#39; is a link, a file-like</span>
<span class="s1">           object is constructed from the link&#39;</span><span class="nx">s</span> <span class="nx">target</span><span class="p">.</span> <span class="nx">If</span> <span class="err">`</span><span class="nx">member</span><span class="s1">&#39; is none of</span>
<span class="s1">           the above, None is returned.</span>
<span class="s1">           The file-like object is read-only and provides the following</span>
<span class="s1">           methods: read(), readline(), readlines(), seek() and tell()</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        self._check(&quot;r&quot;)</span>

<span class="s1">        if isinstance(member, basestring):</span>
<span class="s1">            tarinfo = self.getmember(member)</span>
<span class="s1">        else:</span>
<span class="s1">            tarinfo = member</span>

<span class="s1">        if tarinfo.isreg():</span>
<span class="s1">            return self.fileobject(self, tarinfo)</span>

<span class="s1">        elif tarinfo.type not in SUPPORTED_TYPES:</span>
<span class="s1">            # If a member&#39;</span><span class="nx">s</span> <span class="nx">type</span> <span class="nx">is</span> <span class="nx">unknown</span><span class="p">,</span> <span class="nx">it</span> <span class="nx">is</span> <span class="nx">treated</span> <span class="nx">as</span> <span class="nx">a</span>
            <span class="err">#</span> <span class="nx">regular</span> <span class="nx">file</span><span class="p">.</span>
            <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">fileobject</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">tarinfo</span><span class="p">)</span>

        <span class="nx">elif</span> <span class="nx">tarinfo</span><span class="p">.</span><span class="nx">islnk</span><span class="p">()</span> <span class="nx">or</span> <span class="nx">tarinfo</span><span class="p">.</span><span class="nx">issym</span><span class="p">()</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">isinstance</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">,</span> <span class="nx">_Stream</span><span class="p">)</span><span class="o">:</span>
                <span class="err">#</span> <span class="nx">A</span> <span class="nx">small</span> <span class="nx">but</span> <span class="nx">ugly</span> <span class="nx">workaround</span> <span class="k">for</span> <span class="nx">the</span> <span class="k">case</span> <span class="nx">that</span> <span class="nx">someone</span> <span class="nx">tries</span>
                <span class="err">#</span> <span class="nx">to</span> <span class="nx">extract</span> <span class="nx">a</span> <span class="p">(</span><span class="nx">sym</span><span class="p">)</span><span class="nx">link</span> <span class="nx">as</span> <span class="nx">a</span> <span class="nx">file</span><span class="o">-</span><span class="nx">object</span> <span class="nx">from</span> <span class="nx">a</span> <span class="nx">non</span><span class="o">-</span><span class="nx">seekable</span>
                <span class="err">#</span> <span class="nx">stream</span> <span class="nx">of</span> <span class="nx">tar</span> <span class="nx">blocks</span><span class="p">.</span>
                <span class="nx">raise</span> <span class="nx">StreamError</span><span class="p">(</span><span class="s2">&quot;cannot extract (sym)link as file object&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="o">:</span>
                <span class="err">#</span> <span class="nx">A</span> <span class="p">(</span><span class="nx">sym</span><span class="p">)</span><span class="nx">link</span><span class="s1">&#39;s file object is its target&#39;</span><span class="nx">s</span> <span class="nx">file</span> <span class="nx">object</span><span class="p">.</span>
                <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">extractfile</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">_find_link_target</span><span class="p">(</span><span class="nx">tarinfo</span><span class="p">))</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">If</span> <span class="nx">there</span><span class="s1">&#39;s no data associated with the member (directory, chrdev,</span>
<span class="s1">            # blkdev, etc.), return None instead of a file object.</span>
<span class="s1">            return None</span>

<span class="s1">    def _extract_member(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Extract the TarInfo object tarinfo to a physical</span>
<span class="s1">           file called targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        # Fetch the TarInfo object for the given name</span>
<span class="s1">        # and build the destination pathname, replacing</span>
<span class="s1">        # forward slashes to platform specific separators.</span>
<span class="s1">        targetpath = targetpath.rstrip(&quot;/&quot;)</span>
<span class="s1">        targetpath = targetpath.replace(&quot;/&quot;, os.sep)</span>

<span class="s1">        # Create all upper directories.</span>
<span class="s1">        upperdirs = os.path.dirname(targetpath)</span>
<span class="s1">        if upperdirs and not os.path.exists(upperdirs):</span>
<span class="s1">            # Create directories that are not part of the archive with</span>
<span class="s1">            # default permissions.</span>
<span class="s1">            os.makedirs(upperdirs)</span>

<span class="s1">        if tarinfo.islnk() or tarinfo.issym():</span>
<span class="s1">            self._dbg(1, &quot;%s -&gt; %s&quot; % (tarinfo.name, tarinfo.linkname))</span>
<span class="s1">        else:</span>
<span class="s1">            self._dbg(1, tarinfo.name)</span>

<span class="s1">        if tarinfo.isreg():</span>
<span class="s1">            self.makefile(tarinfo, targetpath)</span>
<span class="s1">        elif tarinfo.isdir():</span>
<span class="s1">            self.makedir(tarinfo, targetpath)</span>
<span class="s1">        elif tarinfo.isfifo():</span>
<span class="s1">            self.makefifo(tarinfo, targetpath)</span>
<span class="s1">        elif tarinfo.ischr() or tarinfo.isblk():</span>
<span class="s1">            self.makedev(tarinfo, targetpath)</span>
<span class="s1">        elif tarinfo.islnk() or tarinfo.issym():</span>
<span class="s1">            self.makelink(tarinfo, targetpath)</span>
<span class="s1">        elif tarinfo.type not in SUPPORTED_TYPES:</span>
<span class="s1">            self.makeunknown(tarinfo, targetpath)</span>
<span class="s1">        else:</span>
<span class="s1">            self.makefile(tarinfo, targetpath)</span>

<span class="s1">        self.chown(tarinfo, targetpath)</span>
<span class="s1">        if not tarinfo.issym():</span>
<span class="s1">            self.chmod(tarinfo, targetpath)</span>
<span class="s1">            self.utime(tarinfo, targetpath)</span>

<span class="s1">    #--------------------------------------------------------------------------</span>
<span class="s1">    # Below are the different file methods. They are called via</span>
<span class="s1">    # _extract_member() when extract() is called. They can be replaced in a</span>
<span class="s1">    # subclass to implement other functionality.</span>

<span class="s1">    def makedir(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a directory called targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        try:</span>
<span class="s1">            # Use a safe mode for the directory, the real mode is set</span>
<span class="s1">            # later in _extract_member().</span>
<span class="s1">            os.mkdir(targetpath, 0700)</span>
<span class="s1">        except EnvironmentError, e:</span>
<span class="s1">            if e.errno != errno.EEXIST:</span>
<span class="s1">                raise</span>

<span class="s1">    def makefile(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a file called targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        source = self.extractfile(tarinfo)</span>
<span class="s1">        try:</span>
<span class="s1">            with bltn_open(targetpath, &quot;wb&quot;) as target:</span>
<span class="s1">                copyfileobj(source, target)</span>
<span class="s1">        finally:</span>
<span class="s1">            source.close()</span>

<span class="s1">    def makeunknown(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a file from a TarInfo object with an unknown type</span>
<span class="s1">           at targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        self.makefile(tarinfo, targetpath)</span>
<span class="s1">        self._dbg(1, &quot;tarfile: Unknown file type %r, &quot; \</span>
<span class="s1">                     &quot;extracted as regular file.&quot; % tarinfo.type)</span>

<span class="s1">    def makefifo(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a fifo called targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if hasattr(os, &quot;mkfifo&quot;):</span>
<span class="s1">            os.mkfifo(targetpath)</span>
<span class="s1">        else:</span>
<span class="s1">            raise ExtractError(&quot;fifo not supported by system&quot;)</span>

<span class="s1">    def makedev(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a character or block device called targetpath.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if not hasattr(os, &quot;mknod&quot;) or not hasattr(os, &quot;makedev&quot;):</span>
<span class="s1">            raise ExtractError(&quot;special devices not supported by system&quot;)</span>

<span class="s1">        mode = tarinfo.mode</span>
<span class="s1">        if tarinfo.isblk():</span>
<span class="s1">            mode |= stat.S_IFBLK</span>
<span class="s1">        else:</span>
<span class="s1">            mode |= stat.S_IFCHR</span>

<span class="s1">        os.mknod(targetpath, mode,</span>
<span class="s1">                 os.makedev(tarinfo.devmajor, tarinfo.devminor))</span>

<span class="s1">    def makelink(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Make a (symbolic) link called targetpath. If it cannot be created</span>
<span class="s1">          (platform limitation), we try to make a copy of the referenced file</span>
<span class="s1">          instead of a link.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if hasattr(os, &quot;symlink&quot;) and hasattr(os, &quot;link&quot;):</span>
<span class="s1">            # For systems that support symbolic and hard links.</span>
<span class="s1">            if tarinfo.issym():</span>
<span class="s1">                if os.path.lexists(targetpath):</span>
<span class="s1">                    os.unlink(targetpath)</span>
<span class="s1">                os.symlink(tarinfo.linkname, targetpath)</span>
<span class="s1">            else:</span>
<span class="s1">                # See extract().</span>
<span class="s1">                if os.path.exists(tarinfo._link_target):</span>
<span class="s1">                    if os.path.lexists(targetpath):</span>
<span class="s1">                        os.unlink(targetpath)</span>
<span class="s1">                    os.link(tarinfo._link_target, targetpath)</span>
<span class="s1">                else:</span>
<span class="s1">                    self._extract_member(self._find_link_target(tarinfo), targetpath)</span>
<span class="s1">        else:</span>
<span class="s1">            try:</span>
<span class="s1">                self._extract_member(self._find_link_target(tarinfo), targetpath)</span>
<span class="s1">            except KeyError:</span>
<span class="s1">                raise ExtractError(&quot;unable to resolve link inside archive&quot;)</span>

<span class="s1">    def chown(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Set owner of targetpath according to tarinfo.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if pwd and hasattr(os, &quot;geteuid&quot;) and os.geteuid() == 0:</span>
<span class="s1">            # We have to be root to do so.</span>
<span class="s1">            try:</span>
<span class="s1">                g = grp.getgrnam(tarinfo.gname)</span><span class="cp">[</span><span class="mi">2</span><span class="cp">]</span><span class="s1"></span>
<span class="s1">            except KeyError:</span>
<span class="s1">                g = tarinfo.gid</span>
<span class="s1">            try:</span>
<span class="s1">                u = pwd.getpwnam(tarinfo.uname)</span><span class="cp">[</span><span class="mi">2</span><span class="cp">]</span><span class="s1"></span>
<span class="s1">            except KeyError:</span>
<span class="s1">                u = tarinfo.uid</span>
<span class="s1">            try:</span>
<span class="s1">                if tarinfo.issym() and hasattr(os, &quot;lchown&quot;):</span>
<span class="s1">                    os.lchown(targetpath, u, g)</span>
<span class="s1">                else:</span>
<span class="s1">                    if sys.platform != &quot;os2emx&quot;:</span>
<span class="s1">                        os.chown(targetpath, u, g)</span>
<span class="s1">            except EnvironmentError, e:</span>
<span class="s1">                raise ExtractError(&quot;could not change owner&quot;)</span>

<span class="s1">    def chmod(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Set file permissions of targetpath according to tarinfo.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if hasattr(os, &#39;</span><span class="nx">chmod</span><span class="s1">&#39;):</span>
<span class="s1">            try:</span>
<span class="s1">                os.chmod(targetpath, tarinfo.mode)</span>
<span class="s1">            except EnvironmentError, e:</span>
<span class="s1">                raise ExtractError(&quot;could not change mode&quot;)</span>

<span class="s1">    def utime(self, tarinfo, targetpath):</span>
<span class="s1">        &quot;&quot;&quot;Set modification time of targetpath according to tarinfo.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        if not hasattr(os, &#39;</span><span class="nx">utime</span><span class="s1">&#39;):</span>
<span class="s1">            return</span>
<span class="s1">        try:</span>
<span class="s1">            os.utime(targetpath, (tarinfo.mtime, tarinfo.mtime))</span>
<span class="s1">        except EnvironmentError, e:</span>
<span class="s1">            raise ExtractError(&quot;could not change modification time&quot;)</span>

<span class="s1">    #--------------------------------------------------------------------------</span>
<span class="s1">    def next(self):</span>
<span class="s1">        &quot;&quot;&quot;Return the next member of the archive as a TarInfo object, when</span>
<span class="s1">           TarFile is opened for reading. Return None if there is no more</span>
<span class="s1">           available.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        self._check(&quot;ra&quot;)</span>
<span class="s1">        if self.firstmember is not None:</span>
<span class="s1">            m = self.firstmember</span>
<span class="s1">            self.firstmember = None</span>
<span class="s1">            return m</span>

<span class="s1">        # Read the next block.</span>
<span class="s1">        self.fileobj.seek(self.offset)</span>
<span class="s1">        tarinfo = None</span>
<span class="s1">        while True:</span>
<span class="s1">            try:</span>
<span class="s1">                tarinfo = self.tarinfo.fromtarfile(self)</span>
<span class="s1">            except EOFHeaderError, e:</span>
<span class="s1">                if self.ignore_zeros:</span>
<span class="s1">                    self._dbg(2, &quot;0x%X: %s&quot; % (self.offset, e))</span>
<span class="s1">                    self.offset += BLOCKSIZE</span>
<span class="s1">                    continue</span>
<span class="s1">            except InvalidHeaderError, e:</span>
<span class="s1">                if self.ignore_zeros:</span>
<span class="s1">                    self._dbg(2, &quot;0x%X: %s&quot; % (self.offset, e))</span>
<span class="s1">                    self.offset += BLOCKSIZE</span>
<span class="s1">                    continue</span>
<span class="s1">                elif self.offset == 0:</span>
<span class="s1">                    raise ReadError(str(e))</span>
<span class="s1">            except EmptyHeaderError:</span>
<span class="s1">                if self.offset == 0:</span>
<span class="s1">                    raise ReadError(&quot;empty file&quot;)</span>
<span class="s1">            except TruncatedHeaderError, e:</span>
<span class="s1">                if self.offset == 0:</span>
<span class="s1">                    raise ReadError(str(e))</span>
<span class="s1">            except SubsequentHeaderError, e:</span>
<span class="s1">                raise ReadError(str(e))</span>
<span class="s1">            break</span>

<span class="s1">        if tarinfo is not None:</span>
<span class="s1">            self.members.append(tarinfo)</span>
<span class="s1">        else:</span>
<span class="s1">            self._loaded = True</span>

<span class="s1">        return tarinfo</span>

<span class="s1">    #--------------------------------------------------------------------------</span>
<span class="s1">    # Little helper methods:</span>

<span class="s1">    def _getmember(self, name, tarinfo=None, normalize=False):</span>
<span class="s1">        &quot;&quot;&quot;Find an archive member by name from bottom to top.</span>
<span class="s1">           If tarinfo is given, it is used as the starting point.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        # Ensure that all members have been loaded.</span>
<span class="s1">        members = self.getmembers()</span>

<span class="s1">        # Limit the member search list up to tarinfo.</span>
<span class="s1">        if tarinfo is not None:</span>
<span class="s1">            members = members</span><span class="cp">[</span><span class="p">:</span><span class="nx">members.index</span><span class="p">(</span><span class="nx">tarinfo</span><span class="p">)</span><span class="cp">]</span><span class="s1"></span>

<span class="s1">        if normalize:</span>
<span class="s1">            name = os.path.normpath(name)</span>

<span class="s1">        for member in reversed(members):</span>
<span class="s1">            if normalize:</span>
<span class="s1">                member_name = os.path.normpath(member.name)</span>
<span class="s1">            else:</span>
<span class="s1">                member_name = member.name</span>

<span class="s1">            if name == member_name:</span>
<span class="s1">                return member</span>

<span class="s1">    def _load(self):</span>
<span class="s1">        &quot;&quot;&quot;Read through the entire archive file and look for readable</span>
<span class="s1">           members.</span>
<span class="s1">        &quot;&quot;&quot;</span>
<span class="s1">        while True:</span>
<span class="s1">            tarinfo = self.next()</span>
<span class="s1">            if tarinfo is None:</span>
<span class="s1">                break</span>
<span class="s1">        self._loaded = True</span>

<span class="s1">    def _check(self, mode=None):</span>
<span class="s1">        &quot;&quot;&quot;Check if TarFile is still open, and if the operation&#39;</span><span class="nx">s</span> <span class="nx">mode</span>
           <span class="nx">corresponds</span> <span class="nx">to</span> <span class="nx">TarFile</span><span class="err">&#39;</span><span class="nx">s</span> <span class="nx">mode</span><span class="p">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if self.closed:</span>
<span class="s2">            raise IOError(&quot;</span><span class="o">%</span><span class="nx">s</span> <span class="nx">is</span> <span class="nx">closed</span><span class="s2">&quot; % self.__class__.__name__)</span>
<span class="s2">        if mode is not None and self.mode not in mode:</span>
<span class="s2">            raise IOError(&quot;</span><span class="nx">bad</span> <span class="nx">operation</span> <span class="k">for</span> <span class="nx">mode</span> <span class="o">%</span><span class="nx">r</span><span class="s2">&quot; % self.mode)</span>

<span class="s2">    def _find_link_target(self, tarinfo):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Find</span> <span class="nx">the</span> <span class="nx">target</span> <span class="nx">member</span> <span class="nx">of</span> <span class="nx">a</span> <span class="nx">symlink</span> <span class="nx">or</span> <span class="nx">hardlink</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">the</span>
           <span class="nx">archive</span><span class="p">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if tarinfo.issym():</span>
<span class="s2">            # Always search the entire archive.</span>
<span class="s2">            linkname = &quot;</span><span class="o">/</span><span class="s2">&quot;.join(filter(None, (os.path.dirname(tarinfo.name), tarinfo.linkname)))</span>
<span class="s2">            limit = None</span>
<span class="s2">        else:</span>
<span class="s2">            # Search the archive before the link, because a hard link is</span>
<span class="s2">            # just a reference to an already archived file.</span>
<span class="s2">            linkname = tarinfo.linkname</span>
<span class="s2">            limit = tarinfo</span>

<span class="s2">        member = self._getmember(linkname, tarinfo=limit, normalize=True)</span>
<span class="s2">        if member is None:</span>
<span class="s2">            raise KeyError(&quot;</span><span class="nx">linkname</span> <span class="o">%</span><span class="nx">r</span> <span class="nx">not</span> <span class="nx">found</span><span class="s2">&quot; % linkname)</span>
<span class="s2">        return member</span>

<span class="s2">    def __iter__(self):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Provide</span> <span class="nx">an</span> <span class="nx">iterator</span> <span class="nx">object</span><span class="p">.</span>
        <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        if self._loaded:</span>
<span class="s2">            return iter(self.members)</span>
<span class="s2">        else:</span>
<span class="s2">            return TarIter(self)</span>

<span class="s2">    def _dbg(self, level, msg):</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="nx">Write</span> <span class="nx">debugging</span> <span class="nx">output</span> <span class="nx">to</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span>
        <span class="s2">&quot;&quot;</span><span class="err">&quot;</span>
        <span class="k">if</span> <span class="nx">level</span> <span class="o">&lt;=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">debug</span><span class="o">:</span>
            <span class="nx">print</span> <span class="o">&gt;&gt;</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">stderr</span><span class="p">,</span> <span class="nx">msg</span>

    <span class="nx">def</span> <span class="nx">__enter__</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_check</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">self</span>

    <span class="nx">def</span> <span class="nx">__exit__</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">traceback</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="nx">type</span> <span class="nx">is</span> <span class="nx">None</span><span class="o">:</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="err">#</span> <span class="nx">An</span> <span class="nx">exception</span> <span class="nx">occurred</span><span class="p">.</span> <span class="nx">We</span> <span class="nx">must</span> <span class="nx">not</span> <span class="nx">call</span> <span class="nx">close</span><span class="p">()</span> <span class="nx">because</span>
            <span class="err">#</span> <span class="nx">it</span> <span class="nx">would</span> <span class="k">try</span> <span class="nx">to</span> <span class="nx">write</span> <span class="nx">end</span><span class="o">-</span><span class="nx">of</span><span class="o">-</span><span class="nx">archive</span> <span class="nx">blocks</span> <span class="nx">and</span> <span class="nx">padding</span><span class="p">.</span>
            <span class="k">if</span> <span class="nx">not</span> <span class="nx">self</span><span class="p">.</span><span class="nx">_extfileobj</span><span class="o">:</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">fileobj</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">closed</span> <span class="o">=</span> <span class="nx">True</span>
<span class="err">#</span> <span class="kr">class</span> <span class="nx">TarFile</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-07-02 13:55:12</p>
      </span>
    </div>

    
    
  </body>
</html>