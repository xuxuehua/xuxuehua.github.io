<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>threading 线程 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;threading 线程
    <span class="updated">Page Updated&nbsp;
      2018-09-27 19:39
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">threading 线程</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#threading">threading</a><ul>
<li><a href="#threadingenumerate">threading.enumerate()</a></li>
<li><a href="#threadingcurrent_thread">threading.current_thread()</a></li>
<li><a href="#threadinglock">threading.Lock()</a></li>
<li><a href="#join">join() 方法</a></li>
<li><a href="#threadingsemaphore">threading.Semaphore()</a></li>
<li><a href="#threadingevent">threading.Event()</a></li>
<li><a href="#threadingcondition">threading.condition()</a><ul>
<li><a href="#acquire">acquire</a></li>
<li><a href="#release">release</a></li>
<li><a href="#wait">wait</a></li>
<li><a href="#notify">notify</a></li>
<li><a href="#notify_all">notify_all</a></li>
</ul>
</li>
<li><a href="#example">example</a></li>
<li><a href="#_1">同步</a><ul>
<li><a href="#oop">OOP创建线程</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="threading">threading</h1>
<p>线程是进程的一部分，比进程更灵活，小巧，切换起来更加节省CPU资源。</p>
<p>进程一般是用来分配资源，线程可以访问进程的资源</p>
<p>线程是利用CPU执行代码，不可以分配拥有资源。但是可以访问资源，即利用CPU执行代码。</p>
<p>多线程可以更加充分的利用CPU的性能优势，相互切换是比进程小很多的</p>
<p>threading是python中专门用作多线程，常用类是Thread</p>
<p>服务器利用多线程的方式来处理大量的请求，以提高对网络端口的读写效率。</p>
<p>Python实现多线程/多进程，大家常常会用到标准库中的threading和multiprocessing模块。<br />
但从Python3.2开始，标准库为我们提供了concurrent.futures模块，它提供了ThreadPoolExecutor和ProcessPoolExecutor两个类，实现了对threading和multiprocessing的进一步抽象，使得开发者只需编写少量代码即可让程序实现并行计算。</p>
<h2 id="threadingenumerate">threading.enumerate()</h2>
<p>查看线程数</p>
<h2 id="threadingcurrent_thread">threading.current_thread()</h2>
<p>当前线程名称</p>
<p>单线程需要等所有的代码执行完成之后，才会执行下一步代码</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">time</span>


<span class="n">def</span> <span class="n">worker</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;I am a thread&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">()</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">getName</span><span class="p">())</span>


<span class="n">worker</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">()</span>
<span class="n">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">getName</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="kr">thread</span>
<span class="n">MainThread</span>
<span class="n">MainThread</span>
</pre></div>


<blockquote>
<p>这里会等待10秒再执行剩下的</p>
</blockquote>
<p>看起来会像是主线程和worker线程同时执行</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">time</span>


<span class="n">def</span> <span class="n">worker</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="s">&quot;I am a thread&quot;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">()</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">getName</span><span class="p">())</span>


<span class="cp"># worker()</span>
<span class="kt">new_t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">worker</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">my_thread</span><span class="err">&#39;</span><span class="p">)</span>
<span class="kt">new_t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">()</span>
<span class="n">print</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">getName</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">I</span> <span class="n">am</span> <span class="n">a</span> <span class="kr">thread</span>
<span class="n">MainThread</span>
<span class="n">my_thread</span>
</pre></div>


<blockquote>
<p>主线程执行不依赖于worker线程的执行结果</p>
</blockquote>
<h2 id="threadinglock">threading.Lock()</h2>
<p>对修改全局变量的地方，需要加锁</p>
<div class="hlcode"><pre><span class="n">gLock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">gLock</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="n">gLock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">random</span>
<span class="n">import</span> <span class="n">time</span>

<span class="n">gMoney</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">gLock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">gTotalTimes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">gTimes</span> <span class="o">=</span> <span class="mi">0</span>


<span class="n">class</span> <span class="n">Producer</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">global</span> <span class="n">gMoney</span>
        <span class="n">global</span> <span class="n">gTimes</span>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
            <span class="n">money</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">gLock</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gTimes</span> <span class="o">&gt;=</span> <span class="n">gTotalTimes</span><span class="o">:</span>
                <span class="n">gLock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">gMoney</span> <span class="o">+=</span> <span class="n">money</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span> <span class="n">produced</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="n">money</span><span class="p">,</span> <span class="n">gMoney</span><span class="p">))</span>
            <span class="n">gTimes</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">gLock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


<span class="n">class</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">global</span> <span class="n">gMoney</span>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
            <span class="n">money</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="n">gLock</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gMoney</span> <span class="o">&gt;=</span> <span class="n">money</span><span class="o">:</span>
                <span class="n">gMoney</span> <span class="o">-=</span> <span class="n">money</span>
                <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span> <span class="n">costs</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="n">remaining</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="n">money</span><span class="p">,</span> <span class="n">gMoney</span><span class="p">))</span>
            <span class="nl">else:</span>
                <span class="k">if</span> <span class="n">gTimes</span> <span class="o">&gt;=</span> <span class="n">gTotalTimes</span><span class="o">:</span>
                    <span class="n">gLock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">break</span>
                <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="o">%</span><span class="n">s</span> <span class="n">consumer</span> <span class="n">will</span> <span class="n">cost</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="n">but</span> <span class="n">remaining</span> <span class="o">%</span><span class="n">d</span> <span class="n">is</span> <span class="n">not</span> <span class="n">enough</span><span class="p">.</span><span class="err">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">current_thread</span><span class="p">(),</span> <span class="n">money</span><span class="p">,</span> <span class="n">gMoney</span><span class="p">))</span>
            <span class="n">gLock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Producer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Producer</span> <span class="n">threading</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="o">%</span><span class="n">d</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">t</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145326419968</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">136</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">1136</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145331675136</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">967</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2103</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145336930304</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">456</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2559</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">3</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145342185472</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">571</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3130</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">4</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145347440640</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">432</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3562</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145352695808</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">190</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3372</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145357950976</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">757</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2615</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145363206144</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">869</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">1746</span>

<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145326419968</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">601</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2347</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">4</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145347440640</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">745</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3092</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">3</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145342185472</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">680</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3772</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145331675136</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">641</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">4413</span>
<span class="o">&lt;</span><span class="n">Producer</span><span class="p">(</span><span class="n">Producer</span> <span class="n">threading</span> <span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145336930304</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">produced</span> <span class="mi">118</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">4531</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145357950976</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">866</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3665</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145352695808</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">647</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">3018</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145363206144</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">511</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2507</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145357950976</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">345</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">2162</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145352695808</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">338</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">1824</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">2</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145363206144</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">857</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">967</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">1</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145357950976</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">451</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">516</span>
<span class="o">&lt;</span><span class="n">Consumer</span><span class="p">(</span><span class="n">Consumer</span> <span class="n">threading</span> <span class="mi">0</span><span class="p">,</span> <span class="n">started</span> <span class="mi">123145352695808</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">costs</span> <span class="mi">408</span><span class="p">,</span> <span class="n">remaining</span> <span class="mi">108</span>
</pre></div>


<h2 id="join">join() 方法</h2>
<p>join() 方法，调用该方法的线程将等待直到该Thread对象完成，再恢复运行，并根据情况阻塞某些进程。</p>
<h2 id="threadingsemaphore">threading.Semaphore()</h2>
<p>semaphore，也就是计数锁(semaphore传统意义上是一种进程间同步工具)。创建对象的时候，可以传递一个整数作为计数上限 (sema = threading.Semaphore(5))。它与Lock类似，也有Lock的两个方法。</p>
<h2 id="threadingevent">threading.Event()</h2>
<p>与threading.Condition相类似，相当于没有潜在的Lock保护的condition variable。对象有True和False两个状态。可以多个线程使用wait()等待，直到某个线程调用该对象的set()方法，将对象设置为True。线程可以调用对象的clear()方法来重置对象为False状态。</p>
<h2 id="threadingcondition">threading.condition()</h2>
<p>Lock 上锁是很消耗CPU的行为，condition可以在没有数据的时候，处于一个阻塞的状态。一旦有合适的数据，可以使用notify相关的函数来通知其他处于等待状态的线程。</p>
<p>condition variable，建立该对象时，会包含一个Lock对象 (因为condition variable总是和mutex一起使用)。</p>
<h3 id="acquire">acquire</h3>
<p>上锁</p>
<h3 id="release">release</h3>
<p>解锁</p>
<h3 id="wait">wait</h3>
<p>当前线程处于等待状态，并且会释放锁，可以被其他线程使用notify和notify_all函数唤醒</p>
<p>被唤醒后会继续等待上锁，上锁后继续执行下面的代码</p>
<h3 id="notify">notify</h3>
<p>通知某个正在等待的线程，默认是第一个等待的线程</p>
<h3 id="notify_all">notify_all</h3>
<p>通知所有正在等待的线程，并且不会释放锁。需要在release之前调用</p>
<h2 id="example">example</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">time</span>


<span class="n">class</span> <span class="n">Listening</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">:</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Listening</span> <span class="o">%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">class</span> <span class="n">Writing</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">:</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Writing</span> <span class="o">%</span><span class="n">s</span><span class="err">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">Listening</span><span class="p">()</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">Writing</span><span class="p">()</span>

    <span class="n">t1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">t2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<h2 id="_1">同步</h2>
<p>多线程售票以及同步</p>
<ul>
<li>
<p>使用mutex 就是Python中的lock类对象，来实现线程同步</p>
</li>
<li>
<p>Python 使用threading.Thread对象来代表线程,用threading.Lock对象来代表一个互斥锁(mutex)</p>
</li>
<li>
<p>booth 中使用的两个doChore()函数，可以在未来改进程序，第一个doChore()依然在Lock内部，所以可以安全地使用共享资源 (critical operations, 比如打印剩余票数)。第二个doChore()时，Lock已经被释放，所以不能再去使用共享资源。这时候可以做一些不使用共享资源的操作 (non-critical operation, 比如找钱、喝水)。我故意让doChore()等待了0.5秒，以代表这些额外的操作可能花费的时间。你可以定义的函数来代替doChore()。</p>
</li>
</ul>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">time</span>
<span class="n">import</span> <span class="n">os</span>

<span class="n">def</span> <span class="n">doChore</span><span class="p">()</span><span class="o">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">def</span> <span class="n">booth</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span><span class="o">:</span>
    <span class="n">global</span> <span class="n">i</span>
    <span class="n">global</span> <span class="n">lock</span>
    <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
        <span class="n">lock</span><span class="p">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">print</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="err">&#39;</span><span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">doChore</span><span class="p">()</span>
        <span class="nl">else:</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Thread_id</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="s">&quot;No more tickets&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lock</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">doChore</span><span class="p">()</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">for</span> <span class="n">k</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">:</span>
    <span class="n">new_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">booth</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">k</span><span class="p">,))</span>

    <span class="n">new_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">0</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">9</span>
<span class="mi">1</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">8</span>
<span class="mi">2</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">7</span>
<span class="mi">3</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">6</span>
<span class="mi">4</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">5</span>
<span class="mi">5</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">4</span>
<span class="mi">6</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">3</span>
<span class="mi">7</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">2</span>
<span class="mi">8</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">1</span>
<span class="mi">9</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">0</span>
<span class="n">Thread_id</span> <span class="mi">0</span> <span class="n">No</span> <span class="n">more</span> <span class="n">tickets</span>
</pre></div>


<h3 id="oop">OOP创建线程</h3>
<ul>
<li>通过修改thread类的run() 方法来定义线程要执行的命令</li>
<li>定义了一个类BoothThread, 这个类继承自thread.Threading类。然后我们把booth()所进行的操作统统放入到BoothThread类的run()方法中。</li>
<li>避免了global声明用法</li>
</ul>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">threading</span>
<span class="n">import</span> <span class="n">time</span>
<span class="n">import</span> <span class="n">os</span>

<span class="n">def</span> <span class="n">doChore</span><span class="p">()</span><span class="o">:</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">class</span> <span class="n">BoothThread</span><span class="p">(</span><span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">monitor</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span>
        <span class="n">self</span><span class="p">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">monitor</span>
        <span class="n">threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
            <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">lock</span><span class="err">&#39;</span><span class="p">].</span><span class="n">acquire</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tick</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">:</span>
                <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tick</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tick</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="n">print</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="err">&#39;</span><span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">tick</span><span class="err">&#39;</span><span class="p">])</span>

                <span class="n">doChore</span><span class="p">()</span>

            <span class="nl">else:</span>
                <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Thread_id</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">No</span> <span class="n">more</span> <span class="n">tickets</span><span class="err">&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="p">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">monitor</span><span class="p">[</span><span class="err">&#39;</span><span class="n">lock</span><span class="err">&#39;</span><span class="p">].</span><span class="n">release</span><span class="p">()</span>
            <span class="n">doChore</span><span class="p">()</span>

<span class="n">monitor</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">tick</span><span class="err">&#39;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lock</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">threading</span><span class="p">.</span><span class="n">Lock</span><span class="p">()}</span>

<span class="k">for</span> <span class="n">k</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">:</span>
    <span class="n">new_thread</span> <span class="o">=</span> <span class="n">BoothThread</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">monitor</span><span class="p">)</span>
    <span class="n">new_thread</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">0</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">9</span>
<span class="mi">1</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">8</span>
<span class="mi">2</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">7</span>
<span class="mi">3</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">6</span>
<span class="mi">4</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">5</span>
<span class="mi">5</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">4</span>
<span class="mi">6</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">3</span>
<span class="mi">7</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">2</span>
<span class="mi">8</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">1</span>
<span class="mi">9</span> <span class="o">:</span><span class="n">now</span> <span class="n">left</span><span class="o">:</span> <span class="mi">0</span>
<span class="n">Thread_id</span> <span class="mi">0</span> <span class="n">No</span> <span class="n">more</span> <span class="n">tickets</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-01-02 08:56:17</p>
      </span>
    </div>

    
    
  </body>
</html>