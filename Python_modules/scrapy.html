<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>scrapy - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python_modules">Python_modules</a>&nbsp;&#187;&nbsp;scrapy
    <span class="updated">Page Updated&nbsp;
      2018-10-02 18:24
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">scrapy</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#scrapy">scrapy</a><ul>
<li><a href="#_1">架构图</a><ul>
<li><a href="#_2">运行流程</a></li>
</ul>
</li>
<li><a href="#_3">安装</a></li>
<li><a href="#_4">创建项目</a><ul>
<li><a href="#_5">前期准备</a></li>
<li><a href="#_6">创建爬虫</a></li>
<li><a href="#_7">调用爬虫</a><ul>
<li><a href="#startpy">start.py 调用</a></li>
</ul>
</li>
<li><a href="#example">example</a><ul>
<li><a href="#qiushibaikecom">qiushibaike.com</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#crawlspider">CrawlSpider</a><ul>
<li><a href="#_8">创建爬虫</a></li>
<li><a href="#linkextractors">LinkExtractors 链接提取器</a></li>
<li><a href="#example_1">example</a><ul>
<li><a href="#wxapp-unioncom">wxapp-union.com</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#scrape-shell">Scrape Shell</a></li>
<li><a href="#request">Request</a><ul>
<li><a href="#scrapyformrequest">scrapy.FormRequest</a></li>
<li><a href="#start_requests">Start_requests</a></li>
<li><a href="#example_2">example</a><ul>
<li><a href="#renrencom-login-page">renren.com (login page)</a></li>
<li><a href="#doubancom">douban.com</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#pipeline">Pipeline</a><ul>
<li><a href="#media-pipeline">media pipeline</a><ul>
<li><a href="#files-pipeline">Files Pipeline</a></li>
<li><a href="#images-pipeline">Images Pipeline</a></li>
</ul>
</li>
<li><a href="#example_3">example</a><ul>
<li><a href="#autohomecomcn">autohome.com.cn</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_9">下载器中间件</a><ul>
<li><a href="#process_requestself-request-spider">process_request(self, request, spider)</a></li>
<li><a href="#process_responseself-request-response-spider">Process_response(self, request, response, spider)</a></li>
<li><a href="#_10">随机请求头中间件</a></li>
<li><a href="#_11">网络上的请求头</a></li>
<li><a href="#example_4">example</a><ul>
<li><a href="#httpbinorg">httpbin.org</a></li>
</ul>
</li>
<li><a href="#_12">代理中间件</a><ul>
<li><a href="#example_5">example</a><ul>
<li><a href="#zhipincom">zhipin.com</a></li>
<li><a href="#jianshucom">jianshu.com</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="scrapy">scrapy</h1>
<p>Scrapy 将一些东西封装好，在上面写爬虫可以变的更加高效</p>
<h2 id="_1">架构图</h2>
<p><img alt="img" src="https://cdn.pbrd.co/images/HGzycG9.png" /></p>
<ul>
<li><strong>引擎(Scrapy)</strong><br />
  用来处理整个系统的数据流处理, 触发事务(框架核心)</li>
<li><strong>调度器(Scheduler)</strong><br />
  用来接受引擎发过来的请求, 压入队列中, 并在引擎再次请求的时候返回. 可以想像成一个URL（抓取网页的网址或者说是链接）的优先队列, 由它来决定下一个要抓取的网址是什么, 同时去除重复的网址</li>
<li><strong>下载器(Downloader)</strong><br />
  用于下载网页内容, 并将网页内容返回给蜘蛛(Scrapy下载器是建立在twisted这个高效的异步模型上的)</li>
<li><strong>爬虫(Spiders)</strong><br />
  爬虫是主要干活的, 用于从特定的网页中提取自己需要的信息, 即所谓的实体(Item)。用户也可以从中提取出链接,让Scrapy继续抓取下一个页面</li>
<li><strong>项目管道(Pipeline)</strong><br />
  负责处理爬虫从网页中抽取的实体，主要的功能是持久化实体、验证实体的有效性、清除不需要的信息。当页面被爬虫解析后，将被发送到项目管道，并经过几个特定的次序处理数据。</li>
<li><strong>下载器中间件(Downloader Middlewares)</strong><br />
  位于Scrapy引擎和下载器之间的框架，主要是处理Scrapy引擎与下载器之间的请求及响应。</li>
<li><strong>爬虫中间件(Spider Middlewares)</strong><br />
  介于Scrapy引擎和爬虫之间的框架，主要工作是处理蜘蛛的响应输入和请求输出。</li>
</ul>
<h3 id="_2">运行流程</h3>
<ol>
<li>引擎从调度器中取出一个链接(URL)用于接下来的抓取</li>
<li>引擎把URL封装成一个请求(Request)传给下载器</li>
<li>下载器把资源下载下来，并封装成应答包(Response)</li>
<li>爬虫解析Response</li>
<li>解析出实体（Item）,则交给实体管道进行进一步的处理</li>
<li>解析出的是链接（URL）,则把URL交给调度器等待抓取</li>
</ol>
<h2 id="_3">安装</h2>
<div class="hlcode"><pre><span class="n">pip</span> <span class="n">install</span> <span class="n">scrapy</span>
</pre></div>


<h2 id="_4">创建项目</h2>
<div class="hlcode"><pre><span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">PROJECT_NAME</span>
</pre></div>


<p>会生成如下目录结构</p>
<div class="hlcode"><pre><span class="n">my_first_scrapy</span><span class="o">/</span>
<span class="err">├──</span> <span class="n">my_first_scrapy</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">__pycache__</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">items</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">middlewares</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">pipelines</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">settings</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">spiders</span>
<span class="err">│</span>       <span class="err">├──</span> <span class="n">__init__</span><span class="p">.</span><span class="n">py</span>
<span class="err">│</span>       <span class="err">└──</span> <span class="n">__pycache__</span>
<span class="err">└──</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">cfg</span>
</pre></div>


<blockquote>
<p>scrapy.cfg  项目的主配置信息。（真正爬虫相关的配置信息在settings.py文件中）<br />
items.py    设置数据存储模板，用于结构化数据，如：Django的Model<br />
pipelines    数据处理行为，如：一般结构化的数据持久化<br />
settings.py 配置文件，如：递归的层数、并发数，延迟下载等<br />
spiders      爬虫目录，如：创建文件，编写爬虫规则</p>
</blockquote>
<h3 id="_5">前期准备</h3>
<p>设置settings.py</p>
<p>关闭robotstxt</p>
<div class="hlcode"><pre><span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
</pre></div>


<p>默认请求头</p>
<div class="hlcode"><pre><span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
</pre></div>


<h3 id="_6">创建爬虫</h3>
<div class="hlcode"><pre><span class="nx">scrapy</span> <span class="nx">gescrapy</span> <span class="nx">genspider</span> <span class="err">[</span><span class="na">-t</span> <span class="nx">template</span><span class="cp">]</span> <span class="nt">&lt;name&gt;</span> <span class="nt">&lt;domain&gt;</span>
   - 创建爬虫应用
   如：
      scrapy gensipider xxh xuxuehua.com
      scrapy gensipider -t xmlfeed autohome autohome.com.cn
   PS:
      查看所有命令：scrapy gensipider -l
      查看模板命令：scrapy gensipider -d 模板名称
</pre></div>


<h3 id="_7">调用爬虫</h3>
<div class="hlcode"><pre><span class="n">scrapy</span> <span class="n">crawl</span> <span class="err">爬虫应用名称</span>
   <span class="o">-</span> <span class="err">运行单独爬虫应用</span>
   <span class="err">如</span><span class="o">:</span>
      <span class="n">scrapy</span> <span class="n">crawl</span> <span class="n">xxh</span>
      <span class="n">scrapy</span> <span class="n">crawl</span> <span class="n">xxh</span> <span class="o">--</span><span class="n">nolog</span>
</pre></div>


<blockquote>
<p>这里运行的应用名称不包含.py 后缀</p>
</blockquote>
<h4 id="startpy">start.py 调用</h4>
<div class="hlcode"><pre><span class="cp"># encoding: utf-8</span>

<span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">([</span><span class="err">&#39;</span><span class="n">scrapy</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">crawl</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">])</span>  <span class="err">#</span> <span class="err">这里的</span><span class="n">name</span><span class="err">指</span><span class="n">spider</span><span class="err">目录下的项目名称，不含</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<h3 id="example">example</h3>
<h4 id="qiushibaikecom">qiushibaike.com</h4>
<p>qsbk_spider.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">from</span> <span class="n">qsbk</span><span class="p">.</span><span class="n">items</span> <span class="n">import</span> <span class="n">QsbkItem</span>


<span class="n">class</span> <span class="n">QsbkSpiderSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">qsbk_spider</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">qiushibaike</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.qiushibaike.com/text/page/1/&#39;]</span>
    <span class="n">base_domain</span> <span class="o">=</span> <span class="s">&quot;https://www.qiushibaike.com&quot;</span>

    <span class="n">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">duanzi_divs</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@id=&#39;content-left&#39;]/div&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">duanzi_div</span> <span class="n">in</span> <span class="n">duanzi_divs</span><span class="o">:</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">duanzi_div</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//h2/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">duanzi_div</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//div[@class=&#39;content&#39;]//text()&quot;</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">=</span> <span class="err">&#39;&#39;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">QsbkItem</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
            <span class="n">yield</span> <span class="n">item</span>
        <span class="n">next_url</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//ul[@class=&#39;pagination&#39;]/li[last()]/a/@href&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">next_url</span><span class="o">:</span>
            <span class="k">return</span>
        <span class="nl">else:</span>
            <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">base_domain</span><span class="o">+</span><span class="n">next_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">parse</span><span class="p">)</span>
</pre></div>


<p>items.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="cp"># Define here the models for your scraped items</span>
<span class="cp">#</span>
<span class="cp"># See documentation in:</span>
<span class="cp"># https:</span><span class="c1">//doc.scrapy.org/en/latest/topics/items.html</span>

<span class="n">import</span> <span class="n">scrapy</span>


<span class="n">class</span> <span class="n">QsbkItem</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">)</span><span class="o">:</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
</pre></div>


<p>pipelines.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="n">import</span> <span class="n">json</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">exporters</span> <span class="n">import</span> <span class="n">JsonLinesItemExporter</span>


<span class="n">class</span> <span class="n">QsbkPipeline</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">duanzi</span><span class="p">.</span><span class="n">json</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exporter</span> <span class="o">=</span> <span class="n">JsonLinesItemExporter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">open_spider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Start</span> <span class="n">crawling</span><span class="p">...</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">process_item</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exporter</span><span class="p">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="n">def</span> <span class="n">close_spider</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">End</span> <span class="n">crawling</span><span class="p">...</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>



<span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">qsbk</span><span class="err">&#39;</span>

<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">qsbk</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">qsbk</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>



<span class="cp"># Obey robots.txt rules</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>


<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>

<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">&#39;</span><span class="n">qsbk</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">QsbkPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="cp"># encoding: utf-8</span>

<span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">([</span><span class="err">&#39;</span><span class="n">scrapy</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">crawl</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">qsbk_spider</span><span class="err">&#39;</span><span class="p">])</span>
</pre></div>


<h2 id="crawlspider">CrawlSpider</h2>
<p>继承自Spider，可有指定规则，满足一定的URL就可以进行爬取， 无需手动 yield Request</p>
<p>LinkExtractor 和 Rule 决定爬虫的具体走向</p>
<h3 id="_8">创建爬虫</h3>
<div class="hlcode"><pre><span class="n">scrapy</span> <span class="n">genspider</span> <span class="o">-</span><span class="n">c</span> <span class="n">crawl</span> <span class="p">[</span><span class="err">爬虫名字</span><span class="p">]</span> <span class="p">[</span><span class="err">域名</span><span class="p">]</span>
</pre></div>


<h3 id="linkextractors">LinkExtractors 链接提取器</h3>
<p>可以自动在所爬的页面上找到符合规则的url，实现自动爬取</p>
<h3 id="example_1">example</h3>
<h4 id="wxapp-unioncom">wxapp-union.com</h4>
<p>CMD</p>
<div class="hlcode"><pre><span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">wxapp</span>
<span class="n">cd</span> <span class="n">wxapp</span><span class="o">/</span>
<span class="n">scrapy</span> <span class="n">genspider</span> <span class="o">-</span><span class="n">t</span> <span class="n">crawl</span> <span class="n">wxapp_spider</span> <span class="s">&quot;wxapp-union.com&quot;</span>
</pre></div>


<p>wxapp_spider.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">linkextractors</span> <span class="n">import</span> <span class="n">LinkExtractor</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">spiders</span> <span class="n">import</span> <span class="n">CrawlSpider</span><span class="p">,</span> <span class="n">Rule</span>
<span class="n">from</span> <span class="n">wxapp</span><span class="p">.</span><span class="n">items</span> <span class="n">import</span> <span class="n">WxappItem</span>


<span class="n">class</span> <span class="n">WxappSpiderSpider</span><span class="p">(</span><span class="n">CrawlSpider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">wxapp_spider</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">wxapp</span><span class="o">-</span><span class="k">union</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.wxapp-union.com/portal.php?mod=list&amp;catid=2&amp;page=1&#39;]</span>

    <span class="n">rules</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Rule</span><span class="p">(</span><span class="n">LinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="n">r</span><span class="err">&#39;</span><span class="p">.</span><span class="o">+</span><span class="n">mod</span><span class="o">=</span><span class="n">list</span><span class="o">&amp;</span><span class="n">catid</span><span class="o">=</span><span class="mi">2</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">\</span><span class="n">d</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">follow</span><span class="o">=</span><span class="n">True</span><span class="p">),</span>
        <span class="n">Rule</span><span class="p">(</span><span class="n">LinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="n">r</span><span class="err">&#39;</span><span class="p">.</span><span class="o">+</span><span class="n">article</span><span class="o">-</span><span class="p">.</span><span class="o">+</span><span class="err">\</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="s">&quot;parse_detail&quot;</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="n">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_detail</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//h1[@class=&#39;ph&#39;]/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="n">author_p</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//p[@class=&#39;authors&#39;]&quot;</span><span class="p">)</span>
        <span class="n">author</span> <span class="o">=</span> <span class="n">author_p</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//a/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="n">public_time</span> <span class="o">=</span> <span class="n">author_p</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//span/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="n">article_content</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//td[@id=&#39;article_content&#39;]//text()&quot;</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>
        <span class="n">article_content</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">article_content</span><span class="p">).</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">WxappItem</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">author</span><span class="p">,</span> <span class="n">public_time</span><span class="o">=</span><span class="n">public_time</span><span class="p">,</span> <span class="n">article_content</span><span class="o">=</span><span class="n">article_content</span><span class="p">)</span>
        <span class="n">yield</span> <span class="n">item</span>
</pre></div>


<p>items.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="n">import</span> <span class="n">scrapy</span>


<span class="n">class</span> <span class="n">WxappItem</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">)</span><span class="o">:</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">public_time</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">article_content</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
</pre></div>


<p>pipelines.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="cp"># Define your item pipelines here</span>
<span class="cp">#</span>
<span class="cp"># Don&#39;t forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="cp"># See: https:</span><span class="c1">//doc.scrapy.org/en/latest/topics/item-pipeline.html</span>

<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">exporters</span> <span class="n">import</span> <span class="n">JsonLinesItemExporter</span>


<span class="n">class</span> <span class="n">WxappPipeline</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">wxjc</span><span class="p">.</span><span class="n">json</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">wb</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exporter</span> <span class="o">=</span> <span class="n">JsonLinesItemExporter</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">process_item</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">exporter</span><span class="p">.</span><span class="n">export_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">item</span>

    <span class="n">def</span> <span class="n">close_spider</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">wxapp</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">wxapp</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">wxapp</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">&#39;</span><span class="n">wxapp</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">WxappPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="cp">#encoding: utf-8</span>

<span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;scrapy crawl wxapp_spider&quot;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<h2 id="scrape-shell">Scrape Shell</h2>
<p>用于测试规则是否正确</p>
<p>需要在scrapy所在环境中执行</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">shell</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.wxapp-union.com/article-4525-1.html</span>


<span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="n">Available</span> <span class="n">Scrapy</span> <span class="n">objects</span><span class="o">:</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">scrapy</span>     <span class="n">scrapy</span> <span class="n">module</span> <span class="p">(</span><span class="n">contains</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Selector</span><span class="p">,</span> <span class="n">etc</span><span class="p">)</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">crawler</span>    <span class="o">&lt;</span><span class="n">scrapy</span><span class="p">.</span><span class="n">crawler</span><span class="p">.</span><span class="n">Crawler</span> <span class="n">object</span> <span class="n">at</span> <span class="mh">0x1038dd048</span><span class="o">&gt;</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">item</span>       <span class="p">{}</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">request</span>    <span class="o">&lt;</span><span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.wxapp-union.com/article-4525-1.html&gt;</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">response</span>   <span class="o">&lt;</span><span class="mi">200</span> <span class="n">http</span><span class="o">:</span><span class="c1">//www.wxapp-union.com/article-4525-1.html&gt;</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">settings</span>   <span class="o">&lt;</span><span class="n">scrapy</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">Settings</span> <span class="n">object</span> <span class="n">at</span> <span class="mh">0x105f4ae10</span><span class="o">&gt;</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">spider</span>     <span class="o">&lt;</span><span class="n">WxappSpiderSpider</span> <span class="err">&#39;</span><span class="n">wxapp_spider</span><span class="err">&#39;</span> <span class="n">at</span> <span class="mh">0x107204cc0</span><span class="o">&gt;</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="n">Useful</span> <span class="n">shortcuts</span><span class="o">:</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">[,</span> <span class="n">redirect</span><span class="o">=</span><span class="n">True</span><span class="p">])</span> <span class="n">Fetch</span> <span class="n">URL</span> <span class="n">and</span> <span class="n">update</span> <span class="n">local</span> <span class="n">objects</span> <span class="p">(</span><span class="n">by</span> <span class="k">default</span><span class="p">,</span> <span class="n">redirects</span> <span class="n">are</span> <span class="n">followed</span><span class="p">)</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">fetch</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>                  <span class="n">Fetch</span> <span class="n">a</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span> <span class="n">and</span> <span class="n">update</span> <span class="n">local</span> <span class="n">objects</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">shelp</span><span class="p">()</span>           <span class="n">Shell</span> <span class="n">help</span> <span class="p">(</span><span class="n">print</span> <span class="n">this</span> <span class="n">help</span><span class="p">)</span>
<span class="p">[</span><span class="n">s</span><span class="p">]</span>   <span class="n">view</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>    <span class="n">View</span> <span class="n">response</span> <span class="n">in</span> <span class="n">a</span> <span class="n">browser</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//h1[@class=&#39;ph&#39;]/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="err">&#39;小程序挖坑之路</span> <span class="err">&#39;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">:</span> <span class="n">from</span> <span class="n">bs4</span> <span class="n">import</span> <span class="n">BeautifulSoup</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">:</span> <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">:</span> <span class="n">soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">h1</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;class&quot;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">ph</span><span class="err">&#39;</span><span class="p">})</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">h1</span> <span class="n">class</span><span class="o">=</span><span class="s">&quot;ph&quot;</span><span class="o">&gt;</span><span class="err">小程序挖坑之路</span> <span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</pre></div>


<h2 id="request">Request</h2>
<h3 id="scrapyformrequest">scrapy.FormRequest</h3>
<p>可发送post请求，指定表单数据</p>
<h3 id="start_requests">Start_requests</h3>
<p>如需要在爬虫开始时发送post 请求，应该重写'start_requests'方法，在这个方法中，发送post请求</p>
<h3 id="example_2">example</h3>
<h4 id="renrencom-login-page">renren.com (login page)</h4>
<p>cmd</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">renren_login</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">renren_login</span><span class="o">/</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="n">renren</span> <span class="err">&#39;</span><span class="n">renren</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
</pre></div>


<p>renren.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>


<span class="n">class</span> <span class="n">RenrenSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">renren</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">renren</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//renren.com/&#39;]</span>

    <span class="n">def</span> <span class="n">start_requests</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;模拟登录&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.renren.com/PLogin.do&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="err">&#39;</span><span class="n">email</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="mi">970138074</span><span class="err">@</span><span class="n">qq</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">password</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">pythonspider</span><span class="err">&#39;</span><span class="p">}</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">FormRequest</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">formdata</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">parse_page</span><span class="p">)</span>
        <span class="n">yield</span> <span class="n">request</span>

    <span class="n">def</span> <span class="n">parse_page</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="err">&#39;&#39;&#39;查看登录后，某人的主页&#39;&#39;&#39;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.renren.com/880151247/profile&#39;, callback=self.parse_profile)</span>
        <span class="n">yield</span> <span class="n">request</span>

    <span class="n">def</span> <span class="n">parse_profile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;获取个人主页内容&quot;&quot;&quot;</span>
        <span class="n">with</span> <span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">dp</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">as</span> <span class="n">fp</span><span class="o">:</span>
            <span class="n">fp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="cp">#encoding: utf-8</span>

<span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;scrapy crawl renren&quot;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<p>setting.py</p>
<div class="hlcode"><pre><span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
</pre></div>


<h4 id="doubancom">douban.com</h4>
<p>cmd</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">douban_login</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">douban_login</span><span class="o">/</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="n">douban</span> <span class="err">&#39;</span><span class="n">douban</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
</pre></div>


<p>douban.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">from</span> <span class="n">urllib</span> <span class="n">import</span> <span class="n">request</span>
<span class="n">from</span> <span class="n">PIL</span> <span class="n">import</span> <span class="n">Image</span>


<span class="n">class</span> <span class="n">DoubanSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">douban</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">douban</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//accounts.douban.com/login&#39;]</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//accounts.douban.com/login&#39;</span>
    <span class="n">profile_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.douban.com/people/50290734/&#39;</span>
    <span class="n">editsignature_url</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.douban.com/j/people/50290734/edit_signature&#39;</span>

    <span class="n">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">formdata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="err">&#39;</span><span class="n">source</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">None</span><span class="err">&#39;</span><span class="p">,</span>
            <span class="err">&#39;</span><span class="n">redir</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.douban.com&#39;,</span>
            <span class="err">&#39;</span><span class="n">form_email</span><span class="err">&#39;</span><span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
            <span class="err">&#39;</span><span class="n">form_password</span><span class="err">&#39;</span><span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">,</span>
            <span class="err">&#39;</span><span class="n">remember</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">on</span><span class="err">&#39;</span><span class="p">,</span>
            <span class="err">&#39;</span><span class="n">login</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;登录&#39;</span>
        <span class="p">}</span>
        <span class="n">captcha_url</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">css</span><span class="p">(</span><span class="err">&#39;</span><span class="n">img</span><span class="err">#</span><span class="n">captcha_image</span><span class="o">::</span><span class="n">attr</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="err">&#39;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">captcha_url</span><span class="o">:</span>
            <span class="n">captcha</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">recognize_captcha</span><span class="p">(</span><span class="n">captcha_url</span><span class="p">)</span>
            <span class="n">formdata</span><span class="p">[</span><span class="err">&#39;</span><span class="n">captcha</span><span class="o">-</span><span class="n">solution</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">captcha</span>
            <span class="n">captcha_id</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//input[@name=&#39;captcha-id&#39;]/@value&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
            <span class="n">formdata</span><span class="p">[</span><span class="err">&#39;</span><span class="n">captcha</span><span class="o">-</span><span class="n">id</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">captcha_id</span>

        <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">FormRequest</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">login_url</span><span class="p">,</span> <span class="n">formdata</span><span class="o">=</span><span class="n">formdata</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">parse_after_login</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_after_login</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">url</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.douban.com&#39;:</span>
            <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">profile_url</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">parse_profile</span><span class="p">)</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Login</span> <span class="n">successful</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="nl">else:</span>
            <span class="n">print</span><span class="p">(</span><span class="s">&quot;Login Failed&quot;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_profile</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">url</span> <span class="o">==</span> <span class="n">self</span><span class="p">.</span><span class="n">profile_url</span><span class="o">:</span>
            <span class="n">ck</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//input[@name=&#39;ck&#39;]/@value&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
            <span class="n">formdata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="err">&#39;</span><span class="n">ck</span><span class="err">&#39;</span><span class="o">:</span> <span class="n">ck</span><span class="p">,</span>
                <span class="err">&#39;</span><span class="n">signature</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">This</span> <span class="n">is</span> <span class="n">python</span> <span class="n">signature</span><span class="p">.</span><span class="err">&#39;</span>
            <span class="p">}</span>
            <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">FormRequest</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">editsignature_url</span><span class="p">,</span> <span class="n">formdata</span><span class="o">=</span><span class="n">formdata</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">parse_none</span><span class="p">)</span>
        <span class="nl">else:</span>
            <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Profile</span> <span class="n">signature</span> <span class="n">unsuccessful</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_none</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;默认没有callback会再次调用parse方法&quot;&quot;&quot;</span>
        <span class="n">pass</span>

    <span class="n">def</span> <span class="n">recognize_captcha</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">image_url</span><span class="p">)</span><span class="o">:</span>
        <span class="n">request</span><span class="p">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">captcha</span><span class="p">.</span><span class="n">png</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="err">&#39;</span><span class="n">captcha</span><span class="p">.</span><span class="n">png</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">image</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">captcha</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Input</span> <span class="n">captcha</span><span class="o">:</span> <span class="err">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">captcha</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="cp">#encoding: utf-8</span>

<span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;scrapy crawl douban&quot;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<p>setting.py</p>
<div class="hlcode"><pre><span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
</pre></div>


<h2 id="pipeline">Pipeline</h2>
<h3 id="media-pipeline">media pipeline</h3>
<p>包括Files Pipeline 或者Images Pipeline</p>
<p>可以避免下载重复的文件</p>
<p>生成的图片时通用格式，方便检测图片信息</p>
<p>异步下载效率非常高</p>
<h4 id="files-pipeline">Files Pipeline</h4>
<ol>
<li>定义一个item，然后再item中定义file_urls &amp; files, file_urls是用来存储需要下载的链接，需要一个列表</li>
<li>文件下载完成后，会讲相关信息存储到item中files属性中，比如下载路径，文件校验码</li>
<li>settings.py中FILES_STORE 时配置文件到下载路径</li>
<li>需要在ITEM_PIPELINES中设置scrapy.pipelines.files.FilesPipeline:1</li>
</ol>
<h4 id="images-pipeline">Images Pipeline</h4>
<ol>
<li>定义一个item，然后再item中定义image_urls &amp; images, image_urls是用来存储需要下载的链接，需要一个列表</li>
<li>文件下载完成后，会讲相关信息存储到item中files属性中，比如下载路径，文件校验码</li>
<li>settings.py中IMAGES_STORE 时配置图片到下载路径</li>
<li>需要在ITEM_PIPELINES中设置scrapy.pipelines.images.ImagesPipeline:1</li>
<li>下载到指定文件夹，需要重写pipeline</li>
</ol>
<h3 id="example_3">example</h3>
<h4 id="autohomecomcn">autohome.com.cn</h4>
<p>CMD</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">bmw</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">bmw</span><span class="o">/</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="n">bmw5</span> <span class="err">&#39;</span><span class="n">car</span><span class="p">.</span><span class="n">autohome</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">cn</span><span class="err">&#39;</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">os</span>
<span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">bmw</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">bmw</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">bmw</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">bmw</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">BmwPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">scrapy</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">images</span><span class="p">.</span><span class="n">ImagesPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">1</span>  <span class="err">#</span> <span class="err">默认的下载方法</span>
    <span class="err">&#39;</span><span class="n">bmw</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">BMWImagesPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="n">IMAGES_STORE</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="err">&#39;</span><span class="n">images</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>items.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="cp"># Define here the models for your scraped items</span>
<span class="cp">#</span>
<span class="cp"># See documentation in:</span>
<span class="cp"># https:</span><span class="c1">//doc.scrapy.org/en/latest/topics/items.html</span>

<span class="n">import</span> <span class="n">scrapy</span>


<span class="n">class</span> <span class="n">BmwItem</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">)</span><span class="o">:</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">image_urls</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
</pre></div>


<p>bmw5.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">from</span> <span class="n">bmw</span><span class="p">.</span><span class="n">items</span> <span class="n">import</span> <span class="n">BmwItem</span>


<span class="n">class</span> <span class="n">Bmw5Spider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">bmw5</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">car</span><span class="p">.</span><span class="n">autohome</span><span class="p">.</span><span class="n">com</span><span class="p">.</span><span class="n">cn</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//car.autohome.com.cn/pic/series/65.html&#39;]</span>

    <span class="n">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">uiboxs</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;uibox&#39;]&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="o">:</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">uibox</span> <span class="n">in</span> <span class="n">uiboxs</span><span class="o">:</span>
            <span class="n">category</span> <span class="o">=</span> <span class="n">uibox</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;./div[@class=&#39;uibox-title&#39;]/a/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
            <span class="n">urls</span> <span class="o">=</span> <span class="n">uibox</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;.//ul/li/a/img/@src&quot;</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>
            <span class="n">urls</span> <span class="o">=</span> <span class="n">list</span><span class="p">(</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">url</span><span class="o">:</span> <span class="n">response</span><span class="p">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">),</span> <span class="n">urls</span><span class="p">))</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">BmwItem</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">image_urls</span><span class="o">=</span><span class="n">urls</span><span class="p">)</span>
            <span class="n">yield</span> <span class="n">item</span>
</pre></div>


<p>pipelines.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>

<span class="cp"># Define your item pipelines here</span>
<span class="cp">#</span>
<span class="cp"># Don&#39;t forget to add your pipeline to the ITEM_PIPELINES setting</span>
<span class="cp"># See: https:</span><span class="c1">//doc.scrapy.org/en/latest/topics/item-pipeline.html</span>

<span class="n">import</span> <span class="n">os</span>
<span class="n">from</span> <span class="n">urllib</span> <span class="n">import</span> <span class="n">request</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">images</span> <span class="n">import</span> <span class="n">ImagesPipeline</span>
<span class="n">from</span> <span class="n">bmw</span> <span class="n">import</span> <span class="n">settings</span>


<span class="n">class</span> <span class="n">BmwPipeline</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;需要打开settings里面的ITEM_PIPELINES&quot;&quot;&quot;</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="n">self</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span> <span class="err">&#39;</span><span class="n">images</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span><span class="o">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">process_item</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="err">&#39;</span><span class="n">category</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="err">&#39;</span><span class="n">urls</span><span class="err">&#39;</span><span class="p">]</span>

        <span class="n">category_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">category_path</span><span class="p">)</span><span class="o">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">category_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="o">:</span>
            <span class="n">image_name</span> <span class="o">=</span> <span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">request</span><span class="p">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">category_path</span><span class="p">,</span> <span class="n">image_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">item</span>


<span class="n">class</span> <span class="n">BMWImagesPipeline</span><span class="p">(</span><span class="n">ImagesPipeline</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">get_media_requests</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;在发送下载请求前调用， 其本身就是去发送下载请求&quot;&quot;&quot;</span>
        <span class="n">request_objs</span> <span class="o">=</span> <span class="n">super</span><span class="p">(</span><span class="n">BMWImagesPipeline</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">get_media_requests</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">request_obj</span> <span class="n">in</span> <span class="n">request_objs</span><span class="o">:</span>
            <span class="n">request_obj</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">return</span> <span class="n">request_objs</span>

    <span class="n">def</span> <span class="n">file_path</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">None</span><span class="p">)</span><span class="o">:</span>
        <span class="s">&quot;&quot;&quot;重写这个方法，图片将要被存储的时候调用，来获取这个图片存储的路径&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">super</span><span class="p">(</span><span class="n">BMWImagesPipeline</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">file_path</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">category</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">item</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">category</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">images_store</span> <span class="o">=</span> <span class="n">settings</span><span class="p">.</span><span class="n">IMAGES_STORE</span>
        <span class="n">category_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">images_store</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">exists</span><span class="p">(</span><span class="n">category_path</span><span class="p">)</span><span class="o">:</span>
            <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">category_path</span><span class="p">)</span>
        <span class="n">image_name</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;full/&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">category_path</span><span class="p">,</span> <span class="n">image_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_path</span>
</pre></div>


<h2 id="_9">下载器中间件</h2>
<p>Downloader Middlewares</p>
<p>中间件可以设置代理IP，随机请求头。</p>
<p>下载器实现两个方法</p>
<h3 id="process_requestself-request-spider">process_request(self, request, spider)</h3>
<ul>
<li>
<p>返回None，scrapy将继续处理该request，执行其他中间件中的相应方法，直到合适的下载器处理函数被调用</p>
</li>
<li>
<p>返回Response对象， 将不会调用其他的process_request方法，将直接返回response对象。已经激活的process_response方法会在每个response返回时调用</p>
</li>
<li>返回Request对象，不会使用之前的request对象去下载数据，而是根据现在返回的request对象返回数据</li>
<li>抛出异常，调用process_exception</li>
</ul>
<h3 id="process_responseself-request-response-spider">Process_response(self, request, response, spider)</h3>
<ul>
<li>返回Response，将新的response传给其他中间件，最终传递给引擎爬虫</li>
<li>返回Request，下载器链接切断，返回request会被重新被下载器调度</li>
<li>抛出异常，调用errback</li>
</ul>
<h3 id="_10">随机请求头中间件</h3>
<h3 id="_11">网络上的请求头</h3>
<p>http://useragentstring.com/pages/useragentstring.php?typ=Browser</p>
<h3 id="example_4">example</h3>
<h4 id="httpbinorg">httpbin.org</h4>
<p>CMD</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">useragent_demo</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">useragent_demo</span><span class="o">/</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="n">httpbin</span> <span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span>
</pre></div>


<p>httpbin.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">import</span> <span class="n">json</span>


<span class="n">class</span> <span class="n">HttpbinSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">httpbin</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//httpbin.org/user-agent&#39;]</span>

    <span class="n">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">user_agent</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="n">print</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="o">*</span><span class="mi">88</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="n">user_agent</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="o">*</span><span class="mi">88</span><span class="p">)</span>
        <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">start_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dont_filter</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>  <span class="err">#</span> <span class="err">关闭去重功能</span>
</pre></div>


<p>middlewares.py</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nt">-</span><span class="o">*</span><span class="nt">-</span> <span class="nt">coding</span><span class="o">:</span> <span class="nt">utf-8</span> <span class="nt">-</span><span class="o">*</span><span class="nt">-</span>

<span class="err">#</span> <span class="nt">Define</span> <span class="nt">here</span> <span class="nt">the</span> <span class="nt">models</span> <span class="nt">for</span> <span class="nt">your</span> <span class="nt">spider</span> <span class="nt">middleware</span>
<span class="err">#</span>
<span class="err">#</span> <span class="nt">See</span> <span class="nt">documentation</span> <span class="nt">in</span><span class="o">:</span>
<span class="err">#</span> <span class="nt">https</span><span class="o">://</span><span class="nt">doc</span><span class="nc">.scrapy.org</span><span class="o">/</span><span class="nt">en</span><span class="o">/</span><span class="nt">latest</span><span class="o">/</span><span class="nt">topics</span><span class="o">/</span><span class="nt">spider-middleware</span><span class="nc">.html</span>

<span class="nt">from</span> <span class="nt">scrapy</span> <span class="nt">import</span> <span class="nt">signals</span>
<span class="nt">import</span> <span class="nt">random</span>



<span class="nt">class</span> <span class="nt">UserAgentDownloadMiddleware</span><span class="o">(</span><span class="nt">object</span><span class="o">):</span>
    <span class="nt">USER_AGENTS</span> <span class="o">=</span> <span class="cp">[</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.1 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2226.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.4; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2225.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2225.0 Safari/537.36&#39;</span>
    <span class="cp">]</span>

    <span class="nt">def</span> <span class="nt">process_request</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">spider</span><span class="o">):</span>
        <span class="nt">user_agent</span> <span class="o">=</span> <span class="nt">random</span><span class="nc">.choice</span><span class="o">(</span><span class="nt">self</span><span class="nc">.USER_AGENTS</span><span class="o">)</span>
        <span class="nt">request</span><span class="nc">.headers</span><span class="cp">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">user_agent</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">useragent_demo</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">useragent_demo</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">useragent_demo</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">useragent_demo</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">UseragentDemoDownloaderMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">543</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">useragent_demo</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">UserAgentDownloadMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">543</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>
<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="err">&#39;</span><span class="n">scrapy</span> <span class="n">crawl</span> <span class="n">httpbin</span><span class="err">&#39;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<h3 id="_12">代理中间件</h3>
<p>cmd</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="n">ipproxy</span> <span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span>
</pre></div>


<p>ipproxy.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">import</span> <span class="n">json</span>


<span class="n">class</span> <span class="n">IpproxySpider</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Spider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">ipproxy</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">httpbin</span><span class="p">.</span><span class="n">org</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//httpbin.org/ip&#39;]</span>
    <span class="err">#</span> <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//ip.cn&#39;]</span>

    <span class="n">def</span> <span class="n">parse</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="n">value</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;well&#39;]/p/code/text()&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">user_agent</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="n">print</span><span class="p">(</span><span class="sc">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">88</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="n">user_agent</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="sc">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">88</span><span class="p">)</span>
        <span class="n">yield</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">start_urls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dont_filter</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>  <span class="err">#</span> <span class="err">关闭去重功能</span>
</pre></div>


<p>middlewares.py</p>
<p>共享代理</p>
<div class="hlcode"><pre><span class="nt">class</span> <span class="nt">IPProxyDownloadMiddleware</span><span class="o">(</span><span class="nt">object</span><span class="o">):</span>
    <span class="s2">&quot;&quot;&quot;kuaidaili.com&quot;&quot;&quot;</span>
    <span class="nt">PROXIES</span> <span class="o">=</span> <span class="cp">[</span>
        <span class="s1">&#39;60.208.32.201:80&#39;</span><span class="p">,</span>
        <span class="s1">&#39;117.30.196.140:58171&#39;</span><span class="p">,</span>
        <span class="s1">&#39;182.18.6.9:53281&#39;</span><span class="p">,</span>
        <span class="s1">&#39;121.232.199.76:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;117.90.7.242:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;114.234.81.212:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;183.158.205.140:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;118.24.185.22:80&#39;</span><span class="p">,</span>
        <span class="s1">&#39;180.118.86.82:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;119.51.246.215:8060&#39;</span><span class="p">,</span>
        <span class="s1">&#39;180.118.73.110:9000&#39;</span><span class="p">,</span>
        <span class="s1">&#39;106.14.197.219:8118&#39;</span>
    <span class="cp">]</span>

    <span class="nt">def</span> <span class="nt">process_request</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">spider</span><span class="o">):</span>
        <span class="nt">proxy</span> <span class="o">=</span> <span class="nt">random</span><span class="nc">.choice</span><span class="o">(</span><span class="nt">self</span><span class="nc">.PROXIES</span><span class="o">)</span>
        <span class="nt">request</span><span class="nc">.meta</span><span class="cp">[</span><span class="s1">&#39;proxy&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">proxy</span>
</pre></div>


<p>独享代理</p>
<div class="hlcode"><pre><span class="n">class</span> <span class="n">IPProxyDownloadMiddleware</span><span class="p">(</span><span class="n">object</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">process_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">)</span><span class="o">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mf">121.191.6.124</span><span class="o">:</span><span class="mi">16816</span><span class="err">&#39;</span>
        <span class="n">user_password</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">username</span><span class="o">:</span><span class="n">password</span><span class="err">&#39;</span>
        <span class="n">request</span><span class="p">.</span><span class="n">meta</span><span class="p">[</span><span class="err">&#39;</span><span class="n">proxy</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="n">b64_user_password</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">user_password</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">))</span>
        <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="err">&#39;</span><span class="n">Proxy</span><span class="o">-</span><span class="n">Authorization</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Basic</span> <span class="err">&#39;</span> <span class="o">+</span> <span class="n">b64_user_password</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">MultiproxyDownloaderMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">543</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">IPProxyDownloadMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">}</span><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">MultiproxyDownloaderMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">543</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">multiproxy</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">IPProxyDownloadMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;scrapy crawl ipproxy&quot;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<h4 id="example_5">example</h4>
<h5 id="zhipincom">zhipin.com</h5>
<p>cmd</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">boss</span>
<span class="err">$</span> <span class="n">cd</span> <span class="n">boss</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="o">-</span><span class="n">t</span> <span class="n">crawl</span> <span class="n">zhipin</span> <span class="err">&#39;</span><span class="n">zhipin</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span>
</pre></div>


<p>middleware.py</p>
<p>这里的代理中间件需要测试</p>
<div class="hlcode"><pre><span class="err">#</span> <span class="nt">-</span><span class="o">*</span><span class="nt">-</span> <span class="nt">coding</span><span class="o">:</span> <span class="nt">utf-8</span> <span class="nt">-</span><span class="o">*</span><span class="nt">-</span>

<span class="err">#</span> <span class="nt">Define</span> <span class="nt">here</span> <span class="nt">the</span> <span class="nt">models</span> <span class="nt">for</span> <span class="nt">your</span> <span class="nt">spider</span> <span class="nt">middleware</span>
<span class="err">#</span>
<span class="err">#</span> <span class="nt">See</span> <span class="nt">documentation</span> <span class="nt">in</span><span class="o">:</span>
<span class="err">#</span> <span class="nt">https</span><span class="o">://</span><span class="nt">doc</span><span class="nc">.scrapy.org</span><span class="o">/</span><span class="nt">en</span><span class="o">/</span><span class="nt">latest</span><span class="o">/</span><span class="nt">topics</span><span class="o">/</span><span class="nt">spider-middleware</span><span class="nc">.html</span>
<span class="nt">import</span> <span class="nt">random</span>
<span class="nt">import</span> <span class="nt">requests</span>
<span class="nt">import</span> <span class="nt">json</span>
<span class="nt">import</span> <span class="nt">datetime</span>
<span class="nt">from</span> <span class="nt">lxml</span> <span class="nt">import</span> <span class="nt">etree</span>


<span class="nt">class</span> <span class="nt">UserAgentDownloadMiddleware</span><span class="o">(</span><span class="nt">object</span><span class="o">):</span>
    <span class="nt">USER_AGENTS</span> <span class="o">=</span> <span class="cp">[</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.1 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2226.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.4; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2225.0 Safari/537.36&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2225.0 Safari/537.36&#39;</span>
    <span class="cp">]</span>

    <span class="nt">def</span> <span class="nt">process_request</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">spider</span><span class="o">):</span>
        <span class="nt">user_agent</span> <span class="o">=</span> <span class="nt">random</span><span class="nc">.choice</span><span class="o">(</span><span class="nt">self</span><span class="nc">.USER_AGENTS</span><span class="o">)</span>
        <span class="nt">request</span><span class="nc">.headers</span><span class="cp">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">user_agent</span>


<span class="nt">class</span> <span class="nt">IPProxyDownloadMiddleware</span><span class="o">(</span><span class="nt">object</span><span class="o">):</span>

    <span class="nt">def</span> <span class="nt">__init__</span><span class="o">(</span><span class="nt">self</span><span class="o">):</span>
        <span class="nt">self</span><span class="nc">.proxy_url</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">self</span><span class="nc">.current_date</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">self</span><span class="nc">.proxy_list</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">self</span><span class="nc">.formated_proxy_list</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">self</span><span class="nc">.current_proxy</span> <span class="o">=</span> <span class="nt">None</span>
        <span class="nt">self</span><span class="nc">.blacked</span> <span class="o">=</span> <span class="nt">False</span>

    <span class="nt">def</span> <span class="nt">process_request</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">spider</span><span class="o">):</span>
        <span class="nt">print</span><span class="o">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nt">88</span><span class="o">)</span>
        <span class="nt">print</span><span class="o">(</span><span class="s1">&#39;request.meta&#39;</span><span class="o">,</span> <span class="nt">request</span><span class="nc">.meta</span><span class="o">)</span>
        <span class="nt">print</span><span class="o">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="nt">88</span><span class="o">)</span>
        <span class="nt">if</span> <span class="s1">&#39;proxy&#39;</span> <span class="nt">not</span> <span class="nt">in</span> <span class="nt">request</span><span class="nc">.meta</span><span class="o">:</span>
            <span class="nt">request</span><span class="nc">.meta</span><span class="cp">[</span><span class="s1">&#39;proxy&#39;</span><span class="cp">]</span> <span class="o">=</span> <span class="nt">self</span><span class="nc">.update_proxy</span><span class="o">()</span>

    <span class="nt">def</span> <span class="nt">process_response</span><span class="o">(</span><span class="nt">self</span><span class="o">,</span> <span class="nt">request</span><span class="o">,</span> <span class="nt">response</span><span class="o">,</span> <span class="nt">spider</span><span class="o">):</span>
        <span class="nt">if</span> <span class="nt">response</span><span class="nc">.status</span> <span class="o">!=</span> <span class="nt">200</span><span class="o">:</span>
            <span class="nt">if</span> <span class="nt">not</span> <span class="nt">self</span><span class="nc">.current_proxy.blacked</span><span class="o">:</span>
                <span class="nt">self</span><span class="nc">.current_proxy.blacked</span> <span class="o">=</span> <span class="nt">True</span>
            <span class="nt">self</span><span class="nc">.update_proxy</span><span class="o">()</span>  <span class="err">#</span> <span class="err">执行到这里，代表请求被</span><span class="nt">block</span><span class="err">了</span>
            <span class="nt">print</span><span class="o">(</span><span class="s1">&#39;%s proxy have been blacked&#39;</span> <span class="o">%</span> <span class="nt">self</span><span class="nc">.current_proxy.ip</span><span class="o">)</span>
            <span class="nt">return</span> <span class="nt">request</span>
        <span class="nt">return</span> <span class="nt">response</span>  <span class="err">#</span> <span class="err">正常请求到，需要返回</span><span class="nt">response</span>

    <span class="nt">def</span> <span class="nt">update_proxy</span><span class="o">(</span><span class="nt">self</span><span class="o">):</span>
        <span class="nt">if</span> <span class="nt">not</span> <span class="nt">self</span><span class="nc">.current_proxy</span> <span class="nt">or</span> <span class="nt">self</span><span class="nc">.current_proxy.blacked</span><span class="o">:</span>
            <span class="nt">temp</span> <span class="o">=</span> <span class="nt">datetime</span><span class="nc">.datetime.now</span><span class="o">()</span>
            <span class="nt">self</span><span class="nc">.current_date</span> <span class="o">=</span> <span class="nt">temp</span><span class="nc">.strftime</span><span class="o">(</span><span class="s1">&#39;%Y/%m/%d/%H&#39;</span><span class="o">)</span>
            <span class="nt">self</span><span class="nc">.proxy_url</span> <span class="o">=</span> <span class="s1">&#39;https://ip.ihuan.me/today/{}.html&#39;</span><span class="nc">.format</span><span class="o">(</span><span class="nt">self</span><span class="nc">.current_date</span><span class="o">)</span>
            <span class="nt">response</span> <span class="o">=</span> <span class="nt">requests</span><span class="nc">.get</span><span class="o">(</span><span class="nt">self</span><span class="nc">.proxy_url</span><span class="o">)</span>
            <span class="nt">text</span> <span class="o">=</span> <span class="nt">response</span><span class="nc">.text</span>
            <span class="nt">html</span> <span class="o">=</span> <span class="nt">etree</span><span class="nc">.HTML</span><span class="o">(</span><span class="nt">text</span><span class="o">)</span>
            <span class="nt">self</span><span class="nc">.proxy_list</span> <span class="o">=</span> <span class="nt">html</span><span class="nc">.xpath</span><span class="o">(</span><span class="s2">&quot;//p</span><span class="cp">[</span><span class="p">@</span><span class="n">class</span><span class="o">=</span><span class="s1">&#39;text-left&#39;</span><span class="cp">]</span><span class="s2">/text()&quot;</span><span class="o">)</span>
            <span class="nt">self</span><span class="nc">.formated_proxy_list</span> <span class="o">=</span> <span class="cp">[]</span>
            <span class="nt">for</span> <span class="nt">i</span> <span class="nt">in</span> <span class="nt">range</span><span class="o">(</span><span class="nt">len</span><span class="o">(</span><span class="nt">self</span><span class="nc">.proxy_list</span><span class="o">)):</span>
                <span class="nt">self</span><span class="nc">.formated_proxy_list.append</span><span class="o">(</span><span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nt">self</span><span class="nc">.proxy_list</span><span class="cp">[</span><span class="nx">i</span><span class="cp">]</span><span class="nc">.split</span><span class="o">(</span><span class="s1">&#39;@&#39;</span><span class="o">)</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="nc">.strip</span><span class="o">())</span>
            <span class="nt">self</span><span class="nc">.current_proxy</span> <span class="o">=</span> <span class="nt">random</span><span class="nc">.choice</span><span class="o">(</span><span class="nt">self</span><span class="nc">.formated_proxy_list</span><span class="o">)</span>
            <span class="nt">return</span> <span class="nt">self</span><span class="nc">.current_proxy</span>
</pre></div>


<p>zhipin.py</p>
<div class="hlcode"><pre><span class="cp"># -*- coding: utf-8 -*-</span>
<span class="n">import</span> <span class="n">scrapy</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">linkextractors</span> <span class="n">import</span> <span class="n">LinkExtractor</span>
<span class="n">from</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">spiders</span> <span class="n">import</span> <span class="n">CrawlSpider</span><span class="p">,</span> <span class="n">Rule</span>
<span class="n">from</span> <span class="n">boss</span><span class="p">.</span><span class="n">items</span> <span class="n">import</span> <span class="n">BossItem</span>


<span class="n">class</span> <span class="n">ZhipinSpider</span><span class="p">(</span><span class="n">CrawlSpider</span><span class="p">)</span><span class="o">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">zhipin</span><span class="err">&#39;</span>
    <span class="n">allowed_domains</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">zhipin</span><span class="p">.</span><span class="n">com</span><span class="err">&#39;</span><span class="p">]</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">https</span><span class="o">:</span><span class="c1">//www.zhipin.com/c101010100/h_100010000/?query=python&amp;page=1&#39;]</span>

    <span class="n">rules</span> <span class="o">=</span> <span class="p">(</span>
        <span class="err">#</span> <span class="n">list</span> <span class="n">info</span>
        <span class="n">Rule</span><span class="p">(</span><span class="n">LinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="n">r</span><span class="err">&#39;</span><span class="p">.</span><span class="o">+</span><span class="err">\</span><span class="o">?</span><span class="n">query</span><span class="o">=</span><span class="n">python</span><span class="o">&amp;</span><span class="n">page</span><span class="o">=</span><span class="err">\</span><span class="n">d</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">follow</span><span class="o">=</span><span class="n">True</span><span class="p">),</span>
        <span class="err">#</span> <span class="n">detail</span> <span class="n">info</span>
        <span class="n">Rule</span><span class="p">(</span><span class="n">LinkExtractor</span><span class="p">(</span><span class="n">allow</span><span class="o">=</span><span class="n">r</span><span class="err">&#39;</span><span class="p">.</span><span class="o">+</span><span class="n">job_detail</span><span class="o">/</span><span class="p">.</span><span class="o">+</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="s">&quot;parse_job&quot;</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="n">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">def</span> <span class="n">parse_job</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span><span class="o">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;name&#39;]/h1/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>
        <span class="n">salary</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//span[@class=&#39;badge&#39;]/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">job_info</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;job-primary detail-box&#39;]/div[@class=&#39;info-primary&#39;]/p/text()&quot;</span><span class="p">).</span><span class="n">getall</span><span class="p">()</span>
        <span class="n">city</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">work_years</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">education</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">company</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">&quot;//div[@class=&#39;info-company&#39;]//a/text()&quot;</span><span class="p">).</span><span class="n">get</span><span class="p">()</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">BossItem</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">salary</span><span class="o">=</span><span class="n">salary</span><span class="p">,</span> <span class="n">city</span><span class="o">=</span><span class="n">city</span><span class="p">,</span> <span class="n">work_years</span><span class="o">=</span><span class="n">work_years</span><span class="p">,</span> <span class="n">education</span><span class="o">=</span><span class="n">education</span><span class="p">,</span> <span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">)</span>
        <span class="n">yield</span> <span class="n">item</span>
</pre></div>


<p>items.py</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">scrapy</span>


<span class="n">class</span> <span class="n">BossItem</span><span class="p">(</span><span class="n">scrapy</span><span class="p">.</span><span class="n">Item</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">define</span> <span class="n">the</span> <span class="n">fields</span> <span class="k">for</span> <span class="n">your</span> <span class="n">item</span> <span class="n">here</span> <span class="n">like</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">salary</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">work_years</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">education</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">company</span> <span class="o">=</span> <span class="n">scrapy</span><span class="p">.</span><span class="n">Field</span><span class="p">()</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre><span class="n">BOT_NAME</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">boss</span><span class="err">&#39;</span>
<span class="n">SPIDER_MODULES</span> <span class="o">=</span> <span class="p">[</span><span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span><span class="p">]</span>
<span class="n">NEWSPIDER_MODULE</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">spiders</span><span class="err">&#39;</span>
<span class="n">ROBOTSTXT_OBEY</span> <span class="o">=</span> <span class="n">False</span>
<span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_REQUEST_HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;*/</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">encoding</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span><span class="p">,</span> <span class="n">br</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">accept</span><span class="o">-</span><span class="n">language</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">en</span><span class="o">-</span><span class="n">US</span><span class="p">,</span><span class="n">en</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">CN</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">zh</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span><span class="n">zh</span><span class="o">-</span><span class="n">TW</span><span class="p">;</span><span class="n">q</span><span class="o">=</span><span class="mf">0.6</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Mozilla</span><span class="o">/</span><span class="mf">5.0</span> <span class="p">(</span><span class="n">Macintosh</span><span class="p">;</span> <span class="n">Intel</span> <span class="n">Mac</span> <span class="n">OS</span> <span class="n">X</span> <span class="mi">10</span><span class="n">_13_6</span><span class="p">)</span> <span class="n">AppleWebKit</span><span class="o">/</span><span class="mf">537.36</span> <span class="p">(</span><span class="n">KHTML</span><span class="p">,</span> <span class="n">like</span> <span class="n">Gecko</span><span class="p">)</span> <span class="n">Chrome</span><span class="o">/</span><span class="mf">69.0.3497.100</span> <span class="n">Safari</span><span class="o">/</span><span class="mf">537.36</span><span class="err">&#39;</span>
<span class="p">}</span>
<span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">#</span> <span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">BossDownloaderMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">543</span><span class="p">,</span>
    <span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">UserAgentDownloadMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="err">#</span> <span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">middlewares</span><span class="p">.</span><span class="n">IPProxyDownloadMiddleware</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">ITEM_PIPELINES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="err">&#39;</span><span class="n">boss</span><span class="p">.</span><span class="n">pipelines</span><span class="p">.</span><span class="n">BossPipeline</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<h5 id="jianshucom">jianshu.com</h5>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">scrapy</span> <span class="n">startproject</span> <span class="n">jianshu_spider</span>
<span class="n">cd</span> <span class="n">jianshu_spider</span><span class="o">/</span>
<span class="err">$</span> <span class="n">scrapy</span> <span class="n">genspider</span> <span class="o">-</span><span class="n">t</span> <span class="n">crawl</span> <span class="n">js</span> <span class="s">&quot;jianshu.com&quot;</span>
</pre></div>


<p>start.py</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">scrapy</span> <span class="n">import</span> <span class="n">cmdline</span>

<span class="n">cmdline</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="err">&#39;</span><span class="n">scrapy</span> <span class="n">crawl</span> <span class="n">js</span><span class="err">&#39;</span><span class="p">.</span><span class="n">split</span><span class="p">())</span>
</pre></div>


<p>settings.py</p>
<div class="hlcode"><pre>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-07-29 22:35:10</p>
      </span>
    </div>

    
    
  </body>
</html>