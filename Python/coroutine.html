<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>coroutine - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Python">Python</a>&nbsp;&#187;&nbsp;coroutine
    <span class="updated">Page Updated&nbsp;
      2019-08-15 08:51
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">coroutine</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#coroutine">coroutine 协程</a><ul>
<li><a href="#async">async</a></li>
<li><a href="#await">await</a></li>
</ul>
</li>
<li><a href="#asyncio">asyncio</a><ul>
<li><a href="#_1">上下文切换</a></li>
<li><a href="#asyncio_1">asyncio 原理</a><ul>
<li><a href="#_2">局限性</a></li>
</ul>
</li>
<li><a href="#event-loop">event loop</a></li>
<li><a href="#create_task">create_task()</a><ul>
<li><a href="#add_done_callback">add_done_callback()</a></li>
</ul>
</li>
<li><a href="#gather">gather()</a></li>
<li><a href="#run">run()</a></li>
</ul>
</li>
<li><a href="#_3">原理</a><ul>
<li><a href="#_4">错误处理</a></li>
<li><a href="#_5">生产者消费者模型</a></li>
</ul>
</li>
<li><a href="#example">example</a><ul>
<li><a href="#_6">效率对比</a></li>
</ul>
</li>
<li><a href="#vs-asyncio">多线程 vs Asyncio</a></li>
<li><a href="#_7">多进程</a></li>
</ul>
</div>
<h1 id="coroutine">coroutine 协程</h1>
<p>协程是实现并发编程的一种方式。</p>
<p>协程相对于多线程，其为单线程</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">24</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">await</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.16</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">2.87</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">5.04</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">10</span> <span class="n">s</span>
</pre></div>


<h2 id="async">async</h2>
<p>声明异步函数， 而调用异步函数，便可以得到一个协程对象coroutine object</p>
<h2 id="await">await</h2>
<p>可以通过await方法调用协程对象，await 执行的效果，和 Python 正常执行是一样的，也就是说程序会阻塞在这里，进入被调用的协程函数，执行完毕返回后再继续，而这也是 await 的字面意思</p>
<p>await是同步调用，所以结果为10s</p>
<h1 id="asyncio">asyncio</h1>
<p>由于多线程的局限性， （多线程运行中容易被打断，即出现race condition情况， 再者，线程切换本身存在一定的损耗， 线程数不能无限增加，若I/O操作非常频繁，多线程很可能满足不了高效率，高质量需求）</p>
<p>因而asyncio产生来解决这些问题</p>
<h2 id="_1">上下文切换</h2>
<p>操作系统及多线程/多进程中称为“上下文切换” (context switch)。其中“上下文”记录了某个线程执行的状态，包括线程里用到的各个变量，线程的调用栈等。而“切换”指的就是保存某个线程当前的运行状态，之后再从之前的状态中恢复。只不过线程相关的工作是由操作系统完成，而协程则是由应用程序自己来完成。</p>
<p>与线程不同的时，协程完成的功能通常较小，所以会有需求将不同的协程串起来，我们暂时称它为协程链 (coroutine chain)。</p>
<h2 id="asyncio_1">asyncio 原理</h2>
<p>Asyncio也是单线程的，只有一个主线程，可以进行多个不同的任务(就是future对象)， 不同的任务被event loop对象控制</p>
<h3 id="_2">局限性</h3>
<p>常用的requests库不兼容asyncio ，只能使用aiohttp库</p>
<p>使用asyncio在任务调度有更多主权，但是逻辑书写要注意，很容易出错</p>
<h2 id="event-loop">event loop</h2>
<p>若任务有两个状态，</p>
<p>预备状态：任务当前空闲，随时准备运行。</p>
<p>等待状态：任务已经运行，但正在等待外部的操作完成，如I/O操作</p>
<p>event loop会维护这两个任务列表，并且选取预备状态的一个任务，使其运行，一直到把这个任务控制权交还给event loop 为止。</p>
<p>当任务把控制权交还给event loop， event loop会根据其是否完成，放置在不同的状态列表中，然后遍历等待状态列表中的任务，查看其是否完成。</p>
<ul>
<li>完成就放到预备状态</li>
<li>未完成就继续放在等待状态</li>
</ul>
<p>这样，所有任务被重新放置在合适的列表后，开始新的循环，直到所有任务完成。</p>
<p>根据event loop的特点， 任务运行时不会被外部的一些因素打断，因此Asyncio内的操作不会出现race condition情况，也就不会出现线程安全的问题</p>
<blockquote>
<p>async 和 await </p>
</blockquote>
<h2 id="create_task">create_task()</h2>
<p>可以通过 asyncio.create_task() 来创建任务</p>
<p>asyncio.create_task(coro)表示对输入的协程 coro创建一个任务，安排其执行，并返回次任务对象</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">task</span> <span class="n">in</span> <span class="n">tasks</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">await</span> <span class="n">task</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.52</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">1.77</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">4.29</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">4.01</span> <span class="n">s</span>
</pre></div>


<h3 id="add_done_callback">add_done_callback()</h3>
<p>协程实现callback函数, 即绑定特定回调函数获得返回值</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">29</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="k">for</span> <span class="n">task</span> <span class="n">in</span> <span class="n">tasks</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>         <span class="n">task</span><span class="p">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">lambda</span> <span class="n">future</span><span class="o">:</span> <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">result</span><span class="o">:</span> <span class="err">&#39;</span><span class="p">,</span> <span class="n">future</span><span class="p">.</span><span class="n">result</span><span class="p">()))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="nl">result:</span>  <span class="n">None</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.12</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">1.85</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">3.97</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">4</span> <span class="n">s</span>
</pre></div>


<h2 id="gather">gather()</h2>
<p>另一种task写法， 针对await的一系列操作，如果只是单个future，只用asyncio.wait() 即可</p>
<p>asyncio.gather(*coro, loop=None, return_exception=False) 表示在event loop中运行coro序列中的所有任务</p>
<div class="hlcode"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">:</span> <span class="n">import</span> <span class="n">asyncio</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">crawling</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">sleep_time</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="n">url</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">OK</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="o">:</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">crawl_page</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls</span><span class="p">]</span> 
    <span class="p">...</span><span class="o">:</span>     <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span> <span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">([</span><span class="err">&#39;</span><span class="n">url_1</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_2</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_3</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">url_4</span><span class="err">&#39;</span><span class="p">]))</span> 
    <span class="p">...</span><span class="o">:</span>  
    <span class="p">...</span><span class="o">:</span>                                                                                              
<span class="n">crawling</span> <span class="n">url_1</span>
<span class="n">crawling</span> <span class="n">url_2</span>
<span class="n">crawling</span> <span class="n">url_3</span>
<span class="n">crawling</span> <span class="n">url_4</span>
<span class="n">OK</span> <span class="n">url_1</span>
<span class="n">OK</span> <span class="n">url_2</span>
<span class="n">OK</span> <span class="n">url_3</span>
<span class="n">OK</span> <span class="n">url_4</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">2.56</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">2.5</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">5.05</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">4.01</span> <span class="n">s</span>
</pre></div>


<h2 id="run">run()</h2>
<p>asyncio.run 来触发运行, 是Asyncio的root call， 表示拿到event loop，直到结束才关闭这个event loop</p>
<p>asyncio.run 这个函数是 Python 3.7 之后才有的特性，可以让 Python 的协程接口变得非常简单，你不用去理会事件循环怎么定义和怎么使用的问题，一个非常好的编程规范是，asyncio.run(main()) 作为主程序的入口函数，在程序运行周期内，只调用一次 asyncio.run。</p>
<h1 id="_3">原理</h1>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">before</span> <span class="n">await</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">worker_1</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_1</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">worker_2</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_2</span><span class="err">&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">before</span> <span class="n">await</span>
<span class="n">worker_1</span> <span class="n">start</span>
<span class="n">worker_1</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_1</span>
<span class="n">worker_2</span> <span class="n">start</span>
<span class="n">worker_2</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_2</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">3</span> <span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="err">#</span> <span class="mf">2.</span> <span class="err">从当前任务切出，调度</span><span class="n">worker2</span>  <span class="err">#</span> <span class="mf">3.</span> <span class="err">事件调度器这时候开始暂停调度，等待</span><span class="mi">1</span><span class="err">秒后，</span><span class="n">sleep</span><span class="err">完成，事件调度器控制器交给</span><span class="n">task1</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_1</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">4.</span> <span class="err">完成任务退出</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">start</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>  <span class="err">#</span> <span class="mf">3.</span> <span class="err">从当前任务切出</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">worker_2</span> <span class="n">done</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">6.</span> <span class="mi">2</span><span class="err">秒后事件调度器将控制器交给</span><span class="n">task2</span><span class="err">，</span> <span class="err">输出结果</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">task1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_1</span><span class="p">())</span> 
    <span class="n">task2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_2</span><span class="p">())</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">before</span> <span class="n">await</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">await</span> <span class="n">task1</span>     <span class="err">#</span> <span class="mf">1.</span> <span class="err">从</span><span class="n">main</span><span class="err">任务中切出，调度</span><span class="n">worker1</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_1</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">5.</span> <span class="err">完成</span><span class="n">task1</span><span class="err">，</span> <span class="err">控制器交给主任务，</span> <span class="err">输出结果</span>
    <span class="n">await</span> <span class="n">task2</span> 
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">awaited</span> <span class="n">worker_2</span><span class="err">&#39;</span><span class="p">)</span> <span class="err">#</span> <span class="mf">7.</span> <span class="err">输出结果，协程结束</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>   

<span class="o">&gt;&gt;&gt;</span>

<span class="n">before</span> <span class="n">await</span>
<span class="n">worker_1</span> <span class="n">start</span>
<span class="n">worker_2</span> <span class="n">start</span>
<span class="n">worker_1</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_1</span>
<span class="n">worker_2</span> <span class="n">done</span>
<span class="n">awaited</span> <span class="n">worker_2</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">2.01</span> <span class="n">s</span>
</pre></div>


<h2 id="_4">错误处理</h2>
<p>worker3执行过长会被cancel掉</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_1</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_2</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">0</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">worker_3</span><span class="p">()</span><span class="o">:</span>
    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">3</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">task_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_1</span><span class="p">())</span>
    <span class="n">task_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_2</span><span class="p">())</span>
    <span class="n">task_3</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker_3</span><span class="p">())</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">task_3</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="n">task_1</span><span class="p">,</span> <span class="n">task_2</span><span class="p">,</span> <span class="n">task_3</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>

<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ZeroDivisionError</span><span class="p">(</span><span class="err">&#39;</span><span class="n">division</span> <span class="n">by</span> <span class="n">zero</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">CancelledError</span><span class="p">()]</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">2</span> <span class="n">s</span>
</pre></div>


<h2 id="_5">生产者消费者模型</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>
<span class="n">import</span> <span class="n">random</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
    <span class="k">while</span> <span class="n">True</span><span class="o">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">await</span> <span class="n">queue</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">await</span> <span class="n">queue</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">Queue</span><span class="p">()</span>

    <span class="n">consumer_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">consumer_1</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">consumer_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">consumer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">consumer_2</span><span class="err">&#39;</span><span class="p">))</span>

    <span class="n">producer_1</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">producer_1</span><span class="err">&#39;</span><span class="p">))</span>
    <span class="n">producer_2</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">producer_2</span><span class="err">&#39;</span><span class="p">))</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">consumer_1</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
    <span class="n">consumer_2</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="n">consumer_1</span><span class="p">,</span> <span class="n">consumer_2</span><span class="p">,</span> <span class="n">producer_1</span><span class="p">,</span> <span class="n">producer_2</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>

<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">1</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">3</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">10</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">6</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">10</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">4</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">4</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">5</span>
<span class="n">producer_1</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">producer_2</span> <span class="n">put</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">8</span>
<span class="n">consumer_1</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">2</span>
<span class="n">consumer_2</span> <span class="n">get</span> <span class="n">a</span> <span class="n">val</span><span class="o">:</span> <span class="mi">8</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mi">10</span> <span class="n">s</span>
</pre></div>


<h1 id="example">example</h1>
<h2 id="_6">效率对比</h2>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span>
<span class="n">import</span> <span class="n">requests</span>
<span class="n">from</span> <span class="n">bs4</span> <span class="n">import</span> <span class="n">BeautifulSoup</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://movie.douban.com/cinema/later/beijing&quot;</span>
    <span class="n">init_page</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">).</span><span class="n">content</span>
    <span class="n">init_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">init_page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">all_movies</span> <span class="o">=</span> <span class="n">init_soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">id</span><span class="o">=</span><span class="err">&#39;</span><span class="n">showing</span><span class="o">-</span><span class="n">soon</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each_movie</span> <span class="n">in</span> <span class="n">all_movies</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;item&quot;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">all_a_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">all_li_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">li</span><span class="err">&#39;</span><span class="p">)</span>

        <span class="n">movie_name</span> <span class="o">=</span> <span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">text</span>
        <span class="n">url_to_fetch</span> <span class="o">=</span> <span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="err">&#39;</span><span class="n">href</span><span class="err">&#39;</span><span class="p">]</span>
        <span class="n">movie_date</span> <span class="o">=</span> <span class="n">all_li_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span>

        <span class="n">response_item</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_to_fetch</span><span class="p">).</span><span class="n">content</span>
        <span class="n">soup_item</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response_item</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">img_tag</span> <span class="o">=</span> <span class="n">soup_item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">img</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="p">{}</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">img_tag</span><span class="p">[</span><span class="err">&#39;</span><span class="n">src</span><span class="err">&#39;</span><span class="p">]))</span>

<span class="o">%</span><span class="n">time</span> <span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">CPU</span> <span class="n">times</span><span class="o">:</span> <span class="n">user</span> <span class="mf">1.3</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="o">:</span> <span class="mf">46.2</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="o">:</span> <span class="mf">1.35</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="o">:</span> <span class="mf">19.8</span> <span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="n">import</span> <span class="n">asyncio</span><span class="p">,</span> <span class="n">aiohttp</span>
<span class="n">import</span> <span class="n">time</span>
<span class="n">from</span> <span class="n">bs4</span> <span class="n">import</span> <span class="n">BeautifulSoup</span>

<span class="n">def</span> <span class="n">cost_time</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Time</span> <span class="n">costs</span><span class="o">:</span> <span class="p">{}</span><span class="n">s</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="n">async</span> <span class="n">def</span> <span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">:</span>
    <span class="n">header</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;User-Agent&quot;</span><span class="o">:</span> <span class="s">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.157 Safari/537.36&quot;</span><span class="p">}</span>
    <span class="n">async</span> <span class="n">with</span> <span class="n">aiohttp</span><span class="p">.</span><span class="n">ClientSession</span><span class="p">(</span>
        <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>  <span class="n">connector</span><span class="o">=</span><span class="n">aiohttp</span><span class="p">.</span><span class="n">TCPConnector</span><span class="p">(</span><span class="n">ssl</span><span class="o">=</span><span class="n">False</span><span class="p">)</span>
    <span class="p">)</span> <span class="n">as</span> <span class="n">session</span><span class="o">:</span>
        <span class="n">async</span> <span class="n">with</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="n">as</span> <span class="n">response</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">await</span> <span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">()</span>

<span class="err">@</span><span class="n">cost_time</span>
<span class="n">async</span> <span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://movie.douban.com/cinema/later/beijing&quot;</span>
    <span class="n">init_page</span> <span class="o">=</span> <span class="n">await</span> <span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">init_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">init_page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>

    <span class="n">movie_names</span><span class="p">,</span> <span class="n">urls_to_fetch</span><span class="p">,</span> <span class="n">movie_dates</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="n">all_movies</span> <span class="o">=</span> <span class="n">init_soup</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">id</span><span class="o">=</span><span class="err">&#39;</span><span class="n">showing</span><span class="o">-</span><span class="n">soon</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">each_movie</span> <span class="n">in</span> <span class="n">all_movies</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">div</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s">&quot;item&quot;</span><span class="p">)</span><span class="o">:</span>
        <span class="n">all_a_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="sc">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">all_li_tag</span> <span class="o">=</span> <span class="n">each_movie</span><span class="p">.</span><span class="n">find_all</span><span class="p">(</span><span class="err">&#39;</span><span class="n">li</span><span class="err">&#39;</span><span class="p">)</span>

        <span class="n">movie_names</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">text</span><span class="p">)</span>
        <span class="n">urls_to_fetch</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_a_tag</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="err">&#39;</span><span class="n">href</span><span class="err">&#39;</span><span class="p">])</span>
        <span class="n">movie_dates</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_li_tag</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">text</span><span class="p">)</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">fetch_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="n">in</span> <span class="n">urls_to_fetch</span><span class="p">]</span>
    <span class="n">pages</span> <span class="o">=</span> <span class="n">await</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">page</span> <span class="n">in</span> <span class="n">zip</span><span class="p">(</span><span class="n">movie_names</span><span class="p">,</span> <span class="n">movie_dates</span><span class="p">,</span> <span class="n">pages</span><span class="p">)</span><span class="o">:</span>
        <span class="n">soup_item</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">lxml</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">img_tag</span> <span class="o">=</span> <span class="n">soup_item</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="err">&#39;</span><span class="n">img</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="p">{}</span> <span class="p">{}</span> <span class="p">{}</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">movie_name</span><span class="p">,</span> <span class="n">movie_date</span><span class="p">,</span> <span class="n">img_tag</span><span class="p">[</span><span class="err">&#39;</span><span class="n">src</span><span class="err">&#39;</span><span class="p">]))</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Time</span> <span class="n">costs</span><span class="o">:</span> <span class="mf">1.5269999948941404e-06</span><span class="n">s</span>
</pre></div>


<h1 id="vs-asyncio">多线程 vs Asyncio</h1>
<div class="hlcode"><pre><span class="k">if</span> <span class="n">io_bound</span><span class="o">:</span>
    <span class="k">if</span> <span class="n">io_slow</span><span class="o">:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">Asyncio</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="nl">else:</span>
        <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">multi</span><span class="o">-</span><span class="n">threading</span><span class="err">&#39;</span><span class="p">)</span>
<span class="k">else</span> <span class="k">if</span> <span class="n">cpu_bound</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Use</span> <span class="n">multi</span><span class="o">-</span><span class="n">processing</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>如果是 I/O bound，并且 I/O 操作很慢，需要很多任务 / 线程协同实现，那么使用 Asyncio 更合适。</p>
<p>如果是 I/O bound，但是 I/O 操作很快，只需要有限数量的任务 / 线程，那么使用多线程就可以了。</p>
<p>如果是 CPU bound，则需要使用多进程来提高程序运行效率。</p>
<h1 id="_7">多进程</h1>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">time</span>
<span class="n">def</span> <span class="n">cpu_bound</span><span class="p">(</span><span class="n">number</span><span class="p">)</span><span class="o">:</span>
    <span class="n">print</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="n">number</span><span class="p">)))</span>

<span class="n">def</span> <span class="n">calculate_sums</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">number</span> <span class="n">in</span> <span class="n">numbers</span><span class="o">:</span>
        <span class="n">cpu_bound</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>

<span class="n">def</span> <span class="n">main</span><span class="p">()</span><span class="o">:</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>  
    <span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10000000</span> <span class="o">+</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>
    <span class="n">calculate_sums</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">print</span><span class="p">(</span><span class="err">&#39;</span><span class="n">Calculation</span> <span class="n">takes</span> <span class="p">{}</span> <span class="n">seconds</span><span class="err">&#39;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">main</span><span class="p">()</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">Calculation</span> <span class="n">takes</span> <span class="mf">17.826206894</span> <span class="n">seconds</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-01-02 08:56:17</p>
      </span>
    </div>

    
    
  </body>
</html>