<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>view_function - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Flask">Flask</a>&nbsp;&#187;&nbsp;view_function
    <span class="updated">Page Updated&nbsp;
      2019-08-10 11:51
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">view_function</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">视图函数</a><ul>
<li><a href="#_2">装饰器方法</a><ul>
<li><a href="#url">多URL绑定</a></li>
<li><a href="#url_1">动态URL</a></li>
</ul>
</li>
<li><a href="#url_2">URL 传递参数</a><ul>
<li><a href="#http-referer">HTTP referer</a></li>
<li><a href="#next">查询参数 next</a></li>
<li><a href="#is_safe_url-url">is_safe_url() 验证URL</a></li>
<li><a href="#_3">返回空值</a></li>
</ul>
</li>
<li><a href="#add_url_rule">add_url_rule</a></li>
<li><a href="#url_for-endpoint">url_for / endpoint</a></li>
<li><a href="#_4">转换器</a><ul>
<li><a href="#int">int</a></li>
<li><a href="#any">any</a></li>
<li><a href="#path">path</a></li>
<li><a href="#_5">自定义</a><ul>
<li><a href="#_6">带参数</a></li>
<li><a href="#to_python-to_url">to_python / to_url</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_7">请求钩子</a><ul>
<li><a href="#before_first_request">before_first_request</a></li>
<li><a href="#before_request">before_request</a></li>
<li><a href="#after_request">after_request</a></li>
<li><a href="#teardown_request">teardown_request</a></li>
<li><a href="#after_this_request">after_this_request</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#request">request 对象</a><ul>
<li><a href="#args">args</a></li>
<li><a href="#get_json">get_json</a></li>
</ul>
</li>
<li><a href="#response">response 对象</a><ul>
<li><a href="#make_response">make_response</a><ul>
<li><a href="#mime">MIME 类型</a><ul>
<li><a href="#json">json</a></li>
<li><a href="#jsonify-json">jsonify （替代json）</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#redirect">redirect 重定向</a><ul>
<li><a href="#url_for">url_for</a></li>
</ul>
</li>
<li><a href="#abort">abort</a></li>
<li><a href="#set_cookie">set_cookie()</a><ul>
<li><a href="#secret_key">secret_key</a></li>
</ul>
</li>
<li><a href="#session">session</a><ul>
<li><a href="#_8">注意点</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">视图函数</h1>
<p>负责管理URL和函数之间的映射</p>
<p>即MVC中的Controller</p>
<h2 id="_2">装饰器方法</h2>
<p>常用方法, 但是其实调用的是add_url_rule实现的</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">)</span>  <span class="err">#</span> <span class="err">定义路由，</span> <span class="err">不加斜杠即不兼容用户输入唯一</span><span class="n">URL</span><span class="err">的情况</span>
<span class="n">def</span> <span class="n">hello</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="err">&#39;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">Rick</span><span class="err">&#39;</span>

<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<h3 id="url">多URL绑定</h3>
<p>两个URL均会触发say_hello函数</p>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/hi&#39;</span><span class="p">)</span>
<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">say_hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World&lt;/h1&gt;&#39;</span>
</pre></div>


<h3 id="url_1">动态URL</h3>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/greet/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">greet</span><span class="p">(</span><span class="nb">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello, %s!&lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="nb">name</span>
</pre></div>


<p>设定默认值</p>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/greet&#39;</span><span class="p">)</span>
<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/greet/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">greet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Programmer&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello, %s! &lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="nb">name</span>
</pre></div>


<h2 id="url_2">URL 传递参数</h2>
<p>通过<code>&lt;&gt;</code> 中包含的参数传递</p>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/book/search/&lt;q&gt;/&lt;page&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nb">search</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">page</span><span class="p">):</span>
    <span class="nb">pass</span>
</pre></div>


<h3 id="http-referer">HTTP referer</h3>
<p>获取上一个页面URL， 请求数据包含的HTTP_REFERER字段记录了用户所在原站点URL， 在Flask中， 通过request.referrer获取</p>
<div class="hlcode"><pre><span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">referrer</span> <span class="n">or</span> <span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">))</span>
</pre></div>


<blockquote>
<p>referrer字段可能会是空值</p>
</blockquote>
<h3 id="next">查询参数 next</h3>
<p>通过在URL中手动加入包含当前页面URL的查询参数， 这个查询参数一般命名为next</p>
<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">flask</span> <span class="k">import</span> <span class="nx">request</span>

<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/foo&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nb">foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Foo Page&lt;/h1&gt;&lt;a href=&quot;%s&quot;&gt; % url_for(&#39;</span><span class="nx">do_something</span><span class="s1">&#39;, next=request.full_page)&#39;</span>
</pre></div>


<blockquote>
<p>request.full_page 可以获取当前页面的完整路径</p>
</blockquote>
<h3 id="is_safe_url-url">is_safe_url() 验证URL</h3>
<p>不验证next变量指向的URL，是否处于本地应用内，程序很容易被重定向到外部地址, 比如虚假完整的镜像网站</p>
<div class="hlcode"><pre><span class="nl">http:</span><span class="c1">//127.0.0.1:5000/do-something?next=http://xurick.com</span>
</pre></div>


<p>使用验证函数确保安全性</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">urlparse</span> <span class="n">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urljoin</span>
<span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">request</span>

<span class="n">def</span> <span class="n">is_safe_url</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">:</span>
    <span class="n">ref_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host_url</span><span class="p">)</span>
    <span class="n">test_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">host_url</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">test_url</span><span class="p">.</span><span class="n">scheme</span> <span class="n">in</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">https</span><span class="err">&#39;</span><span class="p">)</span> <span class="n">and</span> \
    <span class="n">ref_url</span><span class="p">.</span><span class="n">netloc</span> <span class="o">==</span> <span class="n">test_url</span><span class="p">.</span><span class="n">netloc</span>
</pre></div>


<div class="hlcode"><pre><span class="n">def</span> <span class="n">redirect_back</span><span class="p">(</span><span class="k">default</span><span class="o">=</span><span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">:</span>
    <span class="k">for</span> <span class="n">target</span> <span class="n">in</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">next</span><span class="err">&#39;</span><span class="p">),</span> <span class="n">request</span><span class="p">.</span><span class="n">referrer</span><span class="o">:</span>
        <span class="k">if</span> <span class="n">not</span> <span class="n">target</span><span class="o">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">is_safe_url</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="k">default</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</pre></div>


<h3 id="_3">返回空值</h3>
<div class="hlcode"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">post</span><span class="o">/</span><span class="n">delete</span><span class="o">/&lt;</span><span class="kt">int</span><span class="o">:</span><span class="n">post_id</span><span class="o">&gt;</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="err">&#39;</span><span class="n">DELETE</span><span class="err">&#39;</span><span class="p">])</span>
<span class="n">def</span> <span class="n">delete_post</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span><span class="o">:</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="mi">204</span>
</pre></div>


<h2 id="add_url_rule">add_url_rule</h2>
<p>在使用基于类的视图，即插式图，需要使用该方法， 实现了route装饰器的效果</p>
<div class="hlcode"><pre><span class="nx">add_url_rule</span><span class="p">(</span><span class="nx">rule</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">view_function</span><span class="p">)</span>
</pre></div>


<p>但装饰器里面不需要输入view_func ， 使用起来更方便</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">def</span> <span class="n">hello</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="err">&#39;</span><span class="n">Hello</span><span class="p">,</span> <span class="n">Rick</span><span class="err">&#39;</span>


<span class="n">app</span><span class="p">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">hello</span><span class="o">/</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="n">hello</span><span class="p">)</span>

<span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<p>查看当前程序注册的所有路由</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">flask</span> <span class="n">routes</span>
</pre></div>


<h2 id="url_for-endpoint">url_for / endpoint</h2>
<p>动态修改URL规则</p>
<p>默认第一个参数为endpoint，endpoint用来标记一个视图函数以及所对应的URL规则</p>
<p>endpoint的默认值为视图函数的名称</p>
<p>依赖上下文环境</p>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nb">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World&lt;/h1&gt;&#39;</span>
</pre></div>


<blockquote>
<p>url_for('index') 即可获取到对应的URL <code>/</code></p>
</blockquote>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/greet/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">greet</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Programmer&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello, %s! &lt;/h1&gt;&#39;</span> <span class="o">%</span> <span class="nb">name</span>
</pre></div>


<blockquote>
<p>url_for('greet', name='Rick') 获取为<code>/greet/Rick</code></p>
</blockquote>
<h2 id="_4">转换器</h2>
<p>转换器通过特定的规则制定，是对url地址的限制</p>
<div class="hlcode"><pre><span class="o">&lt;</span><span class="err">转换器：变量名</span><span class="o">&gt;</span>
</pre></div>


<h3 id="int">int</h3>
<p>转换为整数</p>
<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;goback/&lt;int:year&gt;&#39;&#39;)</span>
<span class="s1">def go_back(year):</span>
<span class="s1">    return &#39;</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Welcome</span> <span class="k">to</span> <span class="o">%</span><span class="nb">d</span> <span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span><span class="s1">&#39; % ()</span>
</pre></div>


<blockquote>
<p>对year变量转换为整数</p>
</blockquote>
<h3 id="any">any</h3>
<p>匹配一系列给定值的一个元素</p>
<div class="hlcode"><pre><span class="o">&lt;</span><span class="n">any</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="p">...)</span><span class="o">:</span> <span class="err">变量名</span><span class="o">&gt;</span>
</pre></div>


<div class="hlcode"><pre><span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/colors/&lt;any(blue, white, red):color&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">three_colors</span><span class="p">(</span><span class="nx">color</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;p&gt;three colors&lt;/p&gt;&#39;</span>
</pre></div>


<blockquote>
<p>访问http://127.0.0.1:5000/colors/<color> 时，color替换为any转换器中的其他值，均会404错误响应</p>
</blockquote>
<p>可以传入预先定的一个列表</p>
<div class="hlcode"><pre><span class="s-Atom">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s-Atom">&#39;blue&#39;</span><span class="p">,</span> <span class="s-Atom">&#39;white&#39;</span><span class="p">,</span> <span class="s-Atom">&#39;red&#39;</span><span class="p">]</span>
<span class="s-Atom">@app</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="s-Atom">&#39;/colors/&lt;any(%s):color&gt;&#39;</span> <span class="c1">% str(colors)[1:-1])</span>
<span class="p">....</span>
</pre></div>


<h3 id="path">path</h3>
<p>包含斜线的字符串</p>
<p>static路由的URL规则中的filename变量就使用了这个转换器</p>
<h3 id="_5">自定义</h3>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span>
<span class="n">from</span> <span class="n">werkzeug</span><span class="p">.</span><span class="n">routing</span> <span class="n">import</span> <span class="n">BaseConverter</span>  <span class="err">#</span> <span class="err">导入</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="cp"># 1. 自定义转换器 (继承BaseConverter)</span>
<span class="n">class</span> <span class="n">MobileConverter</span><span class="p">(</span><span class="n">BaseConverter</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="err">第一个参数</span><span class="n">url_map</span><span class="err">是固定的。</span><span class="p">(</span><span class="n">url_map</span><span class="err">一般直接交给父类</span><span class="n">BaseConverter</span><span class="err">使用</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url_map</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="err">先调用父类</span><span class="n">BaseConverter</span><span class="err">的初始化方法</span>
        <span class="n">super</span><span class="p">(</span><span class="n">MobileConverter</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">url_map</span><span class="p">)</span>
        <span class="err">#</span> <span class="n">flask</span><span class="err">会自动通过</span><span class="n">regex</span><span class="err">属性来进行路由的正则匹配</span>
        <span class="n">self</span><span class="p">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">r</span><span class="err">&#39;</span><span class="mi">1</span><span class="p">[</span><span class="mi">34578</span><span class="p">]</span><span class="err">\</span><span class="n">d</span><span class="p">{</span><span class="mi">9</span><span class="p">}</span><span class="err">&#39;</span>  <span class="err">#</span> <span class="err">匹配手机号的正则</span>


<span class="cp"># 2. 将自定义的转换器添加到flask的应用中</span>
<span class="n">app</span><span class="p">.</span><span class="n">url_map</span><span class="p">.</span><span class="n">converters</span><span class="p">[</span><span class="s">&quot;mobile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MobileConverter</span>


<span class="cp"># 127.0.0.1:5000/send/18612345678</span>
<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/send/&lt;mobile:mobile_num&gt;&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="n">mobile</span> <span class="err">使用自定义的转换器</span>
<span class="n">def</span> <span class="n">send_sms</span><span class="p">(</span><span class="n">mobile_num</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="s">&quot;send sms to %s&quot;</span> <span class="o">%</span> <span class="n">mobile_num</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<h4 id="_6">带参数</h4>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span>
<span class="n">from</span> <span class="n">werkzeug</span><span class="p">.</span><span class="n">routing</span> <span class="n">import</span> <span class="n">BaseConverter</span>  <span class="err">#</span> <span class="err">导入</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="cp"># 1. 自定义转换器 (继承BaseConverter)</span>
<span class="n">class</span> <span class="n">RegexConverter</span><span class="p">(</span><span class="n">BaseConverter</span><span class="p">)</span><span class="o">:</span>
    <span class="err">#</span> <span class="err">第一个参数</span><span class="n">url_map</span><span class="err">是固定的。</span><span class="p">(</span><span class="n">url_map</span><span class="err">一般直接交给父类</span><span class="n">BaseConverter</span><span class="err">使用</span><span class="p">)</span>
    <span class="err">#</span> <span class="err">接收参数</span><span class="n">regex</span>
    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url_map</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span><span class="o">:</span>
        <span class="n">super</span><span class="p">(</span><span class="n">RegexConverter</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">url_map</span><span class="p">)</span>
        <span class="err">#</span> <span class="err">将路由中正则表达式参数传递给</span><span class="n">regex</span><span class="err">属性</span>
        <span class="err">#</span> <span class="n">flask</span><span class="err">会自动通过</span><span class="n">regex</span><span class="err">属性来进行路由的正则匹配</span>
        <span class="n">self</span><span class="p">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span>


<span class="cp"># 2. 将自定义的转换器添加到flask的应用中</span>
<span class="n">app</span><span class="p">.</span><span class="n">url_map</span><span class="p">.</span><span class="n">converters</span><span class="p">[</span><span class="s">&quot;re&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RegexConverter</span>


<span class="cp"># 127.0.0.1:5000/send/18612345678</span>
<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/send/&lt;re(r&#39;1[34578]\d{9}&#39;):mobile_num&gt;&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="p">()</span><span class="err">表示传递给转换器的参数</span><span class="p">(</span><span class="err">正则表达式</span><span class="p">)</span>
<span class="n">def</span> <span class="n">send_sms</span><span class="p">(</span><span class="n">mobile_num</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="s">&quot;send sms to %s&quot;</span> <span class="o">%</span> <span class="n">mobile_num</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<h4 id="to_python-to_url">to_python / to_url</h4>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="n">from</span> <span class="n">werkzeug</span><span class="p">.</span><span class="n">routing</span> <span class="n">import</span> <span class="n">BaseConverter</span>  <span class="err">#</span> <span class="err">导入</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="cp"># 1. 自定义转换器 (继承BaseConverter)</span>
<span class="n">class</span> <span class="n">RegexConverter</span><span class="p">(</span><span class="n">BaseConverter</span><span class="p">)</span><span class="o">:</span>

    <span class="n">def</span> <span class="n">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">url_map</span><span class="p">,</span> <span class="n">regex</span><span class="p">)</span><span class="o">:</span>
        <span class="n">super</span><span class="p">(</span><span class="n">RegexConverter</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">(</span><span class="n">url_map</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span>

    <span class="err">#</span> <span class="err">重写父类的</span><span class="n">to_python</span><span class="p">()</span><span class="err">方法。</span> <span class="p">(</span><span class="err">可以对</span><span class="n">url</span><span class="err">参数做预处理，类型转换等</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">to_python</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="n">value</span><span class="err">参数就是</span><span class="n">url</span><span class="err">中匹配出的内容。</span>
        <span class="err">#</span> <span class="err">可以在</span><span class="n">to_python</span><span class="p">()</span><span class="err">方法中对</span><span class="n">url</span><span class="err">参数做预处理、类型转换等</span> <span class="p">(</span><span class="err">转换器本质</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>  <span class="err">#</span> <span class="n">return</span><span class="err">的返回值就是传递给视图函数的值</span>

    <span class="err">#</span> <span class="err">重写父类的</span><span class="n">to_url</span><span class="p">()</span><span class="err">方法。</span> <span class="err">使用</span><span class="n">url_for</span><span class="err">方法的时候被调用</span><span class="p">(</span><span class="n">url</span><span class="err">反向解析</span><span class="p">)</span>
    <span class="n">def</span> <span class="n">to_url</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">:</span>
        <span class="err">#</span> <span class="n">value</span><span class="err">就是</span><span class="n">url_for</span><span class="p">()</span><span class="err">中传递的参数。</span>
        <span class="err">#</span> <span class="k">return</span> <span class="s">&quot;15811111111&quot;</span>
        <span class="k">return</span> <span class="n">value</span>   <span class="err">#</span> <span class="err">返回值就是</span><span class="n">url</span><span class="err">路由正则匹配出的</span><span class="n">url</span><span class="err">部分。</span>


<span class="cp"># 2. 将自定义的转换器添加到flask的应用中</span>
<span class="n">app</span><span class="p">.</span><span class="n">url_map</span><span class="p">.</span><span class="n">converters</span><span class="p">[</span><span class="s">&quot;re&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RegexConverter</span>


<span class="cp"># 127.0.0.1:5000/send/18612345678</span>
<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/send/&lt;re(r&#39;1[34578]\d{9}&#39;):mobile_num&gt;&quot;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">send_sms</span><span class="p">(</span><span class="n">mobile_num</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="s">&quot;send sms to %s&quot;</span> <span class="o">%</span> <span class="n">mobile_num</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">&quot;/index&quot;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">index</span><span class="p">()</span><span class="o">:</span>
    <span class="err">#</span> <span class="n">url</span><span class="err">反向解析，根据</span><span class="n">send_sms</span><span class="err">视图获取对应的</span><span class="n">url</span><span class="err">。</span> <span class="p">(</span><span class="err">会调用转换器的</span><span class="n">to_url</span><span class="p">()</span><span class="err">方法</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&quot;send_sms&quot;</span><span class="p">,</span> <span class="n">mobile_num</span><span class="o">=</span><span class="s">&quot;18912341235&quot;</span><span class="p">)</span>  <span class="err">#</span> <span class="n">mobile_num</span><span class="err">对应视图函数接收的形参。</span>
    <span class="err">#</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;/send/18912341235&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
</pre></div>


<h2 id="_7">请求钩子</h2>
<p>对请求进行预处理preprocessing和后处理postprocessing操作,在请求处理的不同阶段执行的处理函数</p>
<p><img alt="img" src="https://snag.gy/4VQg59.jpg" /></p>
<h3 id="before_first_request">before_first_request</h3>
<p>运行程序前的初始化操作，比如创建数据库表，添加管理员用户</p>
<h3 id="before_request">before_request</h3>
<p>如记录用户最后在线时间，通过用户发送的请求时间来实现，避免在每个视图函数都添加更新在线时间的代码，可以在此调用该代码</p>
<h3 id="after_request">after_request</h3>
<p>对数据库进行更新，插入等，之后需要将更改提交到数据库中，可以在此调用</p>
<h3 id="teardown_request">teardown_request</h3>
<p>在请求之后，关闭数据库连接，通过在使用请求钩子注册的函数中添加代码实现</p>
<h3 id="after_this_request">after_this_request</h3>
<p>必须接收一个响应类函数作为参数，并且放回同一个或者更新后的响应对象</p>
<h1 id="request">request 对象</h1>
<p>封装了客户端发来的所有请求数据</p>
<h2 id="args">args</h2>
<p>通过字典方式取值, 推荐使用get方法</p>
<div class="hlcode"><pre><span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">Flask</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<p>若使用字典方式取值</p>
<div class="hlcode"><pre><span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="p">]</span>
</pre></div>


<blockquote>
<p>没有对应的健，会报出http 404 错误， bad request</p>
</blockquote>
<p>若无对映值，放回None</p>
<h2 id="get_json">get_json</h2>
<h1 id="response">response 对象</h1>
<h2 id="make_response">make_response</h2>
<p>视图函数返回的是response 对象， make_response方法将试图函数返回值转换为响应对象</p>
<p>response对象所返回的结果取决于<code>content-type</code> 所定义的value</p>
<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">flask</span> <span class="k">import</span> <span class="nx">Flask</span><span class="p">,</span> <span class="nx">make_response</span>


<span class="n">app</span> <span class="o">=</span> <span class="nx">Flask</span><span class="p">(</span><span class="nx">__name__</span><span class="p">)</span>

<span class="nx">app.config.from_object</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>


<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/hello/&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">hello</span><span class="p">():</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span>
        <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.bing.com&#39;</span>
    <span class="p">}</span>
    <span class="err">#</span> <span class="n">response</span> <span class="o">=</span> <span class="nx">make_response</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">,</span> <span class="mi">301</span><span class="p">)</span>
    <span class="err">#</span> <span class="n">response.headers</span> <span class="o">=</span> <span class="nb">headers</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;html&gt;&lt;/html&gt;&#39;</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="nb">headers</span>


<span class="nx">app.add_url_rule</span><span class="p">(</span><span class="s1">&#39;/hello/&#39;</span><span class="p">,</span> <span class="n">view_func</span><span class="o">=</span><span class="nx">hello</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nx">app.run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="nx">app.config</span><span class="err">[</span><span class="s1">&#39;DEBUG&#39;</span><span class="cp">]</span>)
</pre></div>


<h3 id="mime">MIME 类型</h3>
<p>content-type 可以定义MIME类型， </p>
<p>HTML为text/html</p>
<p>png 为 image/png</p>
<p>纯文本为text/plain</p>
<p>xml为 application/xml</p>
<p>json为 application/json</p>
<h4 id="json">json</h4>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">json</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">foo</span><span class="p">()</span><span class="o">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="err">&#39;</span><span class="n">name</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Rick</span><span class="err">&#39;</span><span class="p">,</span>
        <span class="err">&#39;</span><span class="n">gender</span><span class="err">&#39;</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">male</span><span class="err">&#39;</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">response</span><span class="p">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="err">&#39;</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>


<h4 id="jsonify-json">jsonify （替代json）</h4>
<p>依赖上下文环境，因为其内部调用中使用了current_app变量</p>
<p>一般不直接使用json模块的dumps和loads方法，jsonify函数只需对传入的参数进行序列化即可</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">jsonify</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">foo</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="n">name</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">Rick</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">gender</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">male</span><span class="err">&#39;</span><span class="p">})</span>
</pre></div>


<p>jsonify 函数默认生产200 响应，可以附加自定义响应类型</p>
<div class="hlcode"><pre><span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">foo</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">&quot;Error! &quot;</span><span class="p">),</span> <span class="mi">500</span>
</pre></div>


<h2 id="redirect">redirect 重定向</h2>
<p>redirect函数生成重定向响应</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">hello</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//www.xuxuehua.com&#39;)</span>
</pre></div>


<h3 id="url_for">url_for</h3>
<p>重定向到其他视图函数</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">hi</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">hi</span><span class="p">()</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">))</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">hello</span><span class="p">()</span><span class="o">:</span>
    <span class="n">pass</span>
</pre></div>


<blockquote>
<p>这里的hello是视图函数</p>
</blockquote>
<h2 id="abort">abort</h2>
<p>该函数不需要使用return语句，一旦被调用，后面的代码就不会被执行</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">abort</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="mi">404</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">not_found</span><span class="p">()</span><span class="o">:</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
</pre></div>


<p>实现用户登陆</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">session</span><span class="p">,</span> <span class="n">abort</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">admin</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">admin</span><span class="p">()</span><span class="o">:</span>
    <span class="s">&quot;&quot;&quot;</span>
    <span class="err">使用字典方式存入</span><span class="n">key</span><span class="err">信息</span>
    <span class="n">session</span><span class="p">[</span><span class="err">&#39;</span><span class="n">logged_in</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">True</span>
    <span class="s">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="err">&#39;</span><span class="n">logged_in</span><span class="err">&#39;</span> <span class="n">not</span> <span class="n">in</span> <span class="n">session</span><span class="o">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
    <span class="k">return</span> <span class="err">&#39;</span><span class="n">Welcome</span> <span class="n">to</span> <span class="n">admin</span> <span class="n">page</span><span class="p">.</span><span class="err">&#39;</span>
</pre></div>


<p>登出用户</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">logout</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">logout</span><span class="p">()</span><span class="o">:</span>
    <span class="k">if</span> <span class="err">&#39;</span><span class="n">logged_in</span><span class="err">&#39;</span> <span class="n">in</span> <span class="n">session</span><span class="o">:</span>
        <span class="n">session</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="err">&#39;</span><span class="n">logged_in</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="n">login</span><span class="err">&#39;</span><span class="p">))</span>
</pre></div>


<h2 id="set_cookie">set_cookie()</h2>
<p>Flask 操作cookie，是通过response 对象来操作，可以在response返回之前，通过response.set_cookie 来设置</p>
<div class="hlcode"><pre><span class="nb">from</span> <span class="nx">flask</span> <span class="k">import</span> <span class="nx">Flask</span><span class="p">,</span> <span class="nx">make_response</span>

<span class="p">@</span><span class="nx">app.route</span><span class="p">(</span><span class="s1">&#39;/set/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="nx">def</span> <span class="nx">set_cookie</span><span class="p">(</span><span class="nb">name</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="nx">make_response</span><span class="p">(</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">url_for</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)))</span>
    <span class="nx">response.set_cookie</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">response</span>
</pre></div>


<blockquote>
<p>生成的Set-Cookie字段为 "Set-Cookie: name=Grey;Path=/"</p>
</blockquote>
<p>其几个参数需要注意</p>
<div class="hlcode"><pre><span class="n">key</span><span class="err">：设置的</span><span class="n">cookie</span><span class="err">的</span><span class="n">key</span><span class="err">。</span>
<span class="n">value</span><span class="err">：</span><span class="n">key</span><span class="err">对应的</span><span class="n">value</span><span class="err">。</span>
<span class="n">max_age</span><span class="err">：改</span><span class="n">cookie</span><span class="err">的过期时间，如果不设置，则浏览器关闭后就会自动过期。</span>
<span class="n">expires</span><span class="err">：过期时间，应该是一个</span><span class="n">datetime</span><span class="err">类型。</span>
<span class="n">domain</span><span class="err">：该</span><span class="n">cookie</span><span class="err">在哪个域名中有效。一般设置子域名，比如</span><span class="n">cms</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span><span class="err">。</span>
<span class="n">path</span><span class="err">：该</span><span class="n">cookie</span><span class="err">在哪个路径下有效。</span>
</pre></div>


<p>使用：</p>
<div class="hlcode"><pre><span class="err">获取：</span><span class="n">request</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="err">&#39;默认值&#39;</span><span class="p">)</span>
<span class="err">设置：</span><span class="n">resp</span><span class="p">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="err">整数</span><span class="p">)</span>
<span class="err">删除：</span><span class="n">resp</span><span class="p">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</pre></div>


<h3 id="secret_key">secret_key</h3>
<p>把密钥写进系统环境变量中</p>
<div class="hlcode"><pre><span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">secret</span> <span class="n">string</span>

<span class="cp">###</span>

<span class="n">import</span> <span class="n">os</span> 
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getenv</span><span class="p">(</span><span class="err">&#39;</span><span class="n">SECRET_KEY</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">secret</span> <span class="n">string</span><span class="err">&#39;</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>这里的secret string 需要时一段特殊的随机密钥值</p>
</blockquote>
<h2 id="session">session</h2>
<p>Flask 的 session 默认是client side 的，session是写入到浏览器的cookie中，当浏览器关闭，cookie会自动消失</p>
<p>将session数据加密，然后存储在cookie中，这种专业术语叫做client side session， flask采用这种方式</p>
<div class="hlcode"><pre><span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">url_for</span>

<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">login</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">login</span><span class="p">()</span><span class="o">:</span>
    <span class="n">session</span><span class="p">[</span><span class="err">&#39;</span><span class="n">logged_in</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">True</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="err">&#39;</span><span class="n">hello</span><span class="err">&#39;</span><span class="p">))</span>
</pre></div>


<blockquote>
<p>session 中的数据可以像字典一样通过键读取，或时使用get方法<br />
</p>
</blockquote>
<p>sqlalchemy</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">redis</span>
<span class="n">from</span> <span class="n">flask</span> <span class="n">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span>
<span class="n">from</span> <span class="n">flask_session</span> <span class="n">import</span> <span class="n">Session</span> 
<span class="n">from</span> <span class="n">flask_sqlalchemy</span> <span class="n">import</span> <span class="n">SQLAlchemy</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">True</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">adavafa</span><span class="err">&#39;</span>

<span class="cp"># 设置数据库链接</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SQLALCHEMY_DATABASE_URI</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">mysql</span><span class="o">+</span><span class="n">pymysql</span><span class="o">:</span><span class="c1">//root:dev@127.0.0.1:3306/devops?charset=utf8&#39;</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">True</span>
<span class="cp"># 实例化SQLAlchemy</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_TYPE</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">sqlalchemy</span><span class="err">&#39;</span> <span class="err">#</span> <span class="n">session</span><span class="err">类型为</span><span class="n">sqlalchemy</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_SQLALCHEMY</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span> <span class="err">#</span> <span class="n">SQLAlchemy</span><span class="err">对象</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_SQLALCHEMY_TABLE</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;表名&#39;</span> <span class="err">#</span> <span class="n">session</span><span class="err">要保存的表名称</span>

<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_PERMANENT</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">True</span> <span class="err">#</span> <span class="err">如果设置为</span><span class="n">True</span><span class="err">，则关闭浏览器</span><span class="n">session</span><span class="err">就失效。</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">PERMANENT_SESSION_LIFETIME</span><span class="err">&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="cp">#一个持久化的会话的生存时间，是一个datetime.timedelta对象，也可以用一个整数来表示秒,前提设置了PERMANENT_SESSION_LIFETIME为True</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_USE_SIGNER</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">False</span> <span class="err">#</span> <span class="err">是否对发送到浏览器上</span><span class="n">session</span><span class="err">的</span><span class="n">cookie</span><span class="err">值进行加密</span><span class="p">,</span><span class="err">默认</span><span class="n">False</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_KEY_PREFIX</span><span class="err">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">flask</span><span class="o">-</span><span class="n">session</span><span class="err">&#39;</span> <span class="err">#</span> <span class="err">保存的</span><span class="n">session</span><span class="err">的</span><span class="n">key</span><span class="err">的前缀</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_COOKIE_NAME</span><span class="err">&#39;</span><span class="p">]</span><span class="o">=</span> <span class="err">&#39;</span><span class="n">session_id</span><span class="err">&#39;</span>  <span class="err">#</span> <span class="err">保存在浏览器的</span><span class="n">cookie</span><span class="err">名称</span>


<span class="cp">#其他配置，不经常使用</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_COOKIE_DOMAIN</span><span class="err">&#39;</span><span class="p">]</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">127.0.0.1</span><span class="err">&#39;</span> <span class="err">#</span> <span class="err">设置</span><span class="n">cookie</span><span class="err">的域名，不建议设置默认为</span><span class="n">server_name</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_COOKIE_PATH</span><span class="err">&#39;</span><span class="p">]</span><span class="o">=</span><span class="sc">&#39;/&#39;</span> <span class="err">#</span> <span class="err">会话</span><span class="n">cookie</span><span class="err">的路径。</span> <span class="err">如果未设置，则</span><span class="n">cookie</span><span class="err">将对所有</span><span class="n">url</span><span class="err">有效，默认为</span><span class="sc">&#39;/&#39;</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">[</span><span class="err">&#39;</span><span class="n">SESSION_COOKIE_HTTPONLY</span><span class="err">&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">True</span> <span class="err">#</span> <span class="err">是否启动</span><span class="n">httponly</span><span class="p">,</span><span class="err">默认为</span><span class="nb">true</span><span class="err">，为了防止</span><span class="n">xss</span><span class="err">脚本访问</span><span class="n">cookie</span>




<span class="n">Session</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>


<span class="err">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">login</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">def</span> <span class="n">index</span><span class="p">()</span><span class="o">:</span>
 <span class="n">session</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;jack&quot;</span>
 <span class="k">return</span> <span class="err">&#39;</span><span class="n">login</span><span class="err">&#39;</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="err">&#39;</span><span class="n">__main__</span><span class="err">&#39;</span><span class="o">:</span>
 <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">()</span>


<span class="cp">###使用SQLAlchemy时候先确保数据库和表都存在</span>
<span class="err">在命令行中创建表</span>
<span class="cp">#&gt;&gt;&gt; from app import db</span>
<span class="cp">#&gt;&gt;&gt; db.create_all()</span>
</pre></div>


<p>设置数据库</p>
<div class="hlcode"><pre><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">public</span><span class="p">.</span><span class="n">flask_session_table</span> <span class="p">(</span>
    <span class="n">id</span> <span class="n">integer</span> <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="n">NOT</span> <span class="nb">NULL</span><span class="p">,</span>
    <span class="n">session_id</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
    <span class="n">data</span> <span class="n">bytea</span><span class="p">,</span>
    <span class="n">expiry</span> <span class="n">timestamp</span> <span class="n">without</span> <span class="n">time</span> <span class="n">zone</span>
<span class="p">);</span>
</pre></div>


<h3 id="_8">注意点</h3>
<p>尽管session对象对Cookie进行签名并加密，这种方式仅能够保证session的内容不会被篡改，加密后的数据借助工具仍然可以被轻易读取，所以不能在session中存储敏感信息</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-12-16 08:46:05</p>
      </span>
    </div>

    
    
  </body>
</html>