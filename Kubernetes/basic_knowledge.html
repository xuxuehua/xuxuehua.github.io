<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Basic_Knowledge - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;Basic_Knowledge
    <span class="updated">Page Updated&nbsp;
      2018-06-02 19:03
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Basic_Knowledge</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">基础知识</a><ul>
<li><a href="#kubernetes">Kubernetes 特性</a><ul>
<li><a href="#auto-scaling">自动的调度 Auto Scaling</a></li>
<li><a href="#service-discovery">服务的自动发现 Service Discovery</a></li>
<li><a href="#app-deployment">灰度发布 App Deployment</a></li>
</ul>
</li>
<li><a href="#kubernetes_1">Kubernetes 架构</a><ul>
<li><a href="#master-node">Master node</a></li>
<li><a href="#worker-node">Worker node</a></li>
</ul>
</li>
<li><a href="#kubernetes_2">Kubernetes 功能</a><ul>
<li><a href="#pod">Pod 容器集</a><ul>
<li><a href="#pod-template">Pod template</a></li>
</ul>
</li>
<li><a href="#label">Label</a><ul>
<li><a href="#label-selector">Label Selector</a></li>
</ul>
</li>
<li><a href="#replication-controller">Replication Controller</a></li>
<li><a href="#deployment">Deployment</a></li>
<li><a href="#horizontal-pod-autoscaler">Horizontal Pod Autoscaler</a><ul>
<li><a href="#metrics">Metrics 支持</a></li>
</ul>
</li>
<li><a href="#service">Service</a><ul>
<li><a href="#endpoint">Endpoint</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#kubernetes_3">Kubernetes 服务发现机制</a><ul>
<li><a href="#_2">环境变量</a></li>
<li><a href="#dns">DNS</a></li>
<li><a href="#service_1">外部系统访问service问题</a></li>
<li><a href="#_3">服务类型</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">基础知识</h1>
<p><img alt="alt" src="https://cdn.pbrd.co/images/HocvM1f.png" /></p>
<h2 id="kubernetes">Kubernetes 特性</h2>
<h3 id="auto-scaling">自动的调度 Auto Scaling</h3>
<p>对资源默认的调度</p>
<h3 id="service-discovery">服务的自动发现 Service Discovery</h3>
<h3 id="app-deployment">灰度发布 App Deployment</h3>
<p>灰度发布（又名金丝雀发布）是指在黑与白之间，能够平滑过渡的一种发布方式。在其上可以进行A/B testing，即让一部分用户继续用产品特性A，一部分用户开始用产品特性B，如果用户对B没有什么反对意见，那么逐步扩大范围，把所有用户都迁移到B上面来。灰度发布可以保证整体系统的稳定，在初始灰度的时候就可以发现、调整问题，以保证其影响度。</p>
<p>一旦有故障发生，会立即自动执行回滚操作。</p>
<h2 id="kubernetes_1">Kubernetes 架构</h2>
<p><img alt="alt" src="https://cdn.pbrd.co/images/HocwGKR.png" /></p>
<h3 id="master-node">Master node</h3>
<p>集群的网关和中枢，负责为用户和客户端暴露API，跟踪其他服务器的健康状态，以最优的方式调度工作负载，已经编排其他组件之间的通信等任务。</p>
<p>包含3个进程</p>
<p>API Server：提供资源统一的入口</p>
<p>Controller manager：资源的管理和调度（pod调度）</p>
<p>Scheduler：调度的队列，node的列表</p>
<p>使用etcd进行存储</p>
<h3 id="worker-node">Worker node</h3>
<p>包含3个进程</p>
<p>Kubelet：负责pod对应的容器创建，启动停止等任务， 与master 节点协作，实现集群管理， 与Master node协同同坐</p>
<p>Kube proxy：实现kubernetes service 的通信和负载均衡机制的重要组件，缓存代理，通过iptables的nat表实现</p>
<p>Docker Engine：Docker 引擎，负责本机的容器创建和管理工作</p>
<h2 id="kubernetes_2">Kubernetes 功能</h2>
<h3 id="pod">Pod 容器集</h3>
<p>Pod 是Kubernetes中可以创建的最小部署单元， Pod是一组容器的集合</p>
<p>为分组的容器增加了一个抽象层，帮助用户调度工作负载，并为这些容器提供所需的联网和存储服务。</p>
<p>每个Pod里面都会有一个pause，大概20k大小。这个pause管理网络，以及容器的状态</p>
<h4 id="pod-template">Pod template</h4>
<ul>
<li>(Resource)[https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/]</li>
</ul>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">pod</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s1">&#39;sh&#39;</span><span class="o">,</span> <span class="s1">&#39;-c&#39;</span><span class="o">,</span> <span class="s1">&#39;echo Hello Kubernetes! &amp;&amp; sleep 3600&#39;</span><span class="o">]</span>
</pre></div>


<h3 id="label">Label</h3>
<blockquote>
<p>label是一个key=value的键值对，可以附加到各种资源对象上， 列入Node，Pod， Service， Replication Controller等</p>
</blockquote>
<h4 id="label-selector">Label Selector</h4>
<blockquote>
<p>很多object可能有相同的label通过label selector， 客户端可以指定object集合，通过label selector 对object的集合进行操作</p>
</blockquote>
<ul>
<li>
<p>Equality-based: 可以使用=， ==， !=操作， 逗号分隔多个表达式</p>
</li>
<li>
<p>Et-based:  可以使用in， notin， ! 操作符</p>
</li>
</ul>
<p>e.g.<code>kubectl get pods -l 'environment=production,tier=frontend' $ kubectl get pods -l 'environment in (production), tier in (frontend)'</code></p>
<h3 id="replication-controller">Replication Controller</h3>
<blockquote>
<p>定义了一个期望的场景，声明某种pod的副本数量在任意时刻都符合某个预期值</p>
</blockquote>
<p>e.g. <code>apiVersion: extensions/v1beat1 kind: Replication metadata: name: frontend</code></p>
<h3 id="deployment">Deployment</h3>
<blockquote>
<p>Deployment 为Pod和ReplicaSet提供一个声明方法，用来替代Replication Controller 来方便管理</p>
</blockquote>
<h3 id="horizontal-pod-autoscaler">Horizontal Pod Autoscaler</h3>
<blockquote>
<p>对资源实现削峰填谷， 提高集群的整体资源利用率</p>
</blockquote>
<p><img alt="alt" src="https://cdn.pbrd.co/images/HocsZti.png" /></p>
<h4 id="metrics">Metrics 支持</h4>
<ul>
<li>
<p>autoscaling/v1</p>
</li>
<li>
<p>CPU</p>
</li>
<li>autoscaling/v2</li>
<li>
<p>Memory </p>
</li>
<li>
<p>自定义</p>
<ul>
<li>Kubernetes1.6起支持，必须在kube-controller-manager中配制下列两项</li>
</ul>
<blockquote>
<p>--horizontal-pod-autoscaler-use-rest-clients=true</p>
<p>--api-server 指向kube-aggregator, 或--api-server=true</p>
</blockquote>
</li>
</ul>
<h3 id="service">Service</h3>
<blockquote>
<p>一个pod的逻辑分组，一种可以访问它们的策略成为微服务</p>
<p>一组pod能够被Service 访问到，通常通过Label Selector 实现</p>
</blockquote>
<ul>
<li>Pod, RC, Service 关系</li>
</ul>
<p><img alt="alt" src="https://cdn.pbrd.co/images/Hocxo86.png" /></p>
<ul>
<li>service 事例</li>
</ul>
<p><code>kind: Service
   opiVersion: v1
   metadata:
     name: my-service
   spec:
     selector:
       app: MyApp
     ports:
       - protocol: TCP
         port: 80
         targetPort: 9376</code></p>
<h4 id="endpoint">Endpoint</h4>
<blockquote>
<p>Endpoint: Pod IP + Container Port </p>
</blockquote>
<p>​    </p>
<h2 id="kubernetes_3">Kubernetes 服务发现机制</h2>
<blockquote>
<p>支持两种服务发现模式 - 环境变量和DNS</p>
</blockquote>
<h3 id="_2">环境变量</h3>
<blockquote>
<p>当Pod运行在Node上，Kubelet会为每个活跃的Service添加一组环境变量</p>
</blockquote>
<h3 id="dns">DNS</h3>
<blockquote>
<p>Kubernetes 通过Add on 方式引入DNS，把服务名称作为DNS域名，这样，程序就可以直接使用服务名来建立通信连接，目前大部分应用都采用DNS这种机制</p>
</blockquote>
<h3 id="service_1">外部系统访问service问题</h3>
<ul>
<li>Node IP： node物理节点的IP</li>
<li>Pod IP：Pod的IP</li>
<li>Cluster IP：Service 的IP （不可以ping测试）</li>
</ul>
<h3 id="_3">服务类型</h3>
<ul>
<li>Cluster IP:  通过集群内部IP暴露服务，服务之能够在集群内部访问，默认是ServiceType</li>
<li>Node Pord：每个</li>
<li></li>
</ul>
<p>​    </p>
<p>​    </p>
<p>​    </p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-02-18 20:43:52</p>
      </span>
    </div>

    
    
  </body>
</html>