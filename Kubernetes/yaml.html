<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>yaml - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;yaml
    <span class="updated">Page Updated&nbsp;
      2019-03-08 11:59
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">yaml</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#yaml">yaml 定义</a><ul>
<li><a href="#apiversion">apiVersion</a></li>
<li><a href="#kind">kind</a></li>
<li><a href="#metadata">Metadata</a></li>
<li><a href="#spec">Spec</a></li>
<li><a href="#command">command</a><ul>
<li><a href="#example">example</a></li>
</ul>
</li>
<li><a href="#ports">ports</a><ul>
<li><a href="#example_1">example</a></li>
</ul>
</li>
<li><a href="#imagepullpolicy">imagePullPolicy</a><ul>
<li><a href="#example_2">example</a></li>
</ul>
</li>
<li><a href="#labels">labels</a></li>
<li><a href="#selector">selector</a><ul>
<li><a href="#matchlabels">matchLabels</a></li>
<li><a href="#matchexpressions">matchExpressions</a></li>
</ul>
</li>
<li><a href="#nodeselector">nodeSelector</a></li>
<li><a href="#annotations">annotations</a></li>
<li><a href="#initcontainers">initContainers</a></li>
<li><a href="#lifecycle">lifecycle</a><ul>
<li><a href="#poststart">postStart</a></li>
<li><a href="#prestop">preStop</a></li>
</ul>
</li>
<li><a href="#livenessprobe">livenessProbe</a><ul>
<li><a href="#exec">exec</a></li>
<li><a href="#httpget">httpGet</a></li>
<li><a href="#tcpsocket">tcpSocket</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="yaml">yaml 定义</h1>
<h2 id="apiversion">apiVersion</h2>
<h2 id="kind">kind</h2>
<p>定义了这个API对象的类型</p>
<h2 id="metadata">Metadata</h2>
<p>API对象的“标识”，即元数据，也是从Kubernetes里找到这个对象的主要依据，对所有API对象来说，这一部分的格式和字段基本是一致的</p>
<p>其中最主要使用到的字段是Labels</p>
<h2 id="spec">Spec</h2>
<p>存放属于这个对象独有的定义，用来描述它要表达的功能</p>
<h2 id="command">command</h2>
<p>指定不同于镜像默认运行的应用程序，可以同时使用args字段进行参数传递，将覆盖镜像中的默认定义</p>
<p>自定义args 是向容器中的应用程序传递配置信息的常用方式</p>
<h3 id="example">example</h3>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">command</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">alpine</span><span class="o">:</span><span class="n">latest</span>
      <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">]</span>
      <span class="n">args</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;while true; do sleep 30; done&quot;</span><span class="o">]</span>
</pre></div>


<h2 id="ports">ports</h2>
<p>显示指定容器端口，为其赋予一个名称方便调用</p>
<p>其值为一个列表，有一个到多个端口对象组成，且嵌套以下字段</p>
<div class="hlcode"><pre><span class="nx">containerPort</span> <span class="o">&lt;</span><span class="kt">integer</span><span class="o">&gt;</span> <span class="nx">必选字段</span><span class="err">，</span><span class="nx">指定Pod的IP地址暴露的容器端口</span> <span class="mi">0</span><span class="o">-</span><span class="mi">65536</span>
<span class="nb">name</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span> <span class="nx">当前容器端口名称</span><span class="err">，</span><span class="nx">在当前pod内需要唯一</span><span class="err">，</span><span class="nx">此端口名可以被Service资源调用</span>
<span class="nx">protocol</span> <span class="nx">可以为TCP或UDP</span><span class="err">，</span><span class="nx">默认为TCP</span>
</pre></div>


<h3 id="example_1">example</h3>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="n">example</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
      <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
</pre></div>


<h2 id="imagepullpolicy">imagePullPolicy</h2>
<div class="hlcode"><pre><span class="n">Always</span> <span class="err">镜像标签为</span><span class="n">latest</span><span class="err">，或镜像不存在时总是从指定的仓库中获取镜像</span>
<span class="n">IfNotPresent</span>  <span class="err">仅当本地镜像缺失时方才从目标仓库中下载镜像</span>
<span class="n">Never</span> <span class="err">禁止从仓库中下载镜像，仅仅使用本地镜像</span>
</pre></div>


<h3 id="example_2">example</h3>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">pod</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="n">latest</span>
        <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">Always</span>
</pre></div>


<blockquote>
<p>总是从镜像仓库中获取最新的nginx 镜像</p>
</blockquote>
<h2 id="labels">labels</h2>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">labels</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">env</span><span class="o">:</span> <span class="n">qa</span>
    <span class="n">tier</span><span class="o">:</span> <span class="n">frontend</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
</pre></div>


<h2 id="selector">selector</h2>
<h3 id="matchlabels">matchLabels</h3>
<p>通过直接给定键值来指定标签选择器</p>
<div class="hlcode"><pre><span class="n">selector</span><span class="o">:</span>
  <span class="n">matchLabels</span><span class="o">:</span>
    <span class="n">component</span><span class="o">:</span> <span class="n">redis</span>
</pre></div>


<h3 id="matchexpressions">matchExpressions</h3>
<p>基于表达式指定的标签选择器列表，每个选择器都形如</p>
<div class="hlcode"><pre><span class="p">{</span><span class="n">key</span><span class="o">:</span> <span class="n">KEY_NAME</span><span class="p">,</span> <span class="n">operator</span><span class="o">:</span> <span class="n">OPERATOR</span><span class="p">,</span> <span class="n">values</span><span class="o">:</span> <span class="p">[</span><span class="n">VALUE1</span><span class="p">,</span> <span class="n">VALUE2</span><span class="p">,</span> <span class="p">...]}</span>
</pre></div>


<div class="hlcode"><pre><span class="n">selector</span><span class="o">:</span>
  <span class="n">matchExpressions</span><span class="o">:</span>
    <span class="o">-</span> <span class="o">{</span><span class="n">key</span><span class="o">:</span> <span class="n">tier</span><span class="o">,</span> <span class="n">operator</span><span class="o">:</span> <span class="n">In</span><span class="o">,</span> <span class="n">values</span><span class="o">:</span> <span class="o">[</span><span class="n">cache</span><span class="o">]}</span>
    <span class="o">-</span> <span class="o">{</span><span class="n">key</span><span class="o">:</span> <span class="n">environment</span><span class="o">,</span> <span class="n">operator</span><span class="o">:</span> <span class="n">Exists</span><span class="o">,</span> <span class="n">values</span><span class="o">:}</span>
</pre></div>


<h2 id="nodeselector">nodeSelector</h2>
<p>调度某些资源至指定设备节点，使用nodeSelector选择器</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">nodeselector</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">env</span><span class="o">:</span> <span class="n">testing</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
  <span class="n">nodeSelector</span><span class="o">:</span>
    <span class="n">disktype</span><span class="o">:</span> <span class="n">ssd</span>
</pre></div>


<h2 id="annotations">annotations</h2>
<p>生成资源注解</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">nodeselector</span>
  <span class="n">annotations</span><span class="o">:</span>
    <span class="n">ilinux</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">created</span><span class="o">-</span><span class="n">by</span><span class="o">:</span> <span class="n">cluster</span> <span class="n">admin</span>
<span class="n">spec</span><span class="o">:</span> 
<span class="o">....</span>
</pre></div>


<h2 id="initcontainers">initContainers</h2>
<p>以列表的形式定义可用的初始容器</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">pod</span> 
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
  <span class="n">initContainers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">init</span><span class="o">-</span><span class="n">something</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s1">&#39;sh&#39;</span><span class="o">,</span> <span class="s1">&#39;-c&#39;</span><span class="o">,</span> <span class="s1">&#39;sleep 10&#39;</span><span class="o">]</span>
</pre></div>


<h2 id="lifecycle">lifecycle</h2>
<h3 id="poststart">postStart</h3>
<p>于容器创建完成之后立即运行钩子处理器handler</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">lifecycle</span><span class="o">-</span><span class="n">demo</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">lifecycle</span><span class="o">-</span><span class="n">demo</span><span class="o">-</span><span class="n">containers</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
    <span class="n">lifecycle</span><span class="o">:</span>
      <span class="n">postStart</span><span class="o">:</span>
        <span class="n">exec</span><span class="o">:</span>
          <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo &#39;lifecycle hooks handler&#39; &gt; /usr/share/nginx/html/test.html&quot;</span><span class="o">]</span>
</pre></div>


<h3 id="prestop">preStop</h3>
<p>于容器终止操作之前立即运行的钩子处理器，以同步的方式调用</p>
<p>在其完成之前会阻塞删除容器的操作的调用</p>
<h2 id="livenessprobe">livenessProbe</h2>
<h3 id="exec">exec</h3>
<p>exec类型探针通过在目标容器中执行由用户自定义的命令来判断容器的健康状态</p>
<p>返回0表示成功，其他均为失败</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">test</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">exec</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">exec</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">demo</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
    <span class="n">args</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;touch /tmp/healthy; sleep 60; rm -rf /tmp/healthy; sleep 600;&quot;</span><span class="o">]</span>
    <span class="n">livenessProbe</span><span class="o">:</span>
      <span class="n">exec</span><span class="o">:</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="o">,</span> <span class="s2">&quot;-e&quot;</span><span class="o">,</span> <span class="s2">&quot;/tmp/healthy&quot;</span><span class="o">]</span>
</pre></div>


<h3 id="httpget">httpGet</h3>
<p>向目标容器发起一个http请求，根据响应状态码进行结果盘点</p>
<p>2xx 或3xx表示通过</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">test</span><span class="o">:</span> <span class="n">liveness</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">http</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">demo</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.12</span><span class="o">-</span><span class="n">alpine</span>
      <span class="n">ports</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
        <span class="n">containersPort</span><span class="o">:</span> <span class="mi">80</span>
      <span class="n">lifecycle</span><span class="o">:</span>
        <span class="n">portStart</span><span class="o">:</span>
          <span class="n">exec</span><span class="o">:</span>
            <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo Healthy &gt; /usr/share/nginx/html/healthz&quot;</span><span class="o">]</span>
      <span class="n">livenessProbe</span><span class="o">:</span>
        <span class="n">httpGet</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">healthz</span>
          <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">scheme</span><span class="o">:</span> <span class="n">HTTP</span>
</pre></div>


<h3 id="tcpsocket">tcpSocket</h3>
<p>基于TCP的存活性探测(TCPSocketAction) 向容器的特定端口发起TCP请求并尝试建立连接进行判定</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">test</span><span class="o">:</span> <span class="n">liveness</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">tcp</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">tcp</span><span class="o">-</span><span class="n">demo</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.12</span><span class="o">-</span><span class="n">alpine</span>
      <span class="n">ports</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
        <span class="n">containersPort</span><span class="o">:</span> <span class="mi">80</span>
      <span class="n">livenessProbe</span><span class="o">:</span>
        <span class="n">tcpSocket</span><span class="o">:</span>
          <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-03-14 12:47:41</p>
      </span>
    </div>

    
    
  </body>
</html>