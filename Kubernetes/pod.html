<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>pod - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;pod
    <span class="updated">Page Updated&nbsp;
      2019-02-27 21:42
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">pod</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#pod">Pod</a><ul>
<li><a href="#_1">实现</a><ul>
<li><a href="#infra">infra 容器</a></li>
</ul>
</li>
<li><a href="#_2">设计</a></li>
<li><a href="#pod-phase">Pod 生命周期（phase）</a><ul>
<li><a href="#lifecycle">初始化容器 lifecycle</a><ul>
<li><a href="#poststart-object">postStart   &lt;Object&gt; 启动后</a><ul>
<li><a href="#exec-object">exec &lt;Object&gt; 用户指定命令</a></li>
<li><a href="#httpget-object">httpGet      &lt;Object&gt;</a></li>
<li><a href="#tcpsocket-object">tcpSocket    &lt;Object&gt;</a></li>
</ul>
</li>
<li><a href="#prestop-object">preStop     &lt;Object&gt; 终止前</a><ul>
<li><a href="#exec-object_1">exec &lt;Object&gt; 用户指定命令</a></li>
<li><a href="#httpget-object_1">httpGet      &lt;Object&gt;</a></li>
<li><a href="#tcpsocket-object_1">tcpSocket    &lt;Object&gt;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_3">容器探测</a><ul>
<li><a href="#liveness">liveness 存活探测</a><ul>
<li><a href="#exec-object_2">exec &lt;Object&gt; 用户指定命令</a></li>
<li><a href="#httpget-object_2">httpGet      &lt;Object&gt;</a></li>
<li><a href="#tcpsocket-object_2">tcpSocket    &lt;Object&gt;</a></li>
</ul>
</li>
<li><a href="#readiness">readiness 就绪探测   (重要)</a><ul>
<li><a href="#exec-object_3">exec &lt;Object&gt; 用户指定命令</a></li>
<li><a href="#httpget-object_3">httpGet      &lt;Object&gt;</a></li>
<li><a href="#tcpsocket-object_3">tcpSocket    &lt;Object&gt;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_4"></a></li>
</ul>
</li>
<li><a href="#pod_1">Pod 状态</a><ul>
<li><a href="#pending">Pending</a><ul>
<li><a href="#condition-unschedulable">Condition: Unschedulable</a></li>
</ul>
</li>
<li><a href="#running">Running</a><ul>
<li><a href="#_5">异常情况</a></li>
</ul>
</li>
<li><a href="#succeeded">Succeeded</a></li>
<li><a href="#failed">Failed</a></li>
<li><a href="#unknown">Unknown</a></li>
<li><a href="#crashloopbackoff">CrashLoopBackOff</a></li>
</ul>
</li>
<li><a href="#restartpolicy">restartPolicy 容器重启策略</a><ul>
<li><a href="#always">Always</a></li>
<li><a href="#onfailure">OnFailure</a></li>
<li><a href="#never">Never</a></li>
</ul>
</li>
<li><a href="#pod_2">pod 资源需求</a><ul>
<li><a href="#limits">limits 资源限制</a></li>
</ul>
</li>
<li><a href="#_6">分布式模型</a><ul>
<li><a href="#sidercar-pattern">sidercar pattern</a></li>
<li><a href="#ambassador-pattern">Ambassador pattern</a></li>
<li><a href="#adapter-pattern">Adapter pattern</a></li>
</ul>
</li>
<li><a href="#pod-controller">Pod 控制器 Controller</a><ul>
<li><a href="#replication-controller">Replication Controller (淘汰)</a></li>
<li><a href="#replicaset">ReplicaSet</a></li>
<li><a href="#deployment">Deployment （常用）</a></li>
<li><a href="#services">Services</a><ul>
<li><a href="#services_1">Services 类型</a></li>
</ul>
</li>
<li><a href="#job">Job</a></li>
<li><a href="#daemonset">DaemonSet</a></li>
</ul>
</li>
<li><a href="#_7">环境变量</a><ul>
<li><a href="#env">env</a><ul>
<li><a href="#example">example</a></li>
</ul>
</li>
<li><a href="#envfrom">envFrom</a></li>
</ul>
</li>
<li><a href="#pod-probe">Pod Probe 探针</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="pod">Pod</h1>
<p><img alt="img" src="https://snag.gy/fPQNgz.jpg" /></p>
<p>标准的Kubernetes API资源，在yaml中使用kind，apiVersion，metadata和spec字段定义</p>
<p>status字段在对象创建后由系统自行维护</p>
<p>通过在spec字段中嵌套containers，将容器对象启动</p>
<p>Pod 里面的容器共享同一个Network Namespace，同一组数据卷，而达到高效率的交换信息，即保证了容器间的紧密协作关系</p>
<p>Pod类似于传统基础设置里面的虚拟机角色，而容器，就是虚拟机里面运行的用户程序</p>
<h2 id="_1">实现</h2>
<p>Pod其实是一组共享了某些资源的容器</p>
<p>Pod里面所有容器，共享的是同一个Network Namespace，并且可以声明共享同一个Volume</p>
<h3 id="infra">infra 容器</h3>
<p>在Kubernetes 中，Pod的实现需要使用一个中间容器称为Infra容器，在Pod中，与Infra容器关联在一起</p>
<p>而Pod的生命周期和Infra容器是一致的，与容器A和B无关</p>
<p><img alt="img" src="https://snag.gy/m59fG6.jpg" /></p>
<p>Infra 容器使用一个特殊的镜像 (k8s.gcr.io/pause)，占用资源极少， Infra 容器Hold住Network Namespace后，用户容器就可以加入到Infra 容器的Network Namespace中，所以在查看容器在宿主机的Namespace文件的时候，指向的值是完全一样的</p>
<p>这样，容器A和容器B可以直接通过localhost 进行通信，由于一个Pod值可以有一个IP地址，而这个地址就是Network Namespace 对应的IP地址</p>
<h2 id="_2">设计</h2>
<p>通常应该一个容器中仅运行一个进程，而日志信息通过输出至容器的标准输出，用户通过kubectl log 进行获取</p>
<p>省去了用户手动分拣日志信息</p>
<h2 id="pod-phase">Pod 生命周期（phase）</h2>
<p>pod.status.phase 表示当前Pod的状态</p>
<h3 id="lifecycle">初始化容器 lifecycle</h3>
<h4 id="poststart-object">postStart   <code>&lt;Object&gt;</code> 启动后</h4>
<h5 id="exec-object">exec <code>&lt;Object&gt;</code> 用户指定命令</h5>
<p>根据指令返回码判断</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">poststart</span><span class="o">-</span><span class="n">pod</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">busybox</span><span class="o">-</span><span class="n">httpd</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span><span class="o">:</span><span class="n">latest</span>
    <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
    <span class="n">lifecycle</span><span class="o">:</span>
      <span class="n">postStart</span><span class="o">:</span>
        <span class="n">exec</span><span class="o">:</span>
          <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s1">&#39;mkdir&#39;</span><span class="o">,</span> <span class="s1">&#39;-p&#39;</span><span class="o">,</span> <span class="s1">&#39;/data/web/html&#39;</span><span class="o">]</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s1">&#39;/bin/sh&#39;</span><span class="o">,</span> <span class="s1">&#39;-c&#39;</span><span class="o">,</span> <span class="s1">&#39;sleep 3600&#39;</span><span class="o">]</span>
</pre></div>


<h5 id="httpget-object">httpGet      <code>&lt;Object&gt;</code></h5>
<div class="hlcode"><pre>
</pre></div>


<h5 id="tcpsocket-object">tcpSocket    <code>&lt;Object&gt;</code></h5>
<h4 id="prestop-object">preStop     <code>&lt;Object&gt;</code> 终止前</h4>
<h5 id="exec-object_1">exec <code>&lt;Object&gt;</code> 用户指定命令</h5>
<p>根据指令返回码判断</p>
<div class="hlcode"><pre>
</pre></div>


<h5 id="httpget-object_1">httpGet      <code>&lt;Object&gt;</code></h5>
<div class="hlcode"><pre>
</pre></div>


<h5 id="tcpsocket-object_1">tcpSocket    <code>&lt;Object&gt;</code></h5>
<h3 id="_3">容器探测</h3>
<p>主容器定时探测容器状态</p>
<p>建立在pod.containers 之上</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">explain</span> <span class="n">pods</span><span class="p">.</span><span class="n">spec</span><span class="p">.</span><span class="n">containers</span>
<span class="nl">KIND:</span>     <span class="n">Pod</span>
<span class="nl">VERSION:</span>  <span class="n">v1</span>

<span class="nl">RESOURCE:</span> <span class="n">containers</span> <span class="o">&lt;</span><span class="p">[]</span><span class="n">Object</span><span class="o">&gt;</span>
</pre></div>


<h4 id="liveness">liveness 存活探测</h4>
<p>探测容器是否处于存活状态</p>
<h5 id="exec-object_2">exec <code>&lt;Object&gt;</code> 用户指定命令</h5>
<p>根据指令返回码判断</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">pod</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span><span class="o">:</span><span class="n">latest</span>
    <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 3600&quot;</span><span class="o">]</span>
    <span class="n">livenessProbe</span><span class="o">:</span>
      <span class="n">exec</span><span class="o">:</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;test&quot;</span><span class="o">,</span> <span class="s2">&quot;-e&quot;</span><span class="o">,</span> <span class="s2">&quot;/tmp/healthy&quot;</span><span class="o">]</span>
      <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">1</span>
      <span class="n">periodSeconds</span><span class="o">:</span> <span class="mi">3</span>
</pre></div>


<h5 id="httpget-object_2">httpGet      <code>&lt;Object&gt;</code></h5>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
    <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
      <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">livenessProbe</span><span class="o">:</span>
      <span class="n">httpGet</span><span class="o">:</span>
        <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
        <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="na">html</span>
      <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">1</span>
      <span class="n">periodSeconds</span><span class="o">:</span> <span class="mi">3</span>
</pre></div>


<h5 id="tcpsocket-object_2">tcpSocket    <code>&lt;Object&gt;</code></h5>
<h4 id="readiness">readiness 就绪探测   (重要)</h4>
<p>探测容器中的服务和程序是否提供服务</p>
<h5 id="exec-object_3">exec <code>&lt;Object&gt;</code> 用户指定命令</h5>
<p>根据指令返回码判断</p>
<h5 id="httpget-object_3">httpGet      <code>&lt;Object&gt;</code></h5>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
    <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
    <span class="n">ports</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
      <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">readinessProbe</span><span class="o">:</span>
      <span class="n">httpGet</span><span class="o">:</span>
        <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
        <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="na">html</span>
      <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">1</span>
      <span class="n">periodSeconds</span><span class="o">:</span> <span class="mi">3</span>
</pre></div>


<p>进入容器后创建和删除index文件，会看到以下效果</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span> <span class="o">--</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
</pre></div>


<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">manifests</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">w</span>
<span class="n">NAME</span>                           <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">client</span>                         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">35</span><span class="n">h</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">pod</span>              <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>   <span class="mi">43</span>         <span class="mi">147</span><span class="n">m</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>           <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">1</span>          <span class="mi">12</span><span class="n">m</span>
<span class="n">myapp</span><span class="o">-</span><span class="mi">5</span><span class="n">bc569c47d</span><span class="o">-</span><span class="mi">62</span><span class="n">hwb</span>         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">34</span><span class="n">h</span>
<span class="n">myapp</span><span class="o">-</span><span class="mi">5</span><span class="n">bc569c47d</span><span class="o">-</span><span class="n">kwlcp</span>         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">34</span><span class="n">h</span>
<span class="n">myapp</span><span class="o">-</span><span class="mi">5</span><span class="n">bc569c47d</span><span class="o">-</span><span class="n">tpns4</span>         <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">34</span><span class="n">h</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">55</span><span class="n">d8d67cf</span><span class="o">-</span><span class="mi">7</span><span class="n">zkxm</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">44</span><span class="n">h</span>
<span class="n">pod</span><span class="o">-</span><span class="n">demo</span>                       <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>     <span class="n">Running</span>            <span class="mi">8</span>          <span class="mi">8</span><span class="n">h</span>
<span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>          <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">67</span><span class="n">s</span>
<span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>          <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">69</span><span class="n">s</span>
<span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>          <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">4</span><span class="n">m48s</span>
</pre></div>


<h5 id="tcpsocket-object_3">tcpSocket    <code>&lt;Object&gt;</code></h5>
<h3 id="_4"></h3>
<h2 id="pod_1">Pod 状态</h2>
<h3 id="pending">Pending</h3>
<p>Pod的YAML文件已经提交给Kubernetes，API Server 创建了Pod资源对象并已存储etcd中，但未被调度完成，或着仍然处于从仓库下载镜像的过程中</p>
<p>如调度失败的情况</p>
<h4 id="condition-unschedulable">Condition: Unschedulable</h4>
<p>调度出现问题</p>
<h3 id="running">Running</h3>
<p>Pod已经被调度至一个具体节点绑定，并且所有容器都已经被kubelet创建完成</p>
<h4 id="_5">异常情况</h4>
<p>Pod（即容器）的状态是 Running，但是应用其实已经停止服务的例子</p>
<div class="hlcode"><pre><span class="mf">1.</span> <span class="err">程序本身有</span> <span class="n">bug</span><span class="err">，本来应该返回</span> <span class="mi">200</span><span class="err">，但因为代码问题，返回的是</span><span class="mi">500</span><span class="err">；</span>
<span class="mf">2.</span> <span class="err">程序因为内存问题，已经僵死，但进程还在，但无响应；</span>
<span class="mf">3.</span> <span class="n">Dockerfile</span> <span class="err">写的不规范，应用程序不是主进程，那么主进程出了什么问题都无法发现；</span>
<span class="mf">4.</span> <span class="err">程序出现死循环。</span>
</pre></div>


<h3 id="succeeded">Succeeded</h3>
<p>Pod 中的所有容器都已经成功运行完成并终止，且不会被重启</p>
<p>常见于一次性任务</p>
<h3 id="failed">Failed</h3>
<p>所有容器都已经终止，但至少有一个容器终止失败，即容器返回了非0值的退出状态或已经被系统终止</p>
<p>此时需要debug这个容器的应用，如查看Pod的Events和日志</p>
<h3 id="unknown">Unknown</h3>
<p>Pod的状态不能持续地被kubelet汇报给kube-apiserver，很可能是主从节点间通信出现问题</p>
<h3 id="crashloopbackoff">CrashLoopBackOff</h3>
<p>Kubernetes. 尝试一次又一次的重启Pod</p>
<h2 id="restartpolicy">restartPolicy 容器重启策略</h2>
<h3 id="always">Always</h3>
<p>pod对象终止就将其重启，默认设定</p>
<h3 id="onfailure">OnFailure</h3>
<p>只在pod对象出现错误时方将其重启</p>
<h3 id="never">Never</h3>
<p>从不重启</p>
<h2 id="pod_2">pod 资源需求</h2>
<p>自主式Pod 要求stress 容器确保128Mi的内存及五分之一的CPU核心(200m) 资源可用</p>
<p>运行stress-ng 镜像启动一个进程(-m 1) 进行内存性能压力测试，满载测试时也会尽可能多地占用CPU资源</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">stress</span><span class="o">-</span><span class="n">pod</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">stress</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">stress</span><span class="o">-</span><span class="n">ng</span>
      <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/usr/bin/stress-ng&quot;</span><span class="o">,</span> <span class="s2">&quot;-m 1&quot;</span><span class="o">,</span> <span class="s2">&quot;-c 1&quot;</span><span class="o">,</span> <span class="s2">&quot;-metrics-brief&quot;</span><span class="o">]</span>
      <span class="n">resources</span><span class="o">:</span>
        <span class="n">requests</span><span class="o">:</span>
          <span class="n">memory</span><span class="o">:</span> <span class="s2">&quot;128Mi&quot;</span>
          <span class="n">cpu</span><span class="o">:</span> <span class="s2">&quot;200m&quot;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">pod</span><span class="o">-</span><span class="n">resources</span><span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>


<p>top命令观察其CPU及内存资源占用状态</p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">exec</span> <span class="n">stress</span><span class="o">-</span><span class="n">pod</span> <span class="o">--</span> <span class="n">top</span>
</pre></div>


<h3 id="limits">limits 资源限制</h3>
<p>limits 属性为容器定义资源的最大可用量。</p>
<p>资源分配时，可压缩形资源的CPU的控制阀可以自由调节，容器进程无法获得超出其CPU配额的可用时间</p>
<p>如果超出，会被OOM kill 掉</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">memleak</span><span class="o">-</span><span class="n">pod</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">memleak</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">simmemleak</span>
      <span class="n">image</span><span class="o">:</span> <span class="n">saadali</span><span class="o">/</span><span class="n">simmemleak</span>
      <span class="n">resources</span><span class="o">:</span>
        <span class="n">requests</span><span class="o">:</span>
          <span class="n">memory</span><span class="o">:</span> <span class="s2">&quot;64Mi&quot;</span>
          <span class="n">cpu</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span>
        <span class="n">limits</span><span class="o">:</span>
          <span class="n">memory</span><span class="o">:</span> <span class="s2">&quot;64Mi&quot;</span>
          <span class="n">cpu</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span>
</pre></div>


<h2 id="_6">分布式模型</h2>
<h3 id="sidercar-pattern">sidercar pattern</h3>
<p>边车模型或跨斗模型</p>
<p>即pod的主应用容器提供协同的辅助应用容器，每个应用独立运行</p>
<p>如主应用容器中的日志使用agent收集到日志服务器中，可以将agent运行为辅助应用容器，即sidecar</p>
<p>还如主应用容器中启动database 缓存，sidecar启动Redis Cache</p>
<h3 id="ambassador-pattern">Ambassador pattern</h3>
<p>大使模型</p>
<p>即远程服务器创建本地代理，主容器应用通过代理容器访问远程服务</p>
<h3 id="adapter-pattern">Adapter pattern</h3>
<p>适配器模式</p>
<p>将主应用容器中的内容进行标准化输出</p>
<p>如日志数据或者指标数据的输出，</p>
<h2 id="pod-controller">Pod 控制器 Controller</h2>
<p>借助Controller 对Pod进行管理，实现一次性的Pod对象管理</p>
<p>包括以下多种调度器</p>
<h3 id="replication-controller">Replication Controller (淘汰)</h3>
<p>定义了一个期望的场景，声明某种pod的副本数量在任意时刻都符合某个预期值</p>
<p>e.g. <code>apiVersion: extensions/v1beat1 kind: Replication metadata: name: frontend</code></p>
<h3 id="replicaset">ReplicaSet</h3>
<p>确保给一个pod所指定数量的replicas 会一直运行</p>
<h3 id="deployment">Deployment （常用）</h3>
<p>Deployment 为Pod和ReplicaSet提供一个声明方法，用来替代Replication Controller 来方便管理</p>
<p>可以声明一个yaml文件，确保deployment的状态信息</p>
<h3 id="services">Services</h3>
<p>允许多个deployments之间通信，从而确保pods之间通信</p>
<p>实例</p>
<div class="hlcode"><pre><span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">opiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">my</span><span class="o">-</span><span class="n">service</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">MyApp</span>
  <span class="n">ports</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
      <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
      <span class="n">targetPort</span><span class="o">:</span> <span class="mi">9376</span>
</pre></div>


<h4 id="services_1">Services 类型</h4>
<div class="hlcode"><pre><span class="n">Internal</span><span class="o">:</span><span class="err">仅用于集群内部通信的</span><span class="n">ClusterIP</span><span class="err">类型，即</span><span class="kd">internal</span> <span class="n">IP</span>

<span class="n">External</span><span class="o">:</span> <span class="err">接入集群外部请求的</span><span class="n">NodePort</span><span class="err">类型，</span> <span class="err">工作于每个节点的主机</span><span class="n">IP</span><span class="err">之上，</span>

<span class="n">LoadBalance</span><span class="o">:</span> <span class="err">可以把外部请求负载均衡至多个</span><span class="n">Node</span><span class="err">主机</span><span class="n">IP</span><span class="err">的</span><span class="n">NodePort</span><span class="err">之上</span>
</pre></div>


<h3 id="job">Job</h3>
<p>Pods管理程序，包含一系列job</p>
<p>类似于cronjob</p>
<h3 id="daemonset">DaemonSet</h3>
<p>确保所有nodes 运行同一个指定类型的pod</p>
<h2 id="_7">环境变量</h2>
<p>通过环境变量在容器启动时传递配置信息</p>
<h3 id="env">env</h3>
<p>在容器配置段中嵌套env字段，值是环境变量构成的列表</p>
<div class="hlcode"><pre><span class="nb">name</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>  <span class="nx">环境变量名称</span><span class="err">，</span><span class="nx">必须字段</span>
<span class="nb">value</span> <span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span>  <span class="nx">传递值</span><span class="err">，</span><span class="nx">通过</span><span class="err">$</span><span class="p">(</span><span class="nx">VAR_NAME</span><span class="p">)</span> <span class="nx">引用</span>
</pre></div>


<h4 id="example">example</h4>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pod</span><span class="o">-</span><span class="k">with</span><span class="o">-</span><span class="n">env</span>
<span class="n">spec</span><span class="o">:</span> 
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">filebeat</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">filebeat</span><span class="o">:</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">alpine</span>
    <span class="n">env</span><span class="o">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
      <span class="n">value</span><span class="o">:</span> <span class="n">db</span><span class="o">.</span><span class="na">xurick</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="mi">6379</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">LOG_LEVEL</span>
      <span class="n">value</span><span class="o">:</span> <span class="n">info</span>
</pre></div>


<h3 id="envfrom">envFrom</h3>
<h2 id="pod-probe">Pod Probe 探针</h2>
<p>健康检查探针，kubelet会根据Probe返回值来决定这个容器的状态</p>
<p>test-liveness-exec.yaml</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">test</span><span class="o">:</span> <span class="n">liveness</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">test</span><span class="o">-</span><span class="n">liveness</span><span class="o">-</span><span class="n">exec</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">liveness</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
    <span class="n">args</span><span class="o">:</span>
    <span class="o">-</span> <span class="sr">/bin/s</span><span class="n">h</span>
    <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
    <span class="o">-</span> <span class="n">touch</span> <span class="sr">/tmp/healthy; sleep 30; rm -rf /tmp/</span><span class="n">healthy</span><span class="o">;</span> <span class="n">sleep</span> <span class="mi">600</span>
    <span class="n">livenessProbe</span><span class="o">:</span>
      <span class="n">exec</span><span class="o">:</span>
        <span class="n">command</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">cat</span>
        <span class="o">-</span> <span class="sr">/tmp/</span><span class="n">healthy</span>
      <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">5</span>
      <span class="n">periodSeconds</span><span class="o">:</span> <span class="mi">5</span>
</pre></div>


<blockquote>
<p>与此同时，我们定义了一个这样的 livenessProbe（健康检查）。它的类型是 exec，这意味着，它会在容器启动后，在容器里面执行一句我们指定的命令，比如：“cat /tmp/healthy”。这时，如果这个文件存在，这条命令的返回值就是 0，Pod 就会认为这个容器不仅已经启动，而且是健康的。这个健康检查，在容器启动 5 s 后开始执行（initialDelaySeconds: 5），每 5 s 执行一次（periodSeconds: 5）。</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">test</span><span class="o">-</span><span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span>
<span class="n">NAME</span>                <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">test</span><span class="o">-</span><span class="n">liveness</span><span class="o">-</span><span class="n">exec</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">10</span><span class="n">s</span>
</pre></div>


<p>30s 之后查看</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">test</span><span class="o">-</span><span class="n">liveness</span><span class="o">-</span><span class="n">exec</span>
</pre></div>


<div class="hlcode"><pre>FirstSeen LastSeen    Count   From            SubobjectPath           Type        Reason      Message
--------- --------    -----   ----            -------------           --------    ------      -------
2s        2s      1   {kubelet worker0}   spec.containers{liveness}   Warning     Unhealthy   Liveness probe failed: cat: can&#39;t open &#39;/tmp/healthy&#39;: No such file or directory
</pre></div>


<blockquote>
<p>这里报错，表示文件已经不存在了</p>
</blockquote>
<p>然而pod并没有Fail，而是进入了running 状态，是因为Pod的恢复机制，即restartPolicy</p>
<p>Pod的恢复过程永远发生在当前节点(Node), 除非pod.spec.node字段被更改</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-07-02 13:55:12</p>
      </span>
    </div>

    
    
  </body>
</html>