<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>resource_management 资源管理 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;resource_management 资源管理
    <span class="updated">Page Updated&nbsp;
      2019-02-23 23:05
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">resource_management 资源管理</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">资源管理</a><ul>
<li><a href="#pod-workload">Pod控制器 (也称 工作负载 Workload)</a><ul>
<li><a href="#replicationcontroller">ReplicationController 无状态 （废弃）</a></li>
<li><a href="#replicaset">ReplicaSet 无状态</a><ul>
<li><a href="#_2">结构</a></li>
<li><a href="#_3">水平扩展</a></li>
<li><a href="#_4">滚动扩展</a></li>
</ul>
</li>
<li><a href="#deployment">Deployment  无状态 (常用)</a><ul>
<li><a href="#hpa-pod">HPA 水平Pod伸缩</a></li>
</ul>
</li>
<li><a href="#statefulset">StatefulSet 有状态</a><ul>
<li><a href="#_5">设计</a><ul>
<li><a href="#headless-service">Headless Service</a></li>
<li><a href="#statefulset_1">StatefulSet</a></li>
<li><a href="#volumeclaimtemplate">volumeClaimTemplate</a><ul>
<li><a href="#example">example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#daemonset">DaemonSet 守护进程 无状态</a><ul>
<li><a href="#_6">滚动更新方式</a></li>
<li><a href="#master-toleration">Master 节点 toleration</a></li>
<li><a href="#ingress-controller">Ingress Controller (七层会话卸载)</a><ul>
<li><a href="#example_1">example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#job">Job 完成后终止</a><ul>
<li><a href="#_7">并行控制</a></li>
<li><a href="#_8">使用方法</a><ul>
<li><a href="#job_1">外部管理器 +Job 模板</a></li>
<li><a href="#item">替换$ITEM操作</a></li>
<li><a href="#_9">固定数目并行</a></li>
<li><a href="#parallelism">指定并行度（parallelism）</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#cronjob">CronJob</a></li>
</ul>
</li>
<li><a href="#cluster">集群级资源 Cluster</a><ul>
<li><a href="#namespace">Namespace</a></li>
<li><a href="#node">Node</a></li>
<li><a href="#role">Role</a></li>
<li><a href="#clusterrole">ClusterRole</a></li>
<li><a href="#rolebinding">RoleBinding</a></li>
<li><a href="#clusterrolebinding">ClusterRoleBinding</a></li>
</ul>
</li>
<li><a href="#metadata">元数据资源 Metadata</a><ul>
<li><a href="#hpa">HPA</a></li>
<li><a href="#podtemplate">PodTemplate</a></li>
<li><a href="#limitrange">LimitRange</a></li>
<li><a href="#_10"></a></li>
</ul>
</li>
<li><a href="#api">API 群组</a><ul>
<li><a href="#core-group">核心群组 core group</a></li>
<li><a href="#named-group">命名群组 named group</a></li>
</ul>
</li>
<li><a href="#_11">用户管理</a><ul>
<li><a href="#serviceaccount">ServiceAccount</a></li>
<li><a href="#group">Group</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">资源管理</h1>
<h2 id="pod-workload">Pod控制器 (也称 工作负载 Workload)</h2>
<p>Pod 为此基础资源，负责运行容器，控制器负责Pod监控和管理</p>
<p>当Pod非正常中止，重建工作由此控制器完成</p>
<h3 id="replicationcontroller">ReplicationController 无状态 （废弃）</h3>
<p>负责无状态应用，上一代应用控制器</p>
<p>保证每个容器或者容器组运行并且可以被访问</p>
<h3 id="replicaset">ReplicaSet 无状态</h3>
<p>负责无状态应用，新一代ReplicationController</p>
<p>比上一代支持基于集合的选择器</p>
<p>代用户创建对pod副本，并保证其运行数量的状态</p>
<h4 id="_2">结构</h4>
<p>Nginx-deployment.yaml</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">ReplicaSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="kd">set</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">3</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.7</span><span class="o">.</span><span class="mi">9</span>
</pre></div>


<blockquote>
<p>replicas 是3，对应关系如下</p>
</blockquote>
<p><img alt="img" src="https://snag.gy/RwPJvc.jpg" /></p>
<h4 id="_3">水平扩展</h4>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">scale</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="o">--</span><span class="n">replicas</span><span class="o">=</span><span class="mi">4</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">scaled</span>
</pre></div>


<h4 id="_4">滚动扩展</h4>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span> <span class="o">--</span><span class="n">record</span>
</pre></div>


<blockquote>
<p>--record  可以记录每次操作所执行的命令</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">deployments</span>
<span class="n">NAME</span>               <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">UP</span><span class="o">-</span><span class="n">TO</span><span class="o">-</span><span class="n">DATE</span>   <span class="n">AVAILABLE</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>   <span class="mi">3</span>         <span class="mi">0</span>         <span class="mi">0</span>            <span class="mi">0</span>           <span class="mi">1</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>AVAILABLE 字段描述了用户所期望的最终状态</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">rollout</span> <span class="n">status</span> <span class="n">deployment</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="o">:</span> <span class="mi">2</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">new</span> <span class="n">replicas</span> <span class="n">have</span> <span class="n">been</span> <span class="n">updated</span><span class="p">...</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">successfully</span> <span class="n">rolled</span> <span class="n">out</span>
</pre></div>


<blockquote>
<p>在这个返回结果中，“2 out of 3 new replicas have been updated”意味着已经有 2 个 Pod 进入了 UP-TO-DATE 状态。</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">rs</span>
<span class="n">NAME</span>                          <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">3167673210</span>   <span class="mi">3</span>         <span class="mi">3</span>         <span class="mi">3</span>       <span class="mi">20</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>在用户提交了一个 Deployment 对象后，Deployment Controller 就会立即创建一个 Pod 副本个数为 3 的 ReplicaSet。这个 ReplicaSet 的名字，则是由 Deployment 的名字和一个随机字符串共同组成。</p>
</blockquote>
<p>修改了 Deployment 的 Pod 模板，“滚动更新”就会被自动触发。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">edit</span> <span class="n">deployment</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="p">...</span> 
    <span class="n">spec</span><span class="o">:</span>
      <span class="nl">containers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="nl">image:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.9.1</span> <span class="err">#</span> <span class="mf">1.7.9</span> <span class="o">-&gt;</span> <span class="mf">1.9.1</span>
        <span class="nl">ports:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
<span class="p">...</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">extensions</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">edited</span>
</pre></div>


<blockquote>
<p>编辑 Etcd 里的 API 对象</p>
</blockquote>
<p>查看滚动更细腻状态变化</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">rollout</span> <span class="n">status</span> <span class="n">deployment</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="n">Waiting</span> <span class="k">for</span> <span class="n">rollout</span> <span class="n">to</span> <span class="n">finish</span><span class="o">:</span> <span class="mi">2</span> <span class="n">out</span> <span class="n">of</span> <span class="mi">3</span> <span class="n">new</span> <span class="n">replicas</span> <span class="n">have</span> <span class="n">been</span> <span class="n">updated</span><span class="p">...</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">extensions</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">successfully</span> <span class="n">rolled</span> <span class="n">out</span>


<span class="err">$</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">deployment</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="p">...</span>
<span class="nl">Events:</span>
  <span class="n">Type</span>    <span class="n">Reason</span>             <span class="n">Age</span>   <span class="n">From</span>                   <span class="n">Message</span>
  <span class="o">----</span>    <span class="o">------</span>             <span class="o">----</span>  <span class="o">----</span>                   <span class="o">-------</span>
<span class="p">...</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">24</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">up</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">1764197365</span> <span class="n">to</span> <span class="mi">1</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">22</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">down</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">3167673210</span> <span class="n">to</span> <span class="mi">2</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">22</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">up</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">1764197365</span> <span class="n">to</span> <span class="mi">2</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">19</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">down</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">3167673210</span> <span class="n">to</span> <span class="mi">1</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">19</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">up</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">1764197365</span> <span class="n">to</span> <span class="mi">3</span>
  <span class="n">Normal</span>  <span class="n">ScalingReplicaSet</span>  <span class="mi">14</span><span class="n">s</span>   <span class="n">deployment</span><span class="o">-</span><span class="n">controller</span>  <span class="n">Scaled</span> <span class="n">down</span> <span class="n">replica</span> <span class="n">set</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">3167673210</span> <span class="n">to</span> <span class="mi">0</span>
</pre></div>


<p>新旧状态对比</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">rs</span>
<span class="n">NAME</span>                          <span class="n">DESIRED</span>   <span class="n">CURRENT</span>   <span class="n">READY</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">1764197365</span>   <span class="mi">3</span>         <span class="mi">3</span>         <span class="mi">3</span>       <span class="mi">6</span><span class="n">s</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">3167673210</span>   <span class="mi">0</span>         <span class="mi">0</span>         <span class="mi">0</span>       <span class="mi">30</span><span class="n">s</span>
</pre></div>


<h3 id="deployment">Deployment  无状态 (常用)</h3>
<p>负责无状态应用, 一个deployment 可以管理多个ReplicaSet</p>
<p>用于管理无状态持久化的应用，如HTTP</p>
<p>构建在ReplicaSet之上，通过控制ReplicaSet来控制副本</p>
<p>负责在Pod定义发生变化时，对每个副本进行跟懂更新</p>
<p>实现了Pod的水平扩展和收缩(horizontal scaling out/in)</p>
<p>Deployment 所管理的Pod，他的ownerReference 时ReplicaSet</p>
<p>相对而言，Deployment 只是在ReplicaSet 的基础上，添加了<code>UP-TO-DATE</code> 这个跟版本有关的字段</p>
<p>Deployment 实际上并不足以覆盖所有的应用编排问题。即所有的Pod都是一样的，相互之间没有顺序，也无宿主机要求。</p>
<p>但分布式应用的多个实例之间是相互有依赖关系的</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
      <span class="n">release</span><span class="o">:</span> <span class="n">canary</span>
  <span class="n">template</span><span class="o">:</span>
   <span class="n">metadata</span><span class="o">:</span>
     <span class="n">labels</span><span class="o">:</span>
       <span class="n">app</span><span class="o">:</span> <span class="n">myapp</span>
       <span class="n">release</span><span class="o">:</span> <span class="n">canary</span>
   <span class="n">spec</span><span class="o">:</span>
     <span class="n">containers</span><span class="o">:</span>
     <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
       <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
       <span class="n">ports</span><span class="o">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
         <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
</pre></div>


<h4 id="hpa-pod">HPA 水平Pod伸缩</h4>
<p>Horizontal Pod Autoscaler</p>
<h3 id="statefulset">StatefulSet 有状态</h3>
<p>负责有状态应用</p>
<p>用于管理有状态的持久化应用，如database</p>
<p>要稳定且拥有唯一的网络标识符</p>
<p>而且需要有序，平滑的部署，扩展，滚动更新，删除，终止</p>
<p>运维操作极其复杂，需要将脚本写入到statefulset里面完成其对应的操作</p>
<p>比Deployment会为每个Pod创建一个独有的持久性标识符，并确保Pod之间的顺序性，即管理的是不同的Pod 实例，而不是ReplicaSet中完全一样的Pod</p>
<p>创建statefulset必须要先创建一个headless的service，分为两个步骤， 而且必须是Headless Service</p>
<h4 id="_5">设计</h4>
<div class="hlcode"><pre><span class="err">拓扑状态</span>
<span class="err">应用的多个实例之间不是完全对等的关系。</span>
<span class="err">这些应用实例，必须按照某些顺序启动，比如应用的主节点</span> <span class="n">A</span> <span class="err">要先于从节点</span> <span class="n">B</span> <span class="err">启动。而如果你把</span> <span class="n">A</span> <span class="err">和</span> <span class="n">B</span> <span class="err">两个</span> <span class="n">Pod</span> <span class="err">删除掉，它们再次被创建出来时也必须严格按照这个顺序才行。并且，新创建出来的</span> <span class="n">Pod</span><span class="err">，必须和原来</span> <span class="n">Pod</span> <span class="err">的网络标识一样，这样原先的访问者才能使用同样的方法，访问到这个新</span> <span class="n">Pod</span><span class="err">。</span>
</pre></div>


<div class="hlcode"><pre><span class="err">存储状态</span>
<span class="err">应用的多个实例分别绑定了不同的存储数据。</span>
<span class="err">对于这些应用实例来说，</span><span class="n">Pod</span> <span class="n">A</span> <span class="err">第一次读取到的数据，和隔了十分钟之后再次读取到的数据，应该是同一份，哪怕在此期间</span> <span class="n">Pod</span> <span class="n">A</span> <span class="err">被重新创建过。这种情况最典型的例子，就是一个数据库应用的多个存储实例。</span>
</pre></div>


<h5 id="headless-service">Headless Service</h5>
<p>即一个标准Service YAML文件</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
</pre></div>


<blockquote>
<p>因为clusterIP是None，所以创建之后不会分配VIP地址。所以将采用DNS记录的方式暴露出所在的代理Pod</p>
</blockquote>
<p>当按照上面的方式创建了一个 Headless Service 之后，它所代理的所有 Pod 的 IP 地址，都会被绑定一个这样格式的 DNS 记录</p>
<div class="hlcode"><pre><span class="nt">&lt;pod</span><span class="na">-name</span><span class="nt">&gt;</span>.<span class="nt">&lt;svc</span><span class="na">-name</span><span class="nt">&gt;</span>.<span class="nt">&lt;namespace&gt;</span>.svc.cluster.local
</pre></div>


<p>statefuleSet.yaml</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;nginx&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">1</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
</pre></div>


<blockquote>
<p>serviceName=nginx 字段, 就是告诉 StatefulSet 控制器，在执行控制循环（Control Loop）的时候，请使用 nginx 这个 Headless Service 来保证 Pod 的“可解析身份”。</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">create</span> <span class="na">-f</span> <span class="nx">svc.yaml</span>
<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">get</span> <span class="nx">service</span> <span class="nx">nginx</span>
<span class="nb">NAME</span>      <span class="k">TYPE</span>         <span class="nx">CLUSTER</span><span class="na">-IP</span>   <span class="nx">EXTERNAL</span><span class="na">-IP</span>   <span class="nb">PORT</span><span class="p">(</span><span class="nb">S</span><span class="p">)</span>   <span class="nx">AGE</span>
<span class="nx">nginx</span>     <span class="nx">ClusterIP</span>    <span class="kc">None</span>         <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>        <span class="mi">80</span><span class="p">/</span><span class="nx">TCP</span>    <span class="mi">10</span><span class="nb">s</span>

<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">create</span> <span class="na">-f</span> <span class="nx">statefulset.yaml</span>
<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">get</span> <span class="nx">statefulset</span> <span class="nx">web</span>
<span class="nb">NAME</span>      <span class="nx">DESIRED</span>   <span class="nx">CURRENT</span>   <span class="nx">AGE</span>
<span class="nx">web</span>       <span class="mi">2</span>         <span class="mi">1</span>         <span class="mi">19</span><span class="nb">s</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">NAME</span>      <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">ContainerCreating</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>         <span class="mi">19</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">ContainerCreating</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>         <span class="mi">20</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>StatefulSet 给所有被管理的Pod编号，通过-分隔</p>
</blockquote>
<p>可以查看到容器内部的hostname是不一样的</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">exec</span> <span class="n">web</span><span class="o">-</span><span class="mi">0</span> <span class="o">--</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">hostname</span><span class="err">&#39;</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">exec</span> <span class="n">web</span><span class="o">-</span><span class="mi">1</span> <span class="o">--</span> <span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">hostname</span><span class="err">&#39;</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="o">--</span><span class="n">tty</span> <span class="o">--</span><span class="n">image</span> <span class="n">busybox</span> <span class="n">dns</span><span class="o">-</span><span class="n">test</span> <span class="o">--</span><span class="n">restart</span><span class="o">=</span><span class="n">Never</span> <span class="o">--</span><span class="n">rm</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="err">$</span> <span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mf">0.</span><span class="n">nginx</span>
<span class="nl">Server:</span>    <span class="mf">10.0.0.10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="o">:</span> <span class="mf">10.0.0.10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>

<span class="nl">Name:</span>      <span class="n">web</span><span class="o">-</span><span class="mf">0.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="o">:</span> <span class="mf">10.244.1.7</span>

<span class="err">$</span> <span class="n">nslookup</span> <span class="n">web</span><span class="o">-</span><span class="mf">1.</span><span class="n">nginx</span>
<span class="nl">Server:</span>    <span class="mf">10.0.0.10</span>
<span class="n">Address</span> <span class="mi">1</span><span class="o">:</span> <span class="mf">10.0.0.10</span> <span class="n">kube</span><span class="o">-</span><span class="n">dns</span><span class="p">.</span><span class="n">kube</span><span class="o">-</span><span class="n">system</span><span class="p">.</span><span class="n">svc</span><span class="p">.</span><span class="n">cluster</span><span class="p">.</span><span class="n">local</span>

<span class="nl">Name:</span>      <span class="n">web</span><span class="o">-</span><span class="mf">1.</span><span class="n">nginx</span>
<span class="n">Address</span> <span class="mi">1</span><span class="o">:</span> <span class="mf">10.244.2.7</span>
</pre></div>


<blockquote>
<p>从 nslookup 命令的输出结果中，我们可以看到，在访问 web-0.nginx 的时候，最后解析到的，正是 web-0 这个 Pod 的 IP 地址；而当访问 web-1.nginx 的时候，解析到的则是 web-1 的 IP 地址。</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">delete</span> <span class="n">pod</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">pod</span> <span class="s">&quot;web-0&quot;</span> <span class="n">deleted</span>
<span class="n">pod</span> <span class="s">&quot;web-1&quot;</span> <span class="n">deleted</span>

<span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pod</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">NAME</span>      <span class="n">READY</span>     <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">NAME</span>      <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">web</span><span class="o">-</span><span class="mi">0</span>     <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">2</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">ContainerCreating</span>   <span class="mi">0</span>         <span class="mi">0</span><span class="n">s</span>
<span class="n">web</span><span class="o">-</span><span class="mi">1</span>     <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>         <span class="mi">32</span><span class="n">s</span>
</pre></div>


<blockquote>
<p>可以看到，当把这两个 Pod 删除之后，Kubernetes 会按照原先编号的顺序，创建出了两个新的 Pod。并且，Kubernetes 依然为它们分配了与原来相同的“网络身份”：web-0.nginx 和 web-1.nginx。</p>
</blockquote>
<p>尽管 web-0.nginx 这条记录本身不会变，但它解析到的 Pod 的 IP 地址，并不是固定的。这就意味着，对于“有状态应用”实例的访问，必须使用 DNS 记录或者 hostname 的方式，而绝不应该直接访问这些 Pod 的 IP 地址。</p>
<h5 id="statefulset_1">StatefulSet</h5>
<h5 id="volumeclaimtemplate">volumeClaimTemplate</h5>
<p>不同过pod模版生产，即生成每一个Pod时，会对每一个pod自动创建volume， 而且对每一个volume生成对应的PVC，从而绑定预设好的PV</p>
<h6 id="example">example</h6>
<p>生成PV</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">volumes</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">pv</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">PersistentVolume</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">pv001</span>
  <span class="nl">labels:</span>
    <span class="nl">name:</span> <span class="n">pv001</span>
<span class="nl">spec:</span>
  <span class="nl">nfs:</span>
    <span class="nl">path:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">v1</span>
    <span class="nl">server:</span> <span class="mf">202.182.104.162</span>
  <span class="nl">accessModes:</span> <span class="p">[</span><span class="s">&quot;ReadWriteMany&quot;</span><span class="p">,</span> <span class="s">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="nl">capacity:</span>
    <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">PersistentVolume</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">pv002</span>
  <span class="nl">labels:</span>
    <span class="nl">name:</span> <span class="n">pv002</span>
<span class="nl">spec:</span>
  <span class="nl">nfs:</span>
    <span class="nl">path:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">v2</span>
    <span class="nl">server:</span> <span class="mf">202.182.104.162</span>
  <span class="nl">accessModes:</span> <span class="p">[</span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="nl">capacity:</span>
    <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">PersistentVolume</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">pv003</span>
  <span class="nl">labels:</span>
    <span class="nl">name:</span> <span class="n">pv003</span>
<span class="nl">spec:</span>
  <span class="nl">nfs:</span>
    <span class="nl">path:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">v3</span>
    <span class="nl">server:</span> <span class="mf">202.182.104.162</span>
  <span class="nl">accessModes:</span> <span class="p">[</span><span class="s">&quot;ReadWriteMany&quot;</span><span class="p">,</span> <span class="s">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="nl">capacity:</span>
    <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">PersistentVolume</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">pv004</span>
  <span class="nl">labels:</span>
    <span class="nl">name:</span> <span class="n">pv004</span>
<span class="nl">spec:</span>
  <span class="nl">nfs:</span>
    <span class="nl">path:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">v4</span>
    <span class="nl">server:</span> <span class="mf">202.182.104.162</span>
  <span class="nl">accessModes:</span> <span class="p">[</span><span class="s">&quot;ReadWriteMany&quot;</span><span class="p">,</span> <span class="s">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="nl">capacity:</span>
    <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">PersistentVolume</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">pv005</span>
  <span class="nl">labels:</span>
    <span class="nl">name:</span> <span class="n">pv005</span>
<span class="nl">spec:</span>
  <span class="nl">nfs:</span>
    <span class="nl">path:</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">volumes</span><span class="o">/</span><span class="n">v5</span>
    <span class="nl">server:</span> <span class="mf">202.182.104.162</span>
  <span class="nl">accessModes:</span> <span class="p">[</span><span class="s">&quot;ReadWriteMany&quot;</span><span class="p">,</span> <span class="s">&quot;ReadWriteOnce&quot;</span><span class="p">]</span>
  <span class="nl">capacity:</span>
    <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>
<span class="o">---</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">volumes</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">pv</span>
<span class="n">NAME</span>    <span class="n">CAPACITY</span>   <span class="n">ACCESS</span> <span class="n">MODES</span>   <span class="n">RECLAIM</span> <span class="n">POLICY</span>   <span class="n">STATUS</span>      <span class="n">CLAIM</span>   <span class="n">STORAGECLASS</span>   <span class="n">REASON</span>   <span class="n">AGE</span>
<span class="n">pv001</span>   <span class="mi">5</span><span class="n">Gi</span>        <span class="n">RWO</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Retain</span>           <span class="n">Available</span>                                   <span class="mi">11</span><span class="n">m</span>
<span class="n">pv002</span>   <span class="mi">5</span><span class="n">Gi</span>        <span class="n">RWO</span>            <span class="n">Retain</span>           <span class="n">Available</span>                                   <span class="mi">11</span><span class="n">m</span>
<span class="n">pv003</span>   <span class="mi">5</span><span class="n">Gi</span>        <span class="n">RWO</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Retain</span>           <span class="n">Available</span>                                   <span class="mi">11</span><span class="n">m</span>
<span class="n">pv004</span>   <span class="mi">5</span><span class="n">Gi</span>        <span class="n">RWO</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Retain</span>           <span class="n">Available</span>                                   <span class="mi">11</span><span class="n">m</span>
<span class="n">pv005</span>   <span class="mi">5</span><span class="n">Gi</span>        <span class="n">RWO</span><span class="p">,</span><span class="n">RWX</span>        <span class="n">Retain</span>           <span class="n">Available</span>                                   <span class="mi">11</span><span class="n">m</span>
</pre></div>


<p>生成StatefulSet</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">manifests</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">stateful</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">Service</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">myapp</span>
  <span class="nl">labels:</span>
    <span class="nl">app:</span> <span class="n">myapp</span>
<span class="nl">spec:</span>
  <span class="nl">ports:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="nl">name:</span> <span class="n">web</span>
  <span class="nl">clusterIP:</span> <span class="n">None</span>
  <span class="nl">selector:</span>
    <span class="nl">app:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">pod</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">StatefulSet</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">myapp</span>
<span class="nl">spec:</span>
  <span class="nl">serviceName:</span> <span class="n">myapp</span>
  <span class="nl">replicas:</span> <span class="mi">3</span>
  <span class="nl">selector:</span>
    <span class="nl">matchLabels:</span>
      <span class="nl">app:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">pod</span>
  <span class="nl">template:</span>
    <span class="nl">metadata:</span>
      <span class="nl">labels:</span>
        <span class="nl">app:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">pod</span>
    <span class="nl">spec:</span>
      <span class="nl">containers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
        <span class="nl">image:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v1</span>
        <span class="nl">ports:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="nl">name:</span> <span class="n">web</span>
        <span class="nl">volumeMounts:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myappdata</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span>
  <span class="nl">volumeClaimTemplates:</span>
  <span class="o">-</span> <span class="n">metadata</span><span class="o">:</span>
      <span class="nl">name:</span> <span class="n">myappdata</span>
    <span class="nl">spec:</span>
      <span class="nl">accessModes:</span> <span class="p">[</span> <span class="s">&quot;ReadWriteOnce&quot;</span> <span class="p">]</span>
      <span class="nl">resources:</span>
        <span class="nl">requests:</span>
          <span class="nl">storage:</span> <span class="mi">5</span><span class="n">Gi</span>                   
</pre></div>


<blockquote>
<p>要在每个worker node提前挂载nfs目录</p>
</blockquote>
<div class="hlcode"><pre><span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">manifests</span><span class="cp">]</span># kubectl  apply -f stateful-demo.yaml
service/myapp unchanged
statefulset.apps/myapp created

<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get pods
NAME          READY   STATUS    RESTARTS   AGE
myapp-0       1/1     Running   0          59m
myapp-1       1/1     Running   0          58m
myapp-2       1/1     Running   0          52m
pod-vol-nfs   1/1     Running   0          5d23h
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get pods
NAME          READY   STATUS    RESTARTS   AGE
myapp-0       1/1     Running   0          59m
myapp-1       1/1     Running   0          59m
myapp-2       1/1     Running   0          52m
pod-vol-nfs   1/1     Running   0          5d23h
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1    <span class="nt">&lt;none&gt;</span>        443/TCP   7d20h
myapp        ClusterIP   None         <span class="nt">&lt;none&gt;</span>        80/TCP    59m
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get sts
NAME    READY   AGE
myapp   3/3     59m

<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get pv
NAME    CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                       STORAGECLASS   REASON   AGE
pv001   5Gi        RWO,RWX        Retain           Bound       default/myappdata-myapp-1                           59m
pv002   5Gi        RWO            Retain           Bound       default/myappdata-myapp-0                           59m
pv003   5Gi        RWO,RWX        Retain           Bound       default/myappdata-myapp-2                           59m
pv004   5Gi        RWO,RWX        Retain           Available                                                       59m
pv005   5Gi        RWO,RWX        Retain           Available                                                       59m


<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="err">~</span><span class="cp">]</span># kubectl  get pvc
NAME                STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
myappdata-myapp-0   Bound    pv002    5Gi        RWO                           59m
myappdata-myapp-1   Bound    pv001    5Gi        RWO,RWX                       59m
myappdata-myapp-2   Bound    pv003    5Gi        RWO,RWX                       53m
</pre></div>


<h3 id="daemonset">DaemonSet 守护进程 无状态</h3>
<p>这个Pod会运行在Kubernetes集群里面的有限节点(Node)上面， 而且只会有一个这样的pod 实例</p>
<p>常用于运行集群存储的守护进程，如glusterd，ceph，</p>
<p>日志收集进程如fluentd，logstash，</p>
<p>监控进程，如prometheus的Node Explorter，collected，datadog agent， Ganglia的gmond</p>
<p>当有新的节点加入到Kubernetes集群中，该Pod会自动在新节点上创建完成，旧节点删除后，Pod也会被回收</p>
<p>相对而言，DaemonSet开始运行的时间，会比整个Kubernetes集群要早</p>
<p>DaemonSet没有replicas字段</p>
<p>创建每个Pod的时候，DaemonSet会自动给这个Pod加上一个nodeAffinity，从而保证Pod只会在这个节点上启动，同时还会自动加上一个Toleration，从而忽略节点的unschedulable污点</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">DaemonSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">elasticsearch</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">k8s</span><span class="o">-</span><span class="n">app</span><span class="o">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">logging</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">elasticsearch</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">elasticsearch</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">tolerations</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">key</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="o">.</span><span class="na">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">master</span>
        <span class="n">effect</span><span class="o">:</span> <span class="n">NoSchedule</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">fluentd</span><span class="o">-</span><span class="n">elasticsearch</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">k8s</span><span class="o">.</span><span class="na">gcr</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">fluentd</span><span class="o">-</span><span class="n">elasticsearch</span><span class="o">:</span><span class="mf">1.20</span>
        <span class="n">resources</span><span class="o">:</span>
          <span class="n">limits</span><span class="o">:</span>
            <span class="n">memory</span><span class="o">:</span> <span class="mi">200</span><span class="n">Mi</span>
          <span class="n">requests</span><span class="o">:</span>
            <span class="n">cpu</span><span class="o">:</span> <span class="mi">100</span><span class="n">m</span>
            <span class="n">memory</span><span class="o">:</span> <span class="mi">200</span><span class="n">Mi</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">varlog</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/var/</span><span class="n">log</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">varlibdockercontainers</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/var/lib/docker/</span><span class="n">containers</span>
          <span class="n">readOnly</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">terminationGracePeriodSeconds</span><span class="o">:</span> <span class="mi">30</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">varlog</span>
        <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/var/</span><span class="n">log</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">varlibdockercontainers</span>
        <span class="n">hostPath</span><span class="o">:</span>
          <span class="n">path</span><span class="o">:</span> <span class="sr">/var/lib/docker/</span><span class="n">containers</span>
</pre></div>


<blockquote>
<p>管理的是一个fluentd-elasticsearch镜像的Pod，即通过fluentd将Docker容器里面的日志转发到ElasticSearch中</p>
<p>两个hostPath分别对应/var/log目录和/var/lib/docker/containers目录</p>
</blockquote>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">DaemonSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">ds</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="k">default</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">filebeat</span>
      <span class="n">release</span><span class="o">:</span> <span class="n">stable</span>
  <span class="n">template</span><span class="o">:</span>
   <span class="n">metadata</span><span class="o">:</span>
     <span class="n">labels</span><span class="o">:</span>
       <span class="n">app</span><span class="o">:</span> <span class="n">filebeat</span>
       <span class="n">release</span><span class="o">:</span> <span class="n">stable</span>
   <span class="n">spec</span><span class="o">:</span>
     <span class="n">containers</span><span class="o">:</span>
     <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">filebeat</span>
       <span class="n">image</span><span class="o">:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">filebeat</span><span class="o">:</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">5</span><span class="o">-</span><span class="n">alpine</span>
       <span class="n">env</span><span class="o">:</span>
       <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
         <span class="n">value</span><span class="o">:</span> <span class="n">redis</span><span class="o">.</span><span class="na">default</span><span class="o">.</span><span class="na">svc</span><span class="o">.</span><span class="na">cluster</span><span class="o">.</span><span class="na">local</span>
       <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_LOG_LEVEL</span>
         <span class="n">value</span><span class="o">:</span> <span class="n">info</span>
</pre></div>


<h4 id="_6">滚动更新方式</h4>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">set</span> <span class="n">image</span> <span class="n">daemonsets</span> <span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span> <span class="n">filebeat</span><span class="o">=</span><span class="n">ikubernetes</span><span class="o">/</span><span class="n">filebeat</span><span class="o">:</span><span class="mf">5.6.6</span><span class="o">-</span><span class="n">alpine</span>
<span class="n">daemonset</span><span class="p">.</span><span class="n">extensions</span><span class="o">/</span><span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span> <span class="n">image</span> <span class="n">updated</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">w</span>
<span class="n">NAME</span>                               <span class="n">READY</span>   <span class="n">STATUS</span>              <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">client</span>                             <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">3</span><span class="n">d10h</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">9</span><span class="n">tgw8</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">1</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">x8zpd</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">3</span><span class="n">s</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">pod</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>    <span class="mi">806</span>        <span class="mi">2</span><span class="n">d1h</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">1</span>          <span class="mi">47</span><span class="n">h</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67</span><span class="n">b6dfcd8</span><span class="o">-</span><span class="mi">59</span><span class="n">wxt</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">50</span><span class="n">m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67</span><span class="n">b6dfcd8</span><span class="o">-</span><span class="n">g2cnc</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">50</span><span class="n">m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67</span><span class="n">b6dfcd8</span><span class="o">-</span><span class="n">jjfml</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">50</span><span class="n">m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67</span><span class="n">b6dfcd8</span><span class="o">-</span><span class="n">rc7t8</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">50</span><span class="n">m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67</span><span class="n">b6dfcd8</span><span class="o">-</span><span class="n">s6g9m</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">50</span><span class="n">m</span>
<span class="n">poststart</span><span class="o">-</span><span class="n">pod</span>                      <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>    <span class="mi">319</span>        <span class="mi">26</span><span class="n">h</span>
<span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">46</span><span class="n">h</span>
<span class="n">redis</span><span class="o">-</span><span class="mi">58</span><span class="n">b9f5776</span><span class="o">-</span><span class="n">bdp8d</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">x8zpd</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">6</span><span class="n">s</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">9</span><span class="n">tgw8</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Terminating</span>         <span class="mi">1</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">9</span><span class="n">tgw8</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Terminating</span>         <span class="mi">1</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">9</span><span class="n">tgw8</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Terminating</span>         <span class="mi">1</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">9</span><span class="n">tgw8</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Terminating</span>         <span class="mi">1</span>          <span class="mi">11</span><span class="n">m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">k926z</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">k926z</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Pending</span>             <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">k926z</span>                  <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">ContainerCreating</span>   <span class="mi">0</span>          <span class="mi">0</span><span class="n">s</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="n">k926z</span>                  <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>             <span class="mi">0</span>          <span class="mi">5</span><span class="n">s</span>
</pre></div>


<h4 id="master-toleration">Master 节点 toleration</h4>
<p>添加Toleration，在Master节点上部署Pod</p>
<p>默认Kubernetes集群不允许用户在Master节点上部署Pod，因为Master节点携带了一个<code>node-role.kubernetes.io/master</code> 污点，所以要容忍这个污点</p>
<div class="hlcode"><pre><span class="nl">tolerations:</span>
<span class="o">-</span> <span class="n">key</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span>
  <span class="nl">effect:</span> <span class="n">NoSchedule</span>
</pre></div>


<h4 id="ingress-controller">Ingress Controller (七层会话卸载)</h4>
<p>一种特殊的Pod，直接监听在宿主机的网络上接入外部请求</p>
<p>独立运行的一组Pod资源，通常为应用程序，即拥有七层调度的代理能力</p>
<p><img alt="img" src="https://snag.gy/HhNRni.jpg" /></p>
<p>这里通过一个service，帮助来对Pod进行分组，本身并不接受外部请求，然后通过ingress资源，实时反应Pod节点的状态，将其信息动态注入到ingress controller，并生成对应的配置文件，哪些pod可以被使用</p>
<p>通常有3种选择，Nginx，Traefik， Envoy(微服务)</p>
<h5 id="example_1">example</h5>
<p>对应的repo</p>
<p>https://github.com/kubernetes/ingress-nginx.git</p>
<p>创建名称空间</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">create</span> <span class="n">namespace</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
<span class="n">namespace</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="n">created</span>
</pre></div>


<p>激活所有yaml</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">deploy</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">namespace</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">Warning:</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span> <span class="n">on</span> <span class="n">resource</span> <span class="n">created</span> <span class="n">by</span> <span class="n">either</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">config</span> <span class="n">or</span> <span class="n">kubectl</span> <span class="n">apply</span>
<span class="n">namespace</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="n">configured</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">deploy</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="p">.</span><span class="o">/</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">configuration</span> <span class="n">created</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">tcp</span><span class="o">-</span><span class="n">services</span> <span class="n">created</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">udp</span><span class="o">-</span><span class="n">services</span> <span class="n">created</span>
<span class="n">namespace</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="n">unchanged</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">configuration</span> <span class="n">unchanged</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">tcp</span><span class="o">-</span><span class="n">services</span> <span class="n">unchanged</span>
<span class="n">configmap</span><span class="o">/</span><span class="n">udp</span><span class="o">-</span><span class="n">services</span> <span class="n">unchanged</span>
<span class="n">serviceaccount</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">serviceaccount</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">clusterrole</span> <span class="n">created</span>
<span class="n">role</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">role</span> <span class="n">created</span>
<span class="n">rolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">nisa</span><span class="o">-</span><span class="n">binding</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">clusterrole</span><span class="o">-</span><span class="n">nisa</span><span class="o">-</span><span class="n">binding</span> <span class="n">created</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">controller</span> <span class="n">created</span>
<span class="n">namespace</span><span class="o">/</span><span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="n">unchanged</span>
<span class="n">serviceaccount</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">serviceaccount</span> <span class="n">unchanged</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">clusterrole</span> <span class="n">unchanged</span>
<span class="n">role</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">role</span> <span class="n">unchanged</span>
<span class="n">rolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">role</span><span class="o">-</span><span class="n">nisa</span><span class="o">-</span><span class="n">binding</span> <span class="n">unchanged</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">clusterrole</span><span class="o">-</span><span class="n">nisa</span><span class="o">-</span><span class="n">binding</span> <span class="n">unchanged</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">controller</span> <span class="n">unchanged</span>
</pre></div>


<p>激活service和pod</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">deploy</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">Service</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">myapp</span>
  <span class="nl">namespace:</span> <span class="k">default</span>
<span class="nl">spec:</span>
  <span class="nl">selector:</span>
    <span class="nl">app:</span> <span class="n">myapp</span>
    <span class="nl">release:</span> <span class="n">canary</span>
  <span class="nl">ports:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
    <span class="nl">targetPort:</span> <span class="mi">80</span>
    <span class="nl">port:</span> <span class="mi">80</span>
<span class="o">---</span>
<span class="nl">apiVersion:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">Deployment</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span>
  <span class="nl">namespace:</span> <span class="k">default</span>
<span class="nl">spec:</span>
  <span class="nl">replicas:</span> <span class="mi">3</span>
  <span class="nl">selector:</span>
    <span class="nl">matchLabels:</span>
      <span class="nl">app:</span> <span class="n">myapp</span>
      <span class="nl">release:</span> <span class="n">canary</span>
  <span class="nl">template:</span>
   <span class="nl">metadata:</span>
     <span class="nl">labels:</span>
       <span class="nl">app:</span> <span class="n">myapp</span>
       <span class="nl">release:</span> <span class="n">canary</span>
   <span class="nl">spec:</span>
     <span class="nl">containers:</span>
     <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
       <span class="nl">image:</span> <span class="n">ikubernetes</span><span class="o">/</span><span class="n">myapp</span><span class="o">:</span><span class="n">v2</span>
       <span class="nl">ports:</span>
       <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
         <span class="nl">containerPort:</span> <span class="mi">80</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">deploy</span><span class="o">-</span><span class="n">demo</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span> <span class="n">created</span>

<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>                                <span class="n">READY</span>   <span class="n">STATUS</span>             <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">client</span>                              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">d12h</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">8</span><span class="n">kc4g</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">h19m</span>
<span class="n">filebeat</span><span class="o">-</span><span class="n">ds</span><span class="o">-</span><span class="mi">8</span><span class="n">vwkt</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">h19m</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">exec</span><span class="o">-</span><span class="n">pod</span>                   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>   <span class="mi">1630</span>       <span class="mi">4</span><span class="n">d4h</span>
<span class="n">liveness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>                <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">1</span>          <span class="mi">4</span><span class="n">d1h</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="mi">6</span><span class="n">mtj8</span>       <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">78</span><span class="n">s</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="mi">9</span><span class="n">c52x</span>       <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">78</span><span class="n">s</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deploy</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="n">n2949</span>       <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">78</span><span class="n">s</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="n">q8gxv</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">h19m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="n">tdfk7</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">h19m</span>
<span class="n">myapp</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">675558</span><span class="n">bfc5</span><span class="o">-</span><span class="n">zhn8b</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">5</span><span class="n">h19m</span>
<span class="n">poststart</span><span class="o">-</span><span class="n">pod</span>                       <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>     <span class="n">CrashLoopBackOff</span>   <span class="mi">915</span>        <span class="mi">3</span><span class="n">d5h</span>
<span class="n">readiness</span><span class="o">-</span><span class="n">httpget</span><span class="o">-</span><span class="n">pod</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">4</span><span class="n">d1h</span>
<span class="n">redis</span><span class="o">-</span><span class="mi">58</span><span class="n">b9f5776</span><span class="o">-</span><span class="n">bdp8d</span>               <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>            <span class="mi">0</span>          <span class="mi">2</span><span class="n">d3h</span>
</pre></div>


<p>修改ingress controller，使其能够接入集群外部的流量</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span><span class="p">]</span><span class="err">#</span> <span class="n">vim</span> <span class="n">deploy</span><span class="o">/</span><span class="n">provider</span><span class="o">/</span><span class="n">baremetal</span><span class="o">/</span><span class="n">service</span><span class="o">-</span><span class="n">nodeport</span><span class="p">.</span><span class="n">yaml</span>

<span class="nl">apiVersion:</span> <span class="n">v1</span>
<span class="nl">kind:</span> <span class="n">Service</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
  <span class="nl">namespace:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
  <span class="nl">labels:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="o">:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
    <span class="n">app</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="o">:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
<span class="nl">spec:</span>
  <span class="nl">type:</span> <span class="n">NodePort</span>
  <span class="nl">ports:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
      <span class="nl">port:</span> <span class="mi">80</span>
      <span class="nl">targetPort:</span> <span class="mi">80</span>
      <span class="nl">protocol:</span> <span class="n">TCP</span>
      <span class="nl">nodePort:</span> <span class="mi">30080</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">https</span>
      <span class="nl">port:</span> <span class="mi">443</span>
      <span class="nl">targetPort:</span> <span class="mi">443</span>
      <span class="nl">protocol:</span> <span class="n">TCP</span>
      <span class="nl">nodePort:</span> <span class="mi">30443</span>
  <span class="nl">selector:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">name</span><span class="o">:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
    <span class="n">app</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="n">of</span><span class="o">:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
</pre></div>


<blockquote>
<p>添加特殊的节点端口30080，30443</p>
</blockquote>
<div class="hlcode"><pre><span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">deploy</span><span class="cp">]</span># kubectl apply -f provider/baremetal/service-nodeport.yaml
service/ingress-nginx created
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">deploy</span><span class="cp">]</span># kubectl  get svc -n ingress-nginx
NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx   NodePort   10.98.203.113   <span class="nt">&lt;none&gt;</span>        80:30080/TCP,443:30443/TCP   10s
</pre></div>


<p>将myapp的代码通过ingress发布出去， 使用虚拟主机来实现</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">cat</span> <span class="n">ingress</span><span class="o">-</span><span class="n">myapp</span><span class="p">.</span><span class="n">yaml</span>
<span class="nl">apiVersion:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="nl">kind:</span> <span class="n">Ingress</span>
<span class="nl">metadata:</span>
  <span class="nl">name:</span> <span class="n">ingress</span><span class="o">-</span><span class="n">myapp</span>
  <span class="nl">namespace:</span> <span class="k">default</span>
  <span class="nl">annotations:</span>
    <span class="n">kubenetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">ingress</span><span class="p">.</span><span class="n">class</span><span class="o">:</span> <span class="s">&quot;nginx&quot;</span>
<span class="nl">spec:</span>
  <span class="nl">rules:</span>
  <span class="o">-</span> <span class="n">host</span><span class="o">:</span> <span class="n">myapp</span><span class="p">.</span><span class="n">xurick</span><span class="p">.</span><span class="n">com</span>
    <span class="nl">http:</span>
      <span class="nl">paths:</span>
      <span class="o">-</span> <span class="n">path</span><span class="o">:</span>
        <span class="nl">backend:</span>
          <span class="nl">serviceName:</span> <span class="n">myapp</span>
          <span class="nl">servicePort:</span> <span class="mi">80</span>
</pre></div>


<p>查看部署结果</p>
<div class="hlcode"><pre><span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">ingress</span><span class="cp">]</span># kubectl apply -f ingress-myapp.yaml
ingress.extensions/ingress-myapp created
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">ingress</span><span class="cp">]</span># kubectl get ingress
NAME            HOSTS              ADDRESS   PORTS   AGE
ingress-myapp   myapp.xurick.com             80      6s
<span class="cp">[</span><span class="nb">root</span><span class="p">@</span><span class="nx">master</span> <span class="nx">ingress</span><span class="cp">]</span># kubectl  describe ingress ingress-myapp
Name:             ingress-myapp
Namespace:        default
Address:
Default backend:  default-http-backend:80 (<span class="nt">&lt;none&gt;</span>)
Rules:
  Host              Path  Backends
  ----              ----  --------
  myapp.xurick.com
                       myapp:80 (10.244.1.40:80,10.244.1.41:80,10.244.1.43:80 + 3 more...)
Annotations:
  kubenetes.io/ingress.class:                        nginx
  kubectl.kubernetes.io/last-applied-configuration:  {&quot;apiVersion&quot;:&quot;extensions/v1beta1&quot;,&quot;kind&quot;:&quot;Ingress&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubenetes.io/ingress.class&quot;:&quot;nginx&quot;},&quot;name&quot;:&quot;ingress-myapp&quot;,&quot;namespace&quot;:&quot;default&quot;},&quot;spec&quot;:{&quot;rules&quot;:<span class="cp">[</span><span class="p">{</span><span class="s2">&quot;host&quot;</span><span class="p">:</span><span class="s2">&quot;myapp.xurick.com&quot;</span><span class="p">,</span><span class="s2">&quot;http&quot;</span><span class="p">:{</span><span class="s2">&quot;paths&quot;</span><span class="p">:</span><span class="err">[</span><span class="p">{</span><span class="s2">&quot;backend&quot;</span><span class="p">:{</span><span class="s2">&quot;serviceName&quot;</span><span class="p">:</span><span class="s2">&quot;myapp&quot;</span><span class="p">,</span><span class="s2">&quot;servicePort&quot;</span><span class="p">:</span><span class="mi">80</span><span class="p">},</span><span class="s2">&quot;path&quot;</span><span class="p">:</span><span class="kt">null</span><span class="p">}</span><span class="cp">]</span>}}]}}

Events:
  Type    Reason  Age   From                      Message
  ----    ------  ----  ----                      -------
  Normal  CREATE  46s   nginx-ingress-controller  Ingress default/ingress-myapp
</pre></div>


<p>进入容器可以查看到nginx的配置</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span>
<span class="n">NAME</span>                                        <span class="n">READY</span>   <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="mf">66f</span><span class="mi">94</span><span class="n">c89cb</span><span class="o">-</span><span class="n">thqfv</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>     <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">h</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">master</span> <span class="n">ingress</span><span class="p">]</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">exec</span> <span class="o">-</span><span class="n">n</span> <span class="n">ingress</span><span class="o">-</span><span class="n">nginx</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span><span class="o">-</span><span class="n">ingress</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="mf">66f</span><span class="mi">94</span><span class="n">c89cb</span><span class="o">-</span><span class="n">thqfv</span> <span class="o">--</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="err">$</span> <span class="n">cat</span> <span class="n">nginx</span><span class="p">.</span><span class="n">conf</span>
<span class="p">...</span>

<span class="cp">## start server myapp.xurick.com</span>
        <span class="n">server</span> <span class="p">{</span>
                <span class="n">server_name</span> <span class="n">myapp</span><span class="p">.</span><span class="n">xurick</span><span class="p">.</span><span class="n">com</span> <span class="p">;</span>

                <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>

                <span class="n">set</span> <span class="err">$</span><span class="n">proxy_upstream_name</span> <span class="s">&quot;-&quot;</span><span class="p">;</span>

                <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>

                        <span class="n">set</span> <span class="err">$</span><span class="n">namespace</span>      <span class="s">&quot;default&quot;</span><span class="p">;</span>
                        <span class="n">set</span> <span class="err">$</span><span class="n">ingress_name</span>   <span class="s">&quot;ingress-myapp&quot;</span><span class="p">;</span>
                        <span class="n">set</span> <span class="err">$</span><span class="n">service_name</span>   <span class="s">&quot;myapp&quot;</span><span class="p">;</span>
                        <span class="n">set</span> <span class="err">$</span><span class="n">service_port</span>   <span class="s">&quot;80&quot;</span><span class="p">;</span>
                        <span class="n">set</span> <span class="err">$</span><span class="n">location_path</span>  <span class="s">&quot;/&quot;</span><span class="p">;</span>

                        <span class="n">rewrite_by_lua_block</span> <span class="p">{</span>
                                <span class="n">balancer</span><span class="p">.</span><span class="n">rewrite</span><span class="p">()</span>
                        <span class="p">}</span>

                        <span class="n">header_filter_by_lua_block</span> <span class="p">{</span>

                        <span class="p">}</span>
                        <span class="n">body_filter_by_lua_block</span> <span class="p">{</span>
</pre></div>


<h3 id="job">Job 完成后终止</h3>
<p>只能执行一次性的作业</p>
<p>用来描述离线业务的API对象</p>
<p>restartPolicy 在 Job 对象里只允许被设置为 Never 和 OnFailure</p>
<p>Job对象并不要一定要定一个spec.selector 来描述控制哪些Pod</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">pi</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">resouer</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">bc</span> 
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo &#39;scale=10000; 4*a(1)&#39; | bc -l &quot;</span><span class="o">]</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
  <span class="n">backoffLimit</span><span class="o">:</span> <span class="mi">4</span>
</pre></div>


<blockquote>
<p>4*a(1) 结果为pi </p>
<p>restartPolicy: Never  离线计算的Pod不应该被重启</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">create</span> <span class="na">-f</span> <span class="nx">job.yaml</span>

<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">describe</span> <span class="nx">jobs</span><span class="p">/</span><span class="nb">pi</span>
<span class="nb">Name</span><span class="p">:</span>             <span class="nb">pi</span>
<span class="nx">Namespace</span><span class="p">:</span>        <span class="nb">default</span>
<span class="nx">Selector</span><span class="p">:</span>         <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">c2db599a</span><span class="o">-</span><span class="mi">2</span><span class="nx">c9d</span><span class="o">-</span><span class="mi">11</span><span class="nx">e6</span><span class="na">-b324</span><span class="o">-</span><span class="mi">0209</span><span class="nx">dc45a495</span>
<span class="nx">Labels</span><span class="p">:</span>           <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">c2db599a</span><span class="o">-</span><span class="mi">2</span><span class="nx">c9d</span><span class="o">-</span><span class="mi">11</span><span class="nx">e6</span><span class="na">-b324</span><span class="o">-</span><span class="mi">0209</span><span class="nx">dc45a495</span>
                  <span class="nx">job</span><span class="na">-name</span><span class="o">=</span><span class="nb">pi</span>
<span class="nx">Annotations</span><span class="p">:</span>      <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Parallelism</span><span class="p">:</span>      <span class="mi">1</span>
<span class="nx">Completions</span><span class="p">:</span>      <span class="mi">1</span>
<span class="nx">..</span>
<span class="nx">Pods</span> <span class="nx">Statuses</span><span class="p">:</span>    <span class="mi">0</span> <span class="nb">Running</span> <span class="o">/</span> <span class="mi">1</span> <span class="nx">Succeeded</span> <span class="o">/</span> <span class="mi">0</span> <span class="nx">Failed</span>
<span class="nx">Pod</span> <span class="nx">Template</span><span class="p">:</span>
  <span class="nx">Labels</span><span class="p">:</span>       <span class="nx">controller</span><span class="na">-uid</span><span class="o">=</span><span class="nx">c2db599a</span><span class="o">-</span><span class="mi">2</span><span class="nx">c9d</span><span class="o">-</span><span class="mi">11</span><span class="nx">e6</span><span class="na">-b324</span><span class="o">-</span><span class="mi">0209</span><span class="nx">dc45a495</span>
                <span class="nx">job</span><span class="na">-name</span><span class="o">=</span><span class="nb">pi</span>
  <span class="nx">Containers</span><span class="p">:</span>
   <span class="nx">...</span>
  <span class="nx">Volumes</span><span class="p">:</span>              <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nb">Events</span><span class="p">:</span>
  <span class="nx">FirstSeen</span>    <span class="nx">LastSeen</span>    <span class="nb">Count</span>    <span class="nb">From</span>            <span class="nx">SubobjectPath</span>    <span class="k">Type</span>        <span class="nx">Reason</span>            <span class="nx">Message</span>
  <span class="o">---------</span>    <span class="o">--------</span>    <span class="o">-----</span>    <span class="o">----</span>            <span class="o">-------------</span>    <span class="o">--------</span>    <span class="o">------</span>            <span class="o">-------</span>
  <span class="mi">1</span><span class="nx">m</span>           <span class="mi">1</span><span class="nx">m</span>          <span class="mi">1</span>        <span class="p">{</span><span class="nx">job</span><span class="na">-controller</span> <span class="p">}</span>                <span class="nx">Normal</span>      <span class="nx">SuccessfulCreate</span>  <span class="nx">Created</span> <span class="nx">pod</span><span class="p">:</span> <span class="nb">pi</span><span class="na">-rq5rl</span>
</pre></div>


<blockquote>
<p>创建成功之后，被自动加载了新的label，controller-uid=&lt; 一个随机字符串 &gt;， 这样保证了Job与其他Pod之间的匹配关系</p>
</blockquote>
<p>查看Pod状态</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>                                <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pi</span><span class="o">-</span><span class="n">rq5rl</span>                            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">10</span><span class="n">s</span>
</pre></div>


<p>稍后就completed了</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>                                <span class="n">READY</span>     <span class="n">STATUS</span>      <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">pi</span><span class="o">-</span><span class="n">rq5rl</span>                            <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">4</span><span class="n">m</span>
</pre></div>


<p>可以查看到结果</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">logs</span> <span class="n">pi</span><span class="o">-</span><span class="n">rq5rl</span>
<span class="mf">3.141592653589793238462643383279</span><span class="p">...</span>
</pre></div>


<h4 id="_7">并行控制</h4>
<p>spec.parallelism，它定义的是一个 Job 在任意时间最多可以启动多少个 Pod 同时运行</p>
<p>spec.completions，它定义的是 Job 至少要完成的 Pod 数目，即 Job 的最小完成数</p>
<p>根据 Job 控制器的工作原理，如果你定义的 parallelism 比 completions 还大的话，</p>
<div class="hlcode"><pre> <span class="nl">parallelism:</span> <span class="mi">4</span>
 <span class="nl">completions:</span> <span class="mi">2</span>
</pre></div>


<p>需要创建的 Pod 数目 = 最终需要的 Pod 数目 - 实际在 Running 状态 Pod 数目 - 已经成功退出的 Pod 数目 = 2 - 0 - 0= 2。而parallelism数量为4，2小于4，所以应该会创建2个。</p>
<h4 id="_8">使用方法</h4>
<h5 id="job_1">外部管理器 +Job 模板</h5>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">process</span><span class="o">-</span><span class="n">item</span><span class="o">-</span><span class="n">$ITEM</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">jobgroup</span><span class="o">:</span> <span class="n">jobexample</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">jobexample</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">jobgroup</span><span class="o">:</span> <span class="n">jobexample</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo Processing item $ITEM &amp;&amp; sleep 5&quot;</span><span class="o">]</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
</pre></div>


<blockquote>
<p>$ITEM 用于创建Job时，替换此变量的值</p>
<p>所有来自于同一个模板的 Job，都有一个 jobgroup: jobexample 标签，也就是说这一组 Job 使用这样一个相同的标识。</p>
</blockquote>
<h5 id="item">替换$ITEM操作</h5>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">mkdir</span> <span class="p">.</span><span class="o">/</span><span class="n">jobs</span>
<span class="err">$</span> <span class="k">for</span> <span class="n">i</span> <span class="n">in</span> <span class="n">apple</span> <span class="n">banana</span> <span class="n">cherry</span>
<span class="k">do</span>
  <span class="n">cat</span> <span class="n">job</span><span class="o">-</span><span class="n">tmpl</span><span class="p">.</span><span class="n">yaml</span> <span class="o">|</span> <span class="n">sed</span> <span class="s">&quot;s/\$ITEM/$i/&quot;</span> <span class="o">&gt;</span> <span class="p">.</span><span class="o">/</span><span class="n">jobs</span><span class="o">/</span><span class="n">job</span><span class="o">-</span><span class="err">$</span><span class="n">i</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">done</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="p">.</span><span class="o">/</span><span class="n">jobs</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">l</span> <span class="n">jobgroup</span><span class="o">=</span><span class="n">jobexample</span>
<span class="n">NAME</span>                        <span class="n">READY</span>     <span class="n">STATUS</span>      <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">process</span><span class="o">-</span><span class="n">item</span><span class="o">-</span><span class="n">apple</span><span class="o">-</span><span class="n">kixwv</span>    <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">4</span><span class="n">m</span>
<span class="n">process</span><span class="o">-</span><span class="n">item</span><span class="o">-</span><span class="n">banana</span><span class="o">-</span><span class="n">wrsf7</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">4</span><span class="n">m</span>
<span class="n">process</span><span class="o">-</span><span class="n">item</span><span class="o">-</span><span class="n">cherry</span><span class="o">-</span><span class="n">dnfu9</span>   <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Completed</span>   <span class="mi">0</span>          <span class="mi">4</span><span class="n">m</span>
</pre></div>


<h5 id="_9">固定数目并行</h5>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">completions</span><span class="o">:</span> <span class="mi">8</span>
  <span class="n">parallelism</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">myrepo</span><span class="o">/</span><span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">BROKER_URL</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">amqp</span><span class="o">://</span><span class="n">guest</span><span class="o">:</span><span class="n">guest</span><span class="err">@</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">service</span><span class="o">:</span><span class="mi">5672</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">QUEUE</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">job1</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<blockquote>
<p>completions 的值是：8, 即总共要处理的任务数目是 8 个</p>
</blockquote>
<p>在这个实例中，选择充当工作队列的是一个运行在 Kubernetes 里的 RabbitMQ。所以，需要在 Pod 模板里定义 BROKER_URL，来作为消费者。</p>
<p>所以，一旦用 kubectl create 创建了这个 Job，它就会以并发度为 2 的方式，每两个 Pod 一组，创建出 8 个 Pod。每个 Pod 都会去连接 BROKER_URL，从 RabbitMQ 里读取任务，然后各自进行处理。这个 Pod 里的执行逻辑，可以用这样一段伪代码来表示：</p>
<div class="hlcode"><pre><span class="cm">/* job-wq-1 的伪代码 */</span>
<span class="n">queue</span> <span class="o">:=</span> <span class="n">newQueue</span><span class="p">(</span><span class="err">$</span><span class="no">BROKER_URL</span><span class="p">,</span> <span class="err">$</span><span class="no">QUEUE</span><span class="p">)</span>
<span class="k">task</span> <span class="o">:=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
<span class="n">process</span><span class="p">(</span><span class="k">task</span><span class="p">)</span>
<span class="n">exit</span>
</pre></div>


<p>可以看到，每个 Pod 只需要将任务信息读取出来，处理完成，然后退出即可。而作为用户，我只关心最终一共有 8 个计算任务启动并且退出，只要这个目标达到，我就认为整个 Job 处理完成了。所以说，这种用法，对应的就是“任务总数固定”的场景。</p>
<h5 id="parallelism">指定并行度（parallelism）</h5>
<p>但不设置固定的 completions 的值 </p>
<p>此时，必须自己想办法，来决定什么时候启动新 Pod，什么时候 Job 才算执行完成。在这种情况下，任务的总数是未知的，所以不仅需要一个工作队列来负责任务分发，还需要能够判断工作队列已经为空（即：所有的工作已经结束了）</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">parallelism</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">2</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">c</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">gcr</span><span class="o">.</span><span class="na">io</span><span class="sr">/myproject/</span><span class="n">job</span><span class="o">-</span><span class="n">wq</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">BROKER_URL</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">amqp</span><span class="o">://</span><span class="n">guest</span><span class="o">:</span><span class="n">guest</span><span class="err">@</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">service</span><span class="o">:</span><span class="mi">5672</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">QUEUE</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">job2</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<p>类似伪代码体现</p>
<div class="hlcode"><pre><span class="cm">/* job-wq-2 的伪代码 */</span>
<span class="k">for</span> <span class="o">!</span><span class="n">queue</span><span class="p">.</span><span class="n">IsEmpty</span><span class="p">(</span><span class="err">$</span><span class="no">BROKER_URL</span><span class="p">,</span> <span class="err">$</span><span class="no">QUEUE</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">task</span> <span class="o">:=</span> <span class="n">queue</span><span class="p">.</span><span class="n">Pop</span><span class="p">()</span>
  <span class="n">process</span><span class="p">(</span><span class="k">task</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">print</span><span class="p">(</span><span class="s">&quot;Queue empty, exiting&quot;</span><span class="p">)</span>
<span class="n">exit</span>
</pre></div>


<p>由于任务数目的总数不固定，所以每一个 Pod 必须能够知道，自己什么时候可以退出。比如，在这个例子中，简单地以“队列为空”，作为任务全部完成的标志。所以说，这种用法，对应的是“任务总数不固定”的场景。</p>
<h3 id="cronjob">CronJob</h3>
<p>定时任务，周期性运行</p>
<p>还要处理的问题，如前一个任务未完成，下一个任务时间点已到，将要触发</p>
<p>CronJob是一个Job对象的控制器Controller</p>
<p>CronJob 是一个专门用来管理 Job 对象的控制器。它创建和删除 Job 的依据，是 schedule 字段定义的、一个标准的Unix Cron格式的表达式</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">CronJob</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">hello</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">schedule</span><span class="o">:</span> <span class="s2">&quot;*/1 * * * *&quot;</span>
  <span class="n">jobTemplate</span><span class="o">:</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">template</span><span class="o">:</span>
        <span class="n">spec</span><span class="o">:</span>
          <span class="n">containers</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">hello</span>
            <span class="n">image</span><span class="o">:</span> <span class="n">busybox</span>
            <span class="n">args</span><span class="o">:</span>
            <span class="o">-</span> <span class="sr">/bin/s</span><span class="n">h</span>
            <span class="o">-</span> <span class="o">-</span><span class="n">c</span>
            <span class="o">-</span> <span class="n">date</span><span class="o">;</span> <span class="n">echo</span> <span class="n">Hello</span> <span class="n">from</span> <span class="n">the</span> <span class="n">Kubernetes</span> <span class="n">cluster</span>
          <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
</pre></div>


<p>这个 CronJob 对象在创建 1 分钟后，就会有一个 Job 产生了</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="p">.</span><span class="o">/</span><span class="n">cronjob</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">cronjob</span> <span class="s">&quot;hello&quot;</span> <span class="n">created</span>

<span class="cp"># 一分钟后</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">jobs</span>
<span class="n">NAME</span>               <span class="n">DESIRED</span>   <span class="n">SUCCESSFUL</span>   <span class="n">AGE</span>
<span class="n">hello</span><span class="o">-</span><span class="mi">4111706356</span>   <span class="mi">1</span>         <span class="mi">1</span>         <span class="mi">2</span><span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">cronjob</span> <span class="n">hello</span>
<span class="n">NAME</span>      <span class="n">SCHEDULE</span>      <span class="n">SUSPEND</span>   <span class="n">ACTIVE</span>    <span class="n">LAST</span><span class="o">-</span><span class="n">SCHEDULE</span>
<span class="n">hello</span>     <span class="err">*/</span><span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">False</span>     <span class="mi">0</span>         <span class="n">Thu</span><span class="p">,</span> <span class="mi">6</span> <span class="n">Sep</span> <span class="mi">2018</span> <span class="mi">14</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span><span class="mo">00</span> <span class="o">-</span><span class="mo">070</span>
</pre></div>


<p>需要注意的是，由于定时任务的特殊性，很可能某个 Job 还没有执行完，另外一个新 Job 就产生了。这时候，你可以通过 spec.concurrencyPolicy 字段来定义具体的处理策略。</p>
<div class="hlcode"><pre><span class="n">concurrencyPolicy</span><span class="o">=</span><span class="n">Allow</span><span class="err">，这也是默认情况，这意味着这些</span> <span class="n">Job</span> <span class="err">可以同时存在；</span>
<span class="n">concurrencyPolicy</span><span class="o">=</span><span class="n">Forbid</span><span class="err">，这意味着不会创建新的</span> <span class="n">Pod</span><span class="err">，该创建周期被跳过；</span>
<span class="n">concurrencyPolicy</span><span class="o">=</span><span class="n">Replace</span><span class="err">，这意味着新产生的</span> <span class="n">Job</span> <span class="err">会替换旧的、没有执行完的</span> <span class="n">Job</span><span class="err">。</span>
</pre></div>


<p>而如果某一次 Job 创建失败，这次创建就会被标记为“miss”。当在指定的时间窗口内，miss 的数目达到 100 时，那么 CronJob 会停止再创建这个 Job。</p>
<h2 id="cluster">集群级资源 Cluster</h2>
<h3 id="namespace">Namespace</h3>
<p>资源对象名称的作用范围，默认隶属default</p>
<p>即管理空间</p>
<h3 id="node">Node</h3>
<p>Kubernetes集群工作节点，其标识符在当前集群唯一</p>
<h3 id="role">Role</h3>
<p>名称空间级别有规则组成的权限集合</p>
<p>被RoleBinding 引用</p>
<h3 id="clusterrole">ClusterRole</h3>
<p>Cluster 级别的 </p>
<p>规则组成的权限集合</p>
<p>被RoleBinding，ClusterRole Binding 引用</p>
<h3 id="rolebinding">RoleBinding</h3>
<p>将Role权限绑定在一个或一组用户上，</p>
<p>可以引用同一名称空间的Role，或全局名称的ClusterRole</p>
<h3 id="clusterrolebinding">ClusterRoleBinding</h3>
<p>将ClusterRole中定义的许可权限绑定在一个或一组用户上，引用ClusterRole</p>
<h2 id="metadata">元数据资源 Metadata</h2>
<p>用于为集群内部的其他资源配置其行为或特征，如HorizontalPodAutoscaler用于自动伸缩工作负载类型的资源对象的规模</p>
<h3 id="hpa">HPA</h3>
<p>自动调整元数据的相关信息</p>
<h3 id="podtemplate">PodTemplate</h3>
<p>用于让控制器创建pod的模板</p>
<h3 id="limitrange">LimitRange</h3>
<p>定义资源限制</p>
<h3 id="_10"></h3>
<h2 id="api">API 群组</h2>
<h3 id="core-group">核心群组 core group</h3>
<p>REST 路径为<code>/api/v1</code>，在资源配置信息apiVersion 字段中引用时可以不指定路径，而仅给出版本</p>
<p>如 <code>apiVersion:v1</code></p>
<h3 id="named-group">命名群组 named group</h3>
<p>REST 路径为<code>/apis/$GROUP_NAME/$VERSION</code> </p>
<p>如 <code>/apis/apps/v1</code>  在apiVersion字段中引用的格式为<code>apiVersion:$GROUP_NAME/$VERSION</code> </p>
<p>如<code>apiVersion:apps/v1</code></p>
<h2 id="_11">用户管理</h2>
<h3 id="serviceaccount">ServiceAccount</h3>
<p>Kubernetes 负责管理的内置用户</p>
<p>如果一个 Pod 没有声明 serviceAccountName，Kubernetes 会自动在它的 Namespace 下创建一个名叫 default 的默认 ServiceAccount，然后分配给这个 Pod。</p>
<p>生产环境，建议所有Namespace下默认ServiceAccount 绑定只读权限的Role</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">ServiceAccount</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">mynamespace</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span>
</pre></div>


<p>然后，我们通过编写 RoleBinding 的 YAML 文件，来为这个 ServiceAccount 分配权限：</p>
<div class="hlcode"><pre><span class="n">kind</span><span class="o">:</span> <span class="n">RoleBinding</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">rbac</span><span class="o">.</span><span class="na">authorization</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">rolebinding</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">mynamespace</span>
<span class="n">subjects</span><span class="o">:</span>
<span class="o">-</span> <span class="n">kind</span><span class="o">:</span> <span class="n">ServiceAccount</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">mynamespace</span>
<span class="n">roleRef</span><span class="o">:</span>
  <span class="n">kind</span><span class="o">:</span> <span class="n">Role</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">role</span>
  <span class="n">apiGroup</span><span class="o">:</span> <span class="n">rbac</span><span class="o">.</span><span class="na">authorization</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span>
</pre></div>


<blockquote>
<p>RoleBinding 对象里，subjects 字段的类型（kind），不再是一个 User，而是一个名叫 example-sa 的 ServiceAccount。而 roleRef 引用的 Role 对象，依然名叫 example-role，也就是我在这篇文章一开始定义的 Role 对象。</p>
</blockquote>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">svc</span><span class="o">-</span><span class="n">account</span><span class="p">.</span><span class="n">yaml</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">role</span><span class="o">-</span><span class="n">binding</span><span class="p">.</span><span class="n">yaml</span>
<span class="err">$</span> <span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">role</span><span class="p">.</span><span class="n">yaml</span>

<span class="err">$</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">sa</span> <span class="o">-</span><span class="n">n</span> <span class="n">mynamespace</span> <span class="o">-</span><span class="n">o</span> <span class="n">yaml</span>
<span class="o">-</span> <span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
  <span class="nl">kind:</span> <span class="n">ServiceAccount</span>
  <span class="nl">metadata:</span>
    <span class="nl">creationTimestamp:</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">08</span><span class="n">T12</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">17</span><span class="n">Z</span>
    <span class="nl">name:</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span>
    <span class="nl">namespace:</span> <span class="n">mynamespace</span>
    <span class="nl">resourceVersion:</span> <span class="s">&quot;409327&quot;</span>
    <span class="p">...</span>
  <span class="nl">secrets:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">vmfg6</span>
</pre></div>


<p>声明使用ServiceAccount</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">mynamespace</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">test</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.7</span><span class="o">.</span><span class="mi">9</span>
  <span class="n">serviceAccountName</span><span class="o">:</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span>
</pre></div>


<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">test</span> <span class="o">-</span><span class="n">n</span> <span class="n">mynamespace</span>
<span class="nl">Name:</span>               <span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">test</span>
<span class="nl">Namespace:</span>          <span class="n">mynamespace</span>
<span class="p">...</span>
<span class="nl">Containers:</span>
  <span class="nl">nginx:</span>
    <span class="p">...</span>
    <span class="nl">Mounts:</span>
      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span> <span class="n">from</span> <span class="n">example</span><span class="o">-</span><span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">vmfg6</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>
</pre></div>


<p>查看到目录的文件</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">test</span> <span class="o">-</span><span class="n">n</span> <span class="n">mynamespace</span> <span class="o">--</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">root</span><span class="err">@</span><span class="n">sa</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">test</span><span class="o">:/</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span>
<span class="n">ca</span><span class="p">.</span><span class="n">crt</span> <span class="n">namespace</span>  <span class="n">token</span>
</pre></div>


<blockquote>
<p>容器里的应用，就可以使用这个 ca.crt 来访问 APIServer 了。更重要的是，此时它只能够做 GET、WATCH 和 LIST 操作。因为 example-sa 这个 ServiceAccount 的权限，已经被我们绑定了 Role 做了限制。</p>
</blockquote>
<p>但在这种情况下，这个默认 ServiceAccount 并没有关联任何 Role。也就是说，此时它有访问 APIServer 的绝大多数权限。当然，这个访问所需要的 Token，还是默认 ServiceAccount 对应的 Secret 对象为它提供的，如下所示。</p>
<div class="hlcode"><pre><span class="nv">$kubectl</span> <span class="nb">describe</span> <span class="nx">sa</span> <span class="nb">default</span>
<span class="nb">Name</span><span class="p">:</span>                <span class="nb">default</span>
<span class="nx">Namespace</span><span class="p">:</span>           <span class="nb">default</span>
<span class="nx">Labels</span><span class="p">:</span>              <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Annotations</span><span class="p">:</span>         <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nb">Image</span> <span class="nx">pull</span> <span class="nx">secrets</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Mountable</span> <span class="nx">secrets</span><span class="p">:</span>   <span class="nb">default</span><span class="na">-token-s8rbq</span>
<span class="nx">Tokens</span><span class="p">:</span>              <span class="nb">default</span><span class="na">-token-s8rbq</span>
<span class="nb">Events</span><span class="p">:</span>              <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>

<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">get</span> <span class="nx">secret</span>
<span class="nb">NAME</span>                  <span class="k">TYPE</span>                                  <span class="kd">DATA</span>      <span class="nx">AGE</span>
<span class="nx">kubernetes.io</span><span class="p">/</span><span class="nx">service</span><span class="na">-account-token</span>   <span class="mi">3</span>         <span class="mi">82</span><span class="nb">d</span>

<span class="err">$</span> <span class="nx">kubectl</span> <span class="nb">describe</span> <span class="nx">secret</span> <span class="nb">default</span><span class="na">-token-s8rbq</span>
<span class="nb">Name</span><span class="p">:</span>         <span class="nb">default</span><span class="na">-token-s8rbq</span>
<span class="nx">Namespace</span><span class="p">:</span>    <span class="nb">default</span>
<span class="nx">Labels</span><span class="p">:</span>       <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Annotations</span><span class="p">:</span>  <span class="nx">kubernetes.io</span><span class="p">/</span><span class="nx">service</span><span class="na">-account.name</span><span class="o">=</span><span class="nb">default</span>
              <span class="nx">kubernetes.io</span><span class="p">/</span><span class="nx">service</span><span class="na">-account.uid</span><span class="o">=</span><span class="nx">ffcb12b2</span><span class="o">-</span><span class="mi">917</span><span class="nb">f</span><span class="o">-</span><span class="mi">11</span><span class="nx">e8</span><span class="na">-abde</span><span class="o">-</span><span class="mi">42010</span><span class="nx">aa80002</span>

<span class="k">Type</span><span class="p">:</span>  <span class="nx">kubernetes.io</span><span class="p">/</span><span class="nx">service</span><span class="na">-account-token</span>

<span class="kd">Data</span>
<span class="o">====</span>
<span class="nx">ca.crt</span><span class="p">:</span>     <span class="mi">1025</span> <span class="nb">bytes</span>
<span class="nx">namespace</span><span class="p">:</span>  <span class="mi">7</span> <span class="nb">bytes</span>
<span class="nb">token</span><span class="p">:</span>      <span class="o">&lt;</span><span class="nb">TOKEN</span> <span class="nx">数据</span> <span class="o">&gt;</span>
</pre></div>


<h3 id="group">Group</h3>
<p>一个ServiceAccount在Kubernetes对应的用户为</p>
<div class="hlcode"><pre><span class="n">system</span><span class="o">:</span><span class="n">serviceaccount</span><span class="o">:&lt;</span><span class="n">ServiceAccount</span> <span class="err">名字</span> <span class="o">&gt;</span>
</pre></div>


<p>对应的用户组名</p>
<div class="hlcode"><pre><span class="n">system</span><span class="o">:</span><span class="n">serviceaccounts</span><span class="o">:&lt;</span><span class="n">Namespace</span> <span class="err">名字</span> <span class="o">&gt;</span>
</pre></div>


<p>比如，现在我们可以在 RoleBinding 里定义如下的 subjects：</p>
<div class="hlcode"><pre><span class="nl">subjects:</span>
<span class="o">-</span> <span class="n">kind</span><span class="o">:</span> <span class="n">Group</span>
  <span class="nl">name:</span> <span class="n">system</span><span class="o">:</span><span class="n">serviceaccounts</span><span class="o">:</span><span class="n">mynamespace</span>
  <span class="nl">apiGroup:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
</pre></div>


<blockquote>
<p>这就意味着这个 Role 的权限规则，作用于 mynamespace 里的所有 ServiceAccount。这就用到了“用户组”的概念。</p>
</blockquote>
<div class="hlcode"><pre><span class="nl">subjects:</span>
<span class="o">-</span> <span class="n">kind</span><span class="o">:</span> <span class="n">Group</span>
  <span class="nl">name:</span> <span class="n">system</span><span class="o">:</span><span class="n">serviceaccounts</span>
  <span class="nl">apiGroup:</span> <span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span>
</pre></div>


<blockquote>
<p>就意味着这个 Role 的权限规则，作用于整个系统里的所有 ServiceAccount。</p>
</blockquote>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-06-26 08:56:03</p>
      </span>
    </div>

    
    
  </body>
</html>