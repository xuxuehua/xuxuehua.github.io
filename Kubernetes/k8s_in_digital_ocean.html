<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>k8s_in_digital_ocean - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Kubernetes">Kubernetes</a>&nbsp;&#187;&nbsp;k8s_in_digital_ocean
    <span class="updated">Page Updated&nbsp;
      2019-03-10 21:15
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">k8s_in_digital_ocean</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#master">Master 节点</a><ul>
<li><a href="#ubuntu">Ubuntu</a></li>
<li><a href="#kubeadm">kubeadm</a><ul>
<li><a href="#yaml">编写 yaml</a><ul>
<li><a href="#v1130">v1.13.0</a></li>
</ul>
</li>
<li><a href="#_1">执行</a></li>
</ul>
</li>
<li><a href="#_2">查看部署信息</a><ul>
<li><a href="#pod">查看节点Pod信息</a></li>
</ul>
</li>
<li><a href="#_3">部署网络插件</a><ul>
<li><a href="#kubectl-apply">kubectl apply</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#worker">Worker 节点</a><ul>
<li><a href="#ubuntu_1">Ubuntu</a></li>
<li><a href="#kubeadm-join">Kubeadm join</a></li>
</ul>
</li>
<li><a href="#worker-master">Worker 节点（与Master在一台主机）</a><ul>
<li><a href="#pod_1">声明Pod</a></li>
<li><a href="#mastertaint">master节点的Taint</a></li>
<li><a href="#dashboard">Dashboard 可视化插件</a></li>
<li><a href="#_4">容器持久化插件</a><ul>
<li><a href="#_5">持久化</a></li>
<li><a href="#rook-no-prod">Rook （No PROD）</a></li>
</ul>
</li>
<li><a href="#nginx">nginx 部署</a><ul>
<li><a href="#nginx-18">升级 nginx 1.8</a></li>
</ul>
</li>
<li><a href="#volume">声明Volume</a><ul>
<li><a href="#volume_1">共享Volume</a><ul>
<li><a href="#sidecar">Sidecar 组合</a></li>
<li><a href="#_6">容器的日志收集</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#mysql">MySQL 主从同步</a></li>
<li><a href="#faq">FAQ</a><ul>
<li><a href="#token">token 过期</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="master">Master 节点</h1>
<h2 id="ubuntu">Ubuntu</h2>
<p>16.04, 2 CPU, 7.5G mem, 30G HDD</p>
<p>先部署docker</p>
<div class="hlcode"><pre><span class="n">export</span> <span class="n">VERSION</span><span class="o">=</span><span class="mf">17.03</span> <span class="o">&amp;&amp;</span> <span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="n">get</span><span class="p">.</span><span class="n">docker</span><span class="p">.</span><span class="n">com</span> <span class="o">|</span> <span class="n">sh</span>
</pre></div>


<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">apt</span><span class="o">-</span><span class="n">transport</span><span class="o">-</span><span class="n">https</span> <span class="n">curl</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="o">:</span><span class="c1">//packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">https</span><span class="o">:</span><span class="c1">//apt.kubernetes.io/ kubernetes-xenial main</span>
<span class="n">EOF</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>

<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
</pre></div>


<h2 id="kubeadm">kubeadm</h2>
<h3 id="yaml">编写 yaml</h3>
<p>kubeadm.yaml</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">kubeadm</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1alpha1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">MasterConfiguration</span>
<span class="n">controllerManagerExtraArgs</span><span class="o">:</span>
  <span class="n">horizontal</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">autoscaler</span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">rest</span><span class="o">-</span><span class="n">clients</span><span class="o">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">horizontal</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">autoscaler</span><span class="o">-</span><span class="n">sync</span><span class="o">-</span><span class="n">period</span><span class="o">:</span> <span class="s2">&quot;10s&quot;</span>
  <span class="n">node</span><span class="o">-</span><span class="n">monitor</span><span class="o">-</span><span class="n">grace</span><span class="o">-</span><span class="n">period</span><span class="o">:</span> <span class="s2">&quot;10s&quot;</span>
<span class="n">apiServerExtraArgs</span><span class="o">:</span>
  <span class="n">runtime</span><span class="o">-</span><span class="n">config</span><span class="o">:</span> <span class="s2">&quot;api/all=true&quot;</span>
<span class="n">kubernetesVersion</span><span class="o">:</span> <span class="s2">&quot;stable-1.11&quot;</span>
</pre></div>


<blockquote>
<p>这里的controller-manager 配置了<code>horizontal-pod-autoscaler-use-rest-clients: "true"</code></p>
</blockquote>
<p>这样能够使用自定义资源(Custom Metrics) 进行水平扩展</p>
<h4 id="v1130">v1.13.0</h4>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">kubeadm</span><span class="o">.</span><span class="na">k8s</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">InitConfiguration</span>
<span class="n">controllerManager</span><span class="o">:</span>
  <span class="n">horizontal</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">autoscaler</span><span class="o">-</span><span class="n">use</span><span class="o">-</span><span class="n">rest</span><span class="o">-</span><span class="n">clients</span><span class="o">:</span> <span class="s2">&quot;true&quot;</span>
  <span class="n">horizontal</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">autoscaler</span><span class="o">-</span><span class="n">sync</span><span class="o">-</span><span class="n">period</span><span class="o">:</span> <span class="s2">&quot;10s&quot;</span>
  <span class="n">node</span><span class="o">-</span><span class="n">monitor</span><span class="o">-</span><span class="n">grace</span><span class="o">-</span><span class="n">period</span><span class="o">:</span> <span class="s2">&quot;10s&quot;</span>
<span class="n">apiServer</span><span class="o">:</span>
  <span class="n">runtime</span><span class="o">-</span><span class="n">config</span><span class="o">:</span> <span class="s2">&quot;api/all=true&quot;</span>
<span class="n">kubernetesVersion</span><span class="o">:</span> <span class="s2">&quot;v1.13.0&quot;</span>
</pre></div>


<h3 id="_1">执行</h3>
<div class="hlcode"><pre><span class="n">kubeadm</span> <span class="n">init</span> <span class="o">--</span><span class="n">config</span> <span class="n">kubeadm</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>


<p>部署完成后</p>
<div class="hlcode"><pre><span class="n">Your</span> <span class="n">Kubernetes</span> <span class="n">master</span> <span class="n">has</span> <span class="n">initialized</span> <span class="n">successfully</span><span class="o">!</span>

<span class="n">To</span> <span class="n">start</span> <span class="n">using</span> <span class="n">your</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="n">run</span> <span class="n">the</span> <span class="n">following</span> <span class="n">as</span> <span class="n">a</span> <span class="n">regular</span> <span class="n">user</span><span class="o">:</span>

  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span>
  <span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
  <span class="n">sudo</span> <span class="n">chown</span> <span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="p">)</span><span class="o">:</span><span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>

<span class="n">You</span> <span class="n">should</span> <span class="n">now</span> <span class="n">deploy</span> <span class="n">a</span> <span class="n">pod</span> <span class="n">network</span> <span class="n">to</span> <span class="n">the</span> <span class="n">cluster</span><span class="p">.</span>
<span class="n">Run</span> <span class="s">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="n">with</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">options</span> <span class="n">listed</span> <span class="n">at</span><span class="o">:</span>
  <span class="nl">https:</span><span class="c1">//kubernetes.io/docs/concepts/cluster-administration/addons/</span>

<span class="n">You</span> <span class="n">can</span> <span class="n">now</span> <span class="n">join</span> <span class="n">any</span> <span class="n">number</span> <span class="n">of</span> <span class="n">machines</span> <span class="n">by</span> <span class="n">running</span> <span class="n">the</span> <span class="n">following</span> <span class="n">on</span> <span class="n">each</span> <span class="n">node</span>
<span class="n">as</span> <span class="n">root</span><span class="o">:</span>

  <span class="n">kubeadm</span> <span class="n">join</span> <span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">x</span><span class="o">:</span><span class="mi">6443</span> <span class="o">--</span><span class="n">token</span> <span class="n">h7t5zp</span><span class="mf">.0</span><span class="n">atym3rlxb7oa9vu</span> <span class="o">--</span><span class="n">discovery</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">cert</span><span class="o">-</span><span class="n">hash</span> <span class="n">sha256</span><span class="o">:</span><span class="mf">3f</span><span class="mi">9</span><span class="n">b2fac0cdf760f6b03ccb0934743e97c182e127eca99a516716010275cc046</span>
</pre></div>


<p>执行部署信息</p>
<div class="hlcode"><pre>  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span>
  <span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">i</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">admin</span><span class="p">.</span><span class="n">conf</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
  <span class="n">sudo</span> <span class="n">chown</span> <span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">u</span><span class="p">)</span><span class="o">:</span><span class="err">$</span><span class="p">(</span><span class="n">id</span> <span class="o">-</span><span class="n">g</span><span class="p">)</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="p">.</span><span class="n">kube</span><span class="o">/</span><span class="n">config</span>
</pre></div>


<h2 id="_2">查看部署信息</h2>
<p>可以查看到当前唯一的节点</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">nodes</span>
<span class="n">NAME</span>      <span class="n">STATUS</span>     <span class="n">ROLES</span>     <span class="n">AGE</span>       <span class="n">VERSION</span>
<span class="mi">111</span>       <span class="n">NotReady</span>   <span class="n">master</span>    <span class="mi">3</span><span class="n">m</span>        <span class="n">v1</span><span class="mf">.11.3</span>
</pre></div>


<p>Master节点状态是NotReady，因为KubeletNotReady </p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">describe</span> <span class="n">node</span> <span class="mi">111</span>
</pre></div>


<blockquote>
<p>在condition里面会有这个信息 KubeletNotReady</p>
</blockquote>
<h3 id="pod">查看节点Pod信息</h3>
<p>kube-system是Kubernetes项目预留的系统Pod工作空间(Namespace, 只是Kubernetes 划分不同工作空间的单位)</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">NAME</span>                          <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="mi">46</span><span class="n">p7z</span>      <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>          <span class="mi">43</span><span class="n">m</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="n">scs85</span>      <span class="mi">0</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Pending</span>   <span class="mi">0</span>          <span class="mi">43</span><span class="n">m</span>
<span class="n">etcd</span><span class="o">-</span><span class="mi">111</span>                      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">43</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="mi">111</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">42</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="mi">111</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">43</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">stblp</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">43</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="mi">111</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">42</span><span class="n">m</span>
</pre></div>


<p>这里可以看到CoreDNS等依赖网络的Pod都是pending</p>
<h2 id="_3">部署网络插件</h2>
<h3 id="kubectl-apply">kubectl apply</h3>
<p>部署weave插件</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//git.io/weave-kube-1.6</span>
<span class="n">serviceaccount</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
<span class="n">clusterrole</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
<span class="n">clusterrolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
<span class="n">role</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
<span class="n">rolebinding</span><span class="p">.</span><span class="n">rbac</span><span class="p">.</span><span class="n">authorization</span><span class="p">.</span><span class="n">k8s</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
<span class="n">daemonset</span><span class="p">.</span><span class="n">extensions</span><span class="o">/</span><span class="n">weave</span><span class="o">-</span><span class="n">net</span> <span class="n">created</span>
</pre></div>


<p>这样所有系统的Pod都启动了</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">NAME</span>                          <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="mi">46</span><span class="n">p7z</span>      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">47</span><span class="n">m</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="n">scs85</span>      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">47</span><span class="n">m</span>
<span class="n">etcd</span><span class="o">-</span><span class="mi">111</span>                      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">46</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="mi">111</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">46</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="mi">111</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">46</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">stblp</span>              <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">47</span><span class="n">m</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="mi">111</span>            <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">46</span><span class="n">m</span>
<span class="n">weave</span><span class="o">-</span><span class="n">net</span><span class="o">-</span><span class="n">mkhhs</span>               <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">25</span><span class="n">s</span>
</pre></div>


<h1 id="worker">Worker 节点</h1>
<p>Worker 节点和Master节点几乎是相同的， 运行着都是一个kubelet 组件</p>
<p>唯一区别在kubeadm init的过程中，kubelet 启动后，Master节点上还会自动运行kube-apiserver，kube-scheduler， kube-controller-manager 着三个系统Pod</p>
<h2 id="ubuntu_1">Ubuntu</h2>
<div class="hlcode"><pre><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="o">:</span><span class="c1">//packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span>

<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">list</span>
<span class="n">deb</span> <span class="n">http</span><span class="o">:</span><span class="c1">//apt.kubernetes.io/ kubernetes-xenial main</span>
<span class="n">EOF</span>

<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">update</span>

<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubelet</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubectl</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
<span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">kubeadm</span><span class="o">=</span><span class="mf">1.11.3</span><span class="o">-</span><span class="mo">00</span>
</pre></div>


<h2 id="kubeadm-join">Kubeadm join</h2>
<p>运行master node init之后生成的token指令即可</p>
<h1 id="worker-master">Worker 节点（与Master在一台主机）</h1>
<p>默认Master节点是不允许运行用户的Pod，但可以Kubernetes的Taint/Toleration机制就可以</p>
<p>即某节点被加上一个Taint，那么所有的Pod就不能在这个节点上运行</p>
<p>除非有个别的Pod声明可以容忍这个污点，显式声明Toleration</p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="n">node1</span> <span class="n">foo</span><span class="o">=</span><span class="n">bar</span><span class="o">:</span><span class="n">NoSchedule</span>
</pre></div>


<blockquote>
<p>NoScheduler 意味着Taint只会在调度新Pod时产生作用，不会影响已经在node1上运行的Pod</p>
</blockquote>
<h2 id="pod_1">声明Pod</h2>
<p>为了实现Toleration，需要在Pod的yaml文件中 spec加入tolerations字段即可</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="o">...</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">tolerations</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">key</span><span class="o">:</span> <span class="s2">&quot;foo&quot;</span>
    <span class="n">operator</span><span class="o">:</span> <span class="s2">&quot;Equal&quot;</span>
    <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span>
    <span class="n">effect</span><span class="o">:</span> <span class="s2">&quot;NoSchedule&quot;</span>
</pre></div>


<blockquote>
<p>这个 Toleration 的含义是，这个 Pod 能“容忍”所有键值对为 foo=bar 的 Taint（ operator: “Equal”，“等于”操作）。</p>
</blockquote>
<h2 id="mastertaint">master节点的Taint</h2>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">describe</span> <span class="n">node</span> <span class="mi">111</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">Taints</span>
<span class="nl">Taints:</span>             <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">:</span><span class="n">NoSchedule</span>
</pre></div>


<blockquote>
<p>可以看到，Master 节点默认被加上了node-role.kubernetes.io/master:NoSchedule</p>
<p>这样一个“污点”，其中“键”是node-role.kubernetes.io/master，而没有提供“值”。</p>
</blockquote>
<p>若想要一个单节点的Kubernetes，删除这个Taint即可</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">taint</span> <span class="n">nodes</span> <span class="o">--</span><span class="n">all</span> <span class="n">node</span><span class="o">-</span><span class="n">role</span><span class="p">.</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">master</span><span class="o">-</span>
<span class="n">node</span><span class="o">/</span><span class="mi">111</span> <span class="n">untainted</span>
</pre></div>


<blockquote>
<p>结尾的短线dash表示，移除所有以node-role.kubernetes.io/master为键的taint</p>
</blockquote>
<h2 id="dashboard">Dashboard 可视化插件</h2>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span>
</pre></div>


<p>查看dashboard 对应的pod</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">kube</span><span class="o">-</span><span class="n">system</span>
<span class="n">NAME</span>                                    <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="mi">46</span><span class="n">p7z</span>                <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">coredns</span><span class="o">-</span><span class="mf">78f</span><span class="n">cdf6894</span><span class="o">-</span><span class="n">scs85</span>                <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">etcd</span><span class="o">-</span><span class="mi">111</span>                                <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">-</span><span class="mi">111</span>                      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">controller</span><span class="o">-</span><span class="n">manager</span><span class="o">-</span><span class="mi">111</span>             <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">proxy</span><span class="o">-</span><span class="n">stblp</span>                        <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">kube</span><span class="o">-</span><span class="n">scheduler</span><span class="o">-</span><span class="mi">111</span>                      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">h</span>
<span class="n">kubernetes</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="mi">5</span><span class="n">dd89b9875</span><span class="o">-</span><span class="n">sbct6</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">22</span><span class="n">s</span>
<span class="n">weave</span><span class="o">-</span><span class="n">net</span><span class="o">-</span><span class="n">mkhhs</span>                         <span class="mi">2</span><span class="o">/</span><span class="mi">2</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">44</span><span class="n">m</span>
</pre></div>


<p>需要注意的是，由于 Dashboard 是一个 Web Server，很多人经常会在自己的公有云上无意地暴露 Dashboard 的端口，从而造成安全隐患。所以，1.7 版本之后的 Dashboard 项目部署完成后，默认只能通过 Proxy 的方式在本地访问。具体的操作，你可以查看 Dashboard 项目的文档</p>
<h2 id="_4">容器持久化插件</h2>
<h3 id="_5">持久化</h3>
<p>很多时候我们需要用数据卷（Volume）把外面宿主机上的目录或者文件挂载进容器的 Mount Namespace 中，从而达到容器和宿主机共享这些目录或者文件的目的。容器里的应用，也就可以在这些数据卷中新建和写入文件。</p>
<p>可是，如果你在某一台机器上启动的一个容器，显然无法看到其他机器上的容器在它们的数据卷里写入的文件。</p>
<p>而容器的持久化存储，就是用来保存容器存储状态的重要手段：存储插件会在容器里挂载一个基于网络或者其他机制的远程数据卷，使得在容器里创建的文件，实际上是保存在远程存储服务器上，或者以分布式的方式保存在多个节点上，而与当前宿主机没有任何绑定关系。这样，无论你在其他哪个宿主机上启动新的容器，都可以请求挂载指定的持久化存储卷，从而访问到数据卷里保存的内容。这就是持久化</p>
<p>由于 Kubernetes 本身的松耦合设计，绝大多数存储项目，比如 Ceph、GlusterFS、NFS 等，都可以为 Kubernetes 提供持久化存储能力。在这次选择部署一个很重要的 Kubernetes 存储插件项目：Rook。</p>
<h3 id="rook-no-prod">Rook （No PROD）</h3>
<p>Rook 项目是一个基于 Ceph 的 Kubernetes 存储插件（它后期也在加入对更多存储实现的支持）。不过，不同于对 Ceph 的简单封装，Rook 在自己的实现中加入了水平扩展、迁移、灾难备份、监控等大量的企业级功能，使得这个项目变成了一个完整的、生产级别可用的容器存储插件。</p>
<p>现在rook ceph版本还是beta，不能用于生产环境</p>
<p>得益于容器化技术，用两条指令，Rook 就可以把复杂的 Ceph 存储后端部署起来：</p>
<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/rook/rook/master/cluster/examples/kubernetes/ceph/operator.yaml</span>

<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">https</span><span class="o">:</span><span class="c1">//raw.githubusercontent.com/rook/rook/master/cluster/examples/kubernetes/ceph/cluster.yaml</span>
</pre></div>


<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">rook</span><span class="o">-</span><span class="n">ceph</span>
<span class="n">NAME</span>                               <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">mon</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="mi">6</span><span class="n">c66975</span><span class="o">-</span><span class="mi">5</span><span class="n">kgxt</span>      <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">22</span><span class="n">s</span>
<span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">mon</span><span class="o">-</span><span class="n">b</span><span class="o">-</span><span class="n">b955c6b59</span><span class="o">-</span><span class="mi">9</span><span class="n">r9kk</span>    <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">16</span><span class="n">s</span>
<span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">mon</span><span class="o">-</span><span class="n">c</span><span class="o">-</span><span class="mi">585</span><span class="n">b9dbff9</span><span class="o">-</span><span class="n">h92wq</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">6</span><span class="n">s</span>
<span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span>  <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">n</span> <span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">system</span>
<span class="n">NAME</span>                                  <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">agent</span><span class="o">-</span><span class="n">njf9n</span>                 <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">m</span>
<span class="n">rook</span><span class="o">-</span><span class="n">ceph</span><span class="o">-</span><span class="n">operator</span><span class="o">-</span><span class="mi">5496</span><span class="n">d44d7c</span><span class="o">-</span><span class="n">mgplk</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">m</span>
<span class="n">rook</span><span class="o">-</span><span class="n">discover</span><span class="o">-</span><span class="mi">66</span><span class="n">m7x</span>                   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">1</span><span class="n">m</span>
</pre></div>


<p>这样，一个基于 Rook 持久化存储集群就以容器的方式运行起来了，而接下来在 Kubernetes 项目上创建的所有 Pod 就能够通过 Persistent Volume（PV）和 Persistent Volume Claim（PVC）的方式，在容器里挂载由 Ceph 提供的数据卷了。</p>
<h2 id="nginx">nginx 部署</h2>
<p>nginx-deployment.yaml</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.7</span><span class="o">.</span><span class="mi">9</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
</pre></div>


<div class="hlcode"><pre><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>


<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">nginx</span>
<span class="n">NAME</span>                                <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67594</span><span class="n">d6bf6</span><span class="o">-</span><span class="n">hjgf2</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">18</span><span class="n">s</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">67594</span><span class="n">d6bf6</span><span class="o">-</span><span class="n">xjtlr</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">18</span><span class="n">s</span>
</pre></div>


<div class="hlcode"><pre><span class="nb">root</span><span class="p">@</span><span class="mi">111</span><span class="p">:</span><span class="err">~#</span> <span class="nx">kubectl</span> <span class="nb">describe</span> <span class="nx">pod</span> <span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">67594</span><span class="nx">d6bf6</span><span class="na">-hjgf2</span>
<span class="nb">Name</span><span class="p">:</span>               <span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">67594</span><span class="nx">d6bf6</span><span class="na">-hjgf2</span>
<span class="nx">Namespace</span><span class="p">:</span>          <span class="nb">default</span>
<span class="nx">Priority</span><span class="p">:</span>           <span class="mi">0</span>
<span class="nx">PriorityClassName</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Node</span><span class="p">:</span>               <span class="mi">111</span><span class="p">/</span><span class="nx">178.128.110.131</span>
<span class="nb">Start</span> <span class="nb">Time</span><span class="p">:</span>         <span class="nx">Wed</span><span class="p">,</span> <span class="mi">13</span> <span class="nx">Mar</span> <span class="mi">2019</span> <span class="mi">06</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">14</span> <span class="o">+</span><span class="mi">0000</span>
<span class="nx">Labels</span><span class="p">:</span>             <span class="n">app</span><span class="o">=</span><span class="nx">nginx</span>
                    <span class="nx">pod</span><span class="na">-template-hash</span><span class="o">=</span><span class="mi">2315082692</span>
<span class="nx">Annotations</span><span class="p">:</span>        <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nb">Status</span><span class="p">:</span>             <span class="nb">Running</span>
<span class="nx">IP</span><span class="p">:</span>                 <span class="mf">10.32.0.13</span>
<span class="nx">Controlled</span> <span class="k">By</span><span class="p">:</span>      <span class="nx">ReplicaSet</span><span class="p">/</span><span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">67594</span><span class="nx">d6bf6</span>
<span class="nx">Containers</span><span class="p">:</span>
  <span class="nx">nginx</span><span class="p">:</span>
    <span class="nx">Container</span> <span class="nb">ID</span><span class="p">:</span>   <span class="nx">docker</span><span class="p">:</span><span class="c1">//fab3aadd7695c7505d463decce821d5e40e7cc15a1760375e63b16ef13d5ae77</span>
    <span class="nb">Image</span><span class="p">:</span>          <span class="nx">nginx</span><span class="p">:</span><span class="mf">1.7.9</span>
    <span class="nb">Image</span> <span class="nb">ID</span><span class="p">:</span>       <span class="nx">docker</span><span class="na">-pullable</span><span class="p">:</span><span class="c1">//nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451</span>
    <span class="nb">Port</span><span class="p">:</span>           <span class="mi">80</span><span class="p">/</span><span class="nx">TCP</span>
    <span class="nb">Host</span> <span class="nb">Port</span><span class="p">:</span>      <span class="mi">0</span><span class="p">/</span><span class="nx">TCP</span>
    <span class="nx">State</span><span class="p">:</span>          <span class="nb">Running</span>
      <span class="nx">Started</span><span class="p">:</span>      <span class="nx">Wed</span><span class="p">,</span> <span class="mi">13</span> <span class="nx">Mar</span> <span class="mi">2019</span> <span class="mi">06</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">23</span> <span class="o">+</span><span class="mi">0000</span>
    <span class="nb">Ready</span><span class="p">:</span>          <span class="kc">True</span>
    <span class="nb">Restart</span> <span class="nb">Count</span><span class="p">:</span>  <span class="mi">0</span>
    <span class="nx">Environment</span><span class="p">:</span>    <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
    <span class="nx">Mounts</span><span class="p">:</span>
      <span class="p">/</span><span class="nb">var</span><span class="p">/</span><span class="nb">run</span><span class="p">/</span><span class="nx">secrets</span><span class="p">/</span><span class="nx">kubernetes.io</span><span class="p">/</span><span class="nx">serviceaccount</span> <span class="nb">from</span> <span class="nb">default</span><span class="na">-token-bzv7k</span> <span class="p">(</span><span class="nx">ro</span><span class="p">)</span>
<span class="nx">Conditions</span><span class="p">:</span>
  <span class="k">Type</span>              <span class="nb">Status</span>
  <span class="nx">Initialized</span>       <span class="kc">True</span>
  <span class="nb">Ready</span>             <span class="kc">True</span>
  <span class="nx">ContainersReady</span>   <span class="kc">True</span>
  <span class="nx">PodScheduled</span>      <span class="kc">True</span>
<span class="nx">Volumes</span><span class="p">:</span>
  <span class="nb">default</span><span class="na">-token-bzv7k</span><span class="p">:</span>
    <span class="k">Type</span><span class="p">:</span>        <span class="nx">Secret</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">volume</span> <span class="nx">populated</span> <span class="k">by</span> <span class="nx">a</span> <span class="nx">Secret</span><span class="p">)</span>
    <span class="nx">SecretName</span><span class="p">:</span>  <span class="nb">default</span><span class="na">-token-bzv7k</span>
    <span class="nx">Optional</span><span class="p">:</span>    <span class="kc">false</span>
<span class="nx">QoS</span> <span class="nb">Class</span><span class="p">:</span>       <span class="nx">BestEffort</span>
<span class="nx">Node</span><span class="na">-Selectors</span><span class="p">:</span>  <span class="o">&lt;</span><span class="kc">none</span><span class="o">&gt;</span>
<span class="nx">Tolerations</span><span class="p">:</span>     <span class="nx">node.kubernetes.io</span><span class="p">/</span><span class="nb">not</span><span class="na">-ready</span><span class="p">:</span><span class="nx">NoExecute</span> <span class="nb">for</span> <span class="mi">300</span><span class="nb">s</span>
                 <span class="nx">node.kubernetes.io</span><span class="p">/</span><span class="nx">unreachable</span><span class="p">:</span><span class="nx">NoExecute</span> <span class="nb">for</span> <span class="mi">300</span><span class="nb">s</span>
<span class="nb">Events</span><span class="p">:</span>
  <span class="k">Type</span>    <span class="nx">Reason</span>     <span class="nx">Age</span>   <span class="nb">From</span>               <span class="nx">Message</span>
  <span class="o">----</span>    <span class="o">------</span>     <span class="o">----</span>  <span class="o">----</span>               <span class="o">-------</span>
  <span class="nx">Normal</span>  <span class="nx">Scheduled</span>  <span class="mi">38</span><span class="nb">s</span>   <span class="nb">default</span><span class="na">-scheduler</span>  <span class="nx">Successfully</span> <span class="nx">assigned</span> <span class="nb">default</span><span class="p">/</span><span class="nx">nginx</span><span class="na">-deployment</span><span class="o">-</span><span class="mi">67594</span><span class="nx">d6bf6</span><span class="na">-hjgf2</span> <span class="k">to</span> <span class="mi">111</span>
  <span class="nx">Normal</span>  <span class="nx">Pulling</span>    <span class="mi">37</span><span class="nb">s</span>   <span class="nx">kubelet</span><span class="p">,</span> <span class="mi">111</span>       <span class="nx">pulling</span> <span class="nb">image</span> <span class="s2">&quot;nginx:1.7.9&quot;</span>
  <span class="nx">Normal</span>  <span class="nx">Pulled</span>     <span class="mi">29</span><span class="nb">s</span>   <span class="nx">kubelet</span><span class="p">,</span> <span class="mi">111</span>       <span class="nx">Successfully</span> <span class="nx">pulled</span> <span class="nb">image</span> <span class="s2">&quot;nginx:1.7.9&quot;</span>
  <span class="nx">Normal</span>  <span class="nx">Created</span>    <span class="mi">29</span><span class="nb">s</span>   <span class="nx">kubelet</span><span class="p">,</span> <span class="mi">111</span>       <span class="nx">Created</span> <span class="nx">container</span>
  <span class="nx">Normal</span>  <span class="nx">Started</span>    <span class="mi">29</span><span class="nb">s</span>   <span class="nx">kubelet</span><span class="p">,</span> <span class="mi">111</span>       <span class="nx">Started</span> <span class="nx">container</span>
</pre></div>


<blockquote>
<p>这里的Events信息表示对API对象所有重要操作，都会被记录在这个对象的Events里面</p>
</blockquote>
<h3 id="nginx-18">升级 nginx 1.8</h3>
<div class="hlcode"><pre><span class="p">...</span>    
    <span class="n">spec</span><span class="o">:</span>
      <span class="nl">containers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="nl">image:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.8</span> <span class="err">#</span> <span class="err">这里被从</span> <span class="mf">1.7.9</span> <span class="err">修改为</span> <span class="mf">1.8</span>
        <span class="nl">ports:</span>
      <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
</pre></div>


<p>更新</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span>

<span class="cp"># 修改 nginx-deployment.yaml 的内容</span>

<span class="err">$</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span>
</pre></div>


<h2 id="volume">声明Volume</h2>
<p>仅需要修改yaml文件即可</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span><span class="o">:</span><span class="mf">1.8</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="s2">&quot;/usr/share/nginx/html&quot;</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vol</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vol</span>
        <span class="n">emptyDir</span><span class="o">:</span> <span class="o">{}</span>
</pre></div>


<blockquote>
<p>emptyDir 就是Docker的隐式Volume 参数，即不显式声明宿主机目录的Volume</p>
</blockquote>
<p>Kubernetes会为此在宿主就创建一个临时目录，这个目录将来会被绑定挂载到容器所声明的Volume目录上</p>
<p>若是显式的Volume定义，叫做hostPath</p>
<div class="hlcode"><pre><span class="nl">volumes:</span>
     <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vol</span>
       <span class="nl">hostPath:</span>
         <span class="nl">path:</span> <span class="s">&quot;/home/vagrant/mykube/firstapp/html&quot;</span>
</pre></div>


<p>更新yaml</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">deployment</span><span class="p">.</span><span class="n">apps</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span> <span class="n">configured</span>
</pre></div>


<p>可以看到Volumes 的信息</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">get</span> <span class="n">pods</span>
<span class="n">NAME</span>                                <span class="n">READY</span>     <span class="n">STATUS</span>    <span class="n">RESTARTS</span>   <span class="n">AGE</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">c678cfb6d</span><span class="o">-</span><span class="n">jzknn</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">5</span><span class="n">m</span>
<span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">c678cfb6d</span><span class="o">-</span><span class="n">t785g</span>   <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>       <span class="n">Running</span>   <span class="mi">0</span>          <span class="mi">5</span><span class="n">m</span>


<span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">pod</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">c678cfb6d</span><span class="o">-</span><span class="n">jzknn</span>
<span class="p">....</span>
    <span class="nl">Mounts:</span>
      <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span> <span class="n">from</span> <span class="n">nginx</span><span class="o">-</span><span class="n">vol</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span>
      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span> <span class="n">from</span> <span class="k">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">bzv7k</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>

<span class="nl">Volumes:</span>
  <span class="n">nginx</span><span class="o">-</span><span class="n">vol</span><span class="o">:</span>
    <span class="nl">Type:</span>    <span class="n">EmptyDir</span> <span class="p">(</span><span class="n">a</span> <span class="n">temporary</span> <span class="n">directory</span> <span class="n">that</span> <span class="n">shares</span> <span class="n">a</span> <span class="n">pod</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">lifetime</span><span class="p">)</span>
    <span class="nl">Medium:</span>
</pre></div>


<p>可以切进去查看目录信息</p>
<div class="hlcode"><pre><span class="n">root</span><span class="err">@</span><span class="mi">111</span><span class="o">:~</span><span class="err">#</span> <span class="n">kubectl</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">c678cfb6d</span><span class="o">-</span><span class="n">jzknn</span> <span class="o">--</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="n">root</span><span class="err">@</span><span class="n">nginx</span><span class="o">-</span><span class="n">deployment</span><span class="o">-</span><span class="mi">5</span><span class="n">c678cfb6d</span><span class="o">-</span><span class="n">jzknn</span><span class="o">:/</span><span class="err">#</span> <span class="n">ls</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span>
</pre></div>


<h3 id="volume_1">共享Volume</h3>
<p>nginx-container 读取 debian-container中的index.html</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">two</span><span class="o">-</span><span class="n">containers</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
  <span class="n">volumes</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shared</span><span class="o">-</span><span class="n">data</span>
    <span class="n">hostPath</span><span class="o">:</span>      
      <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">data</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">nginx</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">volumeMounts</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shared</span><span class="o">-</span><span class="n">data</span>
      <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/usr/share/nginx/</span><span class="n">html</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">debian</span><span class="o">-</span><span class="n">container</span>
    <span class="n">image</span><span class="o">:</span> <span class="n">debian</span>
    <span class="n">volumeMounts</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shared</span><span class="o">-</span><span class="n">data</span>
      <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">pod</span><span class="o">-</span><span class="n">data</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;/bin/sh&quot;</span><span class="o">]</span>
    <span class="n">args</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;echo Hello from the debian container &gt; /pod-data/index.html&quot;</span><span class="o">]</span>
</pre></div>


<blockquote>
<p>shared-data 是hostPath类型，而对应在宿主机上的目录就是/data ，而这个目录，其实同时绑定挂载进上述两个容器中</p>
</blockquote>
<h4 id="sidecar">Sidecar 组合</h4>
<p>指在一个Pod中，启动一个辅助容器，完成一些独立与主进程(主容器)之外的工作</p>
<p>这里，Tomcat就是主容器，而initContainer优先运行WAR包容器，扮演了sidecar 角色</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">javaweb</span><span class="o">-</span><span class="mi">2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">initContainers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">geektime</span><span class="o">/</span><span class="n">sample</span><span class="o">:</span><span class="n">v2</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">war</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;cp&quot;</span><span class="o">,</span> <span class="s2">&quot;/sample.war&quot;</span><span class="o">,</span> <span class="s2">&quot;/app&quot;</span><span class="o">]</span>
    <span class="n">volumeMounts</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">app</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">app</span><span class="o">-</span><span class="n">volume</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">geektime</span><span class="o">/</span><span class="n">tomcat</span><span class="o">:</span><span class="mf">7.0</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">tomcat</span>
    <span class="n">command</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;sh&quot;</span><span class="o">,</span><span class="s2">&quot;-c&quot;</span><span class="o">,</span><span class="s2">&quot;/root/apache-tomcat-7.0.42-v2/bin/start.sh&quot;</span><span class="o">]</span>
    <span class="n">volumeMounts</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/root/apache-tomcat-7.0.42-v2/</span><span class="n">webapps</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">app</span><span class="o">-</span><span class="n">volume</span>
    <span class="n">ports</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">8080</span>
      <span class="n">hostPort</span><span class="o">:</span> <span class="mi">8001</span> 
  <span class="n">volumes</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">app</span><span class="o">-</span><span class="n">volume</span>
    <span class="n">emptyDir</span><span class="o">:</span> <span class="o">{}</span>
</pre></div>


<blockquote>
<p>WAR 包容器是一个initContainers，会比所有spec.containers 优先启动，initContainer 容器也会按照顺序启动</p>
<p>通过命令将WAR包复制到/app目录下然后退出</p>
<p>/app 目录挂载了名叫app-volume 的Volume</p>
<p>Tomcat也同样声明挂载了app-volume到自己的/webapps下面</p>
</blockquote>
<h4 id="_6">容器的日志收集</h4>
<p>将实现不断把日志文件输出到容器的/var/log目录中</p>
<p>可以将一个Pod里面的Volume挂载到应用容器的/var/log目录上，然后pod里面运行sidecar容器声明挂载同一个Volume到自己的/var/log目录上</p>
<p>sidecar不断的从自己的/var/log目录中读取日志文件，转发到mongoDB或者ElasticSearch中</p>
<h1 id="mysql">MySQL 主从同步</h1>
<p>Master 节点和 Slave 节点需要有不同的配置文件</p>
<p>使用ConfigMap保存不同的配置文件信息</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
<span class="n">data</span><span class="o">:</span>
  <span class="n">master</span><span class="o">.</span><span class="na">cnf</span><span class="o">:</span> <span class="o">|</span>
    <span class="err">#</span> <span class="err">主节点</span> <span class="n">MySQL</span> <span class="err">的配置文件</span>
    <span class="o">[</span><span class="n">mysqld</span><span class="o">]</span>
    <span class="n">log</span><span class="o">-</span><span class="n">bin</span>
  <span class="n">slave</span><span class="o">.</span><span class="na">cnf</span><span class="o">:</span> <span class="o">|</span>
    <span class="err">#</span> <span class="err">从节点</span> <span class="n">MySQL</span> <span class="err">的配置文件</span>
    <span class="o">[</span><span class="n">mysqld</span><span class="o">]</span>
    <span class="kd">super</span><span class="o">-</span><span class="n">read</span><span class="o">-</span><span class="n">only</span>
</pre></div>


<p>创建两个 Service 来供 StatefulSet 以及用户使用</p>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">3306</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
</pre></div>


<blockquote>
<p>这里clusterIP 是None， 即为一个Headless Service</p>
</blockquote>
<div class="hlcode"><pre><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">read</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">3306</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
</pre></div>


<blockquote>
<p>常规的Service</p>
</blockquote>
<p>InitContainer</p>
<div class="hlcode"><pre>      ...
      # template.spec
      initContainers:
      - name: init-mysql
        image: mysql:5.7
        command:
        - bash
        - &quot;-c&quot;
        - |
          set -ex
          # 从 Pod 的序号，生成 server-id
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=<span class="cp">${</span><span class="n">BASH_REMATCH</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="cp">}</span>
          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf
          # 由于 server-id=0 有特殊含义，我们给 ID 加一个 100 来避开它
          echo server-id=$((100 + <span class="nv">$ordinal</span>)) &gt;&gt; /mnt/conf.d/server-id.cnf
          # 如果 Pod 序号是 0，说明它是 Master 节点，从 ConfigMap 里把 Master 的配置文件拷贝到 /mnt/conf.d/ 目录；
          # 否则，拷贝 Slave 的配置文件
          if [[ <span class="nv">$ordinal</span> -eq 0 ]]; then
            cp /mnt/config-map/master.cnf /mnt/conf.d/
          else
            cp /mnt/config-map/slave.cnf /mnt/conf.d/
          fi
        volumeMounts:
        - name: conf
          mountPath: /mnt/conf.d
        - name: config-map
          mountPath: /mnt/config-map
</pre></div>


<p>第二个InitContainer</p>
<div class="hlcode"><pre>      ...
      # template.spec.initContainers
      - name: clone-mysql
        image: gcr.io/google-samples/xtrabackup:1.0
        command:
        - bash
        - &quot;-c&quot;
        - |
          set -ex
          # 拷贝操作只需要在第一次启动时进行，所以如果数据已经存在，跳过
          [[ -d /var/lib/mysql/mysql ]] <span class="err">&amp;&amp;</span> exit 0
          # Master 节点 (序号为 0) 不需要做这个操作
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=<span class="cp">${</span><span class="n">BASH_REMATCH</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="cp">}</span>
          [[ <span class="nv">$ordinal</span> -eq 0 ]] <span class="err">&amp;&amp;</span> exit 0
          # 使用 ncat 指令，远程地从前一个节点拷贝数据到本地
          ncat --recv-only mysql-$((<span class="nv">$ordinal</span>-1)).mysql 3307 | xbstream -x -C /var/lib/mysql
          # 执行 --prepare，这样拷贝来的数据就可以用作恢复了
          xtrabackup --prepare --target-dir=/var/lib/mysql
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          subPath: mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
</pre></div>


<p>MySQL 容器</p>
<div class="hlcode"><pre>      <span class="p">...</span>
      <span class="err">#</span> <span class="n">template</span><span class="p">.</span><span class="n">spec</span>
      <span class="nl">containers:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
        <span class="nl">image:</span> <span class="n">mysql</span><span class="o">:</span><span class="mf">5.7</span>
        <span class="nl">env:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MYSQL_ALLOW_EMPTY_PASSWORD</span>
          <span class="nl">value:</span> <span class="s">&quot;1&quot;</span>
        <span class="nl">ports:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
          <span class="nl">containerPort:</span> <span class="mi">3306</span>
        <span class="nl">volumeMounts:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">data</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
          <span class="nl">subPath:</span> <span class="n">mysql</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">conf</span>
          <span class="nl">mountPath:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="p">.</span><span class="n">d</span>
        <span class="nl">resources:</span>
          <span class="nl">requests:</span>
            <span class="nl">cpu:</span> <span class="mi">500</span><span class="n">m</span>
            <span class="nl">memory:</span> <span class="mi">1</span><span class="n">Gi</span>
        <span class="nl">livenessProbe:</span>
          <span class="nl">exec:</span>
            <span class="nl">command:</span> <span class="p">[</span><span class="s">&quot;mysqladmin&quot;</span><span class="p">,</span> <span class="s">&quot;ping&quot;</span><span class="p">]</span>
          <span class="nl">initialDelaySeconds:</span> <span class="mi">30</span>
          <span class="nl">periodSeconds:</span> <span class="mi">10</span>
          <span class="nl">timeoutSeconds:</span> <span class="mi">5</span>
        <span class="nl">readinessProbe:</span>
          <span class="nl">exec:</span>
            <span class="err">#</span> <span class="err">通过</span> <span class="n">TCP</span> <span class="err">连接的方式进行健康检查</span>
            <span class="nl">command:</span> <span class="p">[</span><span class="s">&quot;mysql&quot;</span><span class="p">,</span> <span class="s">&quot;-h&quot;</span><span class="p">,</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="s">&quot;-e&quot;</span><span class="p">,</span> <span class="s">&quot;SELECT 1&quot;</span><span class="p">]</span>
          <span class="nl">initialDelaySeconds:</span> <span class="mi">5</span>
          <span class="nl">periodSeconds:</span> <span class="mi">2</span>
          <span class="nl">timeoutSeconds:</span> <span class="mi">1</span>
</pre></div>


<h1 id="faq">FAQ</h1>
<h2 id="token">token 过期</h2>
<p>Kubeadm的token 23小时后过期，所以如果你worker端和master 端不是在同一天做的，有可能会出现如下错误:<br />
[kubelet] Downloading configuration for the kubelet from the "kubelet-config-1.11" ConfigMap in the kube-system namespace<br />
Unauthorized</p>
<p>Stackoverflow上有这个解:<br />
https://stackoverflow.com/questions/52823871/unable-to-join-the-worker-node-to-k8-master-node</p>
<p>简单来说，在master 上重新kubeadm token create一下，替换原来的token 就好了</p>
<p>另外，如果出现<br />
[preflight] Some fatal errors occurred:<br />
        [ERROR FileAvailable--etc-kubernetes-pki-ca.crt]: /etc/kubernetes/pki/ca.crt already exists<br />
        [ERROR FileAvailable--etc-kubernetes-bootstrap-kubelet.conf]: /etc/kubernetes/bootstrap-kubelet.conf already exists<br />
[preflight] If you know what you are doing, you can make a check non-fatal with <code>--ignore-preflight-errors=...</code></p>
<p>把那2个文件mv挪走就好了</p>
<p>如果token过期了，不建议设置ttl=0，使用<code>kubeadm upgrade</code></p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-05-01 20:48:47</p>
      </span>
    </div>

    
    
  </body>
</html>