<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>koa - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Nodejs_modules">Nodejs_modules</a>&nbsp;&#187;&nbsp;koa
    <span class="updated">Page Updated&nbsp;
      2018-08-01 16:34
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">koa</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#koa">koa框架</a><ul>
<li><a href="#koa_1">安装koa</a><ul>
<li><a href="#npm">npm</a></li>
<li><a href="#packagejson">package.json</a></li>
</ul>
</li>
<li><a href="#koa_2">使用Koa</a><ul>
<li><a href="#http">最基本http页面</a></li>
<li><a href="#context">含context的页面</a></li>
<li><a href="#http-response">HTTP Response 的类型</a></li>
<li><a href="#_1">网页模板</a></li>
<li><a href="#_2">路由</a><ul>
<li><a href="#koa-route">koa-route 模块</a></li>
<li><a href="#koa-router">koa-router</a></li>
</ul>
</li>
<li><a href="#_3">静态资源</a></li>
<li><a href="#_4">重定向</a></li>
</ul>
</li>
<li><a href="#_5">中间件</a><ul>
<li><a href="#_6">中间件实现</a></li>
<li><a href="#_7">中间件栈</a></li>
<li><a href="#_8"></a></li>
<li><a href="#_9">异步中间件</a></li>
<li><a href="#_10">中间件的合成</a></li>
</ul>
</li>
<li><a href="#_11">错误处理</a><ul>
<li><a href="#500-error">500 error</a></li>
<li><a href="#404-error">404 error</a></li>
<li><a href="#_12">处理错误的中间件</a></li>
<li><a href="#error">error 事件的监听</a></li>
<li><a href="#error_1">释放 error 事件</a></li>
</ul>
</li>
<li><a href="#web-app">Web App 的功能</a><ul>
<li><a href="#cookies">Cookies</a></li>
<li><a href="#_13">表单</a></li>
<li><a href="#failed-verification">文件上传 (failed verification)</a></li>
</ul>
</li>
<li><a href="#nunjucks">Nunjucks 模板引擎</a><ul>
<li><a href="#_14">模板引擎工程</a></li>
<li><a href="#mvc">MVC</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="koa">koa框架</h1>
<p>koa是Express的下一代基于Node.js的web框架，目前有1.x和2.0两个版本。</p>
<p>出于兼容性考虑，目前koa2仍支持generator的写法，但下一个版本将会去掉。</p>
<h2 id="koa_1">安装koa</h2>
<p>Koa 必须使用 7.6 以上的版本。如果你的版本低于这个要求，就要先升级 Node。</p>
<h3 id="npm">npm</h3>
<p><code>npm install koa@2.0.0</code></p>
<h3 id="packagejson">package.json</h3>
<p>目录下创建一个<code>package.json</code>，这个文件描述了我们的<code>hello-koa</code>工程会用到哪些包。完整的文件内容如下：</p>
<div class="hlcode"><pre><span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;hello-koa2&quot;</span><span class="o">,</span>
    <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="o">,</span>
    <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Hello Koa 2 example with async&quot;</span><span class="o">,</span>
    <span class="s2">&quot;main&quot;</span><span class="o">:</span> <span class="s2">&quot;app.js&quot;</span><span class="o">,</span>
    <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="err">{</span>
        <span class="s2">&quot;start&quot;</span><span class="o">:</span> <span class="s2">&quot;node app.js&quot;</span>
    <span class="p">}</span><span class="o">,</span>
    <span class="s2">&quot;keywords&quot;</span><span class="o">:</span> <span class="cp">[</span>
        <span class="s2">&quot;koa&quot;</span><span class="p">,</span>
        <span class="s2">&quot;async&quot;</span>
    <span class="cp">]</span><span class="o">,</span>
    <span class="s2">&quot;author&quot;</span><span class="o">:</span> <span class="s2">&quot;Michael Liao&quot;</span><span class="o">,</span>
    <span class="s2">&quot;license&quot;</span><span class="o">:</span> <span class="s2">&quot;Apache-2.0&quot;</span><span class="o">,</span>
    <span class="s2">&quot;repository&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;git&quot;</span><span class="o">,</span>
        <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;https://github.com/michaelliao/learn-javascript.git&quot;</span>
    <span class="p">}</span><span class="o">,</span>
    <span class="s2">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;koa&quot;</span><span class="o">:</span> <span class="s2">&quot;2.0.0&quot;</span>
    <span class="p">}</span>
<span class="err">}</span>
</pre></div>


<p>其中，<code>dependencies</code>描述了我们的工程依赖的包以及版本号。其他字段均用来描述项目信息，可任意填写。</p>
<p>然后，我们在<code>hello-koa</code>目录下执行<code>npm install</code>就可以把所需包以及依赖包一次性全部装好：</p>
<div class="hlcode"><pre><span class="nl">C:</span><span class="err">\</span><span class="p">...</span><span class="err">\</span><span class="n">hello</span><span class="o">-</span><span class="n">koa</span><span class="o">&gt;</span> <span class="n">npm</span> <span class="n">install</span>
</pre></div>


<h2 id="koa_2">使用Koa</h2>
<h3 id="http">最基本http页面</h3>
<p>http_testing.js</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<div class="hlcode"><pre><span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span> <span class="err">运行</span>
</pre></div>


<h3 id="context">含context的页面</h3>
<p>Koa 提供一个 Context 对象，表示一次对话的上下文（包括 HTTP 请求和 HTTP 回复）。通过加工这个对象，就可以控制返回给用户的内容。</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Hello</span> <span class="n">World</span><span class="err">&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<h3 id="http-response">HTTP Response 的类型</h3>
<p>Koa 默认的返回类型是<code>text/plain</code>，如果想返回其他类型的内容，可以先用<code>ctx.request.accepts</code>判断一下，客户端希望接受什么数据（根据 HTTP Request 的<code>Accept</code>字段），然后使用<code>ctx.response.type</code>指定返回类型。</p>
<div class="hlcode"><pre><span class="nx">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="k">require</span><span class="err">(&#39;</span><span class="n">koa</span><span class="s1">&#39;);</span>

<span class="s1">const app = new Koa();</span>

<span class="s1">const main = ctx =&gt; {</span>
<span class="s1">    if (ctx.request.accepts(&#39;</span><span class="kt">xml</span><span class="s1">&#39;)) {</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="kt">xml</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="o">&lt;</span><span class="kd">data</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">World</span><span class="o">&lt;/</span><span class="kd">data</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">    } else if (ctx.request.accepts(&#39;</span><span class="nx">json</span><span class="s1">&#39;)) {</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="nx">json</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = {data: &#39;</span><span class="nx">Hello</span> <span class="nx">World</span><span class="s1">&#39;};</span>
<span class="s1">    } else if (ctx.request.accepts(&#39;</span><span class="nx">html</span><span class="s1">&#39;)) {</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="nx">html</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Hello</span> <span class="nx">World</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">    } else {</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="nx">text</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="nx">Hello</span> <span class="nx">World</span><span class="s1">&#39;;</span>
<span class="s1">    }</span>
<span class="s1">}</span>

<span class="s1">app.use(main);</span>
<span class="s1">app.listen(3000);</span>
</pre></div>


<p>这样会返回一个xml文档</p>
<p><img alt="img" src="/var/folders/rz/7zd4wvf90070rc96bxfc_xf13wzxml/T/abnerworks.Typora/image-20180802114918884.png" /></p>
<h3 id="_1">网页模板</h3>
<p>实际开发中，返回给用户的网页往往都写成模板文件。我们可以让 Koa 先读取模板文件，然后将这个模板返回给用户</p>
<p>./demos/template.html</p>
<div class="hlcode"><pre><span class="cp">&lt;!doctype html&gt;</span>

<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;title&gt;</span>The HTML5 Herald<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;HTML5 Template&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;author&quot;</span> <span class="na">content=</span><span class="s">&quot;xxx&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Hello World<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>http_testing.js</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">fs</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">html</span><span class="err">&#39;</span><span class="p">;</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">fs</span><span class="p">.</span><span class="n">createReadStream</span><span class="p">(</span><span class="err">&#39;</span><span class="p">.</span><span class="o">/</span><span class="n">demos</span><span class="o">/</span><span class="n">template</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<h3 id="_2">路由</h3>
<p>网站一般都有多个页面。通过<code>ctx.request.path</code>可以获取用户请求的路径，由此实现简单的路由。</p>
<div class="hlcode"><pre><span class="nx">const</span> <span class="n">fs</span> <span class="o">=</span> <span class="k">require</span><span class="err">(&#39;</span><span class="n">fs</span><span class="s1">&#39;);</span>
<span class="s1">const Koa = require(&#39;</span><span class="nx">koa</span><span class="s1">&#39;);</span>
<span class="s1">const app = new Koa();</span>

<span class="s1">const main = ctx =&gt; {</span>
<span class="s1">    if (ctx.request.path !== &#39;</span><span class="o">/</span><span class="s1">&#39;) {</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="nx">html</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="o">&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="o">&gt;</span><span class="nb">Index</span> <span class="nx">Page</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">    } else {</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="nx">Hello</span> <span class="nx">World</span><span class="s1">&#39;;</span>
<span class="s1">    }</span>
<span class="s1">};</span>

<span class="s1">app.use(main);</span>
<span class="s1">app.listen(3000);</span>
</pre></div>


<p>访问其他URL会显示index page， 并可以跳转</p>
<p><img alt="img" src="https://cdn.pbrd.co/images/HxgdMnb.png" /></p>
<h4 id="koa-route">koa-route 模块</h4>
<p>启用package.json, 安装koa-route</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>根路径<code>/</code>的处理函数是<code>main</code>，<code>/about</code>路径的处理函数是<code>about</code></p>
<div class="hlcode"><pre><span class="nx">const</span> <span class="n">fs</span> <span class="o">=</span> <span class="k">require</span><span class="err">(&#39;</span><span class="n">fs</span><span class="s1">&#39;);</span>
<span class="s1">const Koa = require(&#39;</span><span class="nx">koa</span><span class="s1">&#39;);</span>
<span class="s1">const app = new Koa();</span>
<span class="s1">const route = require(&#39;</span><span class="nx">koa</span><span class="na">-route</span><span class="s1">&#39;);</span>

<span class="s1">const about = ctx =&gt; {</span>
<span class="s1">    ctx.response.type = &#39;</span><span class="nx">html</span><span class="s1">&#39;;</span>
<span class="s1">    ctx.response.body = &#39;</span><span class="o">&lt;</span><span class="nx">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="o">&gt;</span><span class="nb">Index</span> <span class="nx">Page</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">};</span>

<span class="s1">const main = ctx =&gt; {</span>
<span class="s1">    ctx.response.body = &quot;Hello World&quot;;</span>
<span class="s1">}</span>

<span class="s1">app.use(route.get(&#39;</span><span class="o">/</span><span class="s1">&#39;, main));</span>
<span class="s1">app.use(route.get(&#39;</span><span class="p">/</span><span class="nx">about</span><span class="s1">&#39;, about));</span>

<span class="s1">app.listen(3000);</span>
</pre></div>


<h4 id="koa-router">koa-router</h4>
<p>为了处理URL，我们需要引入<code>koa-router</code>这个middleware，让它负责处理URL映射。</p>
<p>我们把上一节的<code>hello-koa</code>工程复制一份，重命名为<code>url-koa</code>。</p>
<p>先在<code>package.json</code>中添加依赖项：</p>
<div class="hlcode"><pre><span class="s">&quot;koa-router&quot;</span><span class="o">:</span> <span class="s">&quot;7.0.0&quot;</span>
</pre></div>


<p>然后用<code>npm install</code>安装。</p>
<p>接下来，我们修改<code>app.js</code>，使用<code>koa-router</code>来处理URL：</p>
<div class="hlcode"><pre>const Koa = require(&#39;koa&#39;);

// 注意require(&#39;koa-router&#39;)返回的是函数:
const router = require(&#39;koa-router&#39;)();

const app = new Koa();

// log request URL:
app.use(async (ctx, next) =&gt; {
    console.log(`Process <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="cp">}</span> <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="cp">}</span>...`);
    await next();
});

// add url-route:
router.get(&#39;/hello/:name&#39;, async (ctx, next) =&gt; {
    var name = ctx.params.name;
    ctx.response.body = `<span class="nt">&lt;h1&gt;</span>Hello, <span class="cp">${</span><span class="n">name</span><span class="cp">}</span>!<span class="nt">&lt;/h1&gt;</span>`;
});

router.get(&#39;/&#39;, async (ctx, next) =&gt; {
    ctx.response.body = &#39;<span class="nt">&lt;h1&gt;</span>Index<span class="nt">&lt;/h1&gt;</span>&#39;;
});

// add router middleware:
app.use(router.routes());

app.listen(3000);
console.log(&#39;app started at port 3000...&#39;);
</pre></div>


<p>注意导入<code>koa-router</code>的语句最后的<code>()</code>是函数调用：</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">router</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="o">-</span><span class="n">router</span><span class="err">&#39;</span><span class="p">)();</span>
</pre></div>


<p>相当于：</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">fn_router</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="o">-</span><span class="n">router</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">router</span> <span class="o">=</span> <span class="n">fn_router</span><span class="p">();</span>
</pre></div>


<p>然后，我们使用<code>router.get('/path', async fn)</code>来注册一个GET请求。可以在请求路径中使用带变量的<code>/hello/:name</code>，变量可以通过<code>ctx.params.name</code>访问。</p>
<p>再运行<code>app.js</code>，我们就可以测试不同的URL：</p>
<p>输入首页：<a href="http://localhost:3000/">http://localhost:3000/</a></p>
<h3 id="_3">静态资源</h3>
<p>如果网站提供静态资源（图片、字体、样式表、脚本......），为它们一个个写路由就很麻烦，也没必要。<a href="https://www.npmjs.com/package/koa-static"><code>koa-static</code></a>模块封装了这部分的请求。</p>
<p>package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="k">const</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">fs</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>
<span class="k">const</span> <span class="n">route</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="o">-</span><span class="n">router</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">path</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">path</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">serve</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="o">-</span><span class="k">static</span><span class="err">&#39;</span><span class="p">);</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">serve</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">));</span>
<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p><img alt="img" src="https://cdn.pbrd.co/images/Hxh7ObeS.png" /></p>
<h3 id="_4">重定向</h3>
<p>有些场合，服务器需要重定向（redirect）访问请求。比如，用户登陆以后，将他重定向到登陆前的页面。<code>ctx.response.redirect()</code>方法可以发出一个302跳转，将用户导向另一个路由。</p>
<p>package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">route</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="o">-</span><span class="n">route</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">redirect</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">redirect</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">Hello</span> <span class="n">World</span><span class="err">&#39;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">,</span> <span class="n">main</span><span class="p">));</span>
<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="o">/</span><span class="n">redirect</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">redirect</span><span class="p">));</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000/redirect ，浏览器会将用户导向根路由</p>
<h2 id="_5">中间件</h2>
<p>Koa 的最大特色，也是最重要的一个设计，就是中间件（middleware）。</p>
<h3 id="_6">中间件实现</h3>
<div class="hlcode"><pre><span class="nf">app.use</span><span class="p">(</span><span class="na">async</span> <span class="p">(</span><span class="na">ctx</span><span class="p">,</span> <span class="na">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">await</span> <span class="nb">next</span><span class="p">();</span>
    <span class="n">ctx.response.type</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span><span class="p">;</span>
    <span class="n">ctx.response.body</span> <span class="o">=</span> <span class="s1">&#39;&lt;h1&gt;Hello, koa2!&lt;/h1&gt;&#39;</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>


<p>koa把很多async函数组成一个处理链，每个async函数都可以做一些自己的事情，然后用<code>await next()</code>来调用下一个async函数。我们把每个async函数称为middleware</p>
<p>如果一个middleware没有调用<code>await next()</code>，会怎么办？答案是后续的middleware将不再执行了。这种情况也很常见，例如，一个检测用户权限的middleware可以决定是否继续处理请求，还是直接返回403错误：</p>
<div class="hlcode"><pre><span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">await</span> <span class="n">checkUserPermission</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">await</span> <span class="n">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">403</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<div class="hlcode"><pre>const Koa = require(&#39;koa&#39;);
const route = require(&#39;koa-route&#39;);
const app = new Koa();

const logger = (ctx, next) =&gt; {
    console.log(`<span class="cp">${</span><span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="cp">}</span> <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="cp">}</span> <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="cp">}</span>`);
};

app.use(logger);
app.listen(3000);
</pre></div>


<p>访问 http://127.0.0.1:3000 ，命令行窗口会显示与上一个例子相同的日志输出。</p>
<div class="hlcode"><pre><span class="n">xhxu</span><span class="o">-</span><span class="n">mac</span><span class="o">:</span><span class="n">koa_ruanyifeng</span> <span class="n">xhxu</span><span class="err">$</span> <span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span>
<span class="mi">1533203867128</span> <span class="n">GET</span> <span class="o">/</span>
</pre></div>


<h3 id="_7">中间件栈</h3>
<p>多个中间件会形成一个栈结构（middle stack），以"先进后出"（first-in-last-out）的顺序执行。</p>
<div class="hlcode"><pre><span class="err">最外层的中间件首先执行。</span>
<span class="err">调用</span><span class="n">next</span><span class="err">函数，把执行权交给下一个中间件。</span>
<span class="p">...</span>
<span class="err">最内层的中间件最后执行。</span>
<span class="err">执行结束后，把执行权交回上一层的中间件。</span>
<span class="p">...</span>
<span class="err">最外层的中间件收回执行权之后，执行</span><span class="n">next</span><span class="err">函数后面的代码。</span>
</pre></div>


<div class="hlcode"><pre><span class="n">xhxu</span><span class="o">-</span><span class="n">mac</span><span class="o">:</span><span class="n">koa_ruanyifeng</span> <span class="n">xhxu</span><span class="err">$</span> <span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span>
<span class="o">&gt;&gt;</span> <span class="n">one</span>
<span class="o">&gt;&gt;</span> <span class="n">two</span>
<span class="o">&gt;&gt;</span> <span class="n">three</span>
<span class="o">&lt;&lt;</span> <span class="n">three</span>
<span class="o">&lt;&lt;</span> <span class="n">two</span>
<span class="o">&lt;&lt;</span> <span class="n">one</span>
</pre></div>


<h3 id="_8"></h3>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span><span class="o">=</span><span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span><span class="o">=</span><span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>
<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第一</span><span class="mi">1</span><span class="err">&#39;</span><span class="p">);</span>
    <span class="n">await</span> <span class="nf">next</span><span class="p">();</span> <span class="c1">// 调用下一个middleware</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第一</span><span class="mi">2</span><span class="err">&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第二</span><span class="mi">1</span><span class="err">&#39;</span><span class="p">);</span>
    <span class="n">await</span> <span class="nf">next</span><span class="p">();</span> <span class="c1">// 调用下一个middleware</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第二</span><span class="mi">2</span><span class="err">&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第三</span><span class="mi">1</span><span class="err">&#39;</span><span class="p">);</span>
    <span class="n">await</span> <span class="nf">next</span><span class="p">();</span>
    <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="err">&#39;第三</span><span class="mi">2</span><span class="err">&#39;</span><span class="p">);</span>
<span class="p">});</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="err">第一</span><span class="mi">1</span>
<span class="err">第二</span><span class="mi">1</span>
<span class="err">第三</span><span class="mi">1</span>
<span class="err">第三</span><span class="mi">2</span>
<span class="err">第二</span><span class="mi">2</span>
<span class="err">第一</span><span class="mi">2</span>
</pre></div>


<p>如果中间件内部没有调用<code>next</code>函数，那么执行权就不会传递下去。<code>two</code>函数里面<code>next()</code>这一行注释掉再执行结果</p>
<div class="hlcode"><pre><span class="n">xhxu</span><span class="o">-</span><span class="n">mac</span><span class="o">:</span><span class="n">koa_ruanyifeng</span> <span class="n">xhxu</span><span class="err">$</span> <span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span>
<span class="o">&gt;&gt;</span> <span class="n">one</span>
<span class="o">&gt;&gt;</span> <span class="n">two</span>
<span class="o">&lt;&lt;</span> <span class="n">two</span>
<span class="o">&lt;&lt;</span> <span class="n">one</span>
</pre></div>


<h3 id="_9">异步中间件</h3>
<p>如果有异步操作（比如读取数据库），中间件就必须写成 <a href="http://es6.ruanyifeng.com/#docs/async">async 函数</a></p>
<p>package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span><span class="p">,</span> 
    <span class="s">&quot;fs&quot;</span><span class="o">:</span> <span class="s">&quot;^0.0.1-security&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="kr">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-route&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs.promised&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;html&#39;</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./demos/template.html&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p><img alt="img" src="https://cdn.pbrd.co/images/HxidP57.png" /></p>
<h3 id="_10">中间件的合成</h3>
<p><a href="https://www.npmjs.com/package/koa-compose"><code>koa-compose</code></a>模块可以将多个中间件合成为一个</p>
<p>Package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;fs.promised&quot;</span><span class="o">:</span> <span class="s">&quot;^3.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-compose&quot;</span><span class="o">:</span> <span class="s">&quot;^4.1.0&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre>const Koa = require(&#39;koa&#39;);
const app = new Koa();
const compose = require(&#39;koa-compose&#39;);

const logger = (ctx, next) =&gt; {
    console.log(`<span class="cp">${</span><span class="n">Date</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="cp">}</span> <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="cp">}</span> <span class="cp">${</span><span class="n">ctx</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="cp">}</span>`);
};

const main = ctx =&gt; {
    ctx.response.body = &#39;Hello World&#39;;
};

const middlewares = compose([logger, main]);

app.use(main);
app.listen(3000);
</pre></div>


<p>访问 http://127.0.0.1:3000 ，就可以在命令行窗口看到日志信息</p>
<div class="hlcode"><pre><span class="n">xhxu</span><span class="o">-</span><span class="n">mac</span><span class="o">:</span><span class="n">koa_ruanyifeng</span> <span class="n">xhxu</span><span class="err">$</span> <span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span>
<span class="mi">1533206455183</span> <span class="n">GET</span> <span class="o">/</span>
</pre></div>


<h2 id="_11">错误处理</h2>
<h3 id="500-error">500 error</h3>
<p>如果代码运行过程中发生错误，我们需要把错误信息返回给用户。HTTP 协定约定这时要返回500状态码。Koa 提供了<code>ctx.throw()</code>方法，用来抛出错误，<code>ctx.throw(500)</code>就是抛出500错误。</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">throw</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000，你会看到一个500错误页"Internal Server Error"</p>
<div class="hlcode"><pre><span class="n">xhxu</span><span class="o">-</span><span class="n">mac</span><span class="o">:</span><span class="n">koa_ruanyifeng</span> <span class="n">xhxu</span><span class="err">$</span> <span class="n">node</span> <span class="n">http_testing</span><span class="p">.</span><span class="n">js</span>

  <span class="nl">InternalServerError:</span> <span class="n">Internal</span> <span class="n">Server</span> <span class="n">Error</span>
</pre></div>


<h3 id="404-error">404 error</h3>
<p>如果将<code>ctx.response.status</code>设置成404，就相当于<code>ctx.throw(404)</code>，返回404错误。</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">404</span><span class="p">;</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&quot;Page Not Found&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000 ，你就看到一个404页面"Page Not Found"。</p>
<p><img alt="img" src="https://cdn.pbrd.co/images/Hxiph8p.png" /></p>
<h3 id="_12">处理错误的中间件</h3>
<p>为了方便处理错误，最好使用<code>try...catch</code>将其捕获。但是，为每个中间件都写<code>try...catch</code>太麻烦，我们可以让最外层的中间件，负责所有中间件的错误处理。</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="n">await</span> <span class="n">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">err</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">||</span> <span class="n">err</span><span class="p">.</span><span class="n">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">;</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nl">message:</span> <span class="n">err</span><span class="p">.</span><span class="n">message</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">throw</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000 ，你会看到一个500页，里面有报错提示 <code>{"message":"Internal Server Error"}</code></p>
<p><img alt="img" src="https://cdn.pbrd.co/images/HxirnEC.png" /></p>
<h3 id="error">error 事件的监听</h3>
<p>运行过程中一旦出错，Koa 会触发一个<code>error</code>事件。监听这个事件，也可以处理错误。</p>
<div class="hlcode"><pre><span class="k">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="err">&#39;</span><span class="n">koa</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">const</span> <span class="n">app</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Koa</span><span class="p">();</span>

<span class="k">const</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">async</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="n">await</span> <span class="n">next</span><span class="p">();</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">err</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">||</span> <span class="n">err</span><span class="p">.</span><span class="n">status</span> <span class="o">||</span> <span class="mi">500</span><span class="p">;</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nl">message:</span> <span class="n">err</span><span class="p">.</span><span class="n">message</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">const</span> <span class="n">main</span> <span class="o">=</span> <span class="n">ctx</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">throw</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">use</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000 ，你会在命令行窗口看到"server error xxx"</p>
<h3 id="error_1">释放 error 事件</h3>
<p>如果错误被<code>try...catch</code>捕获，就不会触发<code>error</code>事件。这时，必须调用<code>ctx.app.emit()</code>，手动释放<code>error</code>事件，才能让监听函数生效。</p>
<div class="hlcode"><pre><span class="nx">const</span> <span class="n">Koa</span> <span class="o">=</span> <span class="k">require</span><span class="err">(&#39;</span><span class="n">koa</span><span class="s1">&#39;);</span>
<span class="s1">const app = new Koa();</span>

<span class="s1">const handler = async (ctx, next) =&gt; {</span>
<span class="s1">    try {</span>
<span class="s1">        await next();</span>
<span class="s1">    } catch (err) {</span>
<span class="s1">        ctx.response.status = err.statusCode || err.status || 500;</span>
<span class="s1">        ctx.response.type = &#39;</span><span class="nx">html</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.response.body = &#39;</span><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Something</span> <span class="nx">wrong</span><span class="p">,</span> <span class="nx">please</span> <span class="nx">contact</span> <span class="nx">adminstrator.</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span><span class="s1">&#39;;</span>
<span class="s1">        ctx.app.emit(&#39;</span><span class="nb">error</span><span class="s1">&#39;, err, ctx);</span>
<span class="s1">    }</span>
<span class="s1">};</span>

<span class="s1">const main = ctx =&gt; {</span>
<span class="s1">    ctx.throw(500);</span>
<span class="s1">};</span>

<span class="s1">app.on(&#39;</span><span class="nb">error</span><span class="s1">&#39;, function (err) {</span>
<span class="s1">    console.log(&#39;</span><span class="nx">logging</span> <span class="nb">error</span><span class="s1">&#39;, err.message);</span>
<span class="s1">    console.log(err);</span>
<span class="s1">});</span>

<span class="s1">app.use(handler);</span>
<span class="s1">app.use(main);</span>
<span class="s1">app.listen(3000);</span>
</pre></div>


<blockquote>
<p><code>main</code>函数抛出错误，被<code>handler</code>函数捕获。<code>catch</code>代码块里面使用<code>ctx.app.emit()</code>手动释放<code>error</code>事件，才能让监听函数监听到。</p>
</blockquote>
<p>http://127.0.0.1:3000 ，你会在命令行窗口看到<code>logging error</code></p>
<h2 id="web-app">Web App 的功能</h2>
<h3 id="cookies">Cookies</h3>
<p><code>ctx.cookies</code>用来读写 Cookie。</p>
<div class="hlcode"><pre><span class="kr">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">n</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">&#39;views&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>访问 http://127.0.0.1:3000 ，你会看到<code>1 views</code>。刷新一次页面，就变成了<code>2 views</code>。再刷新，每次都会计数增加1</p>
<h3 id="_13">表单</h3>
<p>Web 应用离不开处理表单。本质上，表单就是 POST 方法发送到服务器的键值对。<a href="https://www.npmjs.com/package/koa-body"><code>koa-body</code></a>模块可以用来从 POST 请求的数据体里面提取键值对。</p>
<p>package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;fs.promised&quot;</span><span class="o">:</span> <span class="s">&quot;^3.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-compose&quot;</span><span class="o">:</span> <span class="s">&quot;^4.1.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-body&quot;</span><span class="o">:</span> <span class="s">&quot;^4.0.4&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="kr">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-body&#39;</span><span class="p">);</span>


<span class="kr">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;.name required&#39;</span><span class="p">);</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">};</span>
<span class="p">}</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">koaBody</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>打开另一个命令行窗口，运行下面的命令。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">--</span><span class="n">data</span> <span class="s">&quot;name=Jack&quot;</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">3000</span>
<span class="p">{</span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="s">&quot;Jack&quot;</span><span class="p">}</span>

<span class="err">$</span> <span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">POST</span> <span class="o">--</span><span class="n">data</span> <span class="s">&quot;name&quot;</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">3000</span>
<span class="n">name</span> <span class="n">required</span>
</pre></div>


<blockquote>
<p>代码使用 POST 方法向服务器发送一个键值对，会被正确解析。如果发送的数据不正确，就会收到错误提示。</p>
</blockquote>
<h3 id="failed-verification">文件上传 (failed verification)</h3>
<p><a href="https://www.npmjs.com/package/koa-body"><code>koa-body</code></a>模块还可以用来处理文件上传。</p>
<p>package.json</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;koa_ruanyifeng&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;fs&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1-security&quot;</span><span class="p">,</span>
    <span class="s">&quot;fs.promised&quot;</span><span class="o">:</span> <span class="s">&quot;^3.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-body&quot;</span><span class="o">:</span> <span class="s">&quot;^4.0.4&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-compose&quot;</span><span class="o">:</span> <span class="s">&quot;^4.1.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-route&quot;</span><span class="o">:</span> <span class="s">&quot;^3.2.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;koa-static&quot;</span><span class="o">:</span> <span class="s">&quot;^5.0.0&quot;</span><span class="p">,</span>
    <span class="s">&quot;os&quot;</span><span class="o">:</span> <span class="s">&quot;^0.1.1&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<div class="hlcode"><pre><span class="kr">const</span> <span class="nx">os</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">koaBody</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;koa-body&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">main</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">tmpdir</span> <span class="o">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">tmpdir</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">filePaths</span> <span class="o">=</span> <span class="cp">[]</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">files</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">files</span><span class="cp">[</span><span class="nb">key</span><span class="cp">]</span><span class="p">;</span>
        <span class="kr">const</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">tmpdir</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createReadStream</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
        <span class="kr">const</span> <span class="nx">writer</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
        <span class="nx">reader</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">writer</span><span class="p">);</span>
        <span class="nx">filePaths</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">ctx</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">filePaths</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">koaBody</span><span class="p">({</span> <span class="nx">multipart</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>打开另一个命令行窗口，运行下面的命令，上传一个文件。注意，<code>/path/to/file</code>要更换为真实的文件路径。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">curl</span> <span class="o">--</span><span class="n">form</span> <span class="n">upload</span><span class="o">=</span><span class="err">@</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">file</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:3000</span>
<span class="p">[</span><span class="s">&quot;/tmp/file&quot;</span><span class="p">]</span>
</pre></div>


<h2 id="nunjucks">Nunjucks 模板引擎</h2>
<p>Nunjucks是Mozilla开发的一个纯JavaScript编写的模板引擎，既可以用在Node环境下，又可以运行在浏览器端。但是，主要还是运行在Node环境下，因为浏览器端有更好的模板解决方案，例如MVVM框架。</p>
<p>模板引擎就是基于模板配合数据构造出字符串输出的一个组件。比如下面的函数就是一个模板引擎：</p>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">examResult</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="err">`</span><span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="err">同学一年级期末考试语文</span><span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">chinese</span><span class="p">}</span><span class="err">分，数学</span><span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">math</span><span class="p">}</span><span class="err">分，位于年级第</span><span class="nx">$</span><span class="p">{</span><span class="nx">data</span><span class="p">.</span><span class="nx">ranking</span><span class="p">}</span><span class="err">名。`</span>
<span class="p">}</span>
</pre></div>


<p>如果我们输入数据如下：</p>
<div class="hlcode"><pre><span class="n">examResult</span><span class="p">({</span>
    <span class="nl">name:</span> <span class="err">&#39;小明&#39;</span><span class="p">,</span>
    <span class="nl">chinese:</span> <span class="mi">78</span><span class="p">,</span>
    <span class="nl">math:</span> <span class="mi">87</span><span class="p">,</span>
    <span class="nl">ranking:</span> <span class="mi">999</span>
<span class="p">});</span>
</pre></div>


<p>该模板引擎把模板字符串里面对应的变量替换以后，就可以得到以下输出：</p>
<div class="hlcode"><pre><span class="err">小明同学一年级期末考试语文</span><span class="mi">78</span><span class="err">分，数学</span><span class="mi">87</span><span class="err">分，位于年级第</span><span class="mi">999</span><span class="err">名。</span>
</pre></div>


<p>一个模板引擎是非常简单的，因为本质上我们只需要构造这样一个函数：</p>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">render</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// TODO:...</span>
<span class="p">}</span>
</pre></div>


<p>其中，<code>view</code>是模板的名称（又称为视图），因为可能存在多个模板，需要选择其中一个。<code>model</code>就是数据，在JavaScript中，它就是一个简单的Object。<code>render</code>函数返回一个字符串，就是模板的输出。</p>
<h3 id="_14">模板引擎工程</h3>
<p><code>use-nunjucks</code>的VS Code工程结构如下：</p>
<div class="hlcode"><pre>use<span class="o">-</span>nunjucks<span class="o">/</span>
<span class="o">|</span>
<span class="o">+-</span> .vscode<span class="o">/</span>
<span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span>  <span class="o">+-</span> launch.json <span class="o">&lt;--</span> VSCode 配置文件
<span class="o">|</span>
<span class="o">+-</span> views<span class="o">/</span>
<span class="o">|</span>  <span class="o">|</span>
<span class="o">|</span>  <span class="o">+-</span> hello.html <span class="o">&lt;--</span> HTML模板文件
<span class="o">|</span>
<span class="o">+-</span> app.js <span class="o">&lt;--</span> 入口js
<span class="o">|</span>
<span class="o">+-</span> package.json <span class="o">&lt;--</span> 项目描述文件
<span class="o">|</span>
<span class="o">+-</span> node_modules<span class="o">/</span> <span class="o">&lt;--</span> npm安装的所有依赖包
</pre></div>


<p>其中，模板文件存放在<code>views</code>目录中。</p>
<ul>
<li>package.json</li>
</ul>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="o">:</span> <span class="s">&quot;use-nunjucks&quot;</span><span class="p">,</span>
  <span class="s">&quot;version&quot;</span><span class="o">:</span> <span class="s">&quot;0.0.1&quot;</span><span class="p">,</span>
  <span class="s">&quot;dependencies&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s">&quot;nunjucks&quot;</span><span class="o">:</span> <span class="s">&quot;^3.1.3&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>app.js</li>
</ul>
<div class="hlcode"><pre><span class="kr">const</span> <span class="nx">nunjucks</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nunjucks&#39;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">createEnv</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span>
        <span class="nx">autoescape</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">autoescape</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">autoescape</span><span class="p">,</span>
        <span class="nx">noCache</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">noCache</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">watch</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">watch</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">throwOnUndefined</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">throwOnUndefined</span> <span class="o">||</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">env</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">nunjucks</span><span class="p">.</span><span class="nx">Environment</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">nunjucks</span><span class="p">.</span><span class="nx">FileSystemLoader</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">noCache</span><span class="o">:</span> <span class="nx">noCache</span><span class="p">,</span>
                <span class="nx">watch</span><span class="o">:</span> <span class="nx">watch</span><span class="p">,</span>
            <span class="p">}),</span> <span class="p">{</span>
                <span class="nx">autoescape</span><span class="o">:</span> <span class="nx">autoescape</span><span class="p">,</span>
                <span class="nx">throwOnUndefined</span><span class="o">:</span> <span class="nx">throwOnUndefined</span>
            <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">filters</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">filters</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">env</span><span class="p">.</span><span class="nx">addFilter</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">filters</span><span class="cp">[</span><span class="nb">f</span><span class="cp">]</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">env</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">createEnv</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">watch</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">filters</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">hex</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">&#39;0x&#39;</span> <span class="o">+</span> <span class="nx">n</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>我们就可以用下面的代码来渲染这个模板：</p>
<div class="hlcode"><pre><span class="n">var</span> <span class="n">s</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="err">&#39;</span><span class="n">hello</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="err">&#39;小明&#39;</span> <span class="p">});</span>
<span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</pre></div>


<p>获得输出如下：</p>
<div class="hlcode"><pre><span class="nt">&lt;h1&gt;</span>Hello 小明<span class="nt">&lt;/h1&gt;</span>
</pre></div>


<p>定义一个基本的网页框架<code>base.html</code>：</p>
<div class="hlcode"><pre><span class="nt">&lt;html&gt;&lt;body&gt;</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">header</span> <span class="cp">%}</span> <span class="nt">&lt;h3&gt;</span>Unnamed<span class="nt">&lt;/h3&gt;</span> <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span> <span class="nt">&lt;div&gt;</span>No body<span class="nt">&lt;/div&gt;</span> <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">footer</span> <span class="cp">%}</span> <span class="nt">&lt;div&gt;</span>copyright<span class="nt">&lt;/div&gt;</span> <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="nt">&lt;/body&gt;</span>
</pre></div>


<p><code>base.html</code>定义了三个可编辑的块，分别命名为<code>header</code>、<code>body</code>和<code>footer</code>。子模板可以有选择地对块进行重新定义：</p>
<div class="hlcode"><pre><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;base.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">header</span> <span class="cp">%}</span><span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">header</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">body</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>


<p>然后，我们对子模板进行渲染：</p>
<div class="hlcode"><pre><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="err">&#39;</span><span class="n">extend</span><span class="p">.</span><span class="n">html</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nl">header:</span> <span class="err">&#39;</span><span class="n">Hello</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="nl">body:</span> <span class="err">&#39;</span><span class="n">bla</span> <span class="n">bla</span> <span class="n">bla</span><span class="p">...</span><span class="err">&#39;</span>
<span class="p">}));</span>
</pre></div>


<p>输出HTML如下：</p>
<div class="hlcode"><pre><span class="o">&lt;</span>html<span class="o">&gt;&lt;</span>body<span class="o">&gt;</span>
<span class="o">&lt;</span>h1<span class="o">&gt;</span>Hello<span class="o">&lt;/</span>h1<span class="o">&gt;</span>
<span class="o">&lt;</span>p<span class="o">&gt;</span>bla bla bla...<span class="o">&lt;/</span>p<span class="o">&gt;</span>
<span class="o">&lt;</span>div<span class="o">&gt;</span>copyright<span class="o">&lt;/</span>div<span class="o">&gt;</span> <span class="o">&lt;--</span> footer没有重定义，所以仍使用父模板的内容
<span class="o">&lt;/</span>body<span class="o">&gt;</span>
</pre></div>


<h3 id="mvc">MVC</h3>
<p>通过Nunjucks把数据用指定的模板渲染成HTML，然后输出给浏览器，用户就可以看到渲染后的页面了：</p>
<p><img alt="mvc" src="https://cdn.liaoxuefeng.com/cdn/files/attachments/0014714802383905a3e19e0a96d4f0cbd2daba921364bba000/l" /></p>
<p>这就是传说中的MVC：Model-View-Controller，中文名“模型-视图-控制器”。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-11-05 22:57:24</p>
      </span>
    </div>

    
    
  </body>
</html>