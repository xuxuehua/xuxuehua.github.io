<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>higher_order_function 高阶函数 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#JavaScript">JavaScript</a>&nbsp;&#187;&nbsp;higher_order_function 高阶函数
    <span class="updated">Page Updated&nbsp;
      2018-06-15 01:41
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">higher_order_function 高阶函数</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#higher-order-function">高阶函数 Higher-order function</a><ul>
<li><a href="#_1">高阶函数定义</a></li>
<li><a href="#map">map 高阶函数</a></li>
<li><a href="#reduce">reduce 高阶函数</a></li>
<li><a href="#filter">filter 高阶函数</a><ul>
<li><a href="#_2">回调函数</a></li>
</ul>
</li>
<li><a href="#sort">sort 高阶函数</a></li>
<li><a href="#_3">闭包</a><ul>
<li><a href="#_4">函数作为返回值</a><ul>
<li><a href="#_5">匿名函数</a></li>
</ul>
</li>
<li><a href="#_6">闭包的强大功能</a></li>
</ul>
</li>
<li><a href="#_7">箭头函数</a><ul>
<li><a href="#this">this</a></li>
</ul>
</li>
<li><a href="#generator">generator 生成器</a><ul>
<li><a href="#generator_1">generator 实现的功能</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="higher-order-function">高阶函数 Higher-order function</h1>
<h2 id="_1">高阶函数定义</h2>
<ul>
<li>JavaScript的函数其实都指向某个变量。既然变量可以指向函数，函数的参数能接收变量，那么一个函数就可以接收另一个函数作为参数，这种函数就称之为高阶函数</li>
<li>一个最简单的高阶函数：</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">f</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
<span class="nx">y</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="nx">f</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">;</span>
<span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">f</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="mi">11</span><span class="p">;</span>
<span class="k">return</span> <span class="mi">11</span><span class="p">;</span>
</pre></div>


<ul>
<li>代码实现</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">add</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nx">f</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">add</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">);</span>   <span class="c1">// 11</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">11</span>
</pre></div>


<h2 id="map">map 高阶函数</h2>
<ul>
<li>由于<code>map()</code>方法定义在JavaScript的<code>Array</code>中，我们调用<code>Array</code>的<code>map()</code>方法，传入我们自己的函数，就得到了一个新的<code>Array</code>作为结果</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">pow</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">pow</span><span class="p">);</span> <span class="c1">// </span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">81</span><span class="cp">]</span><span class="c1"></span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mi">81</span>
</pre></div>


<ul>
<li><code>map()</code>作为高阶函数，事实上它把运算规则抽象了，因此，我们不但可以计算简单的f(x)=x2，还可以计算任意复杂的函数，比如，把<code>Array</code>的所有数字转为字符串</li>
</ul>
<div class="hlcode"><pre><span class="n">var</span> <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">];</span>
<span class="n">arr</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">String</span><span class="p">);</span> <span class="c1">// [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;6&#39;, &#39;7&#39;, &#39;8&#39;, &#39;9&#39;]</span>
</pre></div>


<ul>
<li>请把用户输入的不规范的英文名字，变为首字母大写，其他小写的规范名字。输入：<code>['adam', 'LISA', 'barT']</code>，输出：<code>['Adam', 'Lisa', 'Bart']</code></li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">normalize</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">normalize</span><span class="p">(</span><span class="cp">[</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span> <span class="s1">&#39;LISA&#39;</span><span class="p">,</span> <span class="s1">&#39;barT&#39;</span><span class="cp">]</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span> <span class="o">===</span> <span class="cp">[</span><span class="s1">&#39;Adam&#39;</span><span class="p">,</span> <span class="s1">&#39;Lisa&#39;</span><span class="p">,</span> <span class="s1">&#39;Bart&#39;</span><span class="cp">]</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;测试通过!&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;测试失败!&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>字符串变成整数</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">r</span><span class="p">;</span> 
<span class="nx">r</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">);</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span>
</pre></div>


<h2 id="reduce">reduce 高阶函数</h2>
<ul>
<li>Array的<code>reduce()</code>把一个函数作用在这个<code>Array</code>的<code>[x1, x2, x3...]</code>上，这个函数必须接收两个参数，<code>reduce()</code>把结果继续和序列的下一个元素做累积计算，其效果就是</li>
</ul>
<div class="hlcode"><pre><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">].</span><span class="n">reduce</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> <span class="n">x3</span><span class="p">),</span> <span class="n">x4</span><span class="p">)</span>
</pre></div>


<ul>
<li><code>Array</code>求和，就可以用<code>reduce</code>实现</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">});</span> <span class="c1">// 25</span>
</pre></div>


<ul>
<li>要把<code>[1, 3, 5, 7, 9]</code>变换成整数13579，<code>reduce()</code>也能派上用场</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="nx">y</span>
<span class="p">});</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">13579</span>
</pre></div>


<h2 id="filter">filter 高阶函数</h2>
<ul>
<li>filter也是一个常用的操作，它用于把<code>Array</code>的某些元素过滤掉，然后返回剩下的元素</li>
<li><code>filter()</code>把传入的函数依次作用于每个元素，然后根据返回值是<code>true</code>还是<code>false</code>决定保留还是丢弃该元素</li>
<li>在一个<code>Array</code>中，删掉偶数，只保留奇数，可以这么写：</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">r</span><span class="p">;</span> <span class="c1">// </span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="cp">]</span><span class="c1"></span>
</pre></div>


<ul>
<li>把一个<code>Array</code>中的空字符串删掉</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="kt">null</span><span class="p">,</span> <span class="nx">undefined</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">s</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trim</span><span class="p">();</span> <span class="c1">// 注意：IE9以下的版本没有trim()方法</span>
<span class="p">});</span>
<span class="nx">r</span><span class="p">;</span> <span class="c1">// </span><span class="cp">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="cp">]</span><span class="c1"></span>
</pre></div>


<ul>
<li>去除<code>Array</code>的重复元素</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span>
    <span class="nx">r</span><span class="p">,</span>
    <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;strawberry&#39;</span><span class="p">,</span> <span class="s1">&#39;banana&#39;</span><span class="p">,</span> <span class="s1">&#39;pear&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;strawberry&#39;</span><span class="cp">]</span><span class="p">;</span>

<span class="nx">r</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">===</span> <span class="nx">index</span><span class="p">;</span>
<span class="p">});</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="nx">apple</span><span class="p">,</span><span class="nx">strawberry</span><span class="p">,</span><span class="nx">banana</span><span class="p">,</span><span class="nx">pear</span><span class="p">,</span><span class="nx">orange</span>
</pre></div>


<blockquote>
<p>去除重复元素依靠的是<code>indexOf</code>总是返回第一个元素的位置，后续的重复元素位置与<code>indexOf</code>返回的位置不相等，因此被<code>filter</code>滤掉了。</p>
</blockquote>
<ul>
<li>尝试用<code>filter()</code>筛选出素数</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">get_primes</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">x</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">%</span> <span class="nx">i</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>


<h3 id="_2">回调函数</h3>
<ul>
<li><code>filter()</code>接收的回调函数，其实可以有多个参数。通常我们仅使用第一个参数，表示<code>Array</code>的某个元素。回调函数还可以接收另外两个参数，表示元素的位置和数组本身</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span> <span class="c1">// 依次打印&#39;A&#39;, &#39;B&#39;, &#39;C&#39;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span> <span class="c1">// 依次打印0, 1, 2</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span> <span class="c1">// self就是变量arr</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>


<h2 id="sort">sort 高阶函数</h2>
<ul>
<li>JavaScript的<code>Array</code>的<code>sort()</code>方法就是用于排序的，但是排序结果可能让你大吃一惊：</li>
</ul>
<div class="hlcode"><pre><span class="c1">// 看上去正常的结果:</span>
<span class="p">[&#39;</span><span class="n">Google</span><span class="p">&#39;,</span> <span class="p">&#39;</span><span class="n">Apple</span><span class="p">&#39;,</span> <span class="p">&#39;</span><span class="n">Microsoft</span><span class="p">&#39;].</span><span class="n">sort</span><span class="p">();</span> <span class="c1">// [&#39;Apple&#39;, &#39;Google&#39;, &#39;Microsoft&#39;];</span>

<span class="c1">// apple排在了最后:</span>
<span class="p">[&#39;</span><span class="n">Google</span><span class="p">&#39;,</span> <span class="p">&#39;</span><span class="n">apple</span><span class="p">&#39;,</span> <span class="p">&#39;</span><span class="n">Microsoft</span><span class="p">&#39;].</span><span class="n">sort</span><span class="p">();</span> <span class="c1">// [&#39;Google&#39;, &#39;Microsoft&quot;, &#39;apple&#39;]</span>

<span class="c1">// 无法理解的结果:</span>
<span class="p">[</span><span class="mh">10</span><span class="p">,</span> <span class="mh">20</span><span class="p">,</span> <span class="mh">1</span><span class="p">,</span> <span class="mh">2</span><span class="p">].</span><span class="n">sort</span><span class="p">();</span> <span class="c1">// [1, 10, 2, 20]</span>
</pre></div>


<blockquote>
<p>第二个排序把<code>apple</code>排在了最后，是因为字符串根据ASCII码进行排序，而小写字母<code>a</code>的ASCII码在大写字母之后。</p>
<p>第三个排序结果是什么鬼？简单的数字排序都能错？</p>
<p>这是因为<code>Array</code>的<code>sort()</code>方法默认把所有元素先转换为String再排序，结果<code>'10'</code>排在了<code>'2'</code>的前面，因为字符<code>'1'</code>比字符<code>'2'</code>的ASCII码小。</p>
</blockquote>
<ul>
<li>要按数字大小排序，我们可以这么写</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">);</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>


<ul>
<li>如果要倒序排序，我们可以把大的数放前面</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">});</span> <span class="c1">// </span><span class="cp">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="cp">]</span><span class="c1"></span>
</pre></div>


<ul>
<li>默认情况下，对字符串排序，是按照ASCII的大小比较的，现在，我们提出排序应该忽略大小写，按照字母序排序。要实现这个算法，不必对现有代码大加改动，只要我们能定义出忽略大小写的比较算法就可以：</li>
</ul>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="s1">&#39;Google&#39;</span><span class="p">,</span> <span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;Microsoft&#39;</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">arr</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">x1</span> <span class="o">=</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
    <span class="nx">x2</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">x2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&gt;</span> <span class="nx">x2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">});</span> <span class="c1">// </span><span class="cp">[</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="s1">&#39;Google&#39;</span><span class="p">,</span> <span class="s1">&#39;Microsoft&#39;</span><span class="cp">]</span><span class="c1"></span>
</pre></div>


<ul>
<li><code>sort()</code>方法会直接对<code>Array</code>进行修改，它返回的结果仍是当前<code>Array</code>：</li>
</ul>
<div class="hlcode"><pre><span class="n">var</span> <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">];</span>
<span class="n">var</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">a1</span><span class="p">.</span><span class="n">sort</span><span class="p">();</span>
<span class="n">a1</span><span class="p">;</span> <span class="c1">// [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]</span>
<span class="n">a2</span><span class="p">;</span> <span class="c1">// [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]</span>
<span class="n">a1</span> <span class="o">===</span> <span class="n">a2</span><span class="p">;</span> <span class="c1">// true, a1和a2是同一对象</span>
</pre></div>


<h2 id="_3">闭包</h2>
<h3 id="_4">函数作为返回值</h3>
<ul>
<li>
<p>高阶函数除了可以接受函数作为参数外，还可以把函数作为结果值返回</p>
</li>
<li>
<p>对<code>Array</code>的求和</p>
</li>
</ul>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">sum</span><span class="p">(</span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="cp">]</span><span class="p">);</span> <span class="c1">// 15</span>
</pre></div>


<ul>
<li>如果不需要立刻求和，而是在后面的代码中，根据需要再计算怎么办？可以不返回求和的结果，而是返回求和的函数！</li>
</ul>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">lazy_sum</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">lazy_sum</span><span class="p">(</span><span class="cp">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="cp">]</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">15</span>
</pre></div>


<blockquote>
<ul>
<li>当<code>lazy_sum</code>返回函数<code>sum</code>时，相关参数和变量都保存在返回的函数中，这种称为“闭包（Closure）”的程序结构拥有极大的威力</li>
</ul>
</blockquote>
<ul>
<li>另一个需要注意的问题是，返回的函数并没有立刻执行，而是直到调用了<code>f()</code>才执行</li>
</ul>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">count</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[]</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">i</span> <span class="o">*</span> <span class="nx">i</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">count</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">f1</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f2</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f3</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">2</span><span class="cp">]</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f1</span><span class="p">())</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f2</span><span class="p">())</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f3</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">16</span>
<span class="mi">16</span>
<span class="mi">16</span>
</pre></div>


<blockquote>
<p>全部都是<code>16</code>！原因就在于返回的函数引用了变量<code>i</code>，但它并非立刻执行。等到3个函数都返回时，它们所引用的变量<code>i</code>已经变成了<code>4</code>，因此最终结果为<code>16</code></p>
<ul>
<li>返回函数不要引用任何循环变量，或者后续会发生变化的变量</li>
</ul>
</blockquote>
<ul>
<li>如果一定要引用循环变量怎么办？方法是再创建一个函数，用该函数的参数绑定循环变量当前的值，无论该循环变量后续如何更改，已绑定到函数参数的值不变：</li>
</ul>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">count</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[]</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">n</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">})(</span><span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">count</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">f1</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f2</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">f3</span> <span class="o">=</span> <span class="nx">results</span><span class="cp">[</span><span class="mi">2</span><span class="cp">]</span><span class="p">;</span>

<span class="nx">f1</span><span class="p">();</span> <span class="c1">// 1</span>
<span class="nx">f2</span><span class="p">();</span> <span class="c1">// 4</span>
<span class="nx">f3</span><span class="p">();</span> <span class="c1">// 9</span>
</pre></div>


<h4 id="_5">匿名函数</h4>
<ul>
<li>注意这里用了一个“创建一个匿名函数并立刻执行”的语法：</li>
</ul>
<div class="hlcode"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">})(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">// 9</span>
</pre></div>


<ul>
<li>创建一个匿名函数并立刻执行可以这么写：</li>
</ul>
<div class="hlcode"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="p">}</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>


<ul>
<li>由于JavaScript语法解析的问题，会报SyntaxError错误，因此需要用括号把整个函数定义括起来：</li>
</ul>
<div class="hlcode"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="p">})</span> <span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>


<ul>
<li>一个立即执行的匿名函数可以把函数体拆开，一般这么写：</li>
</ul>
<div class="hlcode"><pre><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">})(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>


<h3 id="_6">闭包的强大功能</h3>
<ul>
<li>在没有<code>class</code>机制，只有函数的语言里，借助闭包，同样可以封装一个私有变量。我们用JavaScript创建一个计数器：</li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">create_counter</span><span class="p">(</span><span class="nx">initial</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">initial</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">inc</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">x</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>它用起来像这样：</li>
</ul>
<div class="hlcode"><pre><span class="n">var</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">create_counter</span><span class="p">();</span>
<span class="n">c1</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 1</span>
<span class="n">c1</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 2</span>
<span class="n">c1</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 3</span>

<span class="n">var</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">create_counter</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">c2</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 11</span>
<span class="n">c2</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 12</span>
<span class="n">c2</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span> <span class="c1">// 13</span>
</pre></div>


<blockquote>
<p>在返回的对象中，实现了一个闭包，该闭包携带了局部变量<code>x</code>，并且，从外部代码根本无法访问到变量<code>x</code>。换句话说，闭包就是携带状态的函数，并且它的状态可以完全对外隐藏起来。 </p>
</blockquote>
<ul>
<li>闭包还可以把多参数的函数变成单参数的函数。例如，要计算xy可以用<code>Math.pow(x, y)</code>函数，不过考虑到经常计算x2或x3，我们可以利用闭包创建新的函数<code>pow2</code>和<code>pow3</code>： </li>
</ul>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">make_pow</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">pow2</span> <span class="o">=</span> <span class="nx">make_pow</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pow3</span> <span class="o">=</span> <span class="nx">make_pow</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pow2</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pow3</span><span class="p">(</span><span class="mi">7</span><span class="p">));</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">25</span>
<span class="mi">343</span>
</pre></div>


<h2 id="_7">箭头函数</h2>
<div class="hlcode"><pre><span class="n">x</span> <span class="o">=&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
</pre></div>


<p>上面的箭头函数相当于：</p>
<div class="hlcode"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>箭头函数相当于匿名函数，并且简化了函数定义。箭头函数有两种格式，一种像上面的，只包含一个表达式，连<code>{ ... }</code>和<code>return</code>都省略掉了。还有一种可以包含多条语句，这时候就不能省略<code>{ ... }</code>和<code>return</code>：</li>
</ul>
<div class="hlcode"><pre><span class="n">x</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>如果参数不是一个，就需要用括号<code>()</code>括起来：</li>
</ul>
<div class="hlcode"><pre><span class="c1">// 两个参数:</span>
<span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span>

<span class="c1">// 无参数:</span>
<span class="p">()</span> <span class="o">=&gt;</span> <span class="mf">3.14</span>

<span class="c1">// 可变参数:</span>
<span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">...</span><span class="n">rest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">i</span><span class="p">,</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mh">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">rest</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">rest</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>如果要返回一个对象，就要注意，如果是单表达式，这么写的话会报错：</p>
<div class="hlcode"><pre><span class="c1">// SyntaxError:</span>
<span class="n">x</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nl">foo:</span> <span class="n">x</span> <span class="p">}</span>
</pre></div>


<p>因为和函数体的<code>{ ... }</code>有语法冲突，所以要改为：</p>
<div class="hlcode"><pre><span class="c1">// ok:</span>
<span class="n">x</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="nl">foo:</span> <span class="n">x</span> <span class="p">})</span>
</pre></div>


<h3 id="this">this</h3>
<ul>
<li>箭头函数看上去是匿名函数的一种简写，但实际上，箭头函数和匿名函数有个明显的区别：箭头函数内部的<code>this</code>是词法作用域，由上下文确定</li>
</ul>
<p>由于JavaScript函数对<code>this</code>绑定的错误处理，下面的例子无法得到预期结果：</p>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">birth</span><span class="o">:</span> <span class="mi">1990</span><span class="p">,</span>
    <span class="nx">getAge</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// 1990</span>
        <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// this指向window或undefined</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">getAge</span><span class="p">());</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="kc">NaN</span>
</pre></div>


<p>现在，箭头函数完全修复了<code>this</code>的指向，<code>this</code>总是指向词法作用域，也就是外层调用者<code>obj</code>：</p>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">birth</span><span class="o">:</span> <span class="mi">1990</span><span class="p">,</span>
    <span class="nx">getAge</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// 1990</span>
        <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// this指向obj对象</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">getAge</span><span class="p">();</span> <span class="c1">// 28</span>
</pre></div>


<p>由于<code>this</code>在箭头函数中已经按照词法作用域绑定了，所以，用<code>call()</code>或者<code>apply()</code>调用箭头函数时，无法对<code>this</code>进行绑定，即传入的第一个参数被忽略：</p>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">birth</span><span class="o">:</span> <span class="mi">1990</span><span class="p">,</span>
    <span class="nx">getAge</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">year</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// 1990</span>
        <span class="kd">var</span> <span class="nx">fn</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">birth</span><span class="p">;</span> <span class="c1">// this.birth仍是1990</span>
        <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="nx">birth</span><span class="o">:</span><span class="mi">2000</span><span class="p">},</span> <span class="nx">year</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="nx">obj</span><span class="p">.</span><span class="nx">getAge</span><span class="p">(</span><span class="mi">2015</span><span class="p">);</span> <span class="c1">// 28</span>
</pre></div>


<h2 id="generator">generator 生成器</h2>
<ul>
<li>一个generator看上去像一个函数，但可以返回多次</li>
<li>generator和函数不同的是，generator由<code>function*</code>定义（注意多出的<code>*</code>号），并且，除了<code>return</code>语句，还可以用<code>yield</code>返回多次</li>
</ul>
<p>斐波那契数列的函数，可以这么写：</p>
<div class="hlcode"><pre><span class="kd">function</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span>
        <span class="nx">t</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">arr</span> <span class="o">=</span> <span class="cp">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="cp">]</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="cp">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="cp">]</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="cp">]</span><span class="p">;</span>
        <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 测试:</span>
<span class="nx">fib</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// </span><span class="cp">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="cp">]</span><span class="c1"></span>
<span class="nx">fib</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// </span><span class="cp">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">34</span><span class="cp">]</span><span class="c1"></span>
</pre></div>


<p>如果换成generator，就可以一次返回一个数，不断返回多次。用generator改写如下：</p>
<div class="hlcode"><pre><span class="kd">function</span><span class="o">*</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span>
        <span class="nx">t</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">yield</span> <span class="nx">a</span><span class="p">;</span>
        <span class="cp">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="cp">]</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="cp">]</span><span class="p">;</span>
        <span class="nx">n</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>调用generator对象有两个方法，一是不断地调用generator对象的<code>next()</code>方法：</p>
<div class="hlcode"><pre><span class="n">var</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fib</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: 0, done: false}</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: 1, done: false}</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: 1, done: false}</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: 2, done: false}</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: 3, done: false}</span>
<span class="n">f</span><span class="p">.</span><span class="n">next</span><span class="p">();</span> <span class="c1">// {value: undefined, done: true}</span>
</pre></div>


<p>用<code>for ... of</code>循环迭代generator对象，这种方式不需要我们自己判断<code>done</code>：</p>
<div class="hlcode"><pre><span class="s1">&#39;use strict&#39;</span>

<span class="kd">function</span><span class="o">*</span> <span class="nx">fib</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span>
        <span class="nx">t</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">yield</span> <span class="nx">a</span><span class="p">;</span>
        <span class="cp">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="cp">]</span> <span class="o">=</span> <span class="cp">[</span><span class="nx">b</span><span class="p">,</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="cp">]</span><span class="p">;</span>
        <span class="nx">n</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">x</span> <span class="nx">of</span> <span class="nx">fib</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span> <span class="c1">// 依次输出0, 1, 1, 2, 3, ...</span>
<span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="mi">0</span>
<span class="mi">1</span>
<span class="mi">1</span>
<span class="mi">2</span>
<span class="mi">3</span>
<span class="mi">5</span>
<span class="mi">8</span>
<span class="mi">13</span>
<span class="mi">21</span>
<span class="mi">34</span>
</pre></div>


<h3 id="generator_1">generator 实现的功能</h3>
<p>因为generator可以在执行过程中多次返回，所以它看上去就像一个可以记住执行状态的函数，利用这一点，写一个generator就可以实现需要用面向对象才能实现的功能。例如，用一个对象来保存状态，得这么写：</p>
<div class="hlcode"><pre><span class="kd">var</span> <span class="nx">fib</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">a</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">b</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">n</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">max</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nx">next</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span>
            <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span>
            <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">n</span> <span class="o">++</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>


<p>generator还有另一个巨大的好处，就是把异步回调代码变成“同步”代码。这个好处要等到后面学了AJAX以后才能体会到</p>
<p>没有generator之前的黑暗时代，用AJAX时需要这么写代码：</p>
<div class="hlcode"><pre><span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://url-1&#39;</span><span class="p">,</span> <span class="nx">data1</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://url-2&#39;</span><span class="p">,</span> <span class="nx">data2</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">ajax</span><span class="p">(</span><span class="s1">&#39;http://url-3&#39;</span><span class="p">,</span> <span class="nx">data3</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">handle</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">success</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>回调越多，代码越难看。</p>
<p>有了generator的美好时代，用AJAX时可以这么写：</p>
<div class="hlcode"><pre><span class="n">try</span> <span class="p">{</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">yield</span> <span class="n">ajax</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//url-1&#39;, data1);</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">yield</span> <span class="n">ajax</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//url-2&#39;, data2);</span>
    <span class="n">r3</span> <span class="o">=</span> <span class="n">yield</span> <span class="n">ajax</span><span class="p">(</span><span class="err">&#39;</span><span class="n">http</span><span class="o">:</span><span class="c1">//url-3&#39;, data3);</span>
    <span class="n">success</span><span class="p">(</span><span class="n">r3</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">catch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handle</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-03-25 22:15:10</p>
      </span>
    </div>

    
    
  </body>
</html>