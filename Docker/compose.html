<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>compose - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Docker">Docker</a>&nbsp;&#187;&nbsp;compose
    <span class="updated">Page Updated&nbsp;
      2018-10-24 15:17
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">compose</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#compose">compose</a><ul>
<li><a href="#_1">术语</a></li>
<li><a href="#compose_1">Compose 命令</a><ul>
<li><a href="#options">options 命令选项</a></li>
<li><a href="#build">build 构建</a></li>
<li><a href="#config">config</a></li>
<li><a href="#down">down</a></li>
<li><a href="#exec">exec</a></li>
<li><a href="#help">help</a></li>
<li><a href="#images">images</a></li>
<li><a href="#kill">kill</a></li>
<li><a href="#logs">logs</a></li>
<li><a href="#pause">pause</a></li>
<li><a href="#port">port</a></li>
<li><a href="#ps">ps</a></li>
<li><a href="#pull">pull</a></li>
<li><a href="#push">push</a></li>
<li><a href="#restart">restart</a></li>
<li><a href="#rm">rm</a></li>
<li><a href="#run">run</a></li>
<li><a href="#scale">scale</a></li>
<li><a href="#start">start</a></li>
<li><a href="#stop">stop</a></li>
<li><a href="#top">top</a></li>
<li><a href="#unpause">unpause</a></li>
<li><a href="#up">up</a></li>
<li><a href="#version">version</a></li>
</ul>
</li>
<li><a href="#compose_2">Compose 模板文件</a><ul>
<li><a href="#_2">场景案例</a><ul>
<li><a href="#haproxy">haproxy</a></li>
<li><a href="#django">使用 Django</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="compose">compose</h1>
<p>Docker Compose 是 Docker 官方编排（Orchestration）项目之一，负责快速在集群中部署分布式应用。</p>
<p>Compose 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 OpenStack 中的 Heat 十分类似。<br />
Compose 定位是 「定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）」，其前身是开源项目 Fig。</p>
<h2 id="_1">术语</h2>
<p>服务 (service)：一个应用容器，实际上可以运行多个相同镜像的实例。</p>
<p>项目 (project)：由一组关联的应用容器组成的一个完整业务单元。</p>
<h2 id="compose_1">Compose 命令</h2>
<p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>
<p>执行 <code>docker-compose [COMMAND] --help</code> 或者 <code>docker-compose help [COMMAND]</code> 可以查看具体某个命令的使用格式。</p>
<div class="hlcode"><pre><span class="nx">docker</span><span class="na">-compose</span> <span class="err">[</span><span class="na">-f</span><span class="o">=&lt;</span><span class="nx">arg</span><span class="o">&gt;</span><span class="nx">...</span><span class="cp">]</span> <span class="cp">[</span><span class="nx">options</span><span class="cp">]</span> <span class="cp">[</span><span class="nb">COMMAND</span><span class="cp">]</span> <span class="cp">[</span><span class="nx">ARGS...</span><span class="cp">]</span>
</pre></div>


<h3 id="options">options 命令选项</h3>
<ul>
<li>
<p>-f, --file FILE 指定使用的 Compose 模板文件，默认为 docker-compose.yml，可以多次指定。</p>
</li>
<li>
<p>-p, --project-name NAME 指定项目名称，默认将使用所在目录名称作为项目名。</p>
</li>
<li>
<p>--x-networking 使用 Docker 的可拔插网络后端特性</p>
</li>
<li>
<p>--x-network-driver DRIVER 指定网络后端的驱动，默认为 bridge</p>
</li>
<li>
<p>--verbose 输出更多调试信息。</p>
</li>
<li>
<p>-v, --version 打印版本并退出。</p>
</li>
</ul>
<h3 id="build">build 构建</h3>
<p>格式为 <code>docker-compose build [options][SERVICE...]</code></p>
<p>构建（重新构建）项目中的服务容器。</p>
<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 web_db。</p>
<p>可以随时在项目目录下运行 docker-compose build 来重新构建服务。</p>
<p>选项包括：</p>
<p>--force-rm 删除构建过程中的临时容器。</p>
<p>--no-cache 构建镜像过程中不使用 cache（这将加长构建过程）。</p>
<p>--pull 始终尝试通过 pull 来获取更新版本的镜像。</p>
<h3 id="config">config</h3>
<p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>
<h3 id="down">down</h3>
<p>此命令将会停止 up 命令所启动的容器，并移除网络</p>
<h3 id="exec">exec</h3>
<p>进入指定的容器。</p>
<h3 id="help">help</h3>
<p>获得一个命令的帮助。</p>
<h3 id="images">images</h3>
<p>列出 Compose 文件中包含的镜像。</p>
<h3 id="kill">kill</h3>
<p>格式为 <code>docker-compose kill [options][SERVICE...]</code></p>
<p>通过发送 SIGKILL 信号来强制停止服务容器。</p>
<p>支持通过 -s 参数来指定发送的信号，例如通过如下指令发送 SIGINT 信号。</p>
<p>$ docker-compose kill -s SIGINT</p>
<h3 id="logs">logs</h3>
<p>格式为 docker-compose logs [options] [SERVICE...]。</p>
<p>查看服务容器的输出。默认情况下，docker-compose 将对不同的服务输出使用不同的颜色来区分。可以通过 --no-color 来关闭颜色。</p>
<p>该命令在调试问题的时候十分有用。</p>
<h3 id="pause">pause</h3>
<p>格式为 docker-compose pause [SERVICE...]。</p>
<p>暂停一个服务容器。</p>
<h3 id="port">port</h3>
<p>格式为 docker-compose port [options] SERVICE PRIVATE_PORT。</p>
<p>打印某个容器端口所映射的公共端口。</p>
<p>选项：</p>
<p>--protocol=proto 指定端口协议，tcp（默认值）或者 udp。</p>
<p>--index=index 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</p>
<h3 id="ps">ps</h3>
<p>格式为 <code>docker-compose ps [options][SERVICE...]</code></p>
<p>列出项目中目前的所有容器。</p>
<p>选项：</p>
<p>-q 只打印容器的 ID 信息。</p>
<h3 id="pull">pull</h3>
<p>格式为 docker-compose pull [options] [SERVICE...]。</p>
<p>拉取服务依赖的镜像。</p>
<p>选项：</p>
<p>--ignore-pull-failures 忽略拉取镜像过程中的错误。</p>
<h3 id="push">push</h3>
<p>推送服务依赖的镜像到 Docker 镜像仓库。</p>
<h3 id="restart">restart</h3>
<p>格式为 docker-compose restart [options] [SERVICE...]。</p>
<p>重启项目中的服务。</p>
<p>选项：</p>
<p>-t, --timeout TIMEOUT 指定重启前停止容器的超时（默认为 10 秒）。</p>
<h3 id="rm">rm</h3>
<p>格式为 docker-compose rm [options] [SERVICE...]。</p>
<p>删除所有（停止状态的）服务容器。推荐先执行 docker-compose stop 命令来停止容器。</p>
<p>选项：</p>
<p>-f, --force 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</p>
<p>-v 删除容器所挂载的数据卷。</p>
<h3 id="run">run</h3>
<p>格式为 docker-compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]。</p>
<p>在指定服务上执行一个命令。</p>
<p>例如：</p>
<p>$ docker-compose run ubuntu ping docker.com<br />
将会启动一个 ubuntu 服务容器，并执行 ping docker.com 命令。</p>
<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>
<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>
<p>两个不同点：</p>
<p>给定命令将会覆盖原有的自动运行命令；</p>
<p>不会自动创建端口，以避免冲突。</p>
<p>如果不希望自动启动关联的容器，可以使用 --no-deps 选项，例如</p>
<p>$ docker-compose run --no-deps web python manage.py shell<br />
将不会启动 web 容器所关联的其它容器。</p>
<p>选项：</p>
<p>-d 后台运行容器。</p>
<p>--name NAME 为容器指定一个名字。</p>
<p>--entrypoint CMD 覆盖默认的容器启动指令。</p>
<p>-e KEY=VAL 设置环境变量值，可多次使用选项来设置多个环境变量。</p>
<p>-u, --user="" 指定运行容器的用户名或者 uid。</p>
<p>--no-deps 不自动启动关联的服务容器。</p>
<p>--rm 运行命令后自动删除容器，d 模式下将忽略。</p>
<p>-p, --publish=[] 映射容器端口到本地主机。</p>
<p>--service-ports 配置服务端口并映射到本地主机。</p>
<p>-T 不分配伪 tty，意味着依赖 tty 的指令将无法运行。</p>
<h3 id="scale">scale</h3>
<p>格式为 docker-compose scale [options] [SERVICE=NUM...]。</p>
<p>设置指定服务运行的容器个数。</p>
<p>通过 service=num 的参数来设置数量。例如：</p>
<p>$ docker-compose scale web=3 db=2<br />
将启动 3 个容器运行 web 服务，2 个容器运行 db 服务。</p>
<p>一般的，当指定数目多于该服务当前实际运行容器，将新创建并启动容器；反之，将停止容器。</p>
<p>选项：</p>
<p>-t, --timeout TIMEOUT 停止容器时候的超时（默认为 10 秒）。</p>
<h3 id="start">start</h3>
<p>格式为 docker-compose start [SERVICE...]。</p>
<p>启动已经存在的服务容器。</p>
<h3 id="stop">stop</h3>
<p>格式为 <code>docker-compose stop [options][SERVICE...]</code></p>
<p>停止已经处于运行状态的容器，但不删除它。通过 docker-compose start 可以再次启动这些容器。</p>
<p>选项：</p>
<p>-t, --timeout TIMEOUT 停止容器时候的超时（默认为 10 秒）。</p>
<h3 id="top">top</h3>
<p>查看各个服务容器内运行的进程。</p>
<h3 id="unpause">unpause</h3>
<p>格式为 docker-compose unpause [SERVICE...]。</p>
<p>恢复处于暂停状态中的服务。</p>
<h3 id="up">up</h3>
<p>格式为 docker-compose up [options] [SERVICE...]。</p>
<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>
<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>
<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>
<p>默认情况，docker-compose up 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>
<p>当通过 Ctrl-C 停止命令时，所有容器将会停止。</p>
<p>如果使用 docker-compose up -d，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>
<p>默认情况，如果服务容器已经存在，docker-compose up 将会尝试停止容器，然后重新创建（保持使用 volumes-from 挂载的卷），以保证新启动的服务匹配 docker-compose.yml 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 docker-compose up --no-recreate。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 docker-compose up --no-deps -d <SERVICE_NAME> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>
<p>选项：</p>
<p>-d 在后台运行服务容器。</p>
<p>--no-color 不使用颜色来区分不同的服务的控制台输出。</p>
<p>--no-deps 不启动服务所链接的容器。</p>
<p>--force-recreate 强制重新创建容器，不能与 --no-recreate 同时使用。</p>
<p>--no-recreate 如果容器已经存在了，则不重新创建，不能与 --force-recreate 同时使用。</p>
<p>--no-build 不自动构建缺失的服务镜像。</p>
<p>-t, --timeout TIMEOUT 停止容器时候的超时（默认为 10 秒）。</p>
<h3 id="version">version</h3>
<p>格式为 docker-compose version。</p>
<p>打印版本信息。</p>
<h2 id="compose_2">Compose 模板文件</h2>
<p>模板文件是使用 Compose 的核心，涉及到的指令关键字也比较多。但大家不用担心，这里面大部分指令跟 docker run 相关参数的含义都是类似的。</p>
<p>默认的模板文件名称为 docker-compose.yml，格式为 YAML 格式。</p>
<div class="hlcode"><pre><span class="nl">version:</span> <span class="s">&quot;3&quot;</span>

<span class="nl">services:</span>
  <span class="nl">webapp:</span>
    <span class="nl">image:</span> <span class="n">examples</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">ports:</span>
      <span class="o">-</span> <span class="s">&quot;80:80&quot;</span>
    <span class="nl">volumes:</span>
      <span class="o">-</span> <span class="s">&quot;/data&quot;</span>
<span class="err">注意每个服务都必须通过</span> <span class="n">image</span> <span class="err">指令指定镜像或</span> <span class="n">build</span> <span class="err">指令（需要</span> <span class="n">Dockerfile</span><span class="err">）等来自动构建生成镜像。</span>

<span class="err">如果使用</span> <span class="n">build</span> <span class="err">指令，在</span> <span class="n">Dockerfile</span> <span class="err">中设置的选项</span><span class="p">(</span><span class="err">例如：</span><span class="n">CMD</span><span class="p">,</span> <span class="n">EXPOSE</span><span class="p">,</span> <span class="n">VOLUME</span><span class="p">,</span> <span class="n">ENV</span> <span class="err">等</span><span class="p">)</span> <span class="err">将会自动被获取，无需在</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span> <span class="err">中再次设置。</span>

<span class="err">下面分别介绍各个指令的用法。</span>

<span class="n">build</span>

<span class="err">指定</span> <span class="n">Dockerfile</span> <span class="err">所在文件夹的路径（可以是绝对路径，或者相对</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span> <span class="err">文件的路径）。</span> <span class="n">Compose</span> <span class="err">将会利用它自动构建这个镜像，然后使用这个镜像。</span>

<span class="nl">build:</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">dir</span>
<span class="n">cap_add</span><span class="p">,</span> <span class="n">cap_drop</span>

<span class="err">指定容器的内核能力（</span><span class="n">capacity</span><span class="err">）分配。</span>

<span class="err">例如，让容器拥有所有能力可以指定为：</span>

<span class="nl">cap_add:</span>
  <span class="o">-</span> <span class="n">ALL</span>
<span class="err">去掉</span> <span class="n">NET_ADMIN</span> <span class="err">能力可以指定为：</span>

<span class="nl">cap_drop:</span>
  <span class="o">-</span> <span class="n">NET_ADMIN</span>
<span class="n">command</span>

<span class="err">覆盖容器启动后默认执行的命令。</span>

<span class="nl">command:</span> <span class="n">echo</span> <span class="s">&quot;hello world&quot;</span>
<span class="n">configs</span>

<span class="err">仅用于</span> <span class="n">Swarm</span> <span class="n">mode</span><span class="err">，详细内容请查看</span> <span class="n">Swarm</span> <span class="n">mode</span> <span class="err">一节。</span>

<span class="n">cgroup_parent</span>

<span class="err">指定父</span> <span class="n">cgroup</span> <span class="err">组，意味着将继承该组的资源限制。</span>

<span class="err">例如，创建了一个</span> <span class="n">cgroup</span> <span class="err">组名称为</span> <span class="n">cgroups_1</span><span class="err">。</span>

<span class="nl">cgroup_parent:</span> <span class="n">cgroups_1</span>
<span class="n">container_name</span>

<span class="err">指定容器名称。默认将会使用</span> <span class="err">项目名称</span><span class="n">_</span><span class="err">服务名称</span><span class="n">_</span><span class="err">序号</span> <span class="err">这样的格式。</span>

<span class="nl">container_name:</span> <span class="n">docker</span><span class="o">-</span><span class="n">web</span><span class="o">-</span><span class="n">container</span>
<span class="err">需要注意，指定容器名称后，该服务将无法进行扩展（</span><span class="n">scale</span><span class="err">），因为</span> <span class="n">Docker</span> <span class="err">不允许多个容器具有相同的名称。</span>

<span class="n">deploy</span>

<span class="err">仅用于</span> <span class="n">Swarm</span> <span class="n">mode</span><span class="err">，详细内容请查看</span> <span class="n">Swarm</span> <span class="n">mode</span> <span class="err">一节</span>

<span class="n">devices</span>

<span class="err">指定设备映射关系。</span>

<span class="nl">devices:</span>
  <span class="o">-</span> <span class="s">&quot;/dev/ttyUSB1:/dev/ttyUSB0&quot;</span>
<span class="n">depends_on</span>

<span class="err">解决容器的依赖、启动先后的问题。以下例子中会先启动</span> <span class="n">redis</span> <span class="n">db</span> <span class="err">再启动</span> <span class="n">web</span>

<span class="nl">version:</span> <span class="sc">&#39;3&#39;</span>

<span class="nl">services:</span>
  <span class="nl">web:</span>
    <span class="nl">build:</span> <span class="p">.</span>
    <span class="nl">depends_on:</span>
      <span class="o">-</span> <span class="n">db</span>
      <span class="o">-</span> <span class="n">redis</span>

  <span class="nl">redis:</span>
    <span class="nl">image:</span> <span class="n">redis</span>

  <span class="nl">db:</span>
    <span class="nl">image:</span> <span class="n">postgres</span>
<span class="n">dns</span>

<span class="err">自定义</span> <span class="n">DNS</span> <span class="err">服务器。可以是一个值，也可以是一个列表。</span>

<span class="nl">dns:</span> <span class="mf">8.8.8.8</span>

<span class="nl">dns:</span>
  <span class="o">-</span> <span class="mf">8.8.8.8</span>
  <span class="o">-</span> <span class="mf">114.114.114.114</span>
<span class="n">dns_search</span>

<span class="err">配置</span> <span class="n">DNS</span> <span class="err">搜索域。可以是一个值，也可以是一个列表。</span>

<span class="nl">dns_search:</span> <span class="n">example</span><span class="p">.</span><span class="n">com</span>

<span class="nl">dns_search:</span>
  <span class="o">-</span> <span class="n">domain1</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
  <span class="o">-</span> <span class="n">domain2</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">com</span>
<span class="n">tmpfs</span>

<span class="err">挂载一个</span> <span class="n">tmpfs</span> <span class="err">文件系统到容器。</span>

<span class="nl">tmpfs:</span> <span class="o">/</span><span class="n">run</span>
<span class="nl">tmpfs:</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">run</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">tmp</span>
<span class="n">env_file</span>

<span class="err">从文件中获取环境变量，可以为单独的文件路径或列表。</span>

<span class="err">如果通过</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">-</span><span class="n">f</span> <span class="kt">FILE</span> <span class="err">方式来指定</span> <span class="n">Compose</span> <span class="err">模板文件，则</span> <span class="n">env_file</span> <span class="err">中变量的路径会基于模板文件路径。</span>

<span class="err">如果有变量名称与</span> <span class="n">environment</span> <span class="err">指令冲突，则按照惯例，以后者为准。</span>

<span class="nl">env_file:</span> <span class="p">.</span><span class="n">env</span>

<span class="nl">env_file:</span>
  <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">common</span><span class="p">.</span><span class="n">env</span>
  <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">apps</span><span class="o">/</span><span class="n">web</span><span class="p">.</span><span class="n">env</span>
  <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">secrets</span><span class="p">.</span><span class="n">env</span>
<span class="err">环境变量文件中每一行必须符合格式，支持</span> <span class="err">#</span> <span class="err">开头的注释行。</span>

<span class="cp"># common.env: Set development environment</span>
<span class="n">PROG_ENV</span><span class="o">=</span><span class="n">development</span>
<span class="n">environment</span>

<span class="err">设置环境变量。你可以使用数组或字典两种格式。</span>

<span class="err">只给定名称的变量会自动获取运行</span> <span class="n">Compose</span> <span class="err">主机上对应变量的值，可以用来防止泄露不必要的数据。</span>

<span class="nl">environment:</span>
  <span class="nl">RACK_ENV:</span> <span class="n">development</span>
  <span class="nl">SESSION_SECRET:</span>

<span class="nl">environment:</span>
  <span class="o">-</span> <span class="n">RACK_ENV</span><span class="o">=</span><span class="n">development</span>
  <span class="o">-</span> <span class="n">SESSION_SECRET</span>
<span class="err">注意，如果变量名称或者值中用到</span> <span class="nb">true</span><span class="o">|</span><span class="nb">false</span><span class="err">，</span><span class="n">yes</span><span class="o">|</span><span class="n">no</span> <span class="err">等表达布尔含义的词汇，最好放到引号里，避免</span> <span class="n">YAML</span> <span class="err">自动解析某些内容为对应的布尔语义。</span>

<span class="nl">http:</span><span class="c1">//yaml.org/type/bool.html 中给出了这些特定词汇，包括</span>

<span class="n">y</span><span class="o">|</span><span class="n">Y</span><span class="o">|</span><span class="n">yes</span><span class="o">|</span><span class="n">Yes</span><span class="o">|</span><span class="nb">YES</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="n">no</span><span class="o">|</span><span class="n">No</span><span class="o">|</span><span class="nb">NO</span><span class="o">|</span><span class="nb">true</span><span class="o">|</span><span class="n">True</span><span class="o">|</span><span class="n">TRUE</span><span class="o">|</span><span class="nb">false</span><span class="o">|</span><span class="n">False</span><span class="o">|</span><span class="n">FALSE</span><span class="o">|</span><span class="n">on</span><span class="o">|</span><span class="n">On</span><span class="o">|</span><span class="n">ON</span><span class="o">|</span><span class="n">off</span><span class="o">|</span><span class="n">Off</span><span class="o">|</span><span class="n">OFF</span>
<span class="n">expose</span>

<span class="err">暴露端口，但不映射到宿主机，只被连接的服务访问。</span>

<span class="err">仅可以指定内部端口为参数</span>

<span class="nl">expose:</span>
 <span class="o">-</span> <span class="s">&quot;3000&quot;</span>
 <span class="o">-</span> <span class="s">&quot;8000&quot;</span>
<span class="n">external_links</span>

<span class="err">链接到</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span> <span class="err">外部的容器，甚至并非</span> <span class="n">Compose</span> <span class="err">管理的外部容器。参数格式跟</span> <span class="n">links</span> <span class="err">类似。</span>

<span class="nl">external_links:</span>
 <span class="o">-</span> <span class="n">redis_1</span>
 <span class="o">-</span> <span class="n">project_db_1</span><span class="o">:</span><span class="n">mysql</span>
 <span class="o">-</span> <span class="n">project_db_1</span><span class="o">:</span><span class="n">postgresql</span>
<span class="n">extra_hosts</span>

<span class="err">类似</span> <span class="n">Docker</span> <span class="err">中的</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">host</span> <span class="err">参数，指定额外的</span> <span class="n">host</span> <span class="err">名称映射信息。</span>

<span class="nl">extra_hosts:</span>
 <span class="o">-</span> <span class="s">&quot;googledns:8.8.8.8&quot;</span>
 <span class="o">-</span> <span class="s">&quot;dockerhub:52.1.157.61&quot;</span>
<span class="err">会在启动后的服务容器中</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="err">文件中添加如下两条条目。</span>

<span class="mf">8.8.8.8</span> <span class="n">googledns</span>
<span class="mf">52.1.157.61</span> <span class="n">dockerhub</span>
<span class="n">healthcheck</span>

<span class="err">通过命令检查容器是否健康运行。</span>

<span class="nl">healthcheck:</span>
  <span class="nl">test:</span> <span class="p">[</span><span class="s">&quot;CMD&quot;</span><span class="p">,</span> <span class="s">&quot;curl&quot;</span><span class="p">,</span> <span class="s">&quot;-f&quot;</span><span class="p">,</span> <span class="s">&quot;http://localhost&quot;</span><span class="p">]</span>
  <span class="nl">interval:</span> <span class="mi">1</span><span class="n">m30s</span>
  <span class="nl">timeout:</span> <span class="mi">10</span><span class="n">s</span>
  <span class="nl">retries:</span> <span class="mi">3</span>
<span class="n">image</span>

<span class="err">指定为镜像名称或镜像</span> <span class="n">ID</span><span class="err">。如果镜像在本地不存在，</span><span class="n">Compose</span> <span class="err">将会尝试拉去这个镜像。</span>

<span class="nl">image:</span> <span class="n">ubuntu</span>
<span class="nl">image:</span> <span class="n">orchardup</span><span class="o">/</span><span class="n">postgresql</span>
<span class="nl">image:</span> <span class="n">a4bc65fd</span>
<span class="n">labels</span>

<span class="err">为容器添加</span> <span class="n">Docker</span> <span class="err">元数据（</span><span class="n">metadata</span><span class="err">）信息。例如可以为容器添加辅助说明信息。</span>

<span class="nl">labels:</span>
  <span class="n">com</span><span class="p">.</span><span class="n">startupteam</span><span class="p">.</span><span class="n">description</span><span class="o">:</span> <span class="s">&quot;webapp for a startup team&quot;</span>
  <span class="n">com</span><span class="p">.</span><span class="n">startupteam</span><span class="p">.</span><span class="n">department</span><span class="o">:</span> <span class="s">&quot;devops department&quot;</span>
  <span class="n">com</span><span class="p">.</span><span class="n">startupteam</span><span class="p">.</span><span class="n">release</span><span class="o">:</span> <span class="s">&quot;rc3 for v1.0&quot;</span>
<span class="n">links</span>

<span class="err">链接到其它服务中的容器。使用服务名称（同时作为别名）或服务名称：服务别名</span> <span class="err">（</span><span class="n">SERVICE</span><span class="o">:</span><span class="n">ALIAS</span><span class="err">）</span> <span class="err">格式都可以。</span>

<span class="nl">links:</span>
 <span class="o">-</span> <span class="n">db</span>
 <span class="o">-</span> <span class="n">db</span><span class="o">:</span><span class="n">database</span>
 <span class="o">-</span> <span class="n">redis</span>
<span class="err">使用的别名将会自动在服务容器中的</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span> <span class="err">里创建。例如：</span>

<span class="mf">172.17.2.186</span>  <span class="n">db</span>
<span class="mf">172.17.2.186</span>  <span class="n">database</span>
<span class="mf">172.17.2.187</span>  <span class="n">redis</span>
<span class="err">被链接容器中相应的环境变量也将被创建。</span>

<span class="n">logging</span>

<span class="err">配置日志选项。</span>

<span class="nl">logging:</span>
  <span class="nl">driver:</span> <span class="n">syslog</span>
  <span class="nl">options:</span>
    <span class="n">syslog</span><span class="o">-</span><span class="n">address</span><span class="o">:</span> <span class="s">&quot;tcp://192.168.0.42:123&quot;</span>
<span class="err">目前支持三种日志驱动类型。</span>

<span class="nl">driver:</span> <span class="s">&quot;json-file&quot;</span>
<span class="nl">driver:</span> <span class="s">&quot;syslog&quot;</span>
<span class="nl">driver:</span> <span class="s">&quot;none&quot;</span>
<span class="n">options</span> <span class="err">配置日志驱动的相关参数。</span>

<span class="nl">options:</span>
  <span class="n">max</span><span class="o">-</span><span class="n">size</span><span class="o">:</span> <span class="s">&quot;200k&quot;</span>
  <span class="n">max</span><span class="o">-</span><span class="n">file</span><span class="o">:</span> <span class="s">&quot;10&quot;</span>
<span class="n">network_mode</span>

<span class="err">设置网络模式。使用和</span> <span class="n">docker</span> <span class="n">run</span> <span class="err">的</span> <span class="o">--</span><span class="n">net</span> <span class="err">参数一样的值。</span>

<span class="nl">network_mode:</span> <span class="s">&quot;bridge&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;host&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;none&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;service:[service name]&quot;</span>
<span class="nl">network_mode:</span> <span class="s">&quot;container:[container name/id]&quot;</span>
<span class="n">networks</span>

<span class="err">配置容器连接的网络。</span>

<span class="nl">version:</span> <span class="s">&quot;3&quot;</span>
<span class="nl">services:</span>

  <span class="n">some</span><span class="o">-</span><span class="n">service</span><span class="o">:</span>
    <span class="nl">networks:</span>
     <span class="o">-</span> <span class="n">some</span><span class="o">-</span><span class="n">network</span>
     <span class="o">-</span> <span class="n">other</span><span class="o">-</span><span class="n">network</span>

<span class="nl">networks:</span>
  <span class="n">some</span><span class="o">-</span><span class="n">network</span><span class="o">:</span>
  <span class="n">other</span><span class="o">-</span><span class="n">network</span><span class="o">:</span>
<span class="n">pid</span>

<span class="err">跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程</span> <span class="n">ID</span> <span class="err">来相互访问和操作。</span>

<span class="nl">pid:</span> <span class="s">&quot;host&quot;</span>
<span class="n">ports</span>

<span class="err">暴露端口信息。</span>

<span class="err">使用宿主：容器</span> <span class="err">（</span><span class="n">HOST</span><span class="o">:</span><span class="n">CONTAINER</span><span class="err">）格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</span>

<span class="nl">ports:</span>
 <span class="o">-</span> <span class="s">&quot;3000&quot;</span>
 <span class="o">-</span> <span class="s">&quot;8000:8000&quot;</span>
 <span class="o">-</span> <span class="s">&quot;49100:22&quot;</span>
 <span class="o">-</span> <span class="s">&quot;127.0.0.1:8001:8001&quot;</span>
<span class="err">注意：当使用</span> <span class="n">HOST</span><span class="o">:</span><span class="n">CONTAINER</span> <span class="err">格式来映射端口时，如果你使用的容器端口小于</span> <span class="mi">60</span> <span class="err">并且没放到引号里，可能会得到错误结果，因为</span> <span class="n">YAML</span> <span class="err">会自动解析</span> <span class="n">xx</span><span class="o">:</span><span class="n">yy</span> <span class="err">这种数字格式为</span> <span class="mi">60</span> <span class="err">进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</span>

<span class="n">secrets</span>

<span class="err">仅用于</span> <span class="n">Swarm</span> <span class="n">mode</span><span class="err">，详细内容请查看</span> <span class="n">Swarm</span> <span class="n">mode</span> <span class="err">一节。</span>

<span class="n">security_opt</span>

<span class="err">指定容器模板标签（</span><span class="n">label</span><span class="err">）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</span>

<span class="nl">security_opt:</span>
    <span class="o">-</span> <span class="n">label</span><span class="o">:</span><span class="n">user</span><span class="o">:</span><span class="n">USER</span>
    <span class="o">-</span> <span class="n">label</span><span class="o">:</span><span class="n">role</span><span class="o">:</span><span class="n">ROLE</span>
<span class="n">stop_signal</span>

<span class="err">设置另一个信号来停止容器。在默认情况下使用的是</span> <span class="n">SIGTERM</span> <span class="err">停止容器。</span>

<span class="nl">stop_signal:</span> <span class="n">SIGUSR1</span>
<span class="n">sysctls</span>

<span class="err">配置容器内核参数。</span>

<span class="nl">sysctls:</span>
  <span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">somaxconn</span><span class="o">:</span> <span class="mi">1024</span>
  <span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_syncookies</span><span class="o">:</span> <span class="mi">0</span>

<span class="nl">sysctls:</span>
  <span class="o">-</span> <span class="n">net</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">somaxconn</span><span class="o">=</span><span class="mi">1024</span>
  <span class="o">-</span> <span class="n">net</span><span class="p">.</span><span class="n">ipv4</span><span class="p">.</span><span class="n">tcp_syncookies</span><span class="o">=</span><span class="mi">0</span>
<span class="n">ulimits</span>

<span class="err">指定容器的</span> <span class="n">ulimits</span> <span class="err">限制值。</span>

<span class="err">例如，指定最大进程数为</span> <span class="mi">65535</span><span class="err">，指定文件句柄数为</span> <span class="mi">20000</span><span class="err">（软限制，应用可以随时修改，不能超过硬限制）</span> <span class="err">和</span> <span class="mi">40000</span><span class="err">（系统硬限制，只能</span> <span class="n">root</span> <span class="err">用户提高）。</span>

  <span class="nl">ulimits:</span>
    <span class="nl">nproc:</span> <span class="mi">65535</span>
    <span class="nl">nofile:</span>
      <span class="nl">soft:</span> <span class="mi">20000</span>
      <span class="nl">hard:</span> <span class="mi">40000</span>
<span class="n">volumes</span>

<span class="err">数据卷所挂载路径设置。可以设置宿主机路径</span> <span class="err">（</span><span class="n">HOST</span><span class="o">:</span><span class="n">CONTAINER</span><span class="err">）</span> <span class="err">或加上访问模式</span> <span class="err">（</span><span class="n">HOST</span><span class="o">:</span><span class="n">CONTAINER</span><span class="o">:</span><span class="n">ro</span><span class="err">）。</span>

<span class="err">该指令中路径支持相对路径。</span>

<span class="nl">volumes:</span>
 <span class="o">-</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
 <span class="o">-</span> <span class="n">cache</span><span class="o">/:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">cache</span>
 <span class="o">-</span> <span class="o">~/</span><span class="n">configs</span><span class="o">:/</span><span class="n">etc</span><span class="o">/</span><span class="n">configs</span><span class="o">/:</span><span class="n">ro</span>
<span class="err">其它指令</span>

<span class="err">此外，还有包括</span> <span class="n">domainname</span><span class="p">,</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ipc</span><span class="p">,</span> <span class="n">mac_address</span><span class="p">,</span> <span class="n">privileged</span><span class="p">,</span> <span class="n">read_only</span><span class="p">,</span> <span class="n">shm_size</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="n">stdin_open</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">working_dir</span> <span class="err">等指令，基本跟</span> <span class="n">docker</span> <span class="n">run</span> <span class="err">中对应参数的功能一致。</span>

<span class="err">指定服务容器启动后执行的入口文件。</span>

<span class="nl">entrypoint:</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">entrypoint</span><span class="p">.</span><span class="n">sh</span>
<span class="err">指定容器中运行应用的用户名。</span>

<span class="nl">user:</span> <span class="n">nginx</span>
<span class="err">指定容器中工作目录。</span>

<span class="nl">working_dir:</span> <span class="o">/</span><span class="n">code</span>
<span class="err">指定容器中搜索域名、主机名、</span><span class="n">mac</span> <span class="err">地址等。</span>

<span class="nl">domainname:</span> <span class="n">your_website</span><span class="p">.</span><span class="n">com</span>
<span class="nl">hostname:</span> <span class="n">test</span>
<span class="nl">mac_address:</span> <span class="mi">08</span><span class="o">-</span><span class="mo">00</span><span class="o">-</span><span class="mi">27</span><span class="o">-</span><span class="mo">00</span><span class="o">-</span><span class="mi">0</span><span class="n">C</span><span class="o">-</span><span class="mi">0</span><span class="n">A</span>
<span class="err">指定容器中</span>

<span class="nl">ipc:</span> <span class="n">host</span>
<span class="err">允许容器中运行一些特权命令。</span>

<span class="nl">privileged:</span> <span class="nb">true</span>
<span class="err">指定容器退出后的重启策略为始终重启。该命令对保持服务始终运行十分有效，在生产环境中推荐配置为</span> <span class="n">always</span> <span class="err">或者</span> <span class="n">unless</span><span class="o">-</span><span class="n">stopped</span><span class="err">。</span>

<span class="nl">restart:</span> <span class="n">always</span>
<span class="err">以只读模式挂载容器的</span> <span class="n">root</span> <span class="err">文件系统，意味着不能对容器内容进行修改。</span>

<span class="nl">read_only:</span> <span class="nb">true</span>
<span class="err">打开标准输入，可以接受外部输入。</span>

<span class="nl">stdin_open:</span> <span class="nb">true</span>
<span class="err">模拟一个假的远程控制台。</span>

<span class="nl">tty:</span> <span class="nb">true</span>
<span class="err">读取环境变量</span>

<span class="n">Compose</span> <span class="err">模板文件支持动态读取主机的系统环境变量。</span>

<span class="err">例如，下面的</span> <span class="n">Compose</span> <span class="err">文件将从运行它的环境中读取变量</span> <span class="err">$</span><span class="p">{</span><span class="n">MONGO_VERSION</span><span class="p">}</span> <span class="err">的值，并写入执行的指令中。</span>

<span class="nl">db:</span>
  <span class="nl">image:</span> <span class="s">&quot;mongo:${MONGO_VERSION}&quot;</span>
<span class="err">如果执行</span> <span class="n">MONGO_VERSION</span><span class="o">=</span><span class="mf">3.2</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="err">则会启动一个</span> <span class="n">mongo</span><span class="o">:</span><span class="mf">3.2</span> <span class="err">镜像的容器；如果执行</span> <span class="n">MONGO_VERSION</span><span class="o">=</span><span class="mf">2.8</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span> <span class="err">则会启动一个</span> <span class="n">mongo</span><span class="o">:</span><span class="mf">2.8</span> <span class="err">镜像的容器。</span>
</pre></div>


<h3 id="_2">场景案例</h3>
<h4 id="haproxy">haproxy</h4>
<p>我们创建一个经典的 Web 项目：一个 Haproxy，挂载三个 Web 容器。</p>
<p>创建一个 compose-haproxy-web 目录，作为项目工作目录，并在其中分别创建两个子目录：haproxy 和 web。</p>
<ul>
<li>web 子目录</li>
</ul>
<p>这里用 Python 程序来提供一个简单的 HTTP 服务，打印出访问者的 IP 和 实际的本地 IP。</p>
<p>编写一个 index.py 作为服务器文件，代码为</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/usr/bin/python</span>
<span class="c">#authors: yeasy.github.com</span>
<span class="c">#date: 2013-07-05</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">BaseHTTPServer</span>
<span class="kn">from</span> <span class="nn">SimpleHTTPServer</span> <span class="kn">import</span> <span class="n">SimpleHTTPRequestHandler</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>

<span class="k">class</span> <span class="nc">HandlerClass</span><span class="p">(</span><span class="n">SimpleHTTPRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_ip_address</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ifname</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span>
            <span class="mh">0x8915</span><span class="p">,</span>  <span class="c"># SIOCGIFADDR</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;256s&#39;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="p">)[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="s">&quot;200&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s">&quot;r&quot;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">request</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">time_now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip_address</span><span class="p">(</span><span class="s">&#39;eth0&#39;</span><span class="p">)</span>
        <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">address_string</span><span class="p">()</span>
        <span class="n">addr_pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addr_pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">del</span> <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span>
            <span class="n">request</span><span class="p">[</span><span class="n">addr_pair</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">num</span><span class="p">,</span><span class="n">ts</span><span class="p">]</span>
        <span class="nb">file</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;index.html&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;!DOCTYPE html&gt; &lt;html&gt; &lt;body&gt;&lt;center&gt;&lt;h1&gt;&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s"> face=</span><span class="se">\&quot;</span><span class="s">Georgia, Arial</span><span class="se">\&quot;</span><span class="s"> size=8&gt;&lt;em&gt;HA&lt;/em&gt;&lt;/font&gt; Webpage Visit Results&lt;/h1&gt;&lt;/center&gt;&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="s">&quot;LOCAL: &quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">guest</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_now</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s">font-size:150%</span><span class="se">\&quot;</span><span class="s"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s">red</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">blue</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p style=</span><span class="se">\&quot;</span><span class="s">font-size:150%</span><span class="se">\&quot;</span><span class="s"> &gt;#&quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span><span class="s">&quot;: &lt;font color=</span><span class="se">\&quot;</span><span class="s">maroon</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="n">pair</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="s">&quot;&lt;/font&gt; requests &quot;</span> <span class="o">+</span> <span class="s">&quot;from &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">navy</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">guest</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt to WebServer &amp;lt&lt;font color=</span><span class="se">\&quot;</span><span class="s">navy</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="o">+</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;&lt;/font&gt;&amp;gt&lt;/p&gt;&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/body&gt; &lt;/html&gt;&quot;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;pickle_data.txt&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ServerClass</span>  <span class="o">=</span> <span class="n">BaseHTTPServer</span><span class="o">.</span><span class="n">HTTPServer</span>
        <span class="n">Protocol</span>     <span class="o">=</span> <span class="s">&quot;HTTP/1.0&quot;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="s">&quot;0.0.0.0&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="mi">80</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">HandlerClass</span><span class="o">.</span><span class="n">protocol_version</span> <span class="o">=</span> <span class="n">Protocol</span>
        <span class="n">httpd</span> <span class="o">=</span> <span class="n">ServerClass</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="n">HandlerClass</span><span class="p">)</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">httpd</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;Serving HTTP on&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="n">sa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;...&quot;</span>
        <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<ul>
<li>生成一个临时的 index.html 文件，其内容会被 index.py 更新。</li>
</ul>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">touch</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
</pre></div>


<ul>
<li>Dockerfile</li>
</ul>
<div class="hlcode"><pre><span class="n">FROM</span> <span class="n">python</span><span class="o">:</span><span class="mf">2.7</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">code</span>
<span class="n">EXPOSE</span> <span class="mi">80</span>
<span class="n">CMD</span> <span class="n">python</span> <span class="n">index</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<ul>
<li>haproxy 目录 </li>
</ul>
<p>编写 haproxy.cfg 文件，内容为</p>
<div class="hlcode"><pre><span class="n">global</span>
  <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local0</span>
  <span class="n">log</span> <span class="mf">127.0.0.1</span> <span class="n">local1</span> <span class="n">notice</span>

<span class="n">defaults</span>
  <span class="n">log</span> <span class="n">global</span>
  <span class="n">mode</span> <span class="n">http</span>
  <span class="n">option</span> <span class="n">httplog</span>
  <span class="n">option</span> <span class="n">dontlognull</span>
  <span class="n">timeout</span> <span class="n">connect</span> <span class="mi">5000</span><span class="n">ms</span>
  <span class="n">timeout</span> <span class="n">client</span> <span class="mi">50000</span><span class="n">ms</span>
  <span class="n">timeout</span> <span class="n">server</span> <span class="mi">50000</span><span class="n">ms</span>

<span class="n">listen</span> <span class="n">stats</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">70</span>
    <span class="n">stats</span> <span class="n">enable</span>
    <span class="n">stats</span> <span class="n">uri</span> <span class="o">/</span>

<span class="n">frontend</span> <span class="n">balancer</span>
    <span class="n">bind</span> <span class="mf">0.0.0.0</span><span class="o">:</span><span class="mi">80</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">default_backend</span> <span class="n">web_backends</span>

<span class="n">backend</span> <span class="n">web_backends</span>
    <span class="n">mode</span> <span class="n">http</span>
    <span class="n">option</span> <span class="n">forwardfor</span>
    <span class="n">balance</span> <span class="n">roundrobin</span>
    <span class="n">server</span> <span class="n">weba</span> <span class="n">weba</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webb</span> <span class="n">webb</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">server</span> <span class="n">webc</span> <span class="n">webc</span><span class="o">:</span><span class="mi">80</span> <span class="n">check</span>
    <span class="n">option</span> <span class="n">httpchk</span> <span class="n">GET</span> <span class="o">/</span>
    <span class="n">http</span><span class="o">-</span><span class="n">check</span> <span class="n">expect</span> <span class="n">status</span> <span class="mi">200</span>
</pre></div>


<ul>
<li>docker-compose.yml</li>
</ul>
<p>编写 docker-compose.yml 文件，这个是 Compose 使用的主模板文件。内容十分简单，指定 3 个 web 容器，以及 1 个 haproxy 容器。</p>
<div class="hlcode"><pre><span class="nl">version:</span> <span class="s">&quot;3&quot;</span>
<span class="nl">services:</span>

  <span class="nl">weba:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>

  <span class="nl">webb:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>

  <span class="nl">webc:</span>
    <span class="nl">build:</span> <span class="p">.</span><span class="o">/</span><span class="n">web</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="mi">80</span>

  <span class="nl">haproxy:</span>
    <span class="nl">image:</span> <span class="n">haproxy</span><span class="o">:</span><span class="n">latest</span>
    <span class="nl">volumes:</span>
        <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">haproxy</span><span class="o">:/</span><span class="n">haproxy</span><span class="o">-</span><span class="n">override</span>
        <span class="o">-</span> <span class="p">.</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span><span class="o">:/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">haproxy</span><span class="o">/</span><span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span><span class="o">:</span><span class="n">ro</span>
    <span class="nl">ports:</span>
        <span class="o">-</span> <span class="s">&quot;80:80&quot;</span>
        <span class="o">-</span> <span class="s">&quot;70:70&quot;</span>
    <span class="nl">expose:</span>
        <span class="o">-</span> <span class="s">&quot;80&quot;</span>
        <span class="o">-</span> <span class="s">&quot;70&quot;</span>
</pre></div>


<ul>
<li>运行 compose 项目</li>
</ul>
<p>现在 compose-haproxy-web 目录结构如下：</p>
<div class="hlcode"><pre><span class="n">compose</span><span class="o">-</span><span class="n">haproxy</span><span class="o">-</span><span class="n">web</span>
<span class="err">├──</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="n">yml</span>
<span class="err">├──</span> <span class="n">haproxy</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">haproxy</span><span class="p">.</span><span class="n">cfg</span>
<span class="err">└──</span> <span class="n">web</span>
    <span class="err">├──</span> <span class="n">Dockerfile</span>
    <span class="err">├──</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span>
    <span class="err">└──</span> <span class="n">index</span><span class="p">.</span><span class="n">py</span>
</pre></div>


<p>在该目录下执行 docker-compose up 命令，会整合输出所有容器的输出。</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="n">up</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_webb_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_webc_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_weba_1</span><span class="p">...</span>
<span class="n">Recreating</span> <span class="n">composehaproxyweb_haproxy_1</span><span class="p">...</span>
<span class="n">Attaching</span> <span class="n">to</span> <span class="n">composehaproxyweb_webb_1</span><span class="p">,</span> <span class="n">composehaproxyweb_webc_1</span><span class="p">,</span> <span class="n">composehaproxyweb_weba_1</span><span class="p">,</span> <span class="n">composehaproxyweb_haproxy_1</span>
</pre></div>


<blockquote>
<p>此时访问本地的 80 端口，会经过 haproxy 自动转发到后端的某个 web 容器上，刷新页面，可以观察到访问的容器地址的变化。<br />
访问本地 70 端口，可以查看到 haproxy 的统计信息。</p>
</blockquote>
<h4 id="django">使用 Django</h4>
<ul>
<li>将使用 Docker Compose 配置并运行一个 Django/PostgreSQL 应用。</li>
</ul>
<p>第一步 编辑 Dockerfile 文件来指定 Docker 容器要安装内容</p>
<ul>
<li>应用将使用安装了 Python 以及必要依赖包的镜像。更多关于如何编写 Dockerfile 文件的信息可以查看 镜像创建 和 Dockerfile 使用。</li>
</ul>
<div class="hlcode"><pre><span class="n">FROM</span> <span class="n">python</span><span class="o">:</span><span class="mi">3</span>
<span class="n">ENV</span> <span class="n">PYTHONUNBUFFERED</span> <span class="mi">1</span>
<span class="n">RUN</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">code</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">code</span>
<span class="n">ADD</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
<span class="n">RUN</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="p">.</span><span class="n">txt</span>
<span class="n">ADD</span> <span class="p">.</span> <span class="o">/</span><span class="n">code</span><span class="o">/</span>
</pre></div>


<p>第二步，在 requirements.txt 文件里面写明需要安装的具体依赖包名</p>
<div class="hlcode"><pre><span class="n">Django</span><span class="o">&gt;=</span><span class="mf">1.8</span><span class="p">,</span><span class="o">&lt;</span><span class="mf">2.0</span>
<span class="n">psycopg2</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-01-02 08:56:17</p>
      </span>
    </div>

    
    
  </body>
</html>