<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>example - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Iptables">Iptables</a>&nbsp;&#187;&nbsp;example
    <span class="updated">Page Updated&nbsp;
      2018-11-27 18:45
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">example</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#example">example</a><ul>
<li><a href="#_1">关闭所有规则链接</a></li>
<li><a href="#_2">更改默认策略</a></li>
<li><a href="#_3">允许路由</a></li>
<li><a href="#icmp-ping">ICMP （PING）</a><ul>
<li><a href="#ping">允许来自外部的ping测试</a></li>
<li><a href="#ping_1">允许从本机ping外部主机</a></li>
<li><a href="#loopback">允许环回(loopback)访问</a></li>
</ul>
</li>
<li><a href="#ssh">SSH</a><ul>
<li><a href="#-m-state">-m state 方法</a></li>
<li><a href="#sshd">仅sshd</a></li>
<li><a href="#ssh_1">SSH 字典攻击</a></li>
<li><a href="#ssh_2">允许所有SSH连接请求</a></li>
<li><a href="#ssh_3">允许从本地发起的SSH连接</a></li>
<li><a href="#ssh_4">仅允许来自指定网络的SSH连接请求</a></li>
<li><a href="#ssh_5">仅允许从本地发起到指定网络的SSH连接请求</a></li>
<li><a href="#_4"></a></li>
</ul>
</li>
<li><a href="#http">HTTP</a><ul>
<li><a href="#-m-state_1">-m state 方法</a></li>
<li><a href="#http_1">仅http</a></li>
<li><a href="#httphttps">允许HTTP/HTTPS连接请求</a></li>
<li><a href="#https">允许从本地发起HTTPS连接</a></li>
</ul>
</li>
<li><a href="#22-80-ports">动态监控22， 80 ports</a></li>
<li><a href="#sshhttphttps">ssh，http，https 多端口</a></li>
<li><a href="#vnc">VNC</a></li>
<li><a href="#clean_inclean_in">自定义clean_in链，先经过clean_in 链处理</a></li>
<li><a href="#iptablesrecentdos">利用iptables的recent模块抵御DOS攻击</a></li>
<li><a href="#dns">允许出站DNS连接</a></li>
<li><a href="#nis">允许NIS连接</a></li>
<li><a href="#rsync">允许来自指定网络的rsync连接请求</a></li>
<li><a href="#mysql">允许来自指定网络的MySQL连接请求</a></li>
<li><a href="#sendmail-postfix">允许Sendmail, Postfix邮件服务</a></li>
<li><a href="#imapimaps">允许IMAP与IMAPS</a></li>
<li><a href="#pop3pop3s">允许POP3与POP3S</a></li>
<li><a href="#_5">负载平衡</a></li>
<li><a href="#_6">记录丢弃的数据包</a></li>
<li><a href="#openvpn">openvpn</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="example">example</h1>
<h2 id="_1">关闭所有规则链接</h2>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span> 

<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span> 

<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">DROP</span> 
</pre></div>


<h2 id="_2">更改默认策略</h2>
<p>当我们使用-L选项验证当前规则是发现，所有的链旁边都有policy ACCEPT标注，这表明当前链的默认策略为ACCEPT：</p>
<div class="hlcode"><pre><span class="cp"># iptables -L</span>
<span class="n">Chain</span> <span class="n">INPUT</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">target</span> <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span> <span class="n">destination</span>
<span class="n">ACCEPT</span> <span class="n">tcp</span> <span class="o">--</span> <span class="n">anywhere</span> <span class="n">anywhere</span> <span class="n">tcp</span> <span class="n">dpt</span><span class="o">:</span><span class="n">ssh</span>
<span class="n">DROP</span> <span class="n">all</span> <span class="o">--</span> <span class="n">anywhere</span> <span class="n">anywhere</span>

<span class="n">Chain</span> <span class="n">FORWARD</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">target</span> <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span> <span class="n">destination</span>

<span class="n">Chain</span> <span class="n">OUTPUT</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">target</span> <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span> <span class="n">destination</span>
</pre></div>


<p>这种情况下，如果没有明确添加DROP规则，那么默认情况下将采用ACCEPT策略进行过滤。除非：</p>
<p>为以上三个链单独添加DROP规则：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<p>更改默认策略：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">DROP</span>
</pre></div>


<h2 id="_3">允许路由</h2>
<p>如果本地主机有两块网卡，一块连接内网(eth0)，一块连接外网(eth1)，那么可以使用下面的规则将eth0的数据路由到eht1：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth1</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="icmp-ping">ICMP （PING）</h2>
<p>开放172.16.37.1对本机172.16.37.10的ping响应，和ping请求；注：若默认INPUT/OUPUT为DROP，请求和响应同时开启才能ping通</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="mi">0</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>
</pre></div>


<h3 id="ping">允许来自外部的ping测试</h3>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="n">echo</span><span class="o">-</span><span class="n">request</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="n">echo</span><span class="o">-</span><span class="n">reply</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="ping_1">允许从本机ping外部主机</h3>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="n">echo</span><span class="o">-</span><span class="n">request</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="n">echo</span><span class="o">-</span><span class="n">reply</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="loopback">允许环回(loopback)访问</h3>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">lo</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">lo</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="ssh">SSH</h2>
<h3 id="-m-state">-m state 方法</h3>
<p>默认链策略为DROP的情况下，进行防火墙设置</p>
<div class="hlcode"><pre><span class="cp"># 1.删除现有规则</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">F</span>

<span class="cp"># 2.配置默认链策略</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>

<span class="cp"># 3.允许接收远程主机的SSH请求</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># 4.允许发送本地主机的SSH响应</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<blockquote>
<p>-m state: 启用状态匹配模块（state matching module） </p>
<p>–-state: 状态匹配模块的参数。当SSH客户端第一个数据包到达服务器时，状态字段为NEW；建立连接后数据包的状态字段都是ESTABLISHED </p>
<p>–sport 22: sshd监听22端口，同时也通过该端口和客户端建立连接、传送数据。因此对于SSH服务器而言，源端口就是22 </p>
<p>–dport 22: ssh客户端程序可以从本机的随机端口与SSH服务器的22端口建立连接。因此对于SSH客户端而言，目的端口就是22 </p>
</blockquote>
<p>如果服务器也需要使用SSH连接其他远程主机，则还需要增加以下配置：</p>
<div class="hlcode"><pre><span class="cp"># 1.送出的数据包目的端口为22</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># 2.接收的数据包源端口为22</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="sshd">仅sshd</h3>
<p>本机IP172.16.37.10，仅允许172.16.37.1访问sshd服务</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>
</pre></div>


<p>本例实现的规则将仅允许SSH数据包通过本地计算机，其他一切连接（包括ping）都将被拒绝。</p>
<div class="hlcode"><pre><span class="cp"># 1.清空所有iptables规则</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">F</span>

<span class="cp"># 2.接收目标端口为22的数据包</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># 3.拒绝所有其他数据包</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<h3 id="ssh_1">SSH 字典攻击</h3>
<div class="hlcode"><pre><span class="cp"># Prevent SSH Attack</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">recent</span> <span class="o">--</span><span class="n">set</span> <span class="o">--</span><span class="n">name</span> <span class="n">SSH</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">recent</span> <span class="o">--</span><span class="n">update</span> <span class="o">--</span><span class="n">seconds</span> <span class="mi">60</span> <span class="o">--</span><span class="n">hitcount</span> <span class="mi">3</span> <span class="o">--</span><span class="n">name</span> <span class="n">SSH</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="cp"># Enable Normal SSH Connection</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="ssh_2">允许所有SSH连接请求</h3>
<p>本规则允许所有来自外部的SSH连接请求，也就是说，只允许<strong>进入eth0接口，并且目的端口为22的数据包</strong></p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="ssh_3">允许从本地发起的SSH连接</h3>
<p>本规则和上述规则有所不同，本规则意在允许本机发起SSH连接，上面的规则与此正好相反。</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="ssh_4">仅允许来自指定网络的SSH连接请求</h3>
<p>以下规则仅允许来自192.168.100.0/24的网络：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168.100.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<p>上例中，你也可以使用<strong>-s 192.168.100.0/255.255.255.0</strong>作为网络地址。当然使用上面的CIDR地址更容易让人明白。</p>
<h3 id="ssh_5">仅允许从本地发起到指定网络的SSH连接请求</h3>
<p>以下规则仅允许从本地主机连接到<strong>192.168.100.0/24</strong>的网络：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">d</span> <span class="mf">192.168.100.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="_4"></h3>
<h2 id="http">HTTP</h2>
<h3 id="-m-state_1">-m state 方法</h3>
<div class="hlcode"><pre><span class="cp"># 1.删除现有规则</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">F</span>

<span class="cp"># 2.配置默认链策略</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">FORWARD</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>

<span class="cp"># 3.允许接收远程主机的HTTP请求</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># 4.允许发送本地主机的HTTP响应</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="http_1">仅http</h3>
<p>本机IP172.16.37.10，允许172.16.37.1访问httpd服务</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.37.10</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.37.1</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">INPUT</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">P</span> <span class="n">OUTPUT</span> <span class="n">DROP</span>
</pre></div>


<h3 id="httphttps">允许HTTP/HTTPS连接请求</h3>
<div class="hlcode"><pre><span class="cp"># 1.允许HTTP连接：80端口</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># 2.允许HTTPS连接：443端口</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h3 id="https">允许从本地发起HTTPS连接</h3>
<p>本规则可以允许用户从本地主机发起HTTPS连接，从而访问Internet。</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<p>类似的，你可以设置允许HTTP协议（80端口）。</p>
<h2 id="22-80-ports">动态监控22， 80 ports</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">d</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">d</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="sshhttphttps">ssh，http，https 多端口</h2>
<p>允许172.16.100.11对本机的ssh,http,https访问</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="mi">1</span> <span class="o">-</span><span class="n">d</span> <span class="mf">172.16.100.11</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">multiport</span> <span class="o">--</span><span class="n">dports</span> <span class="mi">22</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">OUTPUT</span> <span class="mi">1</span> <span class="o">-</span><span class="n">s</span> <span class="mf">172.16.100.11</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">mmultiport</span> <span class="o">--</span><span class="n">sports</span> <span class="mi">22</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="mi">443</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="vnc">VNC</h2>
<div class="hlcode"><pre><span class="cp"># Open VNC for USER1</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">5800</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">5900</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">6000</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="cp"># Open VNC for USER2</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">5801</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">5901</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">RH</span><span class="o">-</span><span class="n">Firewall</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">6001</span>  <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="clean_inclean_in">自定义clean_in链，先经过clean_in 链处理</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">N</span> <span class="n">clean_in</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">clean_in</span> <span class="o">-</span><span class="n">d</span> <span class="mf">255.255.255.255</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">clean_in</span> <span class="o">-</span><span class="n">d</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">clean_in</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">!</span> <span class="o">--</span><span class="n">syn</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">clean_in</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">tcp</span><span class="o">-</span><span class="n">flags</span> <span class="n">ALL</span> <span class="n">NONE</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">clean_in</span> <span class="o">-</span><span class="n">d</span> <span class="mf">10.76.33.201</span> <span class="o">-</span><span class="n">j</span> <span class="n">RETURN</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">clean_in</span>
<span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">n</span> <span class="o">--</span><span class="n">line</span><span class="o">-</span><span class="n">numbers</span>
<span class="n">Chain</span> <span class="n">INPUT</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">num</span>  <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span>               <span class="n">destination</span>         
<span class="mi">1</span>    <span class="n">clean_in</span>   <span class="n">all</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>           
<span class="mi">2</span>    <span class="n">REJECT</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">STRING</span> <span class="n">match</span> <span class="s">&quot;h7n9&quot;</span> <span class="n">ALGO</span> <span class="n">name</span> <span class="n">kmp</span> <span class="n">TO</span> <span class="mi">65535</span> <span class="n">reject</span><span class="o">-</span><span class="n">with</span> <span class="n">icmp</span><span class="o">-</span><span class="n">port</span><span class="o">-</span><span class="n">unreachable</span>
<span class="mi">3</span>    <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">state</span> <span class="n">RELATED</span><span class="p">,</span><span class="n">ESTABLISHED</span>
<span class="mi">4</span>    <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">multiport</span> <span class="n">dports</span> <span class="mi">21</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span><span class="mi">80</span> <span class="n">state</span> <span class="n">NEW</span>
<span class="mi">5</span>    <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">tcp</span> <span class="n">dpt</span><span class="o">:</span><span class="mi">21</span> <span class="n">state</span> <span class="n">NEW</span>
<span class="mi">6</span>    <span class="n">ACCEPT</span>     <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">RELATED</span><span class="p">,</span><span class="n">ESTABLISHED</span>
<span class="mi">7</span>    <span class="n">LOG</span>        <span class="n">icmp</span> <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">icmp</span> <span class="n">type</span> <span class="mi">8</span> <span class="n">LOG</span> <span class="n">flags</span> <span class="mi">0</span> <span class="n">level</span> <span class="mi">4</span> <span class="n">prefix</span> <span class="err">`</span><span class="o">--</span> <span class="n">firewall</span> <span class="n">log</span> <span class="k">for</span> <span class="n">icmp</span> <span class="o">--</span><span class="err">&#39;</span>
<span class="mi">8</span>    <span class="n">ACCEPT</span>     <span class="n">icmp</span> <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>        <span class="n">icmp</span> <span class="n">type</span> <span class="mi">8</span> <span class="n">limit</span><span class="o">:</span> <span class="n">avg</span> <span class="mi">5</span><span class="o">/</span><span class="n">min</span> <span class="n">burst</span> <span class="mi">6</span>

<span class="n">Chain</span> <span class="n">FORWARD</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">num</span>  <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span>               <span class="n">destination</span>         

<span class="n">Chain</span> <span class="n">OUTPUT</span> <span class="p">(</span><span class="n">policy</span> <span class="n">ACCEPT</span><span class="p">)</span>
<span class="n">num</span>  <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span>               <span class="n">destination</span>         
<span class="mi">1</span>    <span class="n">REJECT</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="mf">10.76.33.201</span>         <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>           <span class="n">STRING</span> <span class="n">match</span> <span class="s">&quot;h7n9&quot;</span> <span class="n">ALGO</span> <span class="n">name</span> <span class="n">kmp</span> <span class="n">TO</span> <span class="mi">65535</span> <span class="n">reject</span><span class="o">-</span><span class="n">with</span> <span class="n">icmp</span><span class="o">-</span><span class="n">port</span><span class="o">-</span><span class="n">unreachable</span>
<span class="mi">2</span>    <span class="n">ACCEPT</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="mf">10.76.33.201</span>         <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>           <span class="n">state</span> <span class="n">RELATED</span><span class="p">,</span><span class="n">ESTABLISHED</span>

<span class="n">Chain</span> <span class="n">clean_in</span> <span class="p">(</span><span class="mi">1</span> <span class="n">references</span><span class="p">)</span>
<span class="n">num</span>  <span class="n">target</span>     <span class="n">prot</span> <span class="n">opt</span> <span class="n">source</span>               <span class="n">destination</span>         
<span class="mi">1</span>    <span class="n">DROP</span>       <span class="n">icmp</span> <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">255.255.255.255</span>     
<span class="mi">2</span>    <span class="n">DROP</span>       <span class="n">icmp</span> <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>       
<span class="mi">3</span>    <span class="n">DROP</span>       <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>           <span class="n">tcp</span> <span class="n">flags</span><span class="o">:!</span><span class="mh">0x17</span><span class="o">/</span><span class="mh">0x02</span> <span class="n">state</span> <span class="n">NEW</span>
<span class="mi">4</span>    <span class="n">DROP</span>       <span class="n">tcp</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>           <span class="n">tcp</span> <span class="n">flags</span><span class="o">:</span><span class="mh">0x3F</span><span class="o">/</span><span class="mh">0x00</span>
<span class="mi">5</span>    <span class="n">RETURN</span>     <span class="n">all</span>  <span class="o">--</span>  <span class="mf">0.0.0.0</span><span class="o">/</span><span class="mi">0</span>            <span class="mf">10.76.33.201</span>       
</pre></div>


<h2 id="iptablesrecentdos">利用iptables的recent模块抵御DOS攻击</h2>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">connlimit</span> <span class="o">--</span><span class="n">connlimit</span><span class="o">-</span><span class="n">above</span> <span class="mi">3</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">recent</span> <span class="o">--</span><span class="n">set</span> <span class="o">--</span><span class="n">name</span> <span class="n">SSH</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">recent</span> <span class="o">--</span><span class="n">update</span> <span class="o">--</span><span class="n">seconds</span> <span class="mi">300</span> <span class="o">--</span><span class="n">hitcount</span> <span class="mi">3</span> <span class="o">--</span><span class="n">name</span> <span class="n">SSH</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<blockquote>
<p>利用connlimit模块将单IP并发设置为3；会误杀使用NAT上网的用户，可以根据实际情况增大该值。 </p>
<p>利用recent和state模块限制单IP在 300s 内只能与本机建立3个新连接，被限制5mins后即可恢复访问。 </p>
<p>第二句：记录访问tcp 22端口的新连接，记录名称为SSH。--set 记录数据包的来源IP，如果IP已经存在将更新已经存在的条目 </p>
<p>第三句：SSH记录中的IP，300s内发起超过3次连接则拒绝此IP的连接 </p>
<p>​               --update 每次建立连接都更新列表 </p>
<p>​               --seconds 必须与--rcheck或者--update同时使用 </p>
<p>​               --hitcount 必须与--rcheck或者--update同时使用 </p>
</blockquote>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">m</span> <span class="n">limit</span> <span class="o">--</span><span class="n">limit</span> <span class="mi">25</span><span class="o">/</span><span class="n">minute</span> <span class="o">--</span><span class="n">limit</span><span class="o">-</span><span class="n">burst</span> <span class="mi">100</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="dns">允许出站DNS连接</h2>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">53</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">53</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="nis">允许NIS连接</h2>
<p>如果你在使用NIS管理你的用户账户，你需要允许NIS连接。即使你已允许SSH连接，你仍需允许NIS相关的ypbind连接，否则用户将无法登陆。NIS端口是动态的，当ypbind启动的时候，它会自动分配端口。因此，首先我们需要获取端口号，本例中使用的端口是853和850：</p>
<div class="hlcode"><pre><span class="n">rpcinfo</span> <span class="o">-</span><span class="n">p</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">ypbind</span>
</pre></div>


<p>然后，允许连接到111端口的请求数据包，以及ypbind使用到的端口：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">111</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">111</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">853</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">853</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">850</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">850</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<p>以上做法在你重启系统后将失效，因为ypbind会重新指派端口。我们有两种解决方法：<br />
1.为NIS使用静态IP地址<br />
2.每次系统启动时调用脚本获得NIS相关端口，并根据上述iptables规则添加到filter表中去。</p>
<h2 id="rsync">允许来自指定网络的rsync连接请求</h2>
<p>你可能启用了rsync服务，但是又不想让rsync暴露在外，只希望能够从内部网络（192.168.101.0/24）访问即可：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168.101.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">873</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">873</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="mysql">允许来自指定网络的MySQL连接请求</h2>
<p>你可能启用了MySQL服务，但只希望DBA与相关开发人员能够从内部网络（192.168.100.0/24）直接登录数据库：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168.100.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">3306</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">3306</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="sendmail-postfix">允许Sendmail, Postfix邮件服务</h2>
<p>邮件服务都使用了25端口，我们只需要允许来自25端口的连接请求即可。</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">25</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">25</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="imapimaps">允许IMAP与IMAPS</h2>
<div class="hlcode"><pre><span class="cp"># IMAP：143</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">143</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">143</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># IMAPS：993</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">993</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">993</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="pop3pop3s">允许POP3与POP3S</h2>
<div class="hlcode"><pre><span class="cp"># POP3：110</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">110</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">110</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="cp"># POP3S：995</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">995</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span><span class="p">,</span><span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">sport</span> <span class="mi">995</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>


<h2 id="_5">负载平衡</h2>
<p>可以利用iptables的<strong>-m nth</strong>扩展，及其参数（–counter 0 –every 3 –packet x），进行DNAT路由设置（-A PREROUTING -j DNAT –to-destination），从而将负载平均分配给3台服务器：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">nth</span> <span class="o">--</span><span class="n">counter</span> <span class="mi">0</span> <span class="o">--</span><span class="n">every</span> <span class="mi">3</span> <span class="o">--</span><span class="n">packet</span> <span class="mi">0</span> <span class="o">-</span><span class="n">j</span> <span class="n">DNAT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">destination</span> <span class="mf">192.168.1.101</span><span class="o">:</span><span class="mi">443</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">nth</span> <span class="o">--</span><span class="n">counter</span> <span class="mi">0</span> <span class="o">--</span><span class="n">every</span> <span class="mi">3</span> <span class="o">--</span><span class="n">packet</span> <span class="mi">1</span> <span class="o">-</span><span class="n">j</span> <span class="n">DNAT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">destination</span> <span class="mf">192.168.1.102</span><span class="o">:</span><span class="mi">443</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">i</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">443</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">m</span> <span class="n">nth</span> <span class="o">--</span><span class="n">counter</span> <span class="mi">0</span> <span class="o">--</span><span class="n">every</span> <span class="mi">3</span> <span class="o">--</span><span class="n">packet</span> <span class="mi">2</span> <span class="o">-</span><span class="n">j</span> <span class="n">DNAT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">destination</span> <span class="mf">192.168.1.103</span><span class="o">:</span><span class="mi">443</span>
</pre></div>


<h2 id="_6">记录丢弃的数据包</h2>
<div class="hlcode"><pre><span class="cp"># 1.新建名为LOGGING的链</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">N</span> <span class="n">LOGGING</span>

<span class="cp"># 2.将所有来自INPUT链中的数据包跳转到LOGGING链中</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">LOGGING</span>

<span class="cp"># 3.指定自定义的日志前缀&quot;IPTables Packet Dropped: &quot;</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">LOGGING</span> <span class="o">-</span><span class="n">m</span> <span class="n">limit</span> <span class="o">--</span><span class="n">limit</span> <span class="mi">2</span><span class="o">/</span><span class="n">min</span> <span class="o">-</span><span class="n">j</span> <span class="n">LOG</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">prefix</span> <span class="s">&quot;IPTables Packet Dropped: &quot;</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="mi">7</span>

<span class="cp"># 4.丢弃这些数据包</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">LOGGING</span> <span class="o">-</span><span class="n">j</span> <span class="n">DROP</span>
</pre></div>


<h2 id="openvpn">openvpn</h2>
<p>这里以用于配置OpenVPN的NAT转发规则为例进行说明，希望读者能进一步了解规则设置的方法：</p>
<div class="hlcode"><pre><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.8.0.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">o</span> <span class="n">venet0</span> <span class="o">-</span><span class="n">j</span> <span class="n">MASQUERADE</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">lo</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="o">!</span> <span class="n">lo</span> <span class="o">-</span><span class="n">d</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">ESTABLISHED</span><span class="p">,</span><span class="n">RELATED</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">OUTPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">80</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">3306</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">22</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">PREROUTING</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">-</span><span class="n">m</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">53</span> <span class="o">-</span><span class="n">j</span> <span class="n">DNAT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">destination</span> <span class="mf">8.8.8.8</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">1194</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="mf">10.8.0.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">p</span> <span class="n">all</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">d</span> <span class="mf">10.8.0.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">i</span> <span class="n">tun</span><span class="o">+</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">i</span> <span class="n">tun</span><span class="o">+</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">icmp</span> <span class="o">-</span><span class="n">m</span> <span class="n">icmp</span> <span class="o">--</span><span class="n">icmp</span><span class="o">-</span><span class="n">type</span> <span class="mi">8</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">m</span> <span class="n">limit</span> <span class="o">--</span><span class="n">limit</span> <span class="mi">5</span><span class="o">/</span><span class="n">min</span> <span class="o">-</span><span class="n">j</span> <span class="n">LOG</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">prefix</span> <span class="s">&quot;iptables denied: &quot;</span> <span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">level</span> <span class="mi">7</span>

<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>
<span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">FORWARD</span> <span class="o">-</span><span class="n">j</span> <span class="n">REJECT</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-07-02 09:31:50</p>
      </span>
    </div>

    
    
  </body>
</html>