<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>vnc - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Linux">Linux</a>&nbsp;&#187;&nbsp;vnc
    <span class="updated">Page Updated&nbsp;
      2018-09-27 15:05
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">vnc</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#vnc">vnc</a><ul>
<li><a href="#centos">CentOS</a></li>
<li><a href="#ubuntu">Ubuntu</a></li>
<li><a href="#debian-8">Debian 8</a></li>
<li><a href="#os-x">OS X</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="vnc">vnc</h1>
<h2 id="centos">CentOS</h2>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">yum</span> <span class="n">groupinstall</span> <span class="o">-</span><span class="n">y</span> <span class="s">&quot;GNOME Desktop&quot;</span>
<span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">tigervnc</span><span class="o">-</span><span class="n">server</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">vncserver</span><span class="err">@</span><span class="p">.</span><span class="n">service</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">vncserver</span><span class="err">@</span><span class="o">:</span><span class="mf">1.</span><span class="n">service</span>

<span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">vncserver</span><span class="err">@</span><span class="o">:</span><span class="mf">1.</span><span class="n">service</span>


<span class="n">ExecStartPre</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">%</span><span class="n">i</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">||</span> <span class="o">:</span><span class="err">&#39;</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">sbin</span><span class="o">/</span><span class="n">runuser</span> <span class="o">-</span><span class="n">l</span> <span class="n">rick</span> <span class="o">-</span><span class="n">c</span> <span class="s">&quot;/usr/bin/vncserver %i -geometry 1280x1024&quot;</span> 
<span class="n">PIDFile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">rick</span><span class="o">/</span><span class="p">.</span><span class="n">vnc</span><span class="o">/%</span><span class="n">H</span><span class="o">%</span><span class="n">i</span><span class="p">.</span><span class="n">pid</span>
<span class="n">ExecStop</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">%</span><span class="n">i</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">||</span> <span class="o">:</span><span class="err">&#39;</span>


<span class="n">su</span> <span class="o">-</span> <span class="n">rick</span>
<span class="n">vncserver</span>
</pre></div>


<h2 id="ubuntu">Ubuntu</h2>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> 

<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span>  <span class="n">tightvncserver</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">gnome</span><span class="o">-</span><span class="n">desktop</span> <span class="n">lxde</span>


<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">gnome</span><span class="o">-</span><span class="n">session</span> <span class="n">gdm3</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">tasksel</span>
<span class="n">sudo</span> <span class="n">tasksel</span> <span class="n">install</span> <span class="n">ubuntu</span><span class="o">-</span><span class="n">desktop</span>
</pre></div>


<div class="hlcode"><pre><span class="n">adduser</span> <span class="n">vnc</span>
<span class="n">passwd</span> <span class="n">vnc</span>

<span class="n">echo</span> <span class="s">&quot;%vnc     ALL=(ALL)       NOPASSWD: ALL&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sudoers</span>

<span class="n">echo</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">startlxde</span><span class="err">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/</span><span class="p">.</span><span class="n">vnc</span><span class="o">/</span><span class="n">xstartup</span>

<span class="n">vncserver</span>
<span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">:</span><span class="mi">1</span>
</pre></div>


<ul>
<li>VNC Service File</li>
</ul>
<div class="hlcode"><pre><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">vncserver</span><span class="err">@</span><span class="p">.</span><span class="n">service</span> 
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Start</span> <span class="n">TightVNC</span> <span class="n">server</span> <span class="n">at</span> <span class="n">startup</span>
<span class="n">After</span><span class="o">=</span><span class="n">syslog</span><span class="p">.</span><span class="n">target</span> <span class="n">network</span><span class="p">.</span><span class="n">target</span>

<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">forking</span>
<span class="n">User</span><span class="o">=</span><span class="n">vnc</span>
<span class="n">PAMName</span><span class="o">=</span><span class="n">login</span>
<span class="n">PIDFile</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">vnc</span><span class="o">/</span><span class="p">.</span><span class="n">vnc</span><span class="o">/%</span><span class="n">H</span><span class="o">:%</span><span class="n">i</span><span class="p">.</span><span class="n">pid</span>
<span class="n">ExecStartPre</span><span class="o">=-/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">:%</span><span class="n">i</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vncserver</span> <span class="o">-</span><span class="n">depth</span> <span class="mi">24</span> <span class="o">-</span><span class="n">geometry</span> <span class="mi">1280</span><span class="n">x800</span> <span class="o">:%</span><span class="n">i</span>
<span class="n">ExecStop</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">:%</span><span class="n">i</span>

<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
</pre></div>


<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">vncserver</span><span class="err">@</span><span class="mf">1.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">vncserver</span><span class="err">@</span><span class="mf">1.</span><span class="n">service</span>
</pre></div>


<h2 id="debian-8">Debian 8</h2>
<div class="hlcode"><pre><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">upgrade</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">xfce4</span> <span class="n">xfce4</span><span class="o">-</span><span class="n">goodies</span> <span class="n">gnome</span><span class="o">-</span><span class="n">icon</span><span class="o">-</span><span class="n">theme</span> <span class="n">tightvncserver</span> <span class="n">xfonts</span><span class="o">-</span><span class="n">base</span> <span class="n">iceweasel</span>
</pre></div>


<div class="hlcode"><pre><span class="n">adduser</span> <span class="n">vnc</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">sudo</span>
<span class="n">gpasswd</span> <span class="o">-</span><span class="n">a</span> <span class="n">vnc</span> <span class="n">sudo</span>
<span class="n">su</span> <span class="o">-</span> <span class="n">vnc</span>
<span class="n">vncserver</span>
<span class="n">vncserver</span> <span class="o">-</span><span class="n">kill</span> <span class="o">:</span><span class="mi">1</span>
<span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">myvncserver</span>
</pre></div>


<p>Add these contents exactly. This script provides VNC with a few parameters for startup.</p>
<p>/usr/local/bin/myvncserver</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/bash</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;$PATH:/usr/bin/&quot;</span>
<span class="nv">DISPLAY</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="nv">DEPTH</span><span class="o">=</span><span class="s2">&quot;16&quot;</span>
<span class="nv">GEOMETRY</span><span class="o">=</span><span class="s2">&quot;1024x768&quot;</span>
<span class="nv">OPTIONS</span><span class="o">=</span><span class="s2">&quot;-depth ${DEPTH} -geometry ${GEOMETRY} :${DISPLAY}&quot;</span>

<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
start<span class="o">)</span>
/usr/bin/vncserver <span class="k">${</span><span class="nv">OPTIONS</span><span class="k">}</span>
;;

stop<span class="o">)</span>
/usr/bin/vncserver -kill :<span class="k">${</span><span class="nv">DISPLAY</span><span class="k">}</span>
;;

restart<span class="o">)</span>
<span class="nv">$0</span> stop
<span class="nv">$0</span> start
;;
<span class="k">esac</span>
<span class="nb">exit </span>0
</pre></div>
</td></tr></table>

<p>Make the file executable:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">myvncserver</span>
</pre></div>


<p>Our script will help us to modify settings and start/stop VNC Server easily.</p>
<p>If you'd like, you can call the script manually to start/stop VNC Server on port 5901 with your desired configuration.<code>sudo /usr/local/bin/myvncserver start sudo /usr/local/bin/myvncserver stop sudo /usr/local/bin/myvncserver restart</code></p>
<p>Copy these commands to the service file. Our service will simply call the startup script above with the user vnc</p>
<p>/lib/systemd/system/myvncserver.service</p>
<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Manage VNC Server on this droplet</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/local/bin/myvncserver start</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/local/bin/myvncserver stop</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/usr/local/bin/myvncserver restart</span>
<span class="na">User</span><span class="o">=</span><span class="s">vnc</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>Now we can reload <code>systemctl</code> and enable our service:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<p>You've enabled your new service now. Use these commands to start, stop or restart the service using the <code>systemctl</code> command:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<ul>
<li>Securing Your VNC Server with SSH Tunneling</li>
</ul>
<p>First, stop the VNC server:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<p>Edit your configuration script:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">myvncserver</span>
</pre></div>


<p>Change this line:</p>
<p>/usr/local/bin/myvncserver</p>
<div class="hlcode"><pre>OPTIONS=&quot;-depth <span class="cp">${</span><span class="n">DEPTH</span><span class="cp">}</span> -geometry <span class="cp">${</span><span class="n">GEOMETRY</span><span class="cp">}</span> :<span class="cp">${</span><span class="n">DISPLAY</span><span class="cp">}</span>&quot;
</pre></div>


<p>Replace it with:</p>
<p>/usr/local/bin/myvncserver</p>
<div class="hlcode"><pre>OPTIONS=&quot;-depth <span class="cp">${</span><span class="n">DEPTH</span><span class="cp">}</span> -geometry <span class="cp">${</span><span class="n">GEOMETRY</span><span class="cp">}</span> :<span class="cp">${</span><span class="n">DISPLAY</span><span class="cp">}</span> -localhost&quot;
</pre></div>


<p>Restart the VNC server:</p>
<div class="hlcode"><pre><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">myvncserver</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<ul>
<li>Windows client</li>
</ul>
<p>We will use PuTTY to create an SSH Tunnel and then connect through the tunnel we have created.</p>
<p>Open PuTTY.</p>
<p>From the left menu, go to the <strong>Connection-&gt;SSH-&gt;Tunnels</strong> section.</p>
<p>In the <strong>Add New Forwarded Port</strong> section, enter <code>5901</code> as <strong>Source port</strong> and <code>localhost:5901</code> as <strong>Destination</strong>.</p>
<p>Click the <strong>Add</strong> button.</p>
<p><img alt="PuTTY SSH Tunnel Configuration" src="https://assets.digitalocean.com/articles/vnc-debian8/jWDVCt9.png" /></p>
<p>You can now go to the <strong>Session</strong> section in the left menu.</p>
<p>Enter your Droplet's IP address in the <strong>Host Name (or IP address)</strong> field.</p>
<p>Click the <strong>Open</strong> button to connect. You can also save these options for later use.</p>
<p><img alt="PuTTY SSH Connection" src="https://assets.digitalocean.com/articles/vnc-debian8/zvIl1fJ.png" /></p>
<p>Log in with your <strong>vnc</strong> user.</p>
<p>Keep the PuTTY window open while you make your VNC connection.</p>
<p>Now you can use your VNC viewer as usual. Just enter <strong>localhost::5901</strong> as the address, and keep your SSH connection live in the background.</p>
<p><img alt="UltraVNC Viewer: localhost::5901" src="https://assets.digitalocean.com/articles/vnc-debian8/FZWF3UH.png" /></p>
<h2 id="os-x">OS X</h2>
<ul>
<li>To establish an SSH tunnel, use the following line in Terminal</li>
</ul>
<div class="hlcode"><pre><span class="n">ssh</span> <span class="n">vnc</span><span class="err">@</span><span class="n">your_server_ip</span> <span class="o">-</span><span class="n">L</span> <span class="mi">5901</span><span class="o">:</span><span class="n">localhost</span><span class="o">:</span><span class="mi">5901</span>
</pre></div>


<p>Authenticate as normal for the <strong>vnc</strong> user for SSH. Then, in the Screen Sharing app, use <strong>localhost:5901</strong>.</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-05-01 20:48:47</p>
      </span>
    </div>

    
    
  </body>
</html>