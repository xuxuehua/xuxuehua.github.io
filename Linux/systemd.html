<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>systemd - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Linux">Linux</a>&nbsp;&#187;&nbsp;systemd
    <span class="updated">Page Updated&nbsp;
      2018-07-30 18:13
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">systemd</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#systemd">systemd</a><ul>
<li><a href="#_1">特点</a></li>
<li><a href="#commands">Commands</a><ul>
<li><a href="#systemctl">systemctl</a><ul>
<li><a href="#list-units-unit">List-units 列出unit</a></li>
</ul>
</li>
<li><a href="#systemd-analyze">systemd-analyze 耗时分析</a></li>
<li><a href="#hostnamectl">hostnamectl 主机信息</a></li>
<li><a href="#localectl">localectl 本地设置</a></li>
<li><a href="#timedatectl">timedatectl 时区设置</a></li>
<li><a href="#loginctl">loginctl 登陆信息</a></li>
<li><a href="#journalctl">journalctl 日志</a></li>
</ul>
</li>
<li><a href="#unit">[Unit]</a><ul>
<li><a href="#description">Description</a></li>
<li><a href="#documentation">Documentation</a></li>
<li><a href="#after">After</a></li>
<li><a href="#requires">Requires</a></li>
<li><a href="#wants">Wants</a></li>
<li><a href="#conflicts">Conflicts</a></li>
</ul>
</li>
<li><a href="#service">[Service]</a><ul>
<li><a href="#type">Type</a></li>
<li><a href="#execstart">ExecStart</a></li>
<li><a href="#execstop">ExecStop</a></li>
<li><a href="#execreload">ExecReload</a></li>
<li><a href="#restart">Restart</a></li>
<li><a href="#remainafterexit">RemainAfterExit</a></li>
</ul>
</li>
<li><a href="#install">[Install]</a><ul>
<li><a href="#target-runlevel">Target 与 Runlevel</a></li>
<li><a href="#init">init 进程</a></li>
<li><a href="#alias">Alias</a></li>
<li><a href="#requiredby">RequiredBy</a></li>
<li><a href="#wantedby">WantedBy</a></li>
<li><a href="#also">Also</a></li>
<li><a href="#defaultinstance">DefaultInstance</a></li>
</ul>
</li>
<li><a href="#timer">[Timer] 定时器</a><ul>
<li><a href="#timer_1">Timer参数</a></li>
<li><a href="#_2">时间参数</a><ul>
<li><a href="#parsing-time-spans">可识别时间符号 Parsing Time Spans</a></li>
<li><a href="#valid-timestamps-and-their-normalized-form">valid timestamps and their normalized form</a></li>
</ul>
</li>
<li><a href="#_3">日志</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#exmaple">exmaple</a><ul>
<li><a href="#ipa_list">ipa_list</a></li>
<li><a href="#rpcbind">rpcbind</a></li>
<li><a href="#postfix">postfix</a></li>
<li><a href="#emacs">Emacs</a></li>
<li><a href="#second-sshd">Second sshd</a></li>
<li><a href="#python-configparser">Python-configparser</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="systemd">systemd</h1>
<p><img alt="img" src="https://cdn.pbrd.co/images/I0KO5bP.png" /></p>
<h2 id="_1">特点</h2>
<p>Systemd 的优点是功能强大，使用方便，缺点是体系庞大，非常复杂。事实上，现在还有很多人反对使用 Systemd，理由就是它过于复杂，与操作系统的其他部分强耦合，违反"keep simple, keep stupid"的Unix 哲学</p>
<h2 id="commands">Commands</h2>
<h3 id="systemctl">systemctl</h3>
<div class="hlcode"><pre><span class="cp"># 显示某个 Unit 是否正在运行</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">is</span><span class="o">-</span><span class="n">active</span> <span class="n">application</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 显示某个 Unit 是否处于启动失败状态</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">is</span><span class="o">-</span><span class="n">failed</span> <span class="n">application</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 显示某个 Unit 服务是否建立了启动链接</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">is</span><span class="o">-</span><span class="n">enabled</span> <span class="n">application</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 立即启动一个服务</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">apache</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 立即停止一个服务</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">apache</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 重启一个服务</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">apache</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 杀死一个服务的所有子进程</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">kill</span> <span class="n">apache</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 重新加载一个服务的配置文件</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">reload</span> <span class="n">apache</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 重载所有修改过的配置文件</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>

<span class="cp"># 显示某个 Unit 的所有底层参数</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">show</span> <span class="n">httpd</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 显示某个 Unit 的指定属性的值</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">show</span> <span class="o">-</span><span class="n">p</span> <span class="n">CPUShares</span> <span class="n">httpd</span><span class="p">.</span><span class="n">service</span>

<span class="cp"># 设置某个 Unit 的指定属性</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">set</span><span class="o">-</span><span class="n">property</span> <span class="n">httpd</span><span class="p">.</span><span class="n">service</span> <span class="n">CPUShares</span><span class="o">=</span><span class="mi">500</span>
</pre></div>


<h4 id="list-units-unit">List-units 列出unit</h4>
<div class="hlcode"><pre><span class="cp"># 列出正在运行的 Unit</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">units</span>

<span class="cp"># 列出所有Unit，包括没有找到配置文件的或者启动失败的</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">units</span> <span class="o">--</span><span class="n">all</span>

<span class="cp"># 列出所有没有运行的 Unit</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">units</span> <span class="o">--</span><span class="n">all</span> <span class="o">--</span><span class="n">state</span><span class="o">=</span><span class="n">inactive</span>

<span class="cp"># 列出所有加载失败的 Unit</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">units</span> <span class="o">--</span><span class="n">failed</span>

<span class="cp"># 列出所有正在运行的、类型为 service 的 Unit</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">units</span> <span class="o">--</span><span class="n">type</span><span class="o">=</span><span class="n">service</span>
</pre></div>


<h3 id="systemd-analyze">systemd-analyze 耗时分析</h3>
<p>命令用于查看启动耗时。</p>
<div class="hlcode"><pre><span class="cp"># 查看启动耗时</span>
<span class="err">$</span> <span class="n">systemd</span><span class="o">-</span><span class="n">analyze</span>                                                                                       

<span class="cp"># 查看每个服务的启动耗时</span>
<span class="err">$</span> <span class="n">systemd</span><span class="o">-</span><span class="n">analyze</span> <span class="n">blame</span>

<span class="cp"># 显示瀑布状的启动过程流</span>
<span class="err">$</span> <span class="n">systemd</span><span class="o">-</span><span class="n">analyze</span> <span class="n">critical</span><span class="o">-</span><span class="n">chain</span>

<span class="cp"># 显示指定服务的启动流</span>
<span class="err">$</span> <span class="n">systemd</span><span class="o">-</span><span class="n">analyze</span> <span class="n">critical</span><span class="o">-</span><span class="n">chain</span> <span class="n">atd</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<h3 id="hostnamectl">hostnamectl 主机信息</h3>
<div class="hlcode"><pre><span class="cp"># 显示当前主机的信息</span>
<span class="err">$</span> <span class="n">hostnamectl</span>

<span class="cp"># 设置主机名。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">hostnamectl</span> <span class="n">set</span><span class="o">-</span><span class="n">hostname</span> <span class="n">rhel7</span>
</pre></div>


<h3 id="localectl">localectl 本地设置</h3>
<div class="hlcode"><pre><span class="cp"># 查看本地化设置</span>
<span class="err">$</span> <span class="n">localectl</span>

<span class="cp"># 设置本地化参数。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">localectl</span> <span class="n">set</span><span class="o">-</span><span class="n">locale</span> <span class="n">LANG</span><span class="o">=</span><span class="n">en_GB</span><span class="p">.</span><span class="n">utf8</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">localectl</span> <span class="n">set</span><span class="o">-</span><span class="n">keymap</span> <span class="n">en_GB</span>
</pre></div>


<h3 id="timedatectl">timedatectl 时区设置</h3>
<p>命令用于查看当前时区设置。</p>
<div class="hlcode"><pre><span class="cp"># 查看当前时区设置</span>
<span class="err">$</span> <span class="n">timedatectl</span>

<span class="cp"># 显示所有可用的时区</span>
<span class="err">$</span> <span class="n">timedatectl</span> <span class="n">list</span><span class="o">-</span><span class="n">timezones</span>                                                                                   

<span class="cp"># 设置当前时区</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">timedatectl</span> <span class="n">set</span><span class="o">-</span><span class="n">timezone</span> <span class="n">America</span><span class="o">/</span><span class="n">New_York</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">timedatectl</span> <span class="n">set</span><span class="o">-</span><span class="n">time</span> <span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">timedatectl</span> <span class="n">set</span><span class="o">-</span><span class="n">time</span> <span class="n">HH</span><span class="o">:</span><span class="n">MM</span><span class="o">:</span><span class="n">SS</span>
</pre></div>


<h3 id="loginctl">loginctl 登陆信息</h3>
<div class="hlcode"><pre><span class="cp"># 列出当前session</span>
<span class="err">$</span> <span class="n">loginctl</span> <span class="n">list</span><span class="o">-</span><span class="n">sessions</span>

<span class="cp"># 列出当前登录用户</span>
<span class="err">$</span> <span class="n">loginctl</span> <span class="n">list</span><span class="o">-</span><span class="n">users</span>

<span class="cp"># 列出显示指定用户的信息</span>
<span class="err">$</span> <span class="n">loginctl</span> <span class="n">show</span><span class="o">-</span><span class="n">user</span> <span class="n">rick</span>
</pre></div>


<h3 id="journalctl">journalctl 日志</h3>
<p>Systemd 统一管理所有 Unit 的启动日志。带来的好处就是，可以只用<code>journalctl</code>一个命令，查看所有日志（内核日志和应用日志）。日志的配置文件是<code>/etc/systemd/journald.conf</code>。</p>
<div class="hlcode"><pre><span class="cp"># 查看所有日志（默认情况下 ，只保存本次启动的日志）</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span>

<span class="cp"># 查看内核日志（不显示应用日志）</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">k</span>

<span class="cp"># 查看系统本次启动的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">b</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="mi">0</span>

<span class="cp"># 查看上一次启动的日志（需更改设置）</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="mi">1</span>

<span class="cp"># 查看指定时间的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">since</span><span class="o">=</span><span class="s">&quot;2012-10-30 18:17:16&quot;</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">since</span> <span class="s">&quot;20 min ago&quot;</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">since</span> <span class="n">yesterday</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">since</span> <span class="s">&quot;2015-01-10&quot;</span> <span class="o">--</span><span class="n">until</span> <span class="s">&quot;2015-01-11 03:00&quot;</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">since</span> <span class="mi">09</span><span class="o">:</span><span class="mo">00</span> <span class="o">--</span><span class="n">until</span> <span class="s">&quot;1 hour ago&quot;</span>

<span class="cp"># 显示尾部的最新10行日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">n</span>

<span class="cp"># 显示尾部指定行数的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">n</span> <span class="mi">20</span>

<span class="cp"># 实时滚动显示最新日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">f</span>

<span class="cp"># 查看指定服务的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">systemd</span>

<span class="cp"># 查看指定进程的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="n">_PID</span><span class="o">=</span><span class="mi">1</span>

<span class="cp"># 查看某个路径的脚本的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="cp"># 查看指定用户的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="n">_UID</span><span class="o">=</span><span class="mi">33</span> <span class="o">--</span><span class="n">since</span> <span class="n">today</span>

<span class="cp"># 查看某个 Unit 的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">service</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">service</span> <span class="o">--</span><span class="n">since</span> <span class="n">today</span>

<span class="cp"># 实时滚动显示某个 Unit 的最新日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">service</span> <span class="o">-</span><span class="n">f</span>

<span class="cp"># 合并显示多个 Unit 的日志</span>
<span class="err">$</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">service</span> <span class="o">-</span><span class="n">u</span> <span class="n">php</span><span class="o">-</span><span class="n">fpm</span><span class="p">.</span><span class="n">service</span> <span class="o">--</span><span class="n">since</span> <span class="n">today</span>

<span class="cp"># 查看指定优先级（及其以上级别）的日志，共有8级</span>
<span class="cp"># 0: emerg</span>
<span class="cp"># 1: alert</span>
<span class="cp"># 2: crit</span>
<span class="cp"># 3: err</span>
<span class="cp"># 4: warning</span>
<span class="cp"># 5: notice</span>
<span class="cp"># 6: info</span>
<span class="cp"># 7: debug</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">p</span> <span class="n">err</span> <span class="o">-</span><span class="n">b</span>

<span class="cp"># 日志默认分页输出，--no-pager 改为正常的标准输出</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">pager</span>

<span class="cp"># 以 JSON 格式（单行）输出</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">service</span> <span class="o">-</span><span class="n">o</span> <span class="n">json</span>

<span class="cp"># 以 JSON 格式（多行）输出，可读性更好</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">u</span> <span class="n">nginx</span><span class="p">.</span><span class="n">serviceqq</span>
 <span class="o">-</span><span class="n">o</span> <span class="n">json</span><span class="o">-</span><span class="n">pretty</span>

<span class="cp"># 显示日志占据的硬盘空间</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">disk</span><span class="o">-</span><span class="n">usage</span>

<span class="cp"># 指定日志文件占据的最大空间</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">vacuum</span><span class="o">-</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="n">G</span>

<span class="cp"># 指定日志文件保存多久</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">--</span><span class="n">vacuum</span><span class="o">-</span><span class="n">time</span><span class="o">=</span><span class="mi">1</span><span class="n">years</span>
</pre></div>


<h2 id="unit">[Unit]</h2>
<h3 id="description">Description</h3>
<p>A meaningful description of the unit. This text is displayed for example in the output of the systemctl status command.</p>
<h3 id="documentation">Documentation</h3>
<p>Provides a list of URIs referencing documentation for the unit.</p>
<h3 id="after">After</h3>
<p>Defines the order in which units are started. The unit starts only after the units specified in After are active. Unlike Requires, After does not explicitly activate the specified units. The Before option has the opposite functionality to After.</p>
<h3 id="requires">Requires</h3>
<p>Configures dependencies on other units. The units listed in Requires are activated together with the unit. If any of the required units fail to start, the unit is not activated.</p>
<h3 id="wants">Wants</h3>
<p>Configures weaker dependencies than Requires. If any of the listed units does not start successfully, it has no impact on the unit activation. This is the recommended way to establish custom unit dependencies.</p>
<h3 id="conflicts">Conflicts</h3>
<p>Configures negative dependencies, an opposite to Requires.</p>
<h2 id="service">[Service]</h2>
<h3 id="type">Type</h3>
<p>Configures the unit process startup type that affects the functionality of ExecStart and related options. One of: </p>
<ul>
<li>simple – The default value. The process started with ExecStart is the main process of the service. </li>
<li>forking – The process started with ExecStart spawns a child process that becomes the main process of the service. The parent process exits when the startup is complete. </li>
<li>oneshot – This type is similar to simple, but the process exits before starting consequent units. </li>
<li>dbus – This type is similar to simple, but consequent units are started only after the main process gains a D-Bus name. </li>
<li>notify – This type is similar to simple, but consequent units are started only after a notification message is sent via the sd_notify() function. </li>
<li>idle – similar to simple, the actual execution of the service binary is delayed until all jobs are finished, which avoids mixing the status output with shell output of services. </li>
</ul>
<h3 id="execstart">ExecStart</h3>
<p>Specifies commands or scripts to be executed when the unit is started. ExecStartPre and ExecStartPost specify custom commands to be executed before and after ExecStart. Type=oneshot enables specifying multiple custom commands that are then executed sequentially.</p>
<h3 id="execstop">ExecStop</h3>
<p>Specifies commands or scripts to be executed when the unit is stopped.</p>
<h3 id="execreload">ExecReload</h3>
<p>Specifies commands or scripts to be executed when the unit is reloaded.</p>
<h3 id="restart">Restart</h3>
<p>With this option enabled, the service is restarted after its process exits, with the exception of a clean stop by the systemctl command.</p>
<p>可能的值包括<code>always</code>（总是重启）、<code>on-success</code>、<code>on-failure</code>、<code>on-abnormal</code>、<code>on-abort</code>、<code>on-watchdog</code></p>
<h3 id="remainafterexit">RemainAfterExit</h3>
<p>If set to True, the service is considered active even when all its processes exited. Default value is False. This option is especially useful if Type=oneshot is configured.</p>
<h2 id="install">[Install]</h2>
<p>启动计算机的时候，需要启动大量的 Unit。如果每一次启动，都要一一写明本次启动需要哪些 Unit，显然非常不方便。Systemd 的解决方案就是 Target。</p>
<p>简单说，Target 就是一个 Unit 组，包含许多相关的 Unit 。启动某个 Target 的时候，Systemd 就会启动里面所有的 Unit。从这个意义上说，Target 这个概念类似于"状态点"，启动某个 Target 就好比启动到某种状态。</p>
<h3 id="target-runlevel">Target 与 Runlevel</h3>
<div class="hlcode"><pre><span class="n">Traditional</span> <span class="n">runlevel</span>      <span class="n">New</span> <span class="n">target</span> <span class="n">name</span>     <span class="n">Symbolically</span> <span class="n">linked</span> <span class="n">to</span><span class="p">...</span>

<span class="n">Runlevel</span> <span class="mi">0</span>           <span class="o">|</span>    <span class="n">runlevel0</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">poweroff</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">1</span>           <span class="o">|</span>    <span class="n">runlevel1</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">rescue</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">2</span>           <span class="o">|</span>    <span class="n">runlevel2</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">3</span>           <span class="o">|</span>    <span class="n">runlevel3</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">4</span>           <span class="o">|</span>    <span class="n">runlevel4</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">5</span>           <span class="o">|</span>    <span class="n">runlevel5</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">graphical</span><span class="p">.</span><span class="n">target</span>
<span class="n">Runlevel</span> <span class="mi">6</span>           <span class="o">|</span>    <span class="n">runlevel6</span><span class="p">.</span><span class="n">target</span> <span class="o">-&gt;</span> <span class="n">reboot</span><span class="p">.</span><span class="n">target</span>
</pre></div>


<h3 id="init">init 进程</h3>
<div class="hlcode"><pre><span class="err">（</span><span class="mi">1</span><span class="err">）默认的</span> <span class="n">RunLevel</span><span class="err">（在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">inittab</span><span class="err">文件设置）现在被默认的</span> <span class="n">Target</span> <span class="err">取代，位置是</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="k">default</span><span class="p">.</span><span class="n">target</span><span class="err">，通常符号链接到</span><span class="n">graphical</span><span class="p">.</span><span class="n">target</span><span class="err">（图形界面）或者</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="p">.</span><span class="n">target</span><span class="err">（多用户命令行）。</span>

<span class="err">（</span><span class="mi">2</span><span class="err">）启动脚本的位置，以前是</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="err">目录，符号链接到不同的</span> <span class="n">RunLevel</span> <span class="err">目录</span> <span class="err">（比如</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc3</span><span class="p">.</span><span class="n">d</span><span class="err">、</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc5</span><span class="p">.</span><span class="n">d</span><span class="err">等），现在则存放在</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="err">和</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="err">目录。</span>

<span class="err">（</span><span class="mi">3</span><span class="err">）配置文件的位置，以前</span><span class="n">init</span><span class="err">进程的配置文件是</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">inittab</span><span class="err">，各种服务的配置文件存放在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="err">目录。现在的配置文件主要存放在</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="err">目录，在</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="err">目录里面的修改可以覆盖原始设置。</span>
</pre></div>


<h3 id="alias">Alias</h3>
<p>Provides a space-separated list of additional names for the unit. Most systemctl commands, excluding systemctl enable, can use aliases instead of the actual unit name.</p>
<h3 id="requiredby">RequiredBy</h3>
<p>A list of units that depend on the unit. When this unit is enabled, the units listed in RequiredBy gain a Require dependency on the unit.</p>
<p>它的值是一个或多个 Target，当前 Unit 激活时，符号链接会放入<code>/etc/systemd/system</code>目录下面以 Target 名 + <code>.required</code>后缀构成的子目录中</p>
<h3 id="wantedby">WantedBy</h3>
<p>A list of units that weakly depend on the unit. When this unit is enabled, the units listed in WantedBy gain a Want dependency on the unit.</p>
<p>它的值是一个或多个 Target，当前 Unit 激活时（enable）符号链接会放入<code>/etc/systemd/system</code>目录下面以 Target 名 + <code>.wants</code>后缀构成的子目录中</p>
<h3 id="also">Also</h3>
<p>Specifies a list of units to be installed or uninstalled along with the unit.</p>
<h3 id="defaultinstance">DefaultInstance</h3>
<p>Limited to instantiated units, this option specifies the default instance for which the unit is enabled.</p>
<h2 id="timer">[Timer] 定时器</h2>
<p>新建 Service 非常简单，就是在/usr/lib/systemd/system目录里面新建一个文件，比如mytimer.service文件，你可以写入下面的内容。</p>
<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">MyTimer</span>

<span class="k">[Service]</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/bash /path/to/mail.sh</span>
</pre></div>


<p><code>/usr/lib/systemd/system</code>目录里面，新建一个<code>mytimer.timer</code>文件。</p>
<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Runs mytimer every hour</span>

<span class="k">[Timer]</span>
<span class="na">OnUnitActiveSec</span><span class="o">=</span><span class="s">1h</span>
<span class="na">Unit</span><span class="o">=</span><span class="s">mytimer.service</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<div class="hlcode"><pre><span class="err">启动定时器</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">start</span> <span class="n">mytimer</span><span class="p">.</span><span class="n">timer</span>

<span class="err">查看这个定时器的状态。</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">status</span> <span class="n">mytimer</span><span class="p">.</span><span class="n">timer</span>

<span class="err">查看所有正在运行的定时器。</span>
<span class="err">$</span> <span class="n">systemctl</span> <span class="n">list</span><span class="o">-</span><span class="n">timers</span>

<span class="err">关闭这个定时器。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">myscript</span><span class="p">.</span><span class="n">timer</span>

<span class="err">下次开机，自动运行这个定时器。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">myscript</span><span class="p">.</span><span class="n">timer</span>

<span class="err">关闭定时器的开机自启动。</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="n">myscript</span><span class="p">.</span><span class="n">timer</span>
</pre></div>


<h3 id="timer_1">Timer参数</h3>
<div class="hlcode"><pre><span class="n">OnActiveSec</span><span class="err">：定时器生效后，多少时间开始执行任务</span>
<span class="n">OnBootSec</span><span class="err">：系统启动后，多少时间开始执行任务</span>
<span class="n">OnStartupSec</span><span class="err">：</span><span class="n">Systemd</span> <span class="err">进程启动后，多少时间开始执行任务</span>
<span class="n">OnUnitActiveSec</span><span class="err">：该单元上次执行后，等多少时间再次执行</span>
<span class="n">OnUnitInactiveSec</span><span class="err">：</span> <span class="err">定时器上次关闭后多少时间，再次执行</span>
<span class="n">OnCalendar</span><span class="err">：基于绝对时间，而不是相对时间执行</span>
<span class="n">AccuracySec</span><span class="err">：如果因为各种原因，任务必须推迟执行，推迟的最大秒数，默认是</span><span class="mi">60</span><span class="err">秒</span>
<span class="n">Unit</span><span class="err">：真正要执行的任务，默认是同名的带有</span><span class="p">.</span><span class="n">service</span><span class="err">后缀的单元</span>
<span class="n">Persistent</span><span class="err">：如果设置了该字段，即使定时器到时没有启动，也会自动执行相应的单元</span>
<span class="n">WakeSystem</span><span class="err">：如果系统休眠，是否自动唤醒系统</span>
</pre></div>


<h3 id="_2">时间参数</h3>
<div class="hlcode"><pre><span class="n">OnUnitActiveSec</span><span class="o">=</span><span class="mi">1</span><span class="n">h</span><span class="err">表示一小时执行一次任务。</span>
</pre></div>


<h4 id="parsing-time-spans">可识别时间符号 Parsing Time Spans</h4>
<p>When parsing, systemd will accept the same time span syntax. Separating spaces may be omitted. The following time units are understood:</p>
<ul>
<li>usec, us, µs</li>
<li>msec, ms</li>
<li>seconds, second, sec, s</li>
<li>minutes, minute, min, m</li>
<li>hours, hour, hr, h</li>
<li>days, day, d</li>
<li>weeks, week, w</li>
<li>months, month, M (defined as 30.44 days)</li>
<li>years, year, y (defined as 365.25 days)</li>
</ul>
<p>If no time unit is specified, generally seconds are assumed, but some exceptions exist and are marked as such. In a few cases "<code>ns</code>", "<code>nsec</code>" is accepted too, where the granularity of the time span permits this. Parsing is generally locale-independent, non-English names for the time units are not accepted.</p>
<p>Examples for valid time span specifications:</p>
<div class="hlcode"><pre><span class="mi">2</span> <span class="n">h</span>
<span class="mi">2</span><span class="n">hours</span>
<span class="mi">48</span><span class="n">hr</span>
<span class="mi">1</span><span class="n">y</span> <span class="mi">12</span><span class="n">month</span>
<span class="mi">55</span><span class="n">s500ms</span>
<span class="mi">300</span><span class="n">ms20s</span> <span class="mi">5</span><span class="n">day</span>
</pre></div>


<h4 id="valid-timestamps-and-their-normalized-form">valid timestamps and their normalized form</h4>
<div class="hlcode"><pre>  <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span>
      <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span>
  <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span> <span class="n">UTC</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">19</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span>
               <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                 <span class="mi">12</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                 <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">13</span>
                    <span class="mi">11</span><span class="o">:</span><span class="mi">12</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">11</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mo">00</span>
                      <span class="n">now</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">18</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">22</span>
                    <span class="n">today</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                <span class="n">today</span> <span class="n">UTC</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">16</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                <span class="n">yesterday</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">22</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                 <span class="n">tomorrow</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">24</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="n">tomorrow</span> <span class="n">Pacific</span><span class="o">/</span><span class="n">Auckland</span> <span class="err">→</span> <span class="n">Thu</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">19</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                 <span class="o">+</span><span class="mi">3</span><span class="n">h30min</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">21</span><span class="o">:</span><span class="mi">45</span><span class="o">:</span><span class="mi">22</span>
                      <span class="o">-</span><span class="mi">5</span><span class="n">s</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">18</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mi">17</span>
                <span class="mi">11</span><span class="n">min</span> <span class="n">ago</span> <span class="err">→</span> <span class="n">Fri</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span> <span class="mi">18</span><span class="o">:</span><span class="mo">04</span><span class="o">:</span><span class="mi">22</span>
              <span class="err">@</span><span class="mi">1395716396</span> <span class="err">→</span> <span class="n">Tue</span> <span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">25</span> <span class="mo">03</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">56</span>
</pre></div>


<p>Timestamps may also be specified with microsecond granularity. The sub-second remainder is expected separated by a full stop from the seconds component. Example:</p>
<div class="hlcode"><pre><span class="mi">2014</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mi">25</span> <span class="mo">03</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mf">56.654563</span>
</pre></div>


<p>The following special expressions may be used as shorthands for longer normalized forms:</p>
<div class="hlcode"><pre>    <span class="n">minutely</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="o">*:*:</span><span class="mo">00</span>
      <span class="n">hourly</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="o">*:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
       <span class="n">daily</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
     <span class="n">monthly</span> <span class="err">→</span> <span class="o">*-*-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
      <span class="n">weekly</span> <span class="err">→</span> <span class="n">Mon</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
      <span class="n">yearly</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
   <span class="n">quarterly</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">01</span><span class="p">,</span><span class="mo">04</span><span class="p">,</span><span class="mo">07</span><span class="p">,</span><span class="mi">10</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
<span class="n">semiannually</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">01</span><span class="p">,</span><span class="mo">07</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
</pre></div>


<p>Examples for valid timestamps and their normalized form:</p>
<div class="hlcode"><pre>  <span class="n">Sat</span><span class="p">,</span><span class="n">Thu</span><span class="p">,</span><span class="n">Mon</span><span class="p">..</span><span class="n">Wed</span><span class="p">,</span><span class="n">Sat</span><span class="p">..</span><span class="n">Sun</span> <span class="err">→</span> <span class="n">Mon</span><span class="p">..</span><span class="n">Thu</span><span class="p">,</span><span class="n">Sat</span><span class="p">,</span><span class="n">Sun</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
      <span class="n">Mon</span><span class="p">,</span><span class="n">Sun</span> <span class="mi">12</span><span class="o">-*-*</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">:</span><span class="mi">23</span> <span class="err">→</span> <span class="n">Mon</span><span class="p">,</span><span class="n">Sun</span> <span class="mi">2012</span><span class="o">-*-*</span> <span class="mo">01</span><span class="p">,</span><span class="mo">02</span><span class="o">:</span><span class="mi">23</span><span class="o">:</span><span class="mo">00</span>
                    <span class="n">Wed</span> <span class="o">*-</span><span class="mi">1</span> <span class="err">→</span> <span class="n">Wed</span> <span class="o">*-*-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
           <span class="n">Wed</span><span class="p">..</span><span class="n">Wed</span><span class="p">,</span><span class="n">Wed</span> <span class="o">*-</span><span class="mi">1</span> <span class="err">→</span> <span class="n">Wed</span> <span class="o">*-*-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                 <span class="n">Wed</span><span class="p">,</span> <span class="mi">17</span><span class="o">:</span><span class="mi">48</span> <span class="err">→</span> <span class="n">Wed</span> <span class="o">*-*-*</span> <span class="mi">17</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mo">00</span>
<span class="n">Wed</span><span class="p">..</span><span class="n">Sat</span><span class="p">,</span><span class="n">Tue</span> <span class="mi">12</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">15</span> <span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="mi">3</span> <span class="err">→</span> <span class="n">Tue</span><span class="p">..</span><span class="n">Sat</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">15</span> <span class="mo">01</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mo">03</span>
                <span class="o">*-*-</span><span class="mi">7</span> <span class="mi">0</span><span class="o">:</span><span class="mi">0</span><span class="o">:</span><span class="mi">0</span> <span class="err">→</span> <span class="o">*-*-</span><span class="mo">07</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                      <span class="mi">10</span><span class="o">-</span><span class="mi">15</span> <span class="err">→</span> <span class="o">*-</span><span class="mi">10</span><span class="o">-</span><span class="mi">15</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
        <span class="n">monday</span> <span class="o">*-</span><span class="mi">12</span><span class="o">-*</span> <span class="mi">17</span><span class="o">:</span><span class="mo">00</span> <span class="err">→</span> <span class="n">Mon</span> <span class="o">*-</span><span class="mi">12</span><span class="o">-*</span> <span class="mi">17</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
  <span class="n">Mon</span><span class="p">,</span><span class="n">Fri</span> <span class="o">*-*-</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="o">*:</span><span class="mi">30</span><span class="o">:</span><span class="mi">45</span> <span class="err">→</span> <span class="n">Mon</span><span class="p">,</span><span class="n">Fri</span> <span class="o">*-*-</span><span class="mo">01</span><span class="p">,</span><span class="mo">02</span><span class="p">,</span><span class="mo">03</span> <span class="o">*:</span><span class="mi">30</span><span class="o">:</span><span class="mi">45</span>
       <span class="mi">12</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">12</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="o">:</span><span class="mo">00</span>
            <span class="mf">12..14</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mf">12..14</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="o">:</span><span class="mo">00</span>
  <span class="n">mon</span><span class="p">,</span><span class="n">fri</span> <span class="o">*-</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> <span class="o">*:</span><span class="mi">30</span><span class="o">:</span><span class="mi">45</span> <span class="err">→</span> <span class="n">Mon</span><span class="p">,</span><span class="n">Fri</span> <span class="o">*-</span><span class="mo">01</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mo">01</span><span class="p">,</span><span class="mo">03</span> <span class="o">*:</span><span class="mi">30</span><span class="o">:</span><span class="mi">45</span>
             <span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span>
                   <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span>
                      <span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mo">00</span>
     <span class="n">Sat</span><span class="p">,</span><span class="n">Sun</span> <span class="mi">12</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="n">Sat</span><span class="p">,</span><span class="n">Sun</span> <span class="o">*-</span><span class="mi">12</span><span class="o">-</span><span class="mo">05</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span>
           <span class="n">Sat</span><span class="p">,</span><span class="n">Sun</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="n">Sat</span><span class="p">,</span><span class="n">Sun</span> <span class="o">*-*-*</span> <span class="mi">08</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">40</span>
           <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="err">→</span> <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mo">00</span>
 <span class="mo">05</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mf">23.4200004</span><span class="o">/</span><span class="mf">3.1700005</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mf">23.420000</span><span class="o">/</span><span class="mf">3.170001</span>
             <span class="mi">2003</span><span class="o">-</span><span class="mf">02..04</span><span class="o">-</span><span class="mo">05</span> <span class="err">→</span> <span class="mi">2003</span><span class="o">-</span><span class="mf">02..04</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
       <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span> <span class="n">UTC</span> <span class="err">→</span> <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">05</span><span class="o">:</span><span class="mi">40</span><span class="o">:</span><span class="mo">00</span> <span class="n">UTC</span>
                 <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="err">→</span> <span class="mi">2003</span><span class="o">-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                      <span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">03</span><span class="o">-</span><span class="mo">05</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                     <span class="n">hourly</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="o">*:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                      <span class="n">daily</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                  <span class="n">daily</span> <span class="n">UTC</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="n">UTC</span>
                    <span class="n">monthly</span> <span class="err">→</span> <span class="o">*-*-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                     <span class="n">weekly</span> <span class="err">→</span> <span class="n">Mon</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
    <span class="n">weekly</span> <span class="n">Pacific</span><span class="o">/</span><span class="n">Auckland</span> <span class="err">→</span> <span class="n">Mon</span> <span class="o">*-*-*</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="n">Pacific</span><span class="o">/</span><span class="n">Auckland</span>
                     <span class="n">yearly</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                   <span class="n">annually</span> <span class="err">→</span> <span class="o">*-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
                      <span class="o">*:</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span> <span class="err">→</span> <span class="o">*-*-*</span> <span class="o">*:</span><span class="mo">02</span><span class="o">/</span><span class="mi">3</span><span class="o">:</span><span class="mo">00</span>
</pre></div>


<h3 id="_3">日志</h3>
<div class="hlcode"><pre><span class="cp"># 查看整个日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span>

<span class="cp"># 查看 mytimer.timer 的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">mytimer</span><span class="p">.</span><span class="n">timer</span>

<span class="cp"># 查看 mytimer.timer 和 mytimer.service 的日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">u</span> <span class="n">mytimer</span>

<span class="cp"># 从结尾开始查看最新日志</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">f</span>

<span class="cp"># 从结尾开始查看 mytimer.timer 的日志</span>
<span class="err">$</span> <span class="n">journalctl</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">u</span> <span class="n">timer</span><span class="p">.</span><span class="n">timer</span>
</pre></div>


<h1 id="exmaple">exmaple</h1>
<h2 id="ipa_list">ipa_list</h2>
<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">ipa_list</span>
<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/root/.pyenv/versions/env3.5.3/bin/python /root/rtmbot_test/ipa_list.py</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/root/rtmbot_test</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
<span class="na">LimitCORE</span><span class="o">=</span><span class="s">infinity</span>
<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<h2 id="rpcbind">rpcbind</h2>
<div class="hlcode"><pre><span class="sx">!1004 $ cat /etc/sysconfig/rpcbind</span>
#
# <span class="n">Optional</span> <span class="n">arguments</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">rpcbind</span><span class="p">.</span> <span class="n">See</span> <span class="n">rpcbind</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="n">RPCBIND_ARGS</span><span class="p">=</span>&quot;&quot;
</pre></div>


<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">RPC bind service</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">rpcbind.socket</span>
<span class="na">After</span><span class="o">=</span><span class="s">systemd-tmpfiles-setup.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">/etc/sysconfig/rpcbind</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/sbin/rpcbind -w $RPCBIND_ARGS</span>

<span class="k">[Install]</span>
<span class="na">Also</span><span class="o">=</span><span class="s">rpcbind.socket</span>
</pre></div>


<h2 id="postfix">postfix</h2>
<div class="hlcode"><pre><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">postifix</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Postfix Mail Transport Agent</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network.target</span>
<span class="na">Conflicts</span><span class="o">=</span><span class="s">sendmail.service exim.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">/var/spool/postfix/pid/master.pid</span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">-/etc/sysconfig/network</span>
<span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/libexec/postfix/aliasesdb</span>
<span class="na">ExecStartPre</span><span class="o">=</span><span class="s">-/usr/libexec/postfix/chroot-update</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/sbin/postfix start</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/usr/sbin/postfix reload</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/sbin/postfix stop</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<h2 id="emacs">Emacs</h2>
<div class="hlcode"><pre><span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">emacs</span><span class="p">.</span><span class="n">service</span>
<span class="n">chmod</span> <span class="mi">664</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">emacs</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Emacs: the extensible, self-documenting text editor</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/emacs --daemon</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/usr/bin/emacsclient --eval &quot;(kill-emacs)&quot;</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">SSH_AUTH_SOCK=%t/keyring/ssh</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">always</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">default.target</span>
</pre></div>


<h2 id="second-sshd">Second sshd</h2>
<div class="hlcode"><pre><span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd</span><span class="p">{,</span><span class="o">-</span><span class="n">second</span><span class="p">}</span><span class="n">_config</span>
</pre></div>


<div class="hlcode"><pre><span class="n">Port</span> <span class="mi">22220</span>
<span class="n">PidFile</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">sshd</span><span class="o">-</span><span class="n">second</span><span class="p">.</span><span class="n">pid</span>
</pre></div>


<div class="hlcode"><pre><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">OpenSSH server second instance daemon</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network.target auditd.service sshd.service</span>

<span class="k">[Service]</span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">/etc/sysconfig/sshd</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/sbin/sshd -D -f /etc/ssh/sshd-second_config $OPTIONS</span>
<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -HUP $MAINPID</span>
<span class="na">KillMode</span><span class="o">=</span><span class="s">process</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
<span class="na">RestartSec</span><span class="o">=</span><span class="s">42s</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<div class="hlcode"><pre><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">sshd</span><span class="p">.</span><span class="n">service</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">sshd</span><span class="o">-</span><span class="n">second</span><span class="p">.</span><span class="n">service</span>
</pre></div>


<p>If using SELinux, add the port for the second instance of sshd to SSH ports, otherwise the second instance of sshd will be rejected to bind to the port:</p>
<div class="hlcode"><pre><span class="n">semanage</span> <span class="n">port</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">t</span> <span class="kt">ssh_port_t</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="mi">22220</span>
</pre></div>


<h2 id="python-configparser">Python-configparser</h2>
<p>可通过configparser 生成systemd配置文件</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-03-12 23:04:43</p>
      </span>
    </div>

    
    
  </body>
</html>