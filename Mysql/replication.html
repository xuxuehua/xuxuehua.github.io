<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/tango.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>replication 复制 - Xu XueHua</title>
    <meta name="keywords" content="Xu XueHua"/>
    <meta name="description" content="Xu XueHua's public notes"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/">Home</a>&nbsp;&#187;&nbsp;<a href="/#Mysql">Mysql</a>&nbsp;&#187;&nbsp;replication 复制
    <span class="updated">Page Updated&nbsp;
      2019-01-16 12:18
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">replication 复制</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">复制</a><ul>
<li><a href="#_2">主从复制</a><ul>
<li><a href="#_3">主节点</a></li>
<li><a href="#_4">从节点</a></li>
</ul>
</li>
<li><a href="#_5">复制架构</a><ul>
<li><a href="#_6">一主多从</a></li>
<li><a href="#_7">一从多主</a></li>
<li><a href="#_8">半同步复制</a></li>
<li><a href="#_9">配置注意点</a><ul>
<li><a href="#_10">限制只读方式</a></li>
<li><a href="#_11">阻止所有用户</a></li>
<li><a href="#_12">保证复制的事务安全</a></li>
</ul>
</li>
<li><a href="#mmm">MMM</a></li>
<li><a href="#mha">MHA</a><ul>
<li><a href="#mha-manager">MHA Manager</a></li>
<li><a href="#mha-node">MHA Node</a></li>
</ul>
</li>
<li><a href="#galera-cluster">Galera Cluster</a><ul>
<li><a href="#percona-cluster">Percona-Cluster</a></li>
<li><a href="#mariadb-cluster">MariaDB-Cluster</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_13">二进制日志事件记录格式</a><ul>
<li><a href="#statement">STATEMENT</a></li>
<li><a href="#row">ROW</a></li>
<li><a href="#mixed">MIXED</a></li>
</ul>
</li>
<li><a href="#_14">复制相关的文件</a><ul>
<li><a href="#masterinfo">master.info</a></li>
<li><a href="#reply-loginfo">reply-log.info</a></li>
</ul>
</li>
<li><a href="#_15">常用操作</a><ul>
<li><a href="#_16">清理日志</a></li>
<li><a href="#_17">复制监控</a></li>
<li><a href="#_18">从服务器是否落后于主服务器</a></li>
<li><a href="#_19"></a></li>
<li><a href="#_20">判断主从结点数据是否一致</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_21">主从复制案例</a><ul>
<li><a href="#_22">主节点</a></li>
<li><a href="#_23">从节点</a></li>
<li><a href="#_24">测试</a></li>
</ul>
</li>
<li><a href="#_25">主主复制案例 （慎用）</a><ul>
<li><a href="#id">自动增长ID</a></li>
<li><a href="#_26">配置步骤</a><ul>
<li><a href="#1">节点1</a></li>
<li><a href="#2">节点2</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_27">半同步复制案例</a><ul>
<li><a href="#master">Master</a></li>
<li><a href="#slave">Slave</a></li>
</ul>
</li>
<li><a href="#_28">复制过滤器</a><ul>
<li><a href="#_29">二进制日志方式</a></li>
<li><a href="#_30">中继日志方式</a><ul>
<li><a href="#example">example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ssl">基于SSL复制</a></li>
</ul>
</div>
<h1 id="_1">复制</h1>
<p>每个节点都有相同的数据集</p>
<p>实现数据分布，负载均衡读，备份，高可用和故障切换</p>
<h2 id="_2">主从复制</h2>
<h3 id="_3">主节点</h3>
<p>Dump Thread： 为每个Slave的I/O Thread 启动一个dump线程，用于向其发送binary log events</p>
<h3 id="_4">从节点</h3>
<p>I/O Thread： 从master请求二进制日志事件，并保存于中继日志中</p>
<p>SQL Thread： 从中继日志中读取日志事件，在本地完成重放</p>
<h2 id="_5">复制架构</h2>
<h3 id="_6">一主多从</h3>
<p>从服务器还可以再有从服务器</p>
<h3 id="_7">一从多主</h3>
<h3 id="_8">半同步复制</h3>
<p>通过插件进行</p>
<p>即一个主节点同步到一个从节点，同步完成之后，再与其他的从节点异步同步数据</p>
<h3 id="_9">配置注意点</h3>
<h4 id="_10">限制只读方式</h4>
<p>在从服务器上设置<code>read_only=ON</code>， 此限制对拥有Super权限的用户均无效</p>
<h4 id="_11">阻止所有用户</h4>
<div class="hlcode"><pre><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">TABLES</span> <span class="n">WITH</span> <span class="n">RAED</span> <span class="n">LOCK</span><span class="p">;</span>
</pre></div>


<h4 id="_12">保证复制的事务安全</h4>
<p>在master 节点启用参数<code>sync_binlog=ON</code></p>
<p>针对InnoDB存储引擎， 开启</p>
<div class="hlcode"><pre><span class="n">innodb_flush_logs_at_trx_commit</span><span class="o">=</span><span class="n">ON</span>
<span class="n">innodb_support_xa</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>Slave 节点</p>
<div class="hlcode"><pre><span class="n">skip_slave_start</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>master 节点</p>
<div class="hlcode"><pre><span class="n">sync_master_info</span>
</pre></div>


<p>slave 节点</p>
<div class="hlcode"><pre><span class="n">sync_relay_log</span>
<span class="n">sync_relay_log_info</span>
</pre></div>


<h3 id="mmm">MMM</h3>
<p>Multi   Master MySQL</p>
<h3 id="mha">MHA</h3>
<p>Master HA</p>
<p>对主节点进行监控，可实现自动转移至其他从节点</p>
<p>通过提升某一从节点为新的主节点</p>
<h4 id="mha-manager">MHA Manager</h4>
<p>通常部署在一台独立机器上管理多个master/slave集群，每个集群成为一个application</p>
<h4 id="mha-node">MHA Node</h4>
<p>运行在每台MySQL服务器上，通过监控具备解析和清理logs功能的脚本来加快故障转移</p>
<h3 id="galera-cluster">Galera Cluster</h3>
<p>实现多主节点模型的机制</p>
<p>通过wresp协议协议在全局事件复制</p>
<p>任何一结点都可读写</p>
<p>工作较为底层，能为服务提供数据复制的组件</p>
<h4 id="percona-cluster">Percona-Cluster</h4>
<p>即整合过Galera Cluster的Percona MySQL 分支版本</p>
<p>至少需要三个结点</p>
<h4 id="mariadb-cluster">MariaDB-Cluster</h4>
<h2 id="_13">二进制日志事件记录格式</h2>
<h3 id="statement">STATEMENT</h3>
<h3 id="row">ROW</h3>
<h3 id="mixed">MIXED</h3>
<h2 id="_14">复制相关的文件</h2>
<h3 id="masterinfo"><code>master.info</code></h3>
<p>用于保存slave 连接至master 时想你管的信息，如账号，密码，服务器地址等</p>
<h3 id="reply-loginfo"><code>reply-log.info</code></h3>
<p>保存在当前slave结点上已经复制的当前二进制日志和本地replay log 日志的对应关系</p>
<h2 id="_15">常用操作</h2>
<h3 id="_16">清理日志</h3>
<div class="hlcode"><pre><span class="n">PURGE</span>
</pre></div>


<h3 id="_17">复制监控</h3>
<div class="hlcode"><pre><span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="n">show</span> <span class="n">binlog</span> <span class="n">events</span><span class="p">;</span>
<span class="n">show</span> <span class="n">binary</span> <span class="n">logs</span><span class="p">;</span>

<span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="p">;</span>
<span class="n">show</span> <span class="n">processlist</span><span class="p">;</span>
</pre></div>


<h3 id="_18">从服务器是否落后于主服务器</h3>
<div class="hlcode"><pre><span class="n">show</span> <span class="n">slave</span> <span class="n">status</span><span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
</pre></div>


<h3 id="_19"></h3>
<h3 id="_20">判断主从结点数据是否一致</h3>
<div class="hlcode"><pre><span class="n">percona</span><span class="o">-</span><span class="n">tools</span>
</pre></div>


<h1 id="_21">主从复制案例</h1>
<h2 id="_22">主节点</h2>
<p>启动二进制日志</p>
<p>为当前节点设置一个全局的唯一ID号</p>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>


<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">SHOW</span> <span class="nx">MASTER</span> <span class="nx">LOGS</span><span class="p">;</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="nx">Log_name</span>         <span class="o">|</span> <span class="nx">File_size</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000001</span> <span class="o">|</span>     <span class="mi">28415</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000002</span> <span class="o">|</span>   <span class="mi">1038814</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000003</span> <span class="o">|</span>       <span class="mi">264</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">mysql</span><span class="o">-</span><span class="nx">bin</span><span class="p">.</span><span class="mi">000004</span> <span class="o">|</span>       <span class="mi">245</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="mi">4</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">SHOW</span> <span class="nx">GLOBAL</span> <span class="nx">VARIABLES</span> <span class="nx">LIKE</span> <span class="s1">&#39;%server%&#39;</span><span class="p">;</span>
<span class="o">+----------------------+-----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>        <span class="o">|</span> <span class="nx">Value</span>           <span class="o">|</span>
<span class="o">+----------------------+-----------------+</span>
<span class="o">|</span> <span class="nx">character_set_server</span> <span class="o">|</span> <span class="nx">utf8</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">collation_server</span>     <span class="o">|</span> <span class="nx">utf8_general_ci</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">server_id</span>            <span class="o">|</span> <span class="mi">1</span>               <span class="o">|</span>
<span class="o">+----------------------+-----------------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>创建有复制权限的用户账号</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">208.73.201</span><span class="p">.</span><span class="o">%</span><span class="err">&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">PRIVILEGES</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h2 id="_23">从节点</h2>
<p>启动中继日志</p>
<p>为当前节点设置一个全局唯一的ID号</p>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="o">-</span><span class="n">index</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="p">.</span><span class="n">index</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">7</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>Master log info</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">MASTER</span> <span class="n">LOGS</span><span class="p">;</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">Log_name</span>         <span class="o">|</span> <span class="n">File_size</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span> <span class="o">|</span>     <span class="mi">28415</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000002</span> <span class="o">|</span>   <span class="mi">1038814</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span> <span class="o">|</span>       <span class="mi">264</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>       <span class="mi">499</span> <span class="o">|</span>
<span class="o">+------------------+-----------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>使用有复制权限的用户账号连接至主服务器，并启动复制线程</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">CHANGE</span> <span class="n">MASTER</span> <span class="n">TO</span> <span class="n">MASTER_HOST</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">208.73.201.156</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_USER</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_PASSWORD</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_FILE</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">MASTER_LOG_POS</span><span class="o">=</span><span class="mi">499</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">STATUS</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">499</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">4</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">No</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">No</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">499</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">245</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="nb">NULL</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>


<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">START</span> <span class="n">SLAVE</span><span class="p">;</span>   <span class="err">#不指定参数默认启动</span><span class="n">IO_THREAD</span><span class="o">|</span><span class="n">SQL_THREAD</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">SLAVE</span> <span class="n">STATUS</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Connecting</span> <span class="n">to</span> <span class="n">master</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">499</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000001</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">4</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Connecting</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">499</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">245</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="nb">NULL</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">1130</span>
                <span class="nl">Last_IO_Error:</span> <span class="n">error</span> <span class="n">connecting</span> <span class="n">to</span> <span class="n">master</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="err">@</span><span class="mf">208.73.201.156</span><span class="o">:</span><span class="mi">3306</span><span class="err">&#39;</span> <span class="o">-</span> <span class="n">retry</span><span class="o">-</span><span class="n">time</span><span class="o">:</span> <span class="mi">60</span>  <span class="n">retries</span><span class="o">:</span> <span class="mi">86400</span>  <span class="n">message</span><span class="o">:</span> <span class="n">Host</span> <span class="err">&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">is</span> <span class="n">not</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">this</span> <span class="n">MariaDB</span> <span class="n">server</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">0</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>可能需要操作</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_password</span> <span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h2 id="_24">测试</h2>
<p>主节点</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>     <span class="mi">1259</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">master</span> <span class="n">status</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>     <span class="mi">1342</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>从节点</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">1259</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">1289</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">1259</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1587</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">208.73.201.156</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">1342</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">localhost</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">1372</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">1342</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1670</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="_25">主主复制案例 （慎用）</h1>
<h2 id="id">自动增长ID</h2>
<p>在一个节点使用奇数id</p>
<div class="hlcode"><pre><span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">1</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>另一个节点使用偶数id</p>
<div class="hlcode"><pre><span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">2</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<h2 id="_26">配置步骤</h2>
<p>各个节点使用一个唯一的server_id</p>
<h3 id="1">节点1</h3>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
<span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">1</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>查看状态</p>
<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%relay_log%&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                    <span class="o">|</span> <span class="nx">Value</span>          <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">innodb_recovery_update_relay_log</span> <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">max_relay_log_size</span>               <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log</span>                        <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span>      <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_index</span>                  <span class="o">|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_info_file</span>              <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_purge</span>                  <span class="o">|</span> <span class="nx">ON</span>             <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_recovery</span>               <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_space_limit</span>            <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log</span>                   <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log_info</span>              <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="mi">10</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>授权账户</p>
<div class="hlcode"><pre><span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span><span class="p">,</span> <span class="n">replication</span> <span class="n">client</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000003</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">511</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.14</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>log_file 及其pos 需去主机器上<code>show master status</code>查看</p>
</blockquote>
<h3 id="2">节点2</h3>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>

<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">5</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
<span class="n">auto_increment_offset</span><span class="o">=</span><span class="mi">2</span>
<span class="n">auto_increment_increment</span><span class="o">=</span><span class="mi">2</span>
</pre></div>


<p>查看状态</p>
<div class="hlcode"><pre><span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%log_bin%&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                   <span class="o">|</span> <span class="nx">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="nx">log_bin</span>                         <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="nx">log_bin_trust_function_creators</span> <span class="o">|</span> <span class="nx">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="nx">sql_log_bin</span>                     <span class="o">|</span> <span class="nx">ON</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">3</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="nx">sec</span><span class="p">)</span>

<span class="nx">MariaDB</span> <span class="cp">[</span><span class="p">(</span><span class="kc">none</span><span class="p">)</span><span class="cp">]</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">global</span> <span class="nx">variables</span> <span class="nx">like</span> <span class="s1">&#39;%relay_log%&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">Variable_name</span>                    <span class="o">|</span> <span class="nx">Value</span>          <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="o">|</span> <span class="nx">innodb_recovery_update_relay_log</span> <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">max_relay_log_size</span>               <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log</span>                        <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span>      <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_index</span>                  <span class="o">|</span>                <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_info_file</span>              <span class="o">|</span> <span class="nx">relay</span><span class="o">-</span><span class="nx">log</span><span class="p">.</span><span class="nx">info</span> <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_purge</span>                  <span class="o">|</span> <span class="nx">ON</span>             <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_recovery</span>               <span class="o">|</span> <span class="nx">OFF</span>            <span class="o">|</span>
<span class="o">|</span> <span class="nx">relay_log_space_limit</span>            <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log</span>                   <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nx">sync_relay_log_info</span>              <span class="o">|</span> <span class="mi">0</span>              <span class="o">|</span>
<span class="o">+----------------------------------+----------------+</span>
<span class="mi">10</span> <span class="nx">rows</span> <span class="k">in</span> <span class="nx">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="nx">sec</span><span class="p">)</span>
</pre></div>


<p>授权账户</p>
<div class="hlcode"><pre><span class="n">grant</span> <span class="n">replication</span> <span class="n">slave</span><span class="p">,</span> <span class="n">replication</span> <span class="n">client</span> <span class="n">on</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">to</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">identified</span> <span class="n">by</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">flush</span> <span class="n">privileges</span><span class="p">;</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">208.73.201.156</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">512</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>log_file 及其pos 需去主机器上<code>show master status</code>查看</p>
</blockquote>
<h1 id="_27">半同步复制案例</h1>
<h2 id="master">Master</h2>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<div class="hlcode"><pre><span class="n">datadir</span> <span class="o">=</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span>
<span class="n">log</span><span class="o">-</span><span class="n">bin</span><span class="o">=</span><span class="n">master</span><span class="o">-</span><span class="n">bin</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<p>创建有复制权限的用户账号</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">GRANT</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="n">ON</span> <span class="o">*</span><span class="p">.</span><span class="o">*</span> <span class="n">TO</span> <span class="err">&#39;</span><span class="n">repluser</span><span class="sc">&#39;@&#39;</span><span class="mf">185.202.172.152</span><span class="err">&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">;</span>  <span class="err">#</span> <span class="err">对端</span><span class="n">IP</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">FLUSH</span> <span class="n">PRIVILEGES</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">SHOW</span> <span class="n">MASTER</span> <span class="n">STATUS</span><span class="p">;</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">File</span>             <span class="o">|</span> <span class="n">Position</span> <span class="o">|</span> <span class="n">Binlog_Do_DB</span> <span class="o">|</span> <span class="n">Binlog_Ignore_DB</span> <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="o">|</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span> <span class="o">|</span>      <span class="mi">500</span> <span class="o">|</span>              <span class="o">|</span>                  <span class="o">|</span>
<span class="o">+------------------+----------+--------------+------------------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>开始配置半同步, 安装插件</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">install</span> <span class="n">plugin</span> <span class="n">rpl_semi_sync_master</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_master</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">plugins</span><span class="p">;</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="o">|</span> <span class="n">Name</span>                           <span class="o">|</span> <span class="n">Status</span> <span class="o">|</span> <span class="n">Type</span>               <span class="o">|</span> <span class="n">Library</span>            <span class="o">|</span> <span class="n">License</span> <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="o">|</span> <span class="n">binlog</span>                         <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">STORAGE</span> <span class="n">ENGINE</span>     <span class="o">|</span> <span class="nb">NULL</span>               <span class="o">|</span> <span class="n">GPL</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master</span>           <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">REPLICATION</span>        <span class="o">|</span> <span class="n">semisync_master</span><span class="p">.</span><span class="n">so</span> <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+--------------------+---------+</span>
<span class="mi">41</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_enabled</span>       <span class="o">|</span> <span class="n">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_timeout</span>       <span class="o">|</span> <span class="mi">10000</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_trace_level</span>   <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_wait_no_slave</span> <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">rpl_semi_sync_master_enabled</span><span class="o">=</span><span class="n">ON</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                      <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_enabled</span>       <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_timeout</span>       <span class="o">|</span> <span class="mi">10000</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_trace_level</span>   <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_master_wait_no_slave</span> <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">+------------------------------------+-------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>slave 启动之后</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">status</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                              <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_clients</span>               <span class="o">|</span> <span class="mi">1</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_avg_wait_time</span>     <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_wait_time</span>         <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_waits</span>             <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_times</span>              <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_tx</span>                 <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_status</span>                <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_timefunc_failures</span>     <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_avg_wait_time</span>      <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_wait_time</span>          <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_waits</span>              <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_pos_backtraverse</span> <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_sessions</span>         <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_yes_tx</span>                <span class="o">|</span> <span class="mi">0</span>     <span class="o">|</span>
<span class="o">+--------------------------------------------+-------+</span>
<span class="mi">14</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>开始测试</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.05</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">mydb</span>
<span class="n">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">table</span> <span class="n">tb1</span> <span class="p">(</span><span class="n">id</span> <span class="kt">int</span><span class="p">,</span> <span class="n">name</span> <span class="kt">char</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">status</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                              <span class="o">|</span> <span class="n">Value</span>  <span class="o">|</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_clients</span>               <span class="o">|</span> <span class="mi">1</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_avg_wait_time</span>     <span class="o">|</span> <span class="mi">56081</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_wait_time</span>         <span class="o">|</span> <span class="mi">112162</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_net_waits</span>             <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_times</span>              <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_no_tx</span>                 <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_status</span>                <span class="o">|</span> <span class="n">ON</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_timefunc_failures</span>     <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_avg_wait_time</span>      <span class="o">|</span> <span class="mi">56189</span>  <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_wait_time</span>          <span class="o">|</span> <span class="mi">112378</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_tx_waits</span>              <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_pos_backtraverse</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_wait_sessions</span>         <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>
<span class="o">|</span> <span class="n">Rpl_semi_sync_master_yes_tx</span>                <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span>
<span class="o">+--------------------------------------------+--------+</span>
<span class="mi">14</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h2 id="slave">Slave</h2>
<div class="hlcode"><pre><span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">my</span><span class="p">.</span><span class="n">cnf</span>
</pre></div>


<div class="hlcode"><pre><span class="n">datadir</span> <span class="o">=</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span>
<span class="n">relay_log</span><span class="o">=</span><span class="n">relay</span><span class="o">-</span><span class="n">log</span>
<span class="n">server</span><span class="o">-</span><span class="n">id</span><span class="o">=</span><span class="mi">5</span>
<span class="n">innodb_file_per_table</span><span class="o">=</span><span class="n">ON</span>
<span class="n">skip_name_resolve</span><span class="o">=</span><span class="n">ON</span>
</pre></div>


<div class="hlcode"><pre><span class="n">change</span> <span class="n">master</span> <span class="n">to</span> <span class="n">master_host</span><span class="o">=</span><span class="err">&#39;</span><span class="mf">45.77.120.103</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_user</span><span class="o">=</span><span class="err">&#39;</span><span class="n">repluser</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_password</span><span class="o">=</span><span class="err">&#39;</span><span class="n">replpass</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_file</span><span class="o">=</span><span class="err">&#39;</span><span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">master_log_pos</span><span class="o">=</span><span class="mi">757</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">45.77.120.103</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">757</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="mf">.000002</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">529</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">757</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">817</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>
</pre></div>


<p>开始配置半同步</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.67</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">install</span> <span class="n">plugin</span> <span class="n">rpl_semi_sync_slave</span> <span class="n">SONAME</span> <span class="err">&#39;</span><span class="n">semisync_slave</span><span class="p">.</span><span class="n">so</span><span class="err">&#39;</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.02</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">plugins</span><span class="p">;</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="o">|</span> <span class="n">Name</span>                           <span class="o">|</span> <span class="n">Status</span> <span class="o">|</span> <span class="n">Type</span>               <span class="o">|</span> <span class="n">Library</span>           <span class="o">|</span> <span class="n">License</span> <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="o">|</span> <span class="n">binlog</span>                         <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">STORAGE</span> <span class="n">ENGINE</span>     <span class="o">|</span> <span class="nb">NULL</span>              <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave</span>            <span class="o">|</span> <span class="n">ACTIVE</span> <span class="o">|</span> <span class="n">REPLICATION</span>        <span class="o">|</span> <span class="n">semisync_slave</span><span class="p">.</span><span class="n">so</span> <span class="o">|</span> <span class="n">GPL</span>     <span class="o">|</span>
<span class="o">+--------------------------------+--------+--------------------+-------------------+---------+</span>
<span class="mi">41</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                   <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_enabled</span>     <span class="o">|</span> <span class="n">OFF</span>   <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_trace_level</span> <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">rpl_semi_sync_slave_enabled</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">semi</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                   <span class="o">|</span> <span class="n">Value</span> <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_enabled</span>     <span class="o">|</span> <span class="n">ON</span>    <span class="o">|</span>
<span class="o">|</span> <span class="n">rpl_semi_sync_slave_trace_level</span> <span class="o">|</span> <span class="mi">32</span>    <span class="o">|</span>
<span class="o">+---------------------------------+-------+</span>
<span class="mi">2</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="_28">复制过滤器</h1>
<p>让从节点复制指定的数据库，或指定数据库的指定表</p>
<h2 id="_29">二进制日志方式</h2>
<p>主服务器仅向二进制日志中记录与特定数据库(特定表)相关的事件</p>
<p>时间还是无法实现，不建议使用</p>
<div class="hlcode"><pre><span class="n">binlog_do_db</span><span class="o">=</span>       <span class="err">#数据库白名单列表</span>
<span class="n">binlog_ignore_db</span><span class="o">=</span>   <span class="err">#数据库黑名单列表</span>
</pre></div>


<h2 id="_30">中继日志方式</h2>
<p>从服务器SQL_THREAD在replay中继日志中的事件时，仅读取与特定数据库(特定表)相关的时间并应用于本地</p>
<p>但会造成网络及磁盘IO浪费</p>
<div class="hlcode"><pre><span class="n">replicate_do_db</span>
<span class="n">replicate_ignore_db</span>
<span class="n">replicate_do_table</span><span class="o">=</span>
<span class="n">replicate_ignore_table</span><span class="o">=</span>
<span class="n">replicate_wild_do_table</span><span class="o">=</span>
<span class="n">replicate_wild_ignore_table</span><span class="o">=</span>
</pre></div>


<h3 id="example">example</h3>
<p>从服务器仅复制mydb</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">replicate</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="o">|</span> <span class="n">Variable_name</span>                    <span class="o">|</span> <span class="n">Value</span>     <span class="o">|</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="o">|</span> <span class="n">replicate_annotate_row_events</span>    <span class="o">|</span> <span class="n">OFF</span>       <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_do_db</span>                  <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_do_table</span>               <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_events_marked_for_skip</span> <span class="o">|</span> <span class="n">replicate</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_ignore_db</span>              <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_ignore_table</span>           <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_wild_do_table</span>          <span class="o">|</span>           <span class="o">|</span>
<span class="o">|</span> <span class="n">replicate_wild_ignore_table</span>      <span class="o">|</span>           <span class="o">|</span>
<span class="o">+----------------------------------+-----------+</span>
<span class="mi">8</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">stop</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">set</span> <span class="n">global</span> <span class="n">replicate_do_db</span><span class="o">=</span><span class="n">mydb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">start</span> <span class="n">slave</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">slave</span> <span class="n">status</span> <span class="err">\</span><span class="n">G</span><span class="p">;</span>
<span class="o">***************************</span> <span class="mf">1.</span> <span class="n">row</span> <span class="o">***************************</span>
               <span class="nl">Slave_IO_State:</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">master</span> <span class="n">to</span> <span class="n">send</span> <span class="n">event</span>
                  <span class="nl">Master_Host:</span> <span class="mf">45.77.120.103</span>
                  <span class="nl">Master_User:</span> <span class="n">repluser</span>
                  <span class="nl">Master_Port:</span> <span class="mi">3306</span>
                <span class="nl">Connect_Retry:</span> <span class="mi">60</span>
              <span class="nl">Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
          <span class="nl">Read_Master_Log_Pos:</span> <span class="mi">943</span>
               <span class="nl">Relay_Log_File:</span> <span class="n">relay</span><span class="o">-</span><span class="n">log</span><span class="mf">.000005</span>
                <span class="nl">Relay_Log_Pos:</span> <span class="mi">529</span>
        <span class="nl">Relay_Master_Log_File:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">bin</span><span class="mf">.000004</span>
             <span class="nl">Slave_IO_Running:</span> <span class="n">Yes</span>
            <span class="nl">Slave_SQL_Running:</span> <span class="n">Yes</span>
              <span class="nl">Replicate_Do_DB:</span> <span class="n">mydb</span>
          <span class="nl">Replicate_Ignore_DB:</span>
           <span class="nl">Replicate_Do_Table:</span>
       <span class="nl">Replicate_Ignore_Table:</span>
      <span class="nl">Replicate_Wild_Do_Table:</span>
  <span class="nl">Replicate_Wild_Ignore_Table:</span>
                   <span class="nl">Last_Errno:</span> <span class="mi">0</span>
                   <span class="nl">Last_Error:</span>
                 <span class="nl">Skip_Counter:</span> <span class="mi">0</span>
          <span class="nl">Exec_Master_Log_Pos:</span> <span class="mi">943</span>
              <span class="nl">Relay_Log_Space:</span> <span class="mi">1287</span>
              <span class="nl">Until_Condition:</span> <span class="n">None</span>
               <span class="nl">Until_Log_File:</span>
                <span class="nl">Until_Log_Pos:</span> <span class="mi">0</span>
           <span class="nl">Master_SSL_Allowed:</span> <span class="n">No</span>
           <span class="nl">Master_SSL_CA_File:</span>
           <span class="nl">Master_SSL_CA_Path:</span>
              <span class="nl">Master_SSL_Cert:</span>
            <span class="nl">Master_SSL_Cipher:</span>
               <span class="nl">Master_SSL_Key:</span>
        <span class="nl">Seconds_Behind_Master:</span> <span class="mi">0</span>
<span class="nl">Master_SSL_Verify_Server_Cert:</span> <span class="n">No</span>
                <span class="nl">Last_IO_Errno:</span> <span class="mi">0</span>
                <span class="nl">Last_IO_Error:</span>
               <span class="nl">Last_SQL_Errno:</span> <span class="mi">0</span>
               <span class="nl">Last_SQL_Error:</span>
  <span class="nl">Replicate_Ignore_Server_Ids:</span>
             <span class="nl">Master_Server_Id:</span> <span class="mi">1</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="nl">ERROR:</span> <span class="n">No</span> <span class="n">query</span> <span class="n">specified</span>
</pre></div>


<p>主节点创建数据库</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">testdb</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">testdb</span>             <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">6</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">insert</span> <span class="n">into</span> <span class="n">tb1</span> <span class="n">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.06</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">tb1</span><span class="p">;</span>
<span class="o">+------+------+</span>
<span class="o">|</span> <span class="n">id</span>   <span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<p>从节点测试</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">mydb</span>               <span class="o">|</span>
<span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">test</span>               <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">5</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>

<span class="n">MariaDB</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">mydb</span>
<span class="n">Database</span> <span class="n">changed</span>
<span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">tb1</span><span class="p">;</span>
<span class="o">+------+------+</span>
<span class="o">|</span> <span class="n">id</span>   <span class="o">|</span> <span class="n">name</span> <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="o">|</span>    <span class="mi">1</span> <span class="o">|</span> <span class="n">a</span>    <span class="o">|</span>
<span class="o">+------+------+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<h1 id="ssl">基于SSL复制</h1>
<p>前提，支持SSL</p>
<div class="hlcode"><pre><span class="n">MariaDB</span> <span class="p">[</span><span class="n">mydb</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">global</span> <span class="n">variables</span> <span class="n">like</span> <span class="err">&#39;</span><span class="o">%</span><span class="n">ssl</span><span class="o">%</span><span class="err">&#39;</span><span class="p">;</span>
<span class="o">+---------------+----------+</span>
<span class="o">|</span> <span class="n">Variable_name</span> <span class="o">|</span> <span class="n">Value</span>    <span class="o">|</span>
<span class="o">+---------------+----------+</span>
<span class="o">|</span> <span class="n">have_openssl</span>  <span class="o">|</span> <span class="n">DISABLED</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">have_ssl</span>      <span class="o">|</span> <span class="n">DISABLED</span> <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_ca</span>        <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_capath</span>    <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_cert</span>      <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_cipher</span>    <span class="o">|</span>          <span class="o">|</span>
<span class="o">|</span> <span class="n">ssl_key</span>       <span class="o">|</span>          <span class="o">|</span>
<span class="o">+---------------+----------+</span>
<span class="mi">7</span> <span class="n">rows</span> <span class="n">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>


<blockquote>
<p>这里需要重新编译mariadb</p>
</blockquote>
<ol>
<li>master 配置证书和私钥：并且创建一个要求必须使用SS了连接的复制账号</li>
<li>slave 端使用<code>CHANGE MASTER TO</code> 命令时指明ssl相关选项</li>
</ol>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 Xu XueHua.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-02-24 13:42:28</p>
      </span>
    </div>

    
    
  </body>
</html>